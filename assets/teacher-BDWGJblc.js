const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./main-CRu-gqtW.js","./vendor-5I4LDDhx.js","./main-Uetmd9Uh.css"])))=>i.map(i=>d[i]);
import{u as e,a as t,b as s,U as a,c as n,S as i,C as r,F as l,D as o,P as c,A as d,d as x,e as m,f as u,L as h,E as p,M as g,T as f,g as j,_ as y,h as k,i as v,j as b,I as w,k as C,R as S,l as I,m as _,n as T,o as F,B as z,W as P,p as E,q as D,r as A,O as W,s as R,t as $,v as B,w as O,x as L,y as M,z as N,G as H,H as U,J as V,K as G,N as q,Q,V as Y,X as J,Y as K,Z as X,$ as Z,a0 as ee,a1 as te,a2 as se,a3 as ae,a4 as ne,a5 as ie,a6 as re,a7 as le,a8 as oe,a9 as ce,aa as de,ab as xe,ac as me,ad as ue,ae as he,af as pe,ag as ge,ah as fe,ai as je,aj as ye,ak as ke,al as ve,am as be,an as we,ao as Ce,ap as Se,aq as Ie,ar as _e,as as Te,at as Fe,au as ze,av as Pe,aw as Ee,ax as De,ay as Ae,az as We,aA as Re,aB as $e,aC as Be,aD as Oe,aE as Le,aF as Me,aG as Ne}from"./main-CRu-gqtW.js";import{a5 as He,ad as Ue,r as Ve,j as Ge,d as qe,e as Qe,L as Ye,H as Je,B as Ke,u as Xe,n as Ze,x as et,w as tt,$ as st,v as at,f as nt,I as it,h as rt,ag as lt,ah as ot,C as ct,b as dt,a0 as xt,a1 as mt,a3 as ut,M as ht,D as pt,i as gt,l as ft,m as jt,X as yt,Y as kt,N as vt,ac as bt,G as wt,J as Ct,ai as St,ab as It,aj as _t,z as Tt,E as Ft,K as zt,ak as Pt,al as Et,A as Dt,y as At,V as Wt,am as Rt,W as $t}from"./vendor-5I4LDDhx.js";const Bt="tasksPageFilters",Ot=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const k=He(),[v]=Ue(),{user:b}=e(),{showErrorToast:w}=t(),[C,S]=Ve.useState([]),[I,_]=Ve.useState([]),[T,F]=Ve.useState(!0),[z,P]=Ve.useState(!1),[E,D]=Ve.useState(null),[A,W]=Ve.useState(0),[R,$]=Ve.useState([]),[B,O]=Ve.useState(""),[L,M]=Ve.useState(""),[N,H]=Ve.useState(null),[U,V]=Ve.useState(!1),[G,q]=Ve.useState(null),[Q,Y]=Ve.useState(null),[J,K]=Ve.useState(!1),[X,Z]=Ve.useState(new Set),[ee,te]=Ve.useState(!1),[se,ae]=Ve.useState(!1),[ne,ie]=Ve.useState(!1),re=Ve.useRef(!0),le=Boolean(G),[oe,ce]=Ve.useState(0),[de,xe]=Ve.useState(!0),me=15,ue=Ve.useRef(null),{t:he}=s(),pe=(null==b?void 0:b.role)===a.ADMIN,ge=(null==b?void 0:b.role)===a.TEACHER||pe,fe=Ve.useCallback((()=>{try{const e=localStorage.getItem(Bt);if(e){return JSON.parse(e)}}catch(e){}return{searchTerm:"",filterTagIds:[]}}),[]),je=Ve.useCallback((()=>{const e={searchTerm:B,filterTagIds:R.map((e=>e.id))};localStorage.setItem(Bt,JSON.stringify(e))}),[B,R]);Ve.useEffect((()=>{const e=setTimeout((()=>{O(L)}),500);return()=>clearTimeout(e)}),[L]),Ve.useEffect((()=>{re.current||je()}),[B,R,je]),Ve.useEffect((()=>{(async()=>{if(re.current){F(!0),D(null);try{const e=fe(),t=v.get("tag_id"),s=await n.tags.getAll();_(s);let a=[];if(t){const e=s.find((e=>e.id===t));e&&($([e]),a=[t])}else if(e.filterTagIds.length>0){const t=e.filterTagIds.map((e=>s.find((t=>t.id===e)))).filter((e=>void 0!==e));t.length>0&&($(t),a=e.filterTagIds)}e.searchTerm&&(O(e.searchTerm),M(e.searchTerm));const i=e.searchTerm||"",r=await n.tasks.getAll(0,me,i,a.join(","));S(r),ce(0),xe(r.length===me),re.current=!1,D(null)}catch(e){const t=j(e);D(t),w(t)}finally{F(!1)}}})()}),[A,v,fe]),Ve.useEffect((()=>{if(re.current)return;(async()=>{F(!0),D(null);try{const e=await n.tasks.getAll(0,me,B,R.map((e=>e.id)).join(","));S(e),ce(0),xe(e.length===me)}catch(e){D("Failed to search tasks. Please try again.")}finally{F(!1)}})()}),[B,R]),Ve.useEffect((()=>{const e=new IntersectionObserver((e=>{const[t]=e;t.isIntersecting&&de&&!T&&!z&&ye()}),{threshold:.5}),t=ue.current;return t&&e.observe(t),()=>{t&&e.unobserve(t)}}),[de,T,z]);const ye=async()=>{if(!de||z)return;P(!0);const e=oe+1;try{const t=await n.tasks.getAll(e*me,me,B,R.map((e=>e.id)).join(","));if(t.length>0){const s=t.filter((e=>!C.some((t=>t.id===e.id))));S((e=>[...e,...s])),ce(e),xe(t.length===me)}else xe(!1)}catch(t){w("Failed to load more tasks. Please try again.")}finally{P(!1)}},ke=Ve.useCallback((()=>{W((e=>e+1))}),[]),ve=()=>{localStorage.removeItem(Bt),O(""),M(""),$([])},be=()=>{V(!1)},we=(e,t)=>{e.stopPropagation(),q(e.currentTarget),Y(t)},Ce=()=>{q(null)},Se=()=>{K(!1),Y(null)},Ie=e=>{Z((t=>{const s=new Set(t);return s.has(e.id)?s.delete(e.id):s.add(e.id),s})),te(!0),V(!1)},_e=()=>{ae(!1)},Te=[Ge.jsxs(qe,{onClick:e=>{e.stopPropagation(),Ie(Q),Ce()},children:[Ge.jsx(Qe,{children:Ge.jsx(i,{fontSize:"small"})}),Ge.jsx(Ye,{children:he("common.actions.select")})]},"select"),Ge.jsxs(qe,{onClick:()=>{Q&&(k(`/tasks/new?copy_task_id=${Q.id}`),Ce())},children:[Ge.jsx(Qe,{children:Ge.jsx(r,{fontSize:"small"})}),Ge.jsx(Ye,{children:he("common.actions.copy")})]},"copy"),Ge.jsxs(qe,{onClick:async()=>{if(Q){ie(!0);try{const{exportToDocx:e}=await y((async()=>{const{exportToDocx:e}=await import("./main-CRu-gqtW.js").then((e=>e.dF));return{exportToDocx:e}}),__vite__mapDeps([0,1,2]),import.meta.url),t=await e(Q),s=URL.createObjectURL(t),a=document.createElement("a");a.href=s,a.download=`${Q.title}.docx`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)}catch(e){w("Failed to export task to DOCX. Please try again.")}finally{ie(!1),Ce()}}},disabled:ne,children:[Ge.jsx(Qe,{children:ne?Ge.jsx(Je,{size:20}):Ge.jsx(l,{fontSize:"small"})}),Ge.jsx(Ye,{children:he("common.actions.export")})]},"export"),Ge.jsxs(qe,{onClick:()=>{Ce(),K(!0)},sx:{color:"error.main"},children:[Ge.jsx(Qe,{children:Ge.jsx(o,{fontSize:"small",color:"error"})}),Ge.jsx(Ye,{children:he("common.actions.delete")})]},"delete")];return Ge.jsxs(Ke,{children:[Ge.jsx(c,{title:he("tasks.title"),actionButton:ge?[{label:he("tasks.actions.createTask"),icon:Ge.jsx(d,{}),onClick:()=>k("/tasks/new")}]:void 0}),E&&Ge.jsx(Xe,{severity:"error",sx:{mb:2},action:Ge.jsx(Ze,{color:"inherit",size:"small",onClick:ke,disabled:T,children:T?"Loading...":"Retry"}),children:E}),Ge.jsx(et,{sx:{p:2,mb:2},children:Ge.jsxs(tt,{spacing:2,children:[Ge.jsxs(Ke,{sx:{display:"flex",flexDirection:"column",gap:2},children:[Ge.jsx(st,{multiple:!0,size:"small",options:I,getOptionLabel:e=>e.name,value:R,onChange:(e,t)=>$(t),renderInput:e=>Ge.jsx(nt,{...e,label:he("tasks.actions.filterByTags"),placeholder:he("filters.selectTags"),variant:"outlined",InputProps:{...e.InputProps,startAdornment:Ge.jsxs(Ge.Fragment,{children:[Ge.jsx(x,{sx:{mr:1,color:"text.secondary"}}),e.InputProps.startAdornment]})}}),renderTags:(e,t)=>e.map(((e,s)=>Ve.createElement(at,{color:"primary",label:e.name,...t({index:s}),key:e.id})))}),Ge.jsx(Ke,{sx:{display:"flex",gap:2},children:Ge.jsx(nt,{label:he("tasks.actions.searchByTitle"),placeholder:he("filters.enterTitle"),variant:"outlined",fullWidth:!0,size:"small",value:L,onChange:e=>{const t=e.target.value;M(t)},InputProps:{startAdornment:Ge.jsx(u,{sx:{mr:1,color:"text.secondary"}}),endAdornment:L?Ge.jsx(it,{position:"end",children:Ge.jsx(rt,{"aria-label":"clear search",onClick:()=>{M(""),O("")},edge:"end",size:"small",children:Ge.jsx(m,{fontSize:"small"})})}):null}})})]}),(R.length>0||L)&&Ge.jsx(Ke,{sx:{display:"flex",justifyContent:"center"},children:Ge.jsx(Ze,{variant:"outlined",startIcon:Ge.jsx(x,{}),onClick:ve,children:he("common.actions.clear")})})]})}),ee&&Ge.jsx(lt,{position:"static",color:"default",elevation:1,sx:{mb:2},children:Ge.jsxs(ot,{variant:"dense",children:[Ge.jsxs(Ke,{sx:{display:"flex",alignItems:"center",gap:1,flex:1},children:[Ge.jsx(ct,{edge:"start",checked:X.size===C.length,indeterminate:X.size>0&&X.size<C.length,onChange:()=>{X.size===C.length?Z(new Set):Z(new Set(C.map((e=>e.id))))}}),Ge.jsx(dt,{variant:"body2",children:he("tasks.selection.selected",{count:X.size})})]}),Ge.jsxs(Ke,{sx:{display:"flex"},children:[ge&&Ge.jsx(Ze,{color:"error",startIcon:Ge.jsx(o,{}),onClick:()=>{ae(!0)},disabled:0===X.size,children:he("tasks.selection.deleteCount",{count:X.size||0})}),Ge.jsx(Ze,{onClick:()=>{Z(new Set),te(!1)},children:he("common.actions.cancel")})]})]})}),T?Ge.jsx(h,{message:he("common.loading")}):Ge.jsxs(Ge.Fragment,{children:[E||0!==C.length?Ge.jsxs(Ge.Fragment,{children:[Ge.jsx(Ke,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"repeat(2, 1fr)",lg:"repeat(3, 1fr)"},gap:2},children:C.map((e=>Ge.jsxs(xt,{sx:{height:"100%",cursor:"pointer",position:"relative","&:hover":{boxShadow:6}},onClick:()=>!ee&&(e=>{H(e),V(!0)})(e),children:[ee&&Ge.jsx(ct,{edge:"start",checked:X.has(e.id),onChange:t=>{t.stopPropagation(),Ie(e)},sx:{position:"absolute",top:8,right:8,zIndex:1}}),Ge.jsx(mt,{sx:{p:2,"&:last-child":{paddingBottom:2}},children:Ge.jsxs(Ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",gap:1},children:[Ge.jsx(dt,{sx:{flex:1,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.2},children:e.title}),Ge.jsx(Ke,{sx:{display:"flex",flexDirection:"row",gap:1,flexShrink:0},children:!ee&&Ge.jsxs(Ge.Fragment,{children:[Ge.jsx(rt,{size:"small",onClick:t=>{t.stopPropagation(),k(`/tasks/${e.id}/edit`)},children:Ge.jsx(p,{})}),Ge.jsx(rt,{size:"small",onClick:t=>we(t,e),children:Ge.jsx(g,{})})]})})]})}),e.tags.length>0&&Ge.jsx(ut,{sx:{pt:0,px:2,pb:2},children:Ge.jsx(Ke,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:e.tags.map((e=>Ge.jsx(at,{label:e.name,size:"small",variant:"outlined",onClick:t=>{t.stopPropagation(),R.some((t=>t.id===e.id))||$([...R,e])},sx:{cursor:"pointer","&:hover":{backgroundColor:"action.hover"}}},e.id)))})})]},e.id)))}),Ge.jsx(Ke,{ref:ue,sx:{display:"flex",justifyContent:"center",p:2,visibility:de?"visible":"hidden"},children:z&&Ge.jsx(Je,{size:24})})]}):Ge.jsxs(Ke,{sx:{textAlign:"center",py:4},children:[Ge.jsx(dt,{variant:"h6",color:"text.secondary",sx:{mb:1},children:B.length<1&&R.length<1?he(ge?"tasks.empty.teacher":"tasks.empty.student"):he("tasks.empty.noMatch")}),ge&&B.length<1&&R.length<1&&Ge.jsx(Ze,{variant:"outlined",startIcon:Ge.jsx(d,{}),onClick:()=>k("/tasks/new"),sx:{mt:2},children:he("tasks.actions.createFirst")}),(B.length>0||R.length>0)&&Ge.jsx(Ze,{variant:"outlined",startIcon:Ge.jsx(x,{}),onClick:ve,sx:{borderRadius:2,textTransform:"none"},children:he("common.actions.clear")})]}),Ge.jsx(f,{open:U,onClose:be,task:N,hasQuizzes:!1,onValidateAnswers:()=>{},actionButtons:Ge.jsxs(Ke,{sx:{display:"flex",gap:1,width:"100%",justifyContent:"space-between"},children:[Ge.jsx(Ke,{sx:{display:"flex",gap:1},children:N&&Ge.jsxs(Ge.Fragment,{children:[Ge.jsx(Ze,{size:"small",onClick:e=>we(e,N),startIcon:Ge.jsx(g,{}),children:he("common.actions.actions")}),Ge.jsx(Ze,{size:"small",onClick:e=>{e.stopPropagation(),k(`/tasks/${N.id}/edit`)},startIcon:Ge.jsx(p,{}),children:he("common.actions.edit")})]})}),Ge.jsx(Ze,{onClick:be,children:he("common.actions.close")})]})}),Ge.jsx(ht,{anchorEl:G,open:le,onClose:Ce,onClick:e=>e.stopPropagation(),children:Te}),Ge.jsxs(pt,{open:J,onClose:Se,maxWidth:"xs",fullWidth:!0,children:[Ge.jsx(gt,{children:he("common.dialog.delete.title",{item:"Task"})}),Ge.jsx(ft,{children:Ge.jsx(dt,{children:he("common.dialog.delete.message",{name:null==Q?void 0:Q.title})})}),Ge.jsxs(jt,{children:[Ge.jsx(Ze,{onClick:Se,children:he("common.actions.cancel")}),Ge.jsx(Ze,{onClick:async()=>{if(Q)try{await n.tasks.delete(Q.id),S(C.filter((e=>e.id!==Q.id)))}catch(e){const t=e instanceof Error?e.message:"Failed to delete task. Please try again.";w(t)}finally{K(!1),Y(null)}},color:"error",variant:"contained",startIcon:Ge.jsx(o,{}),children:he("common.actions.delete")})]})]}),Ge.jsxs(pt,{open:se,onClose:_e,maxWidth:"xs",fullWidth:!0,children:[Ge.jsx(gt,{children:he("common.dialog.delete.title",{item:"Tasks"})}),Ge.jsx(ft,{children:Ge.jsx(dt,{children:he("common.dialog.delete.messageBulk",{count:X.size,item:1===X.size?"task":"tasks"})})}),Ge.jsxs(jt,{children:[Ge.jsx(Ze,{onClick:_e,children:he("common.actions.cancel")}),Ge.jsxs(Ze,{onClick:async()=>{try{await n.tasks.batchDelete(Array.from(X));S(C.filter((e=>!X.has(e.id)))),Z(new Set),te(!1)}catch(e){const t=e instanceof Error?e.message:"Failed to delete tasks. Please try again.";w(t)}finally{ae(!1)}},color:"error",variant:"contained",startIcon:Ge.jsx(o,{}),children:[he("common.actions.delete")," ",X.size," ",1===X.size?"task":"tasks"]})]})]})]})]})}},Symbol.toStringTag,{value:"Module"})),Lt=({editorRef:e,formData:a,setFormData:i,setGeneratedImage:r,setInitText:l,onClose:o})=>{const{t:c}=s(),[d,x]=Ve.useState(""),[m,u]=Ve.useState(!1),[h,p]=Ve.useState([]),[f,j]=Ve.useState(null),[y,I]=Ve.useState(null),[_,T]=Ve.useState(!1),[F,z]=Ve.useState("text"),{showErrorToast:P}=t(),E=()=>{j(null),I(null)},D=async(t,s)=>{const n={id:Date.now().toString(),message:"",text:a.text,timestamp:new Date,status:"done",image:s,type:F};p((e=>[n,...e]));const r=`\n${t}\n`,l=a.text+r;i((e=>({...e,text:l}))),e.current&&(e.current.setMarkdown(l),e.current.focus())};return Ge.jsxs(et,{sx:{width:"350px",display:"flex",flexDirection:"column",overflow:"hidden",...(m||_)&&{position:"relative","&::before":{content:'""',position:"absolute",top:0,left:0,right:0,bottom:0,background:"linear-gradient(45deg, transparent 30%, rgba(25, 118, 210, 0.08) 50%, transparent 70%)",backgroundSize:"400% 400%",borderRadius:"inherit",zIndex:1,pointerEvents:"none",animation:"shimmer 2s ease-in-out infinite"},"&::after":{content:'""',position:"absolute",top:-2,left:-2,right:-2,bottom:-2,background:"linear-gradient(45deg, rgba(25, 118, 210, 0.3), rgba(25, 118, 210, 0.1), rgba(25, 118, 210, 0.3))",backgroundSize:"400% 400%",borderRadius:"inherit",zIndex:-1,animation:"shimmer 3s ease-in-out infinite reverse"},animation:"pulse 2s ease-in-out infinite","& > *":{position:"relative",zIndex:2}},"@keyframes shimmer":{"0%":{backgroundPosition:"100% 0%"},"100%":{backgroundPosition:"-100% 0%"}},"@keyframes pulse":{"0%, 100%":{opacity:1,transform:"scale(1)"},"50%":{opacity:.95,transform:"scale(1.005)"}}},children:[Ge.jsxs(Ke,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:2},children:[Ge.jsx(dt,{variant:"h5",component:"div",children:c("taskForm.ai.title")}),Ge.jsx(Ke,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:Ge.jsx(rt,{size:"small",onClick:o,children:Ge.jsx(k,{})})})]}),Ge.jsxs(Ke,{sx:{flex:1,overflow:"auto",p:2,pt:0},children:[Ge.jsx(dt,{variant:"body1",color:"text.secondary",sx:{mb:2},children:c("taskForm.ai.placeholder")}),h.length>0&&Ge.jsxs(Ke,{sx:{mb:2},children:[Ge.jsxs(dt,{variant:"subtitle2",sx:{mb:1},children:[c("taskForm.ai.history"),":"]}),Ge.jsx(yt,{dense:!0,sx:{bgcolor:"background.paper",borderRadius:1,border:"1px solid",borderColor:"divider"},children:h.map((e=>Ge.jsxs(kt,{onClick:t=>((e,t)=>{j(e.currentTarget),I(t)})(t,e),sx:{"&:hover":{bgcolor:"action.hover"}},secondaryAction:Ge.jsx(Ge.Fragment,{children:Ge.jsx(rt,{size:"small",sx:{ml:1},children:Ge.jsx(g,{fontSize:"small"})})}),children:[Ge.jsxs(Ke,{sx:{display:"flex",alignItems:"center",justifyContent:"center",width:"50px",height:"50px",mr:1,overflow:"hidden"},children:["processing"===e.status&&Ge.jsx(Je,{size:16}),"done"===e.status&&!e.image&&Ge.jsx(v,{fontSize:"small",color:"success"}),"done"===e.status&&e.image&&Ge.jsx("img",{src:e.image,style:{width:"100%"}}),"error"===e.status&&Ge.jsx(b,{fontSize:"small",color:"error"})]}),Ge.jsx(Ye,{primary:e.message||c("taskForm.ai.imageRecognizedText"),secondary:e.timestamp.toLocaleTimeString(c("locale"),{timeStyle:"short"})})]},e.id)))})]}),!1,Ge.jsx(nt,{fullWidth:!0,multiline:!0,minRows:3,maxRows:20,variant:"outlined",placeholder:c("taskForm.ai.messageInputPlaceholder"),value:d,onChange:e=>x(e.target.value),disabled:m,onPaste:async e=>{const t=e.clipboardData.items;for(const a of t)if(a.type.startsWith("image/")){e.preventDefault();const t=a.getAsFile();if(t){T(!0);try{const e=await new Promise((e=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.readAsDataURL(t)})),s=await n.files.recognizeText({imageBase64:e,mode:"text"});s&&await D(s,e)}catch(s){P(c("taskForm.ai.errors.imageProcessing"))}finally{T(!1)}}}else if("text/plain"===a.type){const t=await new Promise((e=>a.getAsString(e)));if(t.match(/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)$/i)){e.preventDefault(),T(!0);try{const e=await fetch(t),s=await e.blob(),a=await new Promise((e=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(s)})),i=await n.files.recognizeText({imageBase64:a,mode:"text"});i&&await D(i,a)}catch(s){P(c("taskForm.ai.errors.imageURLProcessing"))}finally{T(!1)}}}},sx:{mb:2}}),Ge.jsxs(Ke,{sx:{display:"flex",gap:1,mb:2},children:[Ge.jsx(Ze,{variant:"outlined",color:"primary",onClick:()=>{var e;return null==(e=document.getElementById("image-input"))?void 0:e.click()},disabled:_,startIcon:Ge.jsx(w,{}),children:c(_?"common.loading":"taskForm.ai.image")}),Ge.jsx(Ze,{variant:"contained",color:"primary",endIcon:Ge.jsx(C,{}),onClick:async()=>{if(!d.trim())return;const t={id:Date.now().toString(),message:d,text:a.text||"",timestamp:new Date,status:"processing",type:F};p((e=>[t,...e])),x(""),u(!0);try{const s=await n.tasks.chat({text:a.text,message:t.message,type:t.type});p((e=>e.map((e=>e.id===t.id?{...e,status:"done"}:e)))),"text"===F&&s&&(l(a.text),i((e=>({...e,text:s}))),e.current&&(e.current.setMarkdown(s||""),e.current.focus()))}catch(s){p((e=>e.map((e=>e.id===t.id?{...e,status:"error"}:e)))),P("Failed to get AI response. "+s)}finally{u(!1)}},disabled:m||!d.trim(),sx:{flex:1},children:c(m?"taskForm.ai.sending":"taskForm.ai.send")}),Ge.jsx("input",{type:"file",accept:"image/*",style:{display:"none"},id:"image-input",onChange:async e=>{var t;const s=null==(t=e.target.files)?void 0:t[0];if(s){T(!0);try{const e=await new Promise((e=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(s)})),t=await n.files.recognizeText({imageBase64:e,mode:"text"});t?await D(t,e):P(c("taskForm.ai.errors.noTextRecognized"))}catch(a){P(c("taskForm.ai.errors.imageProcessing"))}finally{T(!1)}}}})]})]}),Ge.jsx(ht,{anchorEl:f,open:Boolean(f),onClose:E,children:Ge.jsxs(qe,{onClick:()=>{y&&(x(y.message),i((e=>({...e,text:y.text}))),e.current&&(e.current.setMarkdown(y.text||""),e.current.focus()),p((e=>{const t=e.findIndex((e=>e.id===y.id));return-1===t?e:e.slice(t+1)}))),E()},children:[Ge.jsx(S,{fontSize:"small",sx:{mr:1}}),c("taskForm.ai.rollback")]})})]})},Mt=({title:e,text:t,url:a,tagIds:n,tags:i,teacherId:r,onClose:l,onFullscreen:o,onValidateAnswers:c,hasQuizzes:d})=>{const{t:x}=s();return Ge.jsxs(et,{id:"preview-panel-paper",sx:{width:"350px",display:"flex",flexDirection:"column",height:"100%"},children:[Ge.jsx(Ke,{sx:{width:"100%",display:"flex",flexDirection:"column",gap:2,p:2,flex:"flex-start"},children:Ge.jsxs(Ke,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%"},children:[Ge.jsx(dt,{variant:"h5",component:"div",children:x("common.dialog.preview.title")}),Ge.jsxs(Ke,{sx:{display:"flex",gap:1},children:[Ge.jsx(rt,{size:"small",onClick:o,children:Ge.jsx(I,{})}),Ge.jsx(rt,{size:"small",onClick:l,children:Ge.jsx(k,{})})]})]})}),Ge.jsxs(Ke,{sx:{overflow:"auto",flex:"flex",px:2,height:"100%"},children:[Ge.jsx(Ke,{sx:{mb:2},children:Ge.jsx(dt,{variant:"h3",children:e})}),Ge.jsx(_,{task:{id:"preview",title:e,text:t,url:a||"",tags:i.filter((e=>n.includes(e.id))),teacher_id:r},isSaveAnswer:!1,workId:"preview"})]}),d&&Ge.jsx(Ke,{sx:{p:2,borderTop:1,borderColor:"divider",display:"flex",justifyContent:"center",mt:"auto",flex:"flex-end"},children:Ge.jsx(Ze,{variant:"contained",color:"primary",onClick:c,startIcon:Ge.jsx(v,{}),children:x("common.actions.checkAnswers")})})]})},Nt=()=>{const{t:e}=s(),t=T(F),[a,n]=Ve.useState(null),[i,r]=Ve.useState(null),l=()=>{n(null)},o=Boolean(a),c=(e,t)=>{const s=!!i&&((null==i?void 0:i.row)>=e&&(null==i?void 0:i.col)>=t);return{minWidth:"40px",height:"40px",backgroundColor:s?"primary.main":"transparent",color:s?"primary.contrastText":"primary.main","&:hover":{backgroundColor:"primary.main"},transition:"all 0.5s ease"}};return Ge.jsxs(Ge.Fragment,{children:[Ge.jsx(z,{title:e("taskForm.table.title"),children:Ge.jsx("span",{onClick:e=>{n(e.currentTarget)},children:Ge.jsx(P,{})})}),Ge.jsx(vt,{open:o,anchorEl:a,onClose:l,anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:Ge.jsx(Ke,{sx:{p:2},children:Ge.jsx(Ke,{sx:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:1,width:200},children:Array.from({length:4},((e,t)=>t+1)).map((e=>Array.from({length:4},((e,t)=>t+1)).map((s=>Ge.jsxs(Ze,{variant:"outlined",size:"small",onClick:()=>(t({rows:e,columns:s}),void l()),onMouseEnter:()=>r({row:e,col:s}),onMouseLeave:()=>r(null),sx:c(e,s),children:[e,"x",s]},`${e}-${s}`)))))})})})]})},Ht=({editorRef:e,formData:t,setFormData:a,setInitText:n,setGeneratedImage:i,onClose:r})=>{const{t:l}=s(),o=[{icon:Ge.jsx(E,{}),title:l("components.hiddenText.title"),description:l("components.hiddenText.hint"),image:null},{icon:Ge.jsx(D,{}),title:l("components.multipleChoice.title"),description:l("components.multipleChoice.hint"),image:null},{icon:Ge.jsx(A,{}),title:l("components.draggableAnswers.title"),description:l("components.draggableAnswers.hint"),image:null},{icon:Ge.jsx(W,{}),title:l("components.sortingOrdering.title"),description:l("components.sortingOrdering.hint"),image:null},{icon:Ge.jsx(R,{}),title:l("components.studentsSection.title"),description:l("components.studentsSection.hint"),image:null},{icon:Ge.jsx(w,{}),title:l("components.image.title"),description:l("components.image.hint"),image:null},{icon:Ge.jsx($,{}),title:l("components.audio.title"),description:l("components.audio.hint"),image:null},{icon:Ge.jsx(B,{}),title:l("components.embed.title"),description:l("components.embed.hint"),image:null}];return Ge.jsx(Ke,{children:Ge.jsx(Ke,{sx:{display:"flex",flexWrap:"wrap",gap:2,"& > *":{flex:"1 1 calc(50% - 16px)",minWidth:"200px"}},children:o.map(((e,t)=>Ge.jsx(Ke,{children:Ge.jsx(xt,{sx:{height:"100%"},children:Ge.jsxs(mt,{children:[Ge.jsxs(Ke,{sx:{display:"flex",alignItems:"center",mb:2},children:[Ge.jsx(Qe,{sx:{minWidth:40},children:e.icon}),Ge.jsx(Ye,{primary:e.title,primaryTypographyProps:{variant:"subtitle1",sx:{fontWeight:500}}})]}),Ge.jsx(dt,{variant:"body2",color:"text.secondary",children:e.description})]})})},t)))})})},Ut=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const i=He(),{taskId:r}=bt(),[l]=Ue(),o=l.get("return_to")||"/tasks",c=l.get("copy_task_id"),d=l.get("work_id"),x=l.get("sharingKey"),{user:m}=e(),{showErrorToast:u}=t(),{mode:p}=O(),g=Ve.useRef(null),[j,y]=Ve.useState(null),[k,v]=Ve.useState(!0),[b,w]=Ve.useState(!1),[C,S]=Ve.useState([]),[I,_]=Ve.useState({title:"",text:"",url:"",tag_ids:[]}),[T,F]=Ve.useState(null),[z,P]=Ve.useState({}),[E,D]=Ve.useState(!1),[A,W]=Ve.useState((()=>localStorage.getItem("taskForm_sidePanelMode")||"live-preview"));Ve.useEffect((()=>{A?localStorage.setItem("taskForm_sidePanelMode",A):localStorage.removeItem("taskForm_sidePanelMode")}),[A]);const[R,$]=Ve.useState(""),[B,Ce]=Ve.useState(null),[Se,Ie]=Ve.useState(!1),[_e,Te]=Ve.useState(""),[Fe,ze]=Ve.useState(!1),[Pe,Ee]=Ve.useState(!1),[De,Ae]=Ve.useState(null),[We,Re]=Ve.useState(null),$e=(null==m?void 0:m.role)===a.ADMIN,Be=(null==m?void 0:m.role)===a.TEACHER||$e,Oe=Boolean(r),[Le,Me]=Ve.useState(!1),Ne=wt(),qe=Ct(Ne.breakpoints.down("md")),{t:Qe}=s(),Ye=Ve.useRef(I);Ve.useEffect((()=>{if(!Pe)return;const e=r?`task_${r}`:"new_task";Te(e);const t=localStorage.getItem(e);t&&(Ce(t),Ie(!0))}),[r,Pe]);const Je=e=>{if(Ie(!1),e&&B)try{const e=JSON.parse(B);Ye.current={...Ye.current,...e},_({...Ye.current});const t=document.querySelector('input[name="title"]');t&&(t.value=e.title||""),g.current&&(g.current.setMarkdown(e.text||""),g.current.focus())}catch(t){}else localStorage.removeItem(_e),Ce(null)},Xe=Ve.useCallback(St((()=>{_({...Ye.current}),P((e=>{const t={...e};return Ye.current.title&&t.title&&delete t.title,Ye.current.text&&t.text&&delete t.text,Ye.current.tag_ids.length>0&&t.tag_ids&&delete t.tag_ids,t})),_e&&localStorage.setItem(_e,JSON.stringify(Ye.current))}),500),[_e]),tt=e=>{if(!e)return!1;const t=e.includes(":hidden")||e.includes(":essay")||e.includes(":sort")||e.includes(":select"),s=e.includes("[ ]")||e.includes("[x]");return t||s},it=()=>{window.dispatchEvent(new CustomEvent("validateAllQuizzes",{detail:{taskId:"preview"}}))},rt=e=>{e?(Ce(null),localStorage.removeItem(_e),ze(!1),i(o)):ze(!1)};if(Ve.useEffect((()=>{const e=setTimeout((()=>{g.current&&Ee(!0)}),500);return()=>clearTimeout(e)}),[]),Ve.useEffect((()=>{let e=!0;return(async()=>{if(e){v(!0);try{const t=await n.tags.getAll();if(!e)return;if(S(t),r){const t=await n.tasks.getById(r);if(!e)return;y(t),$(t.text||"");const s={title:t.title,text:t.text||"",tag_ids:t.tags.map((e=>e.id))};Ye.current=s,_(s)}else if(c){const t=await n.tasks.getById(c);if(!e)return;y(t),$(t.text||"");const s={title:`Copy of ${t.title}`,text:t.text||"",tag_ids:t.tags.map((e=>e.id))};Ye.current=s,_(s)}else if(x){const t=await n.tasks.getBySharingKey(x);if(!e)return;y(t),$(t.text||"");const s={title:t.title,text:t.text||"",tag_ids:t.tags.map((e=>e.id))};Ye.current=s,_(s)}d&&F(await n.works.getById(d))}catch(t){const s=t instanceof Error?t.message:"Failed to load data. Please try again.";if(!e)return;u(s),i(o)}finally{if(!e)return;v(!1)}}})(),()=>{e=!1}}),[r,c,i,o]),!Be)return i(o),null;function lt(e=!1){return Ge.jsxs(Ke,{sx:{display:"flex",gap:0,opacity:e?1:.5,pointerEvents:e?"auto":"none"},children:[Ge.jsx(ce,{options:["Bold","Italic"]}),Ge.jsx(de,{options:["bullet","number"]}),Ge.jsx(Nt,{}),Ge.jsx(xe,{}),Ge.jsx(me,{editorRef:g}),Ge.jsx(ue,{editorRef:g}),Ge.jsx(de,{options:["check"]}),Ge.jsx(he,{editorRef:g}),Ge.jsx(pe,{editorRef:g}),Ge.jsx(ge,{editorRef:g}),Ge.jsx(fe,{}),Ge.jsx(je,{}),Ge.jsx(ye,{}),Ge.jsx(ke,{}),Ge.jsx(ve,{})]})}return Ge.jsxs(Ke,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[k?Ge.jsx(h,{message:Qe(Oe?"taskForm.loading.task":"taskForm.loading.default")}):Ge.jsxs(Ke,{sx:{display:"flex",gap:2,height:"100%",overflow:"hidden",justifyContent:"center",alignItems:"center"},children:[Ge.jsxs(Ke,{sx:{display:"flex",flex:"3 1",flexDirection:"column",width:"100%",maxWidth:"800px",height:"100%",position:"relative",overflow:"hidden"},children:[Ge.jsx(Ke,{sx:{flex:1,overflow:"auto",p:1,pt:0},children:Ge.jsx(Ke,{width:"100%",sx:{display:"flex",justifyContent:"space-between"},children:Ge.jsx(Ke,{sx:{flex:1,display:"flex",flexDirection:"column",width:"100%",position:"relative"},children:Ge.jsxs(Ke,{component:"form",noValidate:!0,sx:{display:"flex",flexDirection:"column",height:"100%",minHeight:0,flex:1},children:[Ge.jsxs(et,{sx:{p:2,pt:0,pb:1},children:[T&&Ge.jsx(Ke,{sx:{my:2},children:Ge.jsx(at,{label:T.name,onDelete:()=>i(o),color:"primary"})}),Ge.jsx(nt,{autoFocus:!0,margin:"normal",name:"title",label:Qe("taskForm.title.label"),type:"text",fullWidth:!0,variant:"outlined",defaultValue:I.title,onChange:e=>{Ye.current.title=e.target.value,Xe()},error:!!z.title,helperText:z.title,inputProps:{autoComplete:"off",maxLength:100}}),Ge.jsx(st,{multiple:!0,options:C,getOptionLabel:e=>e.name,value:C.filter((e=>Ye.current.tag_ids.includes(e.id))),onChange:(e,t)=>{const s=t.map((e=>e.id));Ye.current.tag_ids=s,_({...Ye.current}),Xe()},disabled:Le,disableCloseOnSelect:!0,renderInput:e=>Ge.jsxs(Ke,{sx:{position:"relative"},children:[Ge.jsx(nt,{...e,label:Qe("taskForm.tags.label"),margin:"normal",error:!!z.tag_ids}),Le&&Ge.jsx(It,{sx:{position:"absolute",bottom:0,left:0,right:0,height:2}})]}),filterOptions:(e,{inputValue:t})=>{const s=e.filter((e=>e.name.toLowerCase().includes(t.toLowerCase())));return t&&!s.length?[{id:"new",name:t,creator_id:(null==m?void 0:m.id)||""}]:s},renderOption:(e,t)=>"new"===t.id?Ge.jsx("li",{...e,onClick:async e=>{e.stopPropagation(),Me(!0);try{const e=await n.tags.create({name:t.name});S((t=>[...t,e])),Ye.current.tag_ids=[...Ye.current.tag_ids,e.id],_({...Ye.current})}catch(s){const e=s instanceof Error?s.message:"Failed to create tag. Please try again.";u(e)}finally{Me(!1)}},children:Qe("taskForm.tags.create",{name:t.name})}):Ge.jsx("li",{...e,children:t.name})}),z.tag_ids&&Ge.jsx(_t,{error:!0,children:z.tag_ids})]}),Ge.jsx(et,{sx:{flex:1,display:"flex",flexDirection:"column",minHeight:0,position:"relative",mt:2,mb:2,border:"1px solid",borderColor:"divider"},children:Ge.jsx(L,{ref:g,markdown:I.text,autoFocus:!1,onChange:e=>{Ye.current.text=e,Xe()},className:"dark"===p?"mdxeditor dark-theme dark-editor":"mdxeditor light-theme light-editor",translation:(e,t,s)=>Qe("editor."+e,{defaultValue:t,...s}),plugins:[M(),N(),H(),U({disableImageResize:!0,disableImageSettingsButton:!0,imageUploadHandler:async e=>{const t=URL.createObjectURL(e);Ae(t);const s=await n.files.uploadImage(e);return s.url?(Ae(null),URL.revokeObjectURL(t),s.url):(u("Failed to upload image. Please try again."),t)},EditImageToolbar:Z}),V(),G(),q({disableAutoLink:!0}),Q(),Y({viewMode:"rich-text",diffMarkdown:R}),J({escapeUnknownTextDirectives:!0,directiveDescriptors:[ee,te,se,ae,ne,ie,re]}),K(1e5),X({toolbarClassName:"mdxeditor-toolbar-full ",toolbarContents:()=>Ge.jsx(le,{options:qe?[]:["source"],children:Ge.jsx(oe,{options:[{when:e=>{var t;return"root"!==(null==(t=null==e?void 0:e.rootNode)?void 0:t.getType())},contents:()=>lt(!1)},{fallback:()=>lt(!0)}]})})})]})})]})})})}),Ge.jsxs(Ke,{sx:{width:"100%",p:1,display:"flex",justifyContent:"space-between",position:"sticky",bottom:0,left:0,zIndex:1},children:[Ge.jsx(Ke,{sx:{display:"flex-start",gap:2},children:Ge.jsx(Ze,{variant:"outlined",color:"inherit",onClick:()=>{null!==localStorage.getItem(_e)?ze(!0):i(o)},children:Qe("taskForm.buttons.cancel")})}),Ge.jsx(Ke,{sx:{display:{xs:"none",lg:"flex",gap:2}},children:Ge.jsxs(Tt,{color:"primary",value:A,exclusive:!0,onChange:(e,t)=>{W(t)},size:"small",sx:{"& .MuiToggleButtonGroup-firstButton":{borderRadius:"10px 0 0 10px"},"& .MuiToggleButtonGroup-lastButton":{borderRadius:"0 10px 10px 0"}},children:[Ge.jsx(Ft,{value:"components-help",children:Qe("taskForm.buttons.quickHelp")}),Ge.jsx(Ft,{value:"live-preview",children:Qe("taskForm.buttons.livePreview")}),Ge.jsx(Ft,{value:"ai-chat",children:Qe("taskForm.buttons.aiAssistant")})]})}),Ge.jsxs(Ke,{sx:{display:"flex-end",gap:2},children:[Ge.jsx(zt,{title:Qe("taskForm.buttons.preview"),children:Ge.jsx(Ze,{variant:"outlined",color:"info",onClick:()=>D(!0),sx:{mr:1,display:{xs:void 0,lg:"none"}},children:Qe("taskForm.buttons.preview")})}),Ge.jsx(zt,{title:b?Qe("taskForm.loading.saving"):I.title.trim()?I.text.trim()?"":Qe("taskForm.content.error.required"):Qe("taskForm.title.error.required"),children:Ge.jsx("span",{children:Ge.jsx(Ze,{variant:"contained",color:"primary",onClick:async()=>{const{isValid:e,errors:t}=be(we,I);if(e){w(!0);try{if(Oe&&r)await n.tasks.update(r,I);else{const e=await n.tasks.create(I);d&&await n.works.addTask(d,e.id)}Ce(null),localStorage.removeItem(_e),i(o)}catch(s){const e=s instanceof Error?s.message:"Failed to save task. Please try again.";u(e)}finally{w(!1)}}else P(t)},disabled:b||!I.title.trim()||!I.text.trim(),children:Qe(b?"taskForm.loading.saving":Oe?"common.actions.save":"taskForm.buttons.create")})})})]})]})]}),Ge.jsxs(Ke,{sx:{display:{xs:"none",lg:A?"flex":"none"},flex:"1",height:"100%",width:"auto",minWidth:"350px",maxWidth:"600px",overflow:"auto",p:2,pt:0,flexDirection:"column",alignItems:"center"},children:["live-preview"===A&&Ge.jsx(Mt,{title:I.title||"",text:I.text||"",tagIds:I.tag_ids,tags:C,teacherId:(null==m?void 0:m.id)||"",onClose:()=>W(null),onFullscreen:()=>D(!0),onValidateAnswers:it,hasQuizzes:tt(I.text||"")}),"ai-chat"===A&&Ge.jsx(Lt,{editorRef:g,formData:I,setFormData:_,setInitText:$,setGeneratedImage:Re,onClose:()=>W(null)}),"components-help"===A&&Ge.jsx(Ht,{editorRef:g,formData:I,setFormData:_,setInitText:$,setGeneratedImage:Re,onClose:()=>W(null)})]})]}),Ge.jsx(f,{open:E,onClose:()=>D(!1),task:{id:"preview",title:I.title||"",text:I.text||"",tags:C.filter((e=>I.tag_ids.includes(e.id))),teacher_id:(null==m?void 0:m.id)||""},hasQuizzes:tt(I.text),onValidateAnswers:it}),Ge.jsxs(pt,{open:Se,onClose:()=>Ie(!1),children:[Ge.jsx(gt,{children:Qe("taskForm.dialog.unsavedChanges.title")}),Ge.jsx(ft,{children:Ge.jsx(dt,{children:Qe("taskForm.dialog.unsavedChanges.message")})}),Ge.jsxs(jt,{children:[Ge.jsx(Ze,{onClick:()=>Je(!1),color:"error",children:Qe("taskForm.dialog.unsavedChanges.discard")}),Ge.jsx(Ze,{onClick:()=>Je(!0),variant:"contained",children:Qe("taskForm.dialog.unsavedChanges.restore")})]})]}),Ge.jsxs(pt,{open:Fe,onClose:()=>ze(!1),children:[Ge.jsx(gt,{children:Qe("taskForm.dialog.cancel.title")}),Ge.jsx(ft,{children:Ge.jsx(dt,{children:Qe("taskForm.dialog.cancel.message")})}),Ge.jsxs(jt,{children:[Ge.jsx(Ze,{onClick:()=>rt(!1),children:Qe("taskForm.dialog.cancel.keep")}),Ge.jsx(Ze,{onClick:()=>rt(!0),variant:"contained",color:"error",children:Qe("taskForm.dialog.cancel.confirm")})]})]}),Ge.jsxs(pt,{open:!!De,onClose:()=>Ae(null),maxWidth:"sm",fullWidth:!0,children:[Ge.jsx(gt,{children:Qe("taskForm.dialog.image.title")}),Ge.jsxs(ft,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[Ge.jsx(Ke,{component:"img",src:De||"",alt:"Preview",sx:{maxWidth:"100%",maxHeight:"300px",objectFit:"contain"}}),Ge.jsx(h,{message:Qe("taskForm.loading.image")})]})]}),Ge.jsxs(pt,{open:!!We,onClose:()=>Re(null),maxWidth:"sm",fullWidth:!0,children:[Ge.jsx(gt,{children:Qe("taskForm.dialog.generatedImage.title")}),Ge.jsx(ft,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:Ge.jsx(Ke,{component:"img",src:(ot=We,ot?ot.startsWith("data:image")?ot:`data:image/jpeg;base64,${ot}`:""),alt:"Generated",sx:{maxWidth:"100%",maxHeight:"300px",objectFit:"contain"}})}),Ge.jsx(jt,{children:Ge.jsx(Ze,{onClick:()=>Re(null),children:Qe("taskForm.dialog.image.close")})})]})]});var ot}},Symbol.toStringTag,{value:"Module"})),Vt=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const{t:i}=s(),{user:r}=e(),l=He(),[o]=Ue(),c=o.get("return_to")||null,x=o.get("studentId"),u=o.get("work_id"),g="true"===o.get("edit"),y="true"===o.get("copy"),k="true"===o.get("template"),v=o.get("folder"),[b,w]=Ve.useState([]),[C,S]=Ve.useState(null),[I,_]=Ve.useState([]),[T,F]=Ve.useState(null),[z,P]=Ve.useState(""),[E,D]=Ve.useState(!1),[A,W]=Ve.useState(null),[$,B]=Ve.useState(0),[O,L]=Ve.useState([]),[M,N]=Ve.useState(!0),[H,U]=Ve.useState(!1),[V,G]=Ve.useState(null),[q,Q]=Ve.useState({}),[Y,J]=Ve.useState(g||k?1:0),[K,X]=Ve.useState(!1),Z=(null==r?void 0:r.role)===a.TEACHER||(null==r?void 0:r.role)===a.ADMIN,{showErrorToast:ee,showToast:te}=t(),[se,ae]=Ve.useState(null),[ne,ie]=Ve.useState(!1),[re,le]=Ve.useState(0),[oe,ce]=Ve.useState(0),[de,xe]=Ve.useState(null),[me,ue]=Ve.useState([]);Ve.useEffect((()=>{(async()=>{try{const e=await n.folders.getAll(0,100);if(ue(e),v){const t=e.find((e=>e.id===v));if(t)xe(t);else{const e=await n.folders.getById(v);e&&xe(e)}}}catch(e){ee(j(e))}})()}),[v]);const[he,pe]=Ve.useState(!v);Ve.useEffect((()=>{(async()=>{N(!0),G(null);try{const e=await n.contracts.getAll(0,100),t=e.filter((e=>e.status===Ce.AGREED||e.status===Ce.PENDING));L(t);const s=new Map;e.forEach((e=>{e.student&&!s.has(e.student_id)&&s.set(e.student_id,e.student)}));const a=Array.from(s.values()).sort(((e,t)=>{const s=Ie(e).toLowerCase(),a=Ie(t).toLowerCase();return s.localeCompare(a)}));if(Z&&r){const e={id:r.id,first_name:"Template",last_name:null,photo_url:null};a.unshift(e)}if(w(a),G(null),k&&Z&&r){const e=a.find((e=>e.id===r.id&&"Template"===e.first_name));if(e){S(e);const t=new Date,s=t.getDate().toString().padStart(2,"0"),a=(t.getMonth()+1).toString().padStart(2,"0"),n=t.getFullYear();P(`Template - ${`${s}.${a}.${n}`}`)}}else if(x){const e=a.find((e=>e.id===x));if(e){S(e);const t=new Date,s=t.getDate().toString().padStart(2,"0"),a=(t.getMonth()+1).toString().padStart(2,"0"),n=`${s}.${a}.${t.getFullYear()}`;P(`Work for ${Ie(e)||e.id} - ${n}`)}}u&&(g||y)&&await ge(u)}catch(e){const t=j(e);G(t),ee(t)}finally{N(!1)}})()}),[x,u,g,y,re,k]);const ge=async e=>{try{const t=await n.works.getById(e);F(t),P(y?`Copy of ${t.name}`:t.name);const s=(await Promise.all(t.task_states.sort(((e,t)=>(e.order||0)-(t.order||0))).map((async e=>{if(!e.task)try{return await n.tasks.getById(e.task_id)}catch(t){return null}return e.task})))).filter((e=>null!==e));_(s)}catch(t){const e=t instanceof Error?t.message:"Failed to load work data. Please try again.";G(e),ee(e)}};Ve.useEffect((()=>{if(T&&b.length>0&&g){const e=b.find((e=>e.id===T.student_id));e?S(e):ee("Student for this work could not be found. Please select a student manually.")}}),[T,b,g]),Ve.useEffect((()=>{if(C&&"Template"!==C.first_name){const e=O.find((e=>e.student_id===C.id&&e.teacher_id===(null==r?void 0:r.id)&&e.status===Ce.AGREED)),t=O.find((e=>e.student_id===C.id&&e.teacher_id===(null==r?void 0:r.id)&&e.status===Ce.PENDING)),s=e||t;W(s||null),s?(B(s.balance),s.balance>0?D(!0):D(!1)):(B(0),D(!1))}else W(null),B(0),D(!1)}),[C,O,null==r?void 0:r.id]);const fe=e=>{_((t=>t.some((t=>t.id===e.id))?t.filter((t=>t.id!==e.id)):[...t,e]))},je=async(e=!0)=>{if(!C)return void G("Please select a student");const t={name:z,student_id:C.id,task_ids:I.map((e=>e.id)),contract_id:E&&A?A.id:void 0,folder_id:null==de?void 0:de.id},{isValid:s,errors:a}=be(Re,t);if(!s)return void Q(a);U(!0),G(null);let i=null;try{if(g&&T){i=(await n.works.update(T.id,t)).id}else{i=(await n.works.create(t)).id}if(!e)return i;c?l(c):"Template"===(null==C?void 0:C.first_name)?l("/templates"):l("/works")}catch(r){const e=r instanceof Error?r.message:`Failed to ${g?"update":"create"} work. Please try again.`;G(e),ee(e),U(!1)}},ye=e=>{ae(e),ie(!0)},ke=()=>{ie(!1)},ve=Ve.useCallback((()=>{le((e=>e+1))}),[]),we=()=>{X(!1)},[$e,Be]=Ve.useState(!1),Oe=()=>{Be(!1)};return M?Ge.jsx(h,{message:i("common.loading")}):Ge.jsxs(Ke,{sx:{mx:"auto",pb:1,height:"100%",display:"flex",flexDirection:"column",overflow:"hidden",width:"100%",".sortable-list":{position:"relative","& .item":{transition:"background-color 0.2s, box-shadow 0.2s, transform 0.1s","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.04)"},userSelect:"none",cursor:"default"},"& .dragged-item":{backgroundColor:"primary.main!important",color:"white!important",boxShadow:"0 10px 20px rgba(0, 0, 0, 0.3)!important",opacity:.95,zIndex:1e3,transform:"scale(1.03)",borderRadius:"4px",pointerEvents:"none",cursor:"grabbing","& .MuiTypography-root":{color:"white!important"},"& svg":{color:"white!important"}}}},children:[Ge.jsx("style",{children:`\n          .dragged-item {\n            background-color: ${Se.palette.primary.main} !important;\n          }\n        `}),V&&Ge.jsx(Xe,{severity:"error",sx:{mb:2},action:Ge.jsx(Ze,{color:"inherit",size:"small",onClick:ve,disabled:H,children:i(H?"common.status.loading":"common.actions.retry")}),children:V}),Ge.jsx(Ke,{sx:{p:0,mx:"auto",width:"100%",maxWidth:"800px",flexShrink:0},children:Ge.jsxs(Pt,{value:Y,onChange:(e,t)=>{C&&J(t)},centered:!0,variant:"fullWidth",sx:{mx:2},children:[Ge.jsx(Et,{label:i(g?"works.tabs.step1.edit":y?"works.tabs.step1.copy":"works.tabs.step1.create"),disabled:g}),Ge.jsx(Et,{label:i("works.tabs.step2")})]})}),0===Y&&Ge.jsx(Ke,{sx:{width:"100%",maxWidth:"800px",mx:"auto",flex:1,display:"flex",flexDirection:"column",overflow:"hidden",height:"100%"},children:Ge.jsxs(et,{sx:{p:2,mb:1,display:"flex",flexDirection:"column",overflow:"hidden",height:"100%"},children:[0===b.length&&Ge.jsxs(Ke,{sx:{textAlign:"center",py:3},children:[Ge.jsx(dt,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:i("contracts.empty.noContracts")}),Ge.jsx(dt,{variant:"body2",color:"text.secondary",sx:{mb:2},children:i("contracts.empty.hint")}),Ge.jsx(Ze,{variant:"outlined",color:"primary",startIcon:Ge.jsx(d,{}),onClick:()=>l("/contracts/new"),children:i("contracts.actions.create")})]}),Ge.jsx(Ke,{sx:{mt:1,mb:2},children:Ge.jsx(st,{value:C,onChange:(e,t)=>(e=>{if(S(e),e){const t=new Date,s=`${t.getDate().toString().padStart(2,"0")}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getFullYear()}`;"Template"===e.first_name?P(`Template Work - ${s}`):P(`Work for ${Ie(e)||e.id} - ${s}`)}else P("")})(t),options:b,getOptionLabel:e=>Ie(e),renderInput:e=>Ge.jsx(nt,{...e,label:i("works.creator.forStudent"),placeholder:i("works.creator.selectStudent"),required:!0,error:!!q.student_id,helperText:q.student_id,InputProps:{...e.InputProps,startAdornment:Ge.jsxs(Ge.Fragment,{children:[C&&("Template"===C.first_name?Ge.jsx(_e,{sx:{mr:1,color:"primary.main"}}):Ge.jsx(Dt,{src:C.photo_url||void 0,sx:{width:24,height:24,mr:1},children:Te(C)})),e.InputProps.startAdornment]})}}),renderOption:(e,t)=>Ge.jsx(Ke,{component:"li",...e,children:Ge.jsxs(Ke,{sx:{display:"flex",alignItems:"center"},children:["Template"===t.first_name?Ge.jsx(_e,{sx:{mr:1,color:"primary.main"}}):Ge.jsx(Dt,{src:t.photo_url||void 0,sx:{width:24,height:24,mr:1},children:Te(t)}),Ge.jsx(dt,{sx:{fontWeight:"Template"===t.first_name?500:400,color:"Template"===t.first_name?"primary.main":"inherit"},children:"Template"===t.first_name?"Template":Ie(t)||t.id})]})})})}),Ge.jsx(Ke,{sx:{mt:1,mb:2},children:"Template"===(null==C?void 0:C.first_name)?Ge.jsx(dt,{variant:"body1",color:"primary",sx:{mt:1},children:i("works.creator.templateHint")}):C&&Ge.jsx(dt,{variant:"body1",color:"warning",sx:{mt:1},children:i("works.creator.studentHint")})}),"Template"===(null==C?void 0:C.first_name)&&me.length>0&&Ge.jsx(Ge.Fragment,{children:g?Ge.jsx(Ge.Fragment,{children:null==T?void 0:T.folders.map((e=>Ge.jsx(nt,{fullWidth:!0,disabled:!0,label:i("templates.actions.currentFolder"),placeholder:i("templates.actions.currentFolder"),value:e.title,InputProps:{readOnly:!0,startAdornment:Ge.jsx(it,{position:"start",children:Ge.jsx(Fe,{color:"primary"})})}})))}):Ge.jsx(Ge.Fragment,{children:de&&!he?Ge.jsx(nt,{fullWidth:!0,label:i("templates.actions.folder"),placeholder:i("templates.actions.selectFolder"),value:de.title,InputProps:{readOnly:!0,startAdornment:Ge.jsx(it,{position:"start",children:Ge.jsx(Fe,{color:"primary"})}),endAdornment:Ge.jsx(it,{position:"end",children:Ge.jsx(Ze,{variant:"contained",color:"primary",onClick:()=>{xe(null),pe(!0)},size:"small",children:i("common.actions.change")})})}}):he&&Ge.jsxs(Ge.Fragment,{children:[Ge.jsxs(dt,{variant:"body2",sx:{mb:2},children:[i("templates.actions.selectFolder")," (",i("common.optional"),"):"]}),Ge.jsx(Ke,{sx:{backgroundColor:"background.paper",flex:1,overflow:"auto",display:"flex",flexDirection:"column",borderRadius:3},children:Ge.jsx(Ke,{sx:{flex:1,overflow:"auto"},children:Ge.jsx(ze,{onFolderSelect:e=>{xe(e),pe(!1)}})})})]})})})]})}),1===Y&&Ge.jsxs(Ke,{sx:{width:"100%",maxWidth:"800px",mx:"auto",flex:1,display:"flex",flexDirection:"column",overflow:"hidden",height:"100%"},children:[Ge.jsxs(et,{sx:{p:2,mb:2,flexShrink:0},children:[Ge.jsxs(Ke,{sx:{display:"flex",alignItems:"center",gap:1},children:[!g&&Ge.jsx(zt,{title:i("common.actions.edit"),children:Ge.jsx(rt,{onClick:()=>J(0),size:"small",children:Ge.jsx(R,{fontSize:"small"})})}),"Template"===(null==C?void 0:C.first_name)?Ge.jsx(dt,{variant:"body1",color:"primary",children:i("works.creator.templateHint")}):Ge.jsxs(Ge.Fragment,{children:[Ge.jsx(Dt,{src:(null==C?void 0:C.photo_url)||void 0,sx:{width:32,height:32,mr:1},children:Te(C)}),Ge.jsx(dt,{children:"Template"===(null==C?void 0:C.first_name)?"Template":Ie(C)||(null==C?void 0:C.id)})]})]}),Ge.jsx(nt,{fullWidth:!0,label:"Template"===(null==C?void 0:C.first_name)?i("templates.actions.templateName"):i("templates.actions.workName"),value:z,onChange:e=>P(e.target.value),margin:"normal",required:!0,error:!!q.name,helperText:q.name}),"Template"!==(null==C?void 0:C.first_name)&&!g&&Ge.jsx(et,{elevation:0,variant:"outlined",sx:{p:2,mt:2,borderColor:E?"primary.main":"divider"},children:Ge.jsxs(Ke,{sx:{display:"flex",alignItems:"flex-start",gap:2},children:[Ge.jsx(ct,{checked:E,onChange:e=>D(e.target.checked),color:"primary",disabled:!!A&&$<=0||!A}),Ge.jsxs(Ke,{sx:{flex:1},children:[Ge.jsx(dt,{variant:"h6",color:"primary",gutterBottom:!0,children:i("works.creator.redeemLesson")}),A&&Ge.jsx(dt,{variant:"body2",children:i("works.creator.availableLessons",{count:$})}),A&&$<=0&&Ge.jsx(dt,{variant:"body2",color:"error",children:i("works.creator.noLessonsAvailable")}),!A&&Ge.jsx(dt,{variant:"body2",color:"error",children:i("works.creator.noActiveContract")})]})]})})]}),Ge.jsxs(et,{variant:"outlined",sx:{height:"100%",overflow:"auto",mb:1,display:"flex",flexDirection:"column"},children:[0===I.length&&Ge.jsx(Ke,{sx:{p:2,textAlign:"center"},children:Ge.jsx(dt,{variant:"body2",color:"text.secondary",children:i("works.empty.noTasks")})}),Ge.jsxs(Pe,{onSortEnd:(e,t)=>{e<0||t<0||e>=I.length||t>=I.length||e===t||(_((s=>{const a=[...s],[n]=a.splice(e,1);return a.splice(t,0,n),a})),ce((e=>e+1)))},lockAxis:"y",className:"sortable-list",draggedItemClassName:"dragged-item",allowDrag:!0,as:"div",style:{overflowY:"auto",overflowX:"hidden",padding:0,minHeight:"100px",position:"relative"},children:[I.map(((e,t)=>Ge.jsx(Ee,{children:Ge.jsxs(Ke,{sx:{display:"flex",alignItems:"center",p:1,borderBottom:1,borderColor:"divider","&:last-child":{borderBottom:0},cursor:"pointer","&:hover":{backgroundColor:"action.hover"}},children:[Ge.jsxs(Ke,{sx:{display:"flex",alignItems:"center",flex:1},children:[Ge.jsx(De,{children:Ge.jsx(Ae,{sx:{mr:1,color:"primary.main",cursor:"grab"}})}),Ge.jsx(Ke,{sx:{flex:1},onClick:()=>ye(e),children:Ge.jsx(dt,{variant:"body1",sx:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden",textOverflow:"ellipsis"},children:`${t+1}. ${e.title}`})})]}),Ge.jsx(Ke,{sx:{display:"flex",alignItems:"center"},children:Ge.jsx(zt,{title:i("common.actions.remove"),children:Ge.jsx(rt,{edge:"end",onClick:t=>{t.stopPropagation(),fe(e)},size:"small",children:Ge.jsx(m,{})})})})]})},`task-${e.id}-pos-${t}`))),Ge.jsxs(Ke,{sx:{p:2,display:"flex",justifyContent:"center",gap:2},children:[C&&"Template"===(null==C?void 0:C.first_name)&&Ge.jsx(zt,{title:i("works.creator.autoSaveHint"),children:Ge.jsx(Ze,{variant:"outlined",color:"primary",onClick:()=>{je(!1).then((e=>{e&&l(`/tasks/new?work_id=${e}&return_to=/works/assign/%3Fwork_id=${e}%26edit=true%26return_to=${c}`)}))},disabled:H||!C||!z.trim(),sx:{wordWrap:"nowrap"},children:i("tasks.actions.createTask")})}),Ge.jsx(Ze,{variant:"contained",color:"primary",onClick:()=>{Be(!0)},children:i("works.creator.addExistingTask")})]}),!C||!z.trim()&&Ge.jsx(dt,{variant:"body2",color:"error.main",sx:{p:2,textAlign:"center"},children:C?z.trim()?"":i("works.creator.enterWorkName"):i("works.creator.selectStudent")})]},`sortable-list-${oe}`)]}),q.task_ids&&Ge.jsx(_t,{error:!0,children:q.task_ids})]}),Ge.jsxs(Ke,{sx:{mt:1,display:"flex",justifyContent:"space-between",mx:"auto",width:"100%",maxWidth:"800px",flexShrink:0},children:[Ge.jsx(Ze,{variant:"outlined",color:"inherit",onClick:()=>{Y>=1?X(!0):c?l(c):"Template"===(null==C?void 0:C.first_name)?l("/templates"):l("/works")},sx:{mr:2},children:i("common.actions.cancel")}),Ge.jsxs(Ke,{sx:{display:"flex",gap:2},children:[Y>0&&!g&&Ge.jsx(Ze,{variant:"outlined",onClick:()=>J(0),children:i("common.actions.back")}),Y<1?Ge.jsx(Ze,{variant:"contained",color:"primary",onClick:()=>J(1),disabled:!C,children:i("common.actions.next")}):Ge.jsx(Ze,{variant:"contained",color:"primary",onClick:()=>je(!0),disabled:H||!C||!z.trim(),sx:{wordWrap:"nowrap"},children:H?i("common.status.saving"):g?i("common.actions.save"):"Template"===(null==C?void 0:C.first_name)?i("templates.actions.createTemplate"):i("templates.actions.sendToStudent")})]})]}),Ge.jsx(f,{open:ne,onClose:ke,task:se,hasQuizzes:!1,onValidateAnswers:()=>{},actionButtons:Ge.jsxs(Ke,{sx:{display:"flex",gap:1,width:"100%",justifyContent:"space-between"},children:[Ge.jsx(Ke,{sx:{display:"flex",gap:1},children:se&&Ge.jsxs(Ge.Fragment,{children:[Ge.jsx(zt,{title:i("works.creator.autoSaveHint"),children:Ge.jsx(Ze,{size:"small",variant:"outlined",startIcon:Ge.jsx(p,{}),onClick:()=>{je(!1).then((e=>{e&&(l(`/tasks/${se.id}/edit?return_to=/works/assign/%3Fwork_id=${e}%26edit=true`),ke())}))},children:i("common.actions.edit")})}),Ge.jsx(Ze,{size:"small",onClick:e=>{e.stopPropagation(),fe(se),ke()},startIcon:I.some((e=>e.id===se.id))?Ge.jsx(m,{}):Ge.jsx(d,{}),children:I.some((e=>e.id===se.id))?i("common.actions.remove"):i("common.actions.add")})]})}),Ge.jsx(Ze,{onClick:ke,children:i("common.actions.close")})]})}),Ge.jsxs(pt,{open:K,onClose:we,maxWidth:"xs",fullWidth:!0,children:[Ge.jsx(gt,{children:i("common.dialog.cancel.title")}),Ge.jsx(ft,{children:Ge.jsx(dt,{children:i("common.dialog.cancel.message")})}),Ge.jsxs(jt,{children:[Ge.jsx(Ze,{onClick:we,children:i("common.actions.no")}),Ge.jsx(Ze,{onClick:()=>{X(!1),c?l(c):"Template"===(null==C?void 0:C.first_name)?l("/templates"):l("/works")},color:"error",children:i("common.actions.yes")})]})]}),Ge.jsxs(At,{anchor:"right",open:$e,onClose:Oe,sx:{"& .MuiDrawer-paper":{width:"100%",maxWidth:"800px",height:"100%",display:"flex",flexDirection:"column",borderRadius:0}},children:[Ge.jsxs(Ke,{sx:{px:2,py:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[Ge.jsx(dt,{variant:"h6",children:i("works.creator.addTasks")}),Ge.jsx(Ze,{onClick:Oe,size:"small",variant:"contained",color:"primary",children:i("common.actions.done")})]}),Ge.jsx(Ke,{sx:{flex:1,overflow:"auto",px:2},children:Ge.jsx(We,{selectedTasks:I,onTaskToggle:fe,onPreviewTask:ye})})]})]})}},Symbol.toStringTag,{value:"Module"})),Gt=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const{t:i}=s(),{user:r}=e(),{showErrorToast:l}=t(),d=Ve.useRef(null),[x,u]=Ve.useState([]),[g,f]=Ve.useState(!0),[y,k]=Ve.useState(null),[v,b]=Ve.useState(0),[w,C]=Ve.useState(""),[S,I]=Ve.useState(!1),[_,T]=Ve.useState({}),[F,z]=Ve.useState(null),[P,E]=Ve.useState(null),[D,A]=Ve.useState(!1),[W,R]=Ve.useState(""),[$,B]=Ve.useState(!1),O=He(),L=(null==r?void 0:r.role)===a.ADMIN,M=(null==r?void 0:r.role)===a.TEACHER||L;Ve.useEffect((()=>{(async()=>{f(!0),k(null);try{const e=await n.tags.getAll();u(e),k(null)}catch(e){const t=j(e);k(t),l(t)}finally{f(!1)}})()}),[v]),Ve.useCallback((()=>{b((e=>e+1))}),[]);const N=async()=>{var e;const{isValid:t,errors:s}=be(Oe,{name:w});if(t){I(!0);try{const t=await n.tags.create({name:w.trim()});u((e=>[t,...e])),C(""),T({}),null==(e=d.current)||e.focus()}catch(a){const e=a instanceof Error?a.message:"Failed to create tag. Please try again.";l(e)}finally{I(!1)}}else T(s)},H=()=>{z(null)},U=()=>{A(!1),R("")},V=()=>{B(!1)};return Ge.jsxs(Ke,{children:[Ge.jsx(c,{title:i("navigation.tags")}),g?Ge.jsx(h,{message:i(g?"common.loading":"tags.loading.tags")}):Ge.jsxs(Ge.Fragment,{children:[Ge.jsx(et,{sx:{p:3,mb:3,mx:"auto",maxWidth:"1200px"},children:Ge.jsxs(Ke,{sx:{display:"flex",gap:1,alignItems:"center"},children:[Ge.jsx(nt,{inputRef:d,fullWidth:!0,autoComplete:"off",autoCapitalize:"off",size:"small",placeholder:i("tags.input.placeholder"),value:w,onChange:e=>{C(e.target.value),_.name&&T((e=>({...e,name:""})))},onKeyPress:e=>{"Enter"===e.key&&w.trim()&&N()},error:!!_.name,helperText:_.name,InputProps:{endAdornment:w?Ge.jsx(it,{position:"end",children:Ge.jsx(rt,{size:"small",onClick:()=>{C(""),T({})},edge:"end",children:Ge.jsx(m,{})})}):null}}),w.trim()&&Ge.jsx(Ze,{size:"small",startIcon:Ge.jsx($e,{}),onClick:N,disabled:S,children:i(S?"common.status.saving":"common.actions.create")})]})}),y||0!==x.length?Ge.jsx(et,{sx:{p:3,mx:"auto",maxWidth:"1200px"},children:Ge.jsx(Ke,{sx:{display:"flex",flexWrap:"wrap",gap:1,mt:1},children:x.map((e=>Ge.jsx(Ke,{children:Ge.jsx(at,{onClick:t=>((e,t)=>{e.stopPropagation(),E(t),z(e.currentTarget)})(t,e),label:e.name,sx:{m:.5,height:"auto",borderRadius:"16px","& .MuiChip-label":{px:1.5,py:.5}},variant:"outlined"})},e.id)))})}):Ge.jsx(Ke,{sx:{textAlign:"center",py:4},children:Ge.jsx(dt,{variant:"h6",color:"text.secondary",sx:{mb:1},children:i(M?"tags.empty.teacher":"tags.empty.default")})})]}),Ge.jsxs(ht,{anchorEl:F,open:Boolean(F),onClose:H,onClick:e=>e.stopPropagation(),children:[Ge.jsxs(qe,{onClick:()=>{H(),O(`/tasks?tag_id=${null==P?void 0:P.id}`)},children:[Ge.jsx(Qe,{children:Ge.jsx(Be,{fontSize:"small"})}),Ge.jsx(Ye,{children:i("tags.actions.showTasks")})]}),Ge.jsxs(qe,{onClick:()=>{P&&(R(P.name),A(!0)),H()},children:[Ge.jsx(Qe,{children:Ge.jsx(p,{fontSize:"small"})}),Ge.jsx(Ye,{children:i("common.actions.rename")})]}),Ge.jsxs(qe,{onClick:()=>{H(),B(!0)},sx:{color:"error.main"},children:[Ge.jsx(Qe,{sx:{color:"error.main"},children:Ge.jsx(o,{fontSize:"small"})}),Ge.jsx(Ye,{children:i("common.actions.delete")})]})]}),Ge.jsxs(pt,{open:D,onClose:U,maxWidth:"xs",fullWidth:!0,children:[Ge.jsx(gt,{children:i("tags.dialog.rename.title")}),Ge.jsx(ft,{children:Ge.jsx(nt,{autoFocus:!0,margin:"dense",label:i("tags.input.label"),type:"text",fullWidth:!0,value:W,onChange:e=>R(e.target.value),variant:"outlined"})}),Ge.jsxs(jt,{children:[Ge.jsx(Ze,{onClick:U,children:i("common.actions.cancel")}),Ge.jsx(Ze,{onClick:async()=>{if(!P||!W.trim())return;const{isValid:e,errors:t}=be(Oe,{name:W});if(e)try{const e=await n.tags.update(P.id,{name:W.trim()});u((t=>t.map((t=>t.id===P.id?e:t)))),A(!1),R(""),E(null)}catch(s){const e=s instanceof Error?s.message:"Failed to rename tag. Please try again.";l(e)}else l(t.name)},variant:"contained",disabled:!W.trim()||W===(null==P?void 0:P.name),children:i("common.actions.rename")})]})]}),Ge.jsxs(pt,{open:$,onClose:V,maxWidth:"xs",fullWidth:!0,children:[Ge.jsx(gt,{children:i("tags.dialog.delete.title")}),Ge.jsx(ft,{children:Ge.jsx(dt,{children:i("tags.dialog.delete.message",{name:null==P?void 0:P.name})})}),Ge.jsxs(jt,{children:[Ge.jsx(Ze,{onClick:V,children:i("common.actions.cancel")}),Ge.jsx(Ze,{onClick:async()=>{P&&(await(async e=>{try{await n.tags.delete(e),u((t=>t.filter((t=>t.id!==e))))}catch(t){const e=t instanceof Error?t.message:"Failed to delete tag. Please try again.";l(e)}})(P.id),B(!1))},color:"error",variant:"contained",children:i("common.actions.delete")})]})]})]})}},Symbol.toStringTag,{value:"Module"})),qt=()=>{var i;const{t:r}=s(),l=He(),{contractId:o}=bt(),[c]=Ue(),d=c.get("return_to")||"/contracts",{user:x}=e(),{showErrorToast:m,showToast:u}=t(),p="true"===c.get("testStudent"),g="teachair_test_student",[f,j]=Ve.useState(!0),[y,k]=Ve.useState(!1),[v,b]=Ve.useState(null),[w,C]=Ve.useState([]),[S,I]=Ve.useState({username:"",price:"",currency:null,balance:null,description:""}),[_,T]=Ve.useState({}),[F,z]=Ve.useState(null),[P,E]=Ve.useState(!1),[D,A]=Ve.useState(!1),W=(null==x?void 0:x.role)===a.ADMIN,R=(null==x?void 0:x.role)===a.TEACHER||W,$=Boolean(o);Ve.useEffect((()=>{(async()=>{j(!0);try{const e=await n.contracts.getCurrencies();C(e);const t=e.find((e=>"RUR"===e.code))||e[0];if(o){const t=await n.contracts.getById(o);b(t);let s=null;t.currency?s=t.currency:e.length>0&&(s=e[0].code),I({username:t.student_id,price:t.price,currency:s,balance:t.balance,description:t.description||""})}else p?I((e=>({...e,username:g||"",price:1e3,currency:"RUR",balance:10,description:r("contracts.form.testStudentDescription")}))):t&&!S.currency&&I((e=>({...e,currency:t.code})))}catch(e){const t=e instanceof Error?e.message:"Failed to load data. Please try again.";m(t),l("/contracts")}finally{j(!1)}})()}),[o,l,m,p,g,r]);return R?Ge.jsxs(Ke,{sx:{display:"flex",flexDirection:"column",overflowX:"hidden",overflowY:"auto"},children:[f?Ge.jsx(h,{message:r($?"contracts.status.loadingContract":"common.loading")}):Ge.jsx(Ge.Fragment,{children:Ge.jsxs(Ke,{sx:{flex:1,display:"flex",flexDirection:"column",mx:"auto",width:"100%",maxWidth:"800px",pb:1},children:[Ge.jsxs(et,{sx:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",p:2,py:1},children:[Ge.jsx(Ke,{sx:{mt:2,mb:3},children:Ge.jsx(dt,{variant:"h4",children:r($?"contracts.actions.edit":"contracts.actions.create")})}),Ge.jsxs(Ke,{component:"form",noValidate:!0,children:[$?Ge.jsxs(Ke,{sx:{display:"flex",alignItems:"center",gap:2,mb:3},children:[Ge.jsx(Dt,{src:(null==(i=null==v?void 0:v.student)?void 0:i.photo_url)||void 0,sx:{width:48,height:48},children:Te(null==v?void 0:v.student)}),Ge.jsxs(Ke,{children:[Ge.jsx(dt,{variant:"h6",children:Ie(null==v?void 0:v.student)}),Ge.jsx(dt,{variant:"body2",color:"text.secondary",children:r("common.student.one")})]})]}):Ge.jsx(nt,{autoFocus:!0,margin:"normal",name:"username",label:r("contracts.form.studentUsername"),type:"text",fullWidth:!0,variant:"outlined",value:S.username,onChange:e=>{const t=e.target.value;let s;s=t.includes("@")&&t.indexOf("@")>0?t.split("@")[0]:t.replace(/^@/,""),I((e=>({...e,username:s}))),_.username&&T((e=>{const t={...e};return delete t.username,t}))},error:!!_.username,helperText:_.username||r("contracts.form.telegramUsername"),placeholder:r("contracts.form.usernamePlaceholder"),InputProps:{startAdornment:Ge.jsx(dt,{sx:{mr:.5},children:"@"})}}),Ge.jsxs(Ke,{sx:{display:"flex",gap:2,alignItems:"flex-start"},children:[Ge.jsx(nt,{margin:"normal",name:"price",label:r("contracts.form.pricePerLesson"),type:"number",sx:{flex:1},variant:"outlined",value:0===S.price?"":S.price,onChange:e=>{const t=e.target.value,s=""===t?0:Number(t.replace(/^0+/,""));I((e=>({...e,price:s}))),_.price&&T((e=>{const t={...e};return delete t.price,t}))},error:!!_.price,helperText:_.price}),Ge.jsxs(Wt,{margin:"normal",sx:{minWidth:120},error:!!_.currency,children:[Ge.jsx(Rt,{id:"currency-label",children:r("contracts.form.currency")}),Ge.jsx($t,{labelId:"currency-label",name:"currency",value:S.currency||"",label:r("contracts.form.currency"),onChange:e=>{const{name:t,value:s}=e.target;I((e=>({...e,[t]:s}))),_[t]&&T((e=>{const s={...e};return delete s[t],s}))},children:w.map((e=>Ge.jsxs(qe,{value:e.code,children:[e.emoji,"  ",e.code]},e.code)))})]})]}),$?Ge.jsxs(dt,{variant:"body1",color:"text.secondary",sx:{mt:1},children:[r("contracts.form.currentBalance"),": ",S.balance]}):Ge.jsx(nt,{margin:"normal",name:"balance",label:r("contracts.form.balanceLabel"),type:"number",fullWidth:!0,variant:"outlined",value:null===S.balance?"":S.balance,onChange:e=>{const t=e.target.value,s=""===t?null:Number(t.replace(/^0+/,""));I((e=>({...e,balance:s}))),_.balance&&T((e=>{const t={...e};return delete t.balance,t}))},error:!!_.balance,helperText:_.balance||r("contracts.form.balanceHint")}),Ge.jsx(nt,{margin:"normal",name:"description",label:r("contracts.form.description"),type:"text",fullWidth:!0,variant:"outlined",value:S.description,onChange:e=>{const{name:t,value:s}=e.target;I((e=>({...e,[t]:"price"===t||"balance"===t?Number(s):s}))),_[t]&&T((e=>{const s={...e};return delete s[t],s}))},multiline:!0,rows:3,error:!!_.description,helperText:_.description||r("contracts.form.descriptionHint")})]})]}),Ge.jsxs(Ke,{sx:{mt:2,display:"flex",justifyContent:"space-between",flexShrink:0},children:[Ge.jsx(Ke,{sx:{display:"flex",alignItems:"center"},children:Ge.jsx(Ze,{variant:"outlined",color:"inherit",sx:{mr:2},onClick:()=>l(d),children:r("common.actions.cancel")})}),Ge.jsx(Ke,{children:Ge.jsx(Ze,{variant:"contained",color:"primary",onClick:async()=>{const{isValid:e,errors:t}=be($?Me:Ne,S);if(e){k(!0);try{if($&&o)await n.contracts.update(o,{price:S.price,currency:S.currency,balance:S.balance??0,description:S.description}),l(d);else{const e=await n.contracts.create({...S,balance:S.balance??0});"new_user_created"===e.create_code?(z(e.id),E(!0),u(r("contracts.status.contractCreated"),"success")):"already_exists"===e.create_code?(z(e.id),A(!0)):(z(null),E(!1),A(!1),l(d))}}catch(s){const e=s instanceof Error?s.message:r("contracts.status.errorCreating");if(e.includes("student_is_self"))return void m(r("contracts.status.studentIsSelf"));if(e.includes("student_is_teacher"))return void m(r("contracts.status.studentIsTeacher"));m(e)}finally{k(!1)}}else T(t)},disabled:y||!$&&!S.username.trim(),children:r(y?"common.status.saving":$?"contracts.actions.update":"contracts.actions.create")})})]})]})}),Ge.jsx(Le,{open:P,onClose:()=>E(!1),onCancel:()=>l(d),botUrl:"https://t.me/teachair_bot",cancelButtonText:r("common.actions.done")}),Ge.jsxs(pt,{open:D,onClose:()=>A(!1),maxWidth:"xs",fullWidth:!0,children:[Ge.jsx(gt,{children:r("contracts.dialog.existingContract.title")}),Ge.jsx(ft,{children:Ge.jsx(dt,{children:r("contracts.dialog.existingContract.message")})}),Ge.jsxs(jt,{children:[Ge.jsx(Ze,{onClick:()=>A(!1),children:r("common.actions.cancel")}),Ge.jsx(Ze,{onClick:()=>{A(!1),F&&l(`/contracts/${F}/edit`)},color:"primary",variant:"contained",children:r("contracts.actions.editExisting")})]})]})]}):(l("/contracts"),null)},Qt=Object.freeze(Object.defineProperty({__proto__:null,ContractFormPage:qt,default:qt},Symbol.toStringTag,{value:"Module"}));export{Nt as A,Qt as C,Mt as P,Ot as T,Ut as a,Vt as b,Gt as c};
