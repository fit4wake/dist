import{a7 as e,ad as t,r,K as s,O as l,j as a,B as o,y as n,H as i,J as d,d as c,h as u,i as m,o as x,v as p,ae as h,aG as f,aH as g,b as j,A as v,N as b,D as y,l as w,w as k,m as S,n as C,M as F,x as T,z as D,a2 as _,a8 as z,a3 as I,Q as W}from"./vendor-VHbKv6Ho.js";import{u as E,a as O,b as L,be as P,U as B,c as A,g as R,P as M,bf as $,A as N,aw as U,d as H,e as K,bg as q,F as J,k as G,E as Z,L as Q,bh as V,M as X,bi as Y,bj as ee,bk as te,D as re,I as se,bl as le,h as ae,bm as oe,at as ne,bn as ie}from"./main-CV7Ja_th.js";const de=e=>{const t=e?`/#/templates?folder=${e}`:"/#/templates";window.history.replaceState({},"",t)};function ce(e){let t,r=0;for(t=0;t<e.length;t+=1)r=e.charCodeAt(t)+((r<<5)-r);let s="#";for(t=0;t<3;t+=1){const e=r>>8*t&255;s+=`00${Math.min(255,Math.floor((e+128)/2)).toString(16)}`.slice(-2)}return s}function ue(e){if(!e)return"?";const t=e.split(" ").filter((e=>""!==e));return 1===t.length?t[0][0].toUpperCase():`${t[0][0]}${t[1][0]}`.toUpperCase()}const me="templatesPageFilters",xe="templatesPageOrder",pe=({work:t,onClick:s,onDelete:l,isNewWork:n=!1})=>{const i=e(),[d,u]=r.useState(null),[p,h]=r.useState(!1),[f,g]=r.useState(!1),{showErrorToast:v,showToast:k}=O(),{t:T}=L(),[D]=z(),E="true"===D.get("onboarding"),P=()=>{u(null)},B=e=>{e.stopPropagation(),e.preventDefault();const r=E?"/":"/templates";i(`/works/assign/?work_id=${t.id}&copy=true&send=true&return_to=${r}`)};return a.jsxs(a.Fragment,{children:[a.jsx(_,{className:"template-card",draggable:!0,onDragStart:e=>{e.dataTransfer.setData("text/plain",t.id),e.currentTarget.style.opacity="0.5"},onDragEnd:e=>{e.currentTarget.style.opacity="1"},onDragOver:e=>{e.preventDefault(),e.stopPropagation(),e.currentTarget.style.cursor="default"},onContextMenu:e=>{e.preventDefault(),e.stopPropagation(),u(e.currentTarget)},sx:{height:"100%",cursor:"pointer","&:hover":{boxShadow:6},position:"relative",borderLeft:"4px solid",borderLeftColor:n?"success.main":t.share_key?"primary.main":"secondary.main",borderRadius:3,borderTopLeftRadius:2,borderBottomLeftRadius:3,...n&&{animation:"pulsate 3s ease-in-out","@keyframes pulsate":{"0%":{transform:"scale(1)"},"50%":{transform:"scale(1.05)"},"100%":{transform:"scale(1)"}}}},onClick:()=>s(t,"view"),children:a.jsx(I,{sx:{p:2,"&:last-child":{paddingBottom:2}},children:a.jsxs(o,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",gap:1},children:[a.jsx(j,{sx:{flex:1,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.2},children:t.name}),a.jsx(W,{title:T("templates.actions.sendToStudent"),children:a.jsx(m,{size:"small",onClick:B,sx:{flexShrink:0},color:t.share_key?"primary":"default",children:a.jsx(Y,{fontSize:"small"})})}),a.jsx(m,{size:"small",onClick:e=>{e.stopPropagation(),u(e.currentTarget)},sx:{flexShrink:0},children:a.jsx(X,{fontSize:"small"})})]})})},t.id),a.jsxs(F,{anchorEl:d,open:Boolean(d),onClose:P,onClick:e=>e.stopPropagation(),children:[a.jsxs(c,{onClick:e=>{P(),e&&B(e)},children:[a.jsx(Y,{fontSize:"small",sx:{mr:1}}),T("templates.actions.sendToStudent")]}),a.jsxs(c,{onClick:()=>{P(),i(`/works/assign/?work_id=${t.id}&edit=true&return_to=/templates`)},children:[a.jsx(Z,{fontSize:"small",sx:{mr:1}}),T("common.actions.edit")]}),a.jsxs(c,{onClick:e=>{P(),e&&(e=>{e.stopPropagation(),e.preventDefault();const r=E?"/":"/templates";i(`/works/assign/?work_id=${t.id}&copy=true&template=true&return_to=${r}`)})(e)},children:[a.jsx(ee,{fontSize:"small",sx:{mr:1}}),T("common.actions.copy")]}),a.jsxs(c,{onClick:()=>{P(),P(),s(t,"move")},children:[a.jsx(te,{fontSize:"small",sx:{mr:1}}),T("common.actions.moveTo")]}),a.jsxs(c,{onClick:()=>{P(),h(!0)},disabled:f,sx:{color:"error.main",borderTop:1,borderColor:"divider"},children:[f?a.jsx(b,{size:20,sx:{mr:1}}):a.jsx(re,{fontSize:"small",sx:{mr:1}}),T("common.actions.delete")]})]}),a.jsxs(y,{open:p,onClose:()=>!f&&h(!1),maxWidth:"xs",fullWidth:!0,children:[a.jsx(w,{children:T("common.dialog.delete.title",{item:T("templates.titleSingle")})}),a.jsx(S,{children:a.jsx(j,{children:T("common.dialog.delete.message",{name:null==t?void 0:t.name})})}),a.jsxs(C,{children:[a.jsx(x,{onClick:()=>h(!1),disabled:f,children:T("common.actions.cancel")}),a.jsx(x,{onClick:async()=>{g(!0);try{await A.works.delete(t.id),l(t),k(T("templates.status.templateDeleted"),"success")}catch(e){v(R(e))}finally{g(!1),h(!1)}},color:"error",variant:"contained",disabled:f,startIcon:f?a.jsx(b,{size:20}):a.jsx(re,{}),children:T(f?"common.status.deleting":"common.actions.delete")})]})]})]})},he=({folder:e,onClick:t,onContextMenu:r,onDrop:s,onFolderDrop:l,allWorks:n,isNewFolder:i=!1})=>a.jsxs(o,{sx:{width:120},children:[a.jsx(_,{className:i?"folder-card":"","data-folder-id":e.id,draggable:!0,onDragStart:t=>{t.dataTransfer.setData("folder-id",e.id),t.currentTarget.style.opacity="0.5"},onDragEnd:e=>{e.currentTarget.style.opacity="1"},onDragOver:e=>{e.preventDefault(),e.currentTarget.style.boxShadow="0 0 10px 0 rgba(0, 0, 0, 0.1)",e.currentTarget.style.transform="scale(1.1)",e.currentTarget.style.transition="transform 0.2s ease"},onDragLeave:e=>{e.currentTarget.style.boxShadow="none",e.currentTarget.style.transform="scale(1)"},onDrop:t=>{t.preventDefault(),t.currentTarget.style.boxShadow="none",t.currentTarget.style.transform="scale(1)";const r=t.dataTransfer.getData("text/plain"),a=t.dataTransfer.getData("folder-id");if(r){const t=n.find((e=>e.id===r));t&&s(t,e.id)}else a&&l(a,e.id)},sx:{cursor:"pointer","&:hover":{boxShadow:6,transform:"scale(1.05)",transition:"transform 0.2s ease"},position:"relative",zIndex:0,width:"100%",display:"flex",flexDirection:"column","&.folder-card":{transition:"transform 0.2s ease",animation:"zoomIn 0.3s ease","@keyframes zoomIn":{"0%":{transform:"scale(0)",opacity:0},"80%":{transform:"scale(1.05)",opacity:1},"100%":{transform:"scale(1)",opacity:1}}}},onClick:()=>t(e),onContextMenu:t=>r(t,e),children:a.jsxs(o,{sx:{position:"relative",width:"100%",paddingTop:"150%",overflow:"hidden"},children:[a.jsx(v,{variant:"square",src:e.cover||void 0,sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",bgcolor:e.cover?"primary.main":ce(e.title),fontSize:"300%"},children:!e.cover&&ue(e.title)}),a.jsx(m,{size:"small",onClick:t=>{t.stopPropagation(),r(t,e)},sx:{position:"absolute",bottom:4,right:4,bgcolor:"background.paper",opacity:.5,"&:hover":{bgcolor:"background.default",opacity:1}},children:a.jsx(X,{fontSize:"small"})})]})}),a.jsx(j,{sx:{mt:2,width:"100%",overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.2,textAlign:"center"},children:e.title})]}),fe=()=>{var _,z,I,W,ue,fe;const{user:ge}=E(),je=e(),ve=t(),{showErrorToast:be,showToast:ye}=O(),{t:we}=L(),ke=new URLSearchParams(ve.search).get("teacher"),Se=new URLSearchParams(ve.search).get("new_work_id"),Ce="true"===new URLSearchParams(ve.search).get("clear_filters"),[Fe,Te]=r.useState(null),[De,_e]=r.useState((()=>{try{if(Ce)return localStorage.removeItem(me),{teacherFilter:"",searchTerm:"",folderState:void 0};const e=localStorage.getItem(me);if(e){const t=JSON.parse(e);return Te(t),t}}catch(e){}return{teacherFilter:"",searchTerm:"",folderState:void 0}})),[ze,Ie]=r.useState(De.teacherFilter),[We,Ee]=r.useState(De.searchTerm),[Oe,Le]=r.useState(De.searchTerm),[Pe,Be]=r.useState((()=>(()=>{try{return localStorage.getItem(xe)||"created_at_desc"}catch(Xe){return"created_at_desc"}})())),[Ae,Re]=r.useState(De.folderState||{currentFolder:null,breadcrumbs:[]}),[Me,$e]=r.useState([]),[Ne,Ue]=r.useState([]),[He,Ke]=r.useState([]),[qe,Je]=r.useState(!0),[Ge,Ze]=r.useState(!1),[Qe,Ve]=r.useState(!0),[Xe,Ye]=r.useState(null),[et,tt]=r.useState(null),[rt,st]=r.useState(null),[lt,at]=r.useState(!1),[ot,nt]=r.useState(!1),[it,dt]=r.useState(!1),[ct,ut]=r.useState(null),mt=Boolean(ct),[xt,pt]=r.useState(!1),[ht,ft]=r.useState(0),gt=r.useRef(!0),[jt,vt]=r.useState(0),[bt,yt]=r.useState(!0),wt=50;new URLSearchParams(ve.search).get("onboarding");const[kt,St]=r.useState([]),[Ct,Ft]=r.useState(!0),[Tt,Dt]=r.useState(!1),[_t,zt]=r.useState({title:"",description:"",type:P.BOOK,cover:void 0}),[It,Wt]=r.useState(!1),[Et,Ot]=r.useState(null),[Lt,Pt]=r.useState(null),[Bt,At]=r.useState(!1),[Rt,Mt]=r.useState(null),[$t,Nt]=r.useState(!1),[Ut,Ht]=r.useState(!1),[Kt,qt]=r.useState(!1),[Jt,Gt]=r.useState([]),[Zt,Qt]=r.useState(!0),[Vt,Xt]=r.useState(0),[Yt,er]=r.useState(!0),[tr,rr]=r.useState(!1),sr=r.useRef(null),[lr,ar]=r.useState(!1),[or,nr]=r.useState((()=>{try{const e=localStorage.getItem("templatesAccordionState");return e?JSON.parse(e):{folders:!0,allTemplates:!0}}catch{return{folders:!0,allTemplates:!0}}})),[ir,dr]=r.useState(!1),[cr,ur]=r.useState(!1),[mr,xr]=r.useState(!1),[pr,hr]=r.useState(null),[fr,gr]=r.useState(!1);r.useEffect((()=>{const e=setTimeout((()=>{Oe!==We&&Ee(Oe)}),500);return()=>clearTimeout(e)}),[Oe]),r.useEffect((()=>{if(Se){const e=setTimeout((()=>{const e=new URL(window.location.href);e.searchParams.delete("new_work_id"),window.history.replaceState({},"",e.toString())}),3e3);return()=>clearTimeout(e)}}),[Se]);const jr=(null==ge?void 0:ge.role)===B.ADMIN,vr=(null==ge?void 0:ge.role)===B.TEACHER||jr;r.useEffect((()=>{if(!gt.current){const e={teacherFilter:ze,searchTerm:We,folderState:Ae};localStorage.setItem(me,JSON.stringify(e))}}),[ze,We,Ae]),r.useEffect((()=>{gt.current||(e=>{localStorage.setItem(xe,e)})(Pe)}),[Pe]),r.useEffect((()=>{(async()=>{if(!xt){Ve(!0),Ye(null);try{if(ke&&Ie(ke),jr){const e=(await A.users.getAll(0,100,void 0,B.TEACHER)).sort(((e,t)=>{const r=U(e).toLowerCase(),s=U(t).toLowerCase();return r.localeCompare(s)}));Ke(e)}gt.current=!1}catch(e){const t=R(e);Ye(t),pt(!0),be(t)}finally{Ve(!1)}}})()}),[ke,jr,xt]),r.useEffect((()=>{(async()=>{if(!Qe&&!gt.current){Ft(!0);try{if(!Ae.currentFolder){const e=await A.folders.getAll(0,100,void 0,void 0,ze||(null==ge?void 0:ge.id),We,"name_asc"===Pe||"name_desc"===Pe?Pe.replace("name_","title_"):Pe);St(e)}}catch(e){be(R(e))}finally{Ft(!1)}}})()}),[ze,null==ge?void 0:ge.id,We,Pe,Ae.currentFolder,Qe]),r.useEffect((()=>{(async()=>{if(!Qe&&!gt.current){Je(!0),Ye(null);try{const e=ze||(null==ge?void 0:ge.id);let t=[];Ae.currentFolder?(t=(Ae.currentFolder.works||[]).filter((e=>e.name.toLowerCase().includes(We.toLowerCase()))),t=[...t].sort(((e,t)=>"name_asc"===Pe?e.name.localeCompare(t.name):"name_desc"===Pe?t.name.localeCompare(e.name):"created_at_asc"===Pe?new Date(e.created_at).getTime()-new Date(t.created_at).getTime():new Date(t.created_at).getTime()-new Date(e.created_at).getTime()))):t=await A.works.getAll(0,wt,void 0,e,e,We,Pe),$e(t),vt(0),yt(t.length===wt),Ye(null)}catch(e){const t=R(e);Ye(t),be(t)}finally{Je(!1)}}})()}),[ze,null==ge?void 0:ge.id,Ae.currentFolder,We,Pe,Qe]),r.useEffect((()=>{var e,t,r;Fe&&(null==(e=Fe.folderState)?void 0:e.currentFolder)&&A.folders.getById(null==(r=null==(t=Fe.folderState)?void 0:t.currentFolder)?void 0:r.id).then((e=>{Re((t=>({...t,currentFolder:e})))}))}),[Fe]),r.useEffect((()=>{(async()=>{if(!Qe&&!gt.current){Qt(!0);try{const e=ze||(null==ge?void 0:ge.id),t=await A.works.getAll(0,wt,void 0,e,e,We,Pe);Gt(t),Xt(0),er(t.length===wt)}catch(e){be(R(e))}finally{Qt(!1)}}})()}),[ze,null==ge?void 0:ge.id,We,Pe,Qe]);const br=r.useCallback((async()=>{if(!Yt||tr)return;rr(!0);const e=Vt+1;try{const t=ze||(null==ge?void 0:ge.id),r=await A.works.getAll(e*wt,wt,void 0,t,t,We,Pe);r.length>0?(Gt((e=>[...e,...r])),Xt(e),er(r.length===wt)):er(!1)}catch(t){be(R(t))}finally{rr(!1)}}),[Yt,tr,Vt,ze,null==ge?void 0:ge.id,We,Pe,wt]);r.useEffect((()=>{const e=new IntersectionObserver((e=>{const[t]=e;t.isIntersecting&&Yt&&!Zt&&!tr&&br()}),{threshold:.5}),t=sr.current;return t&&e.observe(t),()=>{t&&e.unobserve(t)}}),[Yt,Zt,tr,br]);const yr=()=>{localStorage.removeItem(me),Ie(""),Ee(""),Le("")},wr=(e,t="view")=>{st(e),"move"===t?(hr({type:"template",id:e.id}),xr(!0),dt(!1)):dt(!0)},kr=()=>{dt(!1),st(null),tt(null),nt(!1)},Sr=()=>{ut(null)},Cr=r.useCallback((()=>{ft((e=>e+1))}),[]),Fr=async e=>{Ft(!0);try{const t=await A.folders.getById(e.id);Re((r=>({currentFolder:t,breadcrumbs:[...r.breadcrumbs,e]}))),$e(t.works||[]),de(e.id)}catch(t){be(R(t))}finally{Ft(!1)}},Tr=async()=>{try{Re({currentFolder:null,breadcrumbs:[]});const e=ze||(null==ge?void 0:ge.id),t=await A.works.getAll(0,wt,void 0,e,e,We,Pe);Gt(t),Xt(0),er(t.length===wt),de(null)}catch(e){be(R(e))}},Dr=(e,t)=>{e.preventDefault(),e.stopPropagation(),Pt(t),Ot(e.currentTarget)},_r=()=>{Ot(null)},zr=async(e,t)=>{try{t?await A.folders.addWork(t,e.id):null!==Ae.currentFolder&&await A.folders.removeWork(Ae.currentFolder.id,e.id),null!==Ae.currentFolder?$e((t=>t.filter((t=>t.id!==e.id)))):Gt((t=>t.filter((t=>t.id!==e.id)))),ye(we("templates.status.templateMoved"),"success")}catch(r){be(R(r))}},Ir=e=>{$e((t=>t.filter((t=>t.id!==e.id)))),Gt((t=>t.filter((t=>t.id!==e.id))))},Wr=async(e,t)=>{try{if(e===t)return;await A.folders.update(e,{parent_id:t}),Ae.currentFolder?Re((t=>({...t,currentFolder:{...t.currentFolder,subfolders:t.currentFolder.subfolders.filter((t=>t.id!==e))}}))):St((t=>t.filter((t=>t.id!==e)))),ye(we("templates.status.folderMoved"),"success")}catch(r){be(R(r))}},Er=s(),Or=l(Er.breakpoints.down("md")),Lr=e=>{e.dataTransfer.getData("text/plain")||e.dataTransfer.getData("folder-id")?ar(!0):e.preventDefault()},Pr=()=>{ar(!1)};r.useEffect((()=>(document.addEventListener("dragstart",Lr),document.addEventListener("dragend",Pr),document.addEventListener("drop",Pr),()=>{document.removeEventListener("dragstart",Lr),document.removeEventListener("dragend",Pr),document.removeEventListener("drop",Pr)})),[]);return a.jsxs(o,{children:[a.jsx(M,{title:we("templates.title"),actionButton:[{label:we(Or?"templates.actions.folder":"templates.actions.addFolder"),icon:a.jsx($,{}),onClick:()=>Dt(!0)},{label:we(Or?"templates.actions.template":"templates.actions.createTemplate"),icon:a.jsx(N,{}),onClick:()=>je("/works/assign?template=true"+(Ae.currentFolder?`&folder=${Ae.currentFolder.id}`:""))}]}),a.jsx(n,{sx:{p:2,mb:2},children:a.jsxs(o,{sx:{display:"flex",flexDirection:"column",gap:2},children:[jr&&a.jsx(i,{fullWidth:!0,size:"small",sx:{"& .MuiOutlinedInput-root":{borderRadius:2}},children:a.jsxs(d,{value:ze,onChange:e=>Ie(e.target.value),displayEmpty:!0,children:[a.jsx(c,{value:null==ge?void 0:ge.id,children:we("templates.filters.onlyMy")}),He.map((e=>a.jsx(c,{value:e.id,children:U(e)||e.id},e.id)))]})}),a.jsxs(o,{sx:{display:"flex",flexDirection:{xs:"column",lg:"row"},gap:2,alignItems:{xs:"stretch",lg:"flex-start"}},children:[a.jsx(u,{label:we("templates.filters.search"),placeholder:Ae.currentFolder?we("templates.filters.searchInside"):we("templates.filters.searchGlobal"),variant:"outlined",fullWidth:!0,size:"small",sx:{order:{xs:2,lg:1},flex:{lg:1}},value:Oe,onChange:e=>Le(e.target.value),InputProps:{startAdornment:a.jsx(K,{sx:{mr:1,color:"text.secondary"},fontSize:"small"}),endAdornment:Oe?a.jsx(m,{"aria-label":"clear search",onClick:()=>{Le(""),Ee("")},edge:"end",size:"small",children:a.jsx(H,{fontSize:"small"})}):null}}),a.jsx(i,{size:"small",sx:{order:{xs:1,lg:2},minWidth:{xs:"auto",md:180},width:{xs:"100%",md:"auto"},"& .MuiOutlinedInput-root":{borderRadius:2}},children:a.jsxs(d,{value:Pe,onChange:e=>Be(e.target.value),displayEmpty:!0,startAdornment:a.jsx(q,{sx:{mr:1,color:"text.secondary"}}),children:[a.jsx(c,{value:"created_at_desc",children:we("templates.filters.order.newestFirst")}),a.jsx(c,{value:"created_at_asc",children:we("templates.filters.order.oldestFirst")}),a.jsx(c,{value:"name_asc",children:we("templates.filters.order.nameAZ")}),a.jsx(c,{value:"name_desc",children:we("templates.filters.order.nameZA")})]})})]}),(Oe||We||ze)&&a.jsx(o,{sx:{display:"flex",justifyContent:"center"},children:a.jsx(x,{variant:"outlined",startIcon:a.jsx(J,{}),onClick:yr,children:we("common.actions.clear")})})]})}),Xe&&a.jsx(p,{severity:"error",sx:{mb:2},action:a.jsx(x,{color:"inherit",size:"small",onClick:Cr,disabled:qe,children:we(qe?"common.status.loading":"common.actions.retry")}),children:Xe}),a.jsx(o,{sx:{mb:1,height:"2px"},children:Ct&&a.jsx(h,{sx:{height:"2px"}})}),((null==(_=Ae.currentFolder)?void 0:_.subfolders)||kt.length>0)&&a.jsxs(o,{sx:{mb:3},children:[a.jsxs(f,{sx:{ml:1,mb:2,transform:lr&&Ae.breadcrumbs.length>0?"scale(2)":"scale(1)",transformOrigin:"left center",transition:"transform 0.3s ease-in-out"},children:[a.jsx(g,{onDrop:e=>{e.preventDefault();const t=e.dataTransfer.getData("text/plain"),r=e.dataTransfer.getData("folder-id");if(t){const e=Me.find((e=>e.id===t));e&&zr(e,null)}else r&&Wr(r,null)},onDragOver:e=>{e.preventDefault()},component:"button",variant:"body1",onClick:Tr,sx:{textDecoration:"none"},children:we("templates.title")}),Ae.breadcrumbs.map(((e,t)=>t<Ae.breadcrumbs.length-1?a.jsx(g,{onDrop:t=>{t.preventDefault();const r=t.dataTransfer.getData("text/plain"),s=t.dataTransfer.getData("folder-id");if(r){const t=Me.find((e=>e.id===r));t&&zr(t,e.id)}else s&&Wr(s,e.id)},onDragOver:e=>e.preventDefault(),component:"button",variant:"body1",onClick:()=>(async(e,t)=>{Ft(!0);try{const r=await A.folders.getById(e.id);Re({currentFolder:r,breadcrumbs:Ae.breadcrumbs.slice(0,t+1)}),de(e.id)}catch(r){be(R(r))}finally{Ft(!1)}})(e,t),sx:{textDecoration:"none"},children:e.title},e.id):a.jsx(j,{variant:"body1",children:e.title},e.id)))]}),Ae.currentFolder&&a.jsxs(n,{sx:{p:2,my:3,display:"flex",gap:3,alignItems:"flex-start",position:"relative"},children:[a.jsx(m,{size:"small",onClick:async()=>{if(Ae.breadcrumbs.length>1){const t=Ae.breadcrumbs[Ae.breadcrumbs.length-2];try{const e=await A.folders.getById(t.id);Re((t=>({currentFolder:e,breadcrumbs:t.breadcrumbs.slice(0,-1)}))),de(t.id)}catch(e){be(R(e))}}else Tr()},sx:{position:"absolute",top:4,left:4,bgcolor:"background.paper",opacity:.5,zIndex:1e3,"&:hover":{bgcolor:"background.default",opacity:1}},children:a.jsx(G,{fontSize:"small"})}),a.jsx(v,{variant:"square",src:Ae.currentFolder.cover||void 0,sx:{m:-2,mr:1,width:120,height:180,borderRadius:3,bgcolor:Ae.currentFolder.cover?"primary.main":ce(Ae.currentFolder.title),fontSize:"300%"},children:!Ae.currentFolder.cover&&Ae.currentFolder.title.split(" ").map((e=>e[0])).join("").toUpperCase()}),a.jsxs(o,{sx:{flex:1},children:[a.jsxs(o,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",gap:1,mb:1},children:[a.jsx(j,{variant:"h5",sx:{flex:1,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.2,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:Ae.currentFolder.title}),a.jsx(m,{"aria-label":"edit",onClick:()=>{Ae.currentFolder&&(Pt(Ae.currentFolder),zt({title:Ae.currentFolder.title,description:Ae.currentFolder.description||"",type:Ae.currentFolder.type,cover:Ae.currentFolder.cover||void 0}),At(!0),Dt(!0))},children:a.jsx(Z,{})})]}),Ae.currentFolder.description&&a.jsxs(o,{onClick:()=>ur(!cr),children:[a.jsx(j,{variant:"body1",color:"text.secondary",sx:{display:"-webkit-box",WebkitLineClamp:cr?"unset":3,WebkitBoxOrient:"vertical",overflow:"hidden",textOverflow:"ellipsis",transition:"all 0.2s ease-in-out",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:Ae.currentFolder.description}),Ae.currentFolder.description.split("\n").length>3&&a.jsx(j,{variant:"caption",color:"primary",sx:{cursor:"pointer",display:"block",mt:1,"&:hover":{opacity:.8}},children:cr?"Show less":"Show more"})]})]})]}),a.jsx(o,{sx:{display:"flex",flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},gap:5,my:3,mx:1},children:Ae.currentFolder?((null==(z=Ae.currentFolder)?void 0:z.subfolders)||[]).slice().sort(((e,t)=>"name_asc"===Pe||"title_asc"===Pe?e.title.localeCompare(t.title):"name_desc"===Pe||"title_desc"===Pe?t.title.localeCompare(e.title):"created_at_asc"===Pe?new Date(e.created_at).getTime()-new Date(t.created_at).getTime():new Date(t.created_at).getTime()-new Date(e.created_at).getTime())).map((e=>a.jsx(he,{folder:e,onClick:Fr,onContextMenu:Dr,onDrop:zr,onFolderDrop:Wr,allWorks:Me},e.id))):kt.slice().sort(((e,t)=>"name_asc"===Pe||"title_asc"===Pe?e.title.localeCompare(t.title):"name_desc"===Pe||"title_desc"===Pe?t.title.localeCompare(e.title):"created_at_asc"===Pe?new Date(e.created_at).getTime()-new Date(t.created_at).getTime():new Date(t.created_at).getTime()-new Date(e.created_at).getTime())).map((e=>a.jsx(he,{folder:e,onClick:Fr,onContextMenu:Dr,onDrop:zr,onFolderDrop:Wr,allWorks:Jt},e.id)))}),Ae.breadcrumbs.length>0&&a.jsxs(a.Fragment,{children:[a.jsx(o,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"repeat(2, 1fr)",lg:"repeat(3, 1fr)"},gap:2,position:"relative"},children:Me.map((e=>a.jsx(pe,{work:e,onClick:wr,onDelete:Ir,isNewWork:Se===e.id},e.id)))}),0===Me.length&&a.jsxs(o,{sx:{textAlign:"center",py:4},children:[a.jsx(j,{variant:"h6",color:"text.secondary",sx:{mb:1},children:we("templates.empty.noTemplatesInFolder")}),a.jsx(x,{variant:"outlined",onClick:()=>je("/works/assign?template=true"+(Ae.currentFolder?`&folder=${Ae.currentFolder.id}`:"")),children:we("templates.actions.create")})]})]})]}),null===Ae.currentFolder&&a.jsx(o,{children:Zt?a.jsx(Q,{message:we("common.loading")}):a.jsxs(a.Fragment,{children:[0!==Jt.length||Xe?a.jsx(o,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"repeat(2, 1fr)",lg:"repeat(3, 1fr)"},gap:2,position:"relative"},children:Jt.map((e=>a.jsx(pe,{work:e,onClick:wr,onDelete:Ir,isNewWork:Se===e.id},e.id)))}):a.jsxs(o,{sx:{textAlign:"center",py:4},children:[a.jsx(j,{variant:"h6",color:"text.secondary",sx:{mb:1},children:ze||We?we("templates.empty.noMatch"):kt.length>0?we("templates.empty.noFolder"):we("templates.empty.noTemplates")}),a.jsx(j,{variant:"body2",color:"text.secondary",sx:{mb:3},children:ze||We?we("templates.hint.adjust"):kt.length>0?"":we("onboarding.steps.createTemplate.description")}),vr&&0===Jt.length&&!ze&&!We&&a.jsx(x,{variant:"outlined",onClick:()=>je("/works/assign?template=true"+(Ae.currentFolder?`&folder=${Ae.currentFolder.id}`:"")),sx:{borderRadius:2,textTransform:"none",fontWeight:500},children:we("templates.actions.create")}),0===Jt.length&&(ze||We)&&a.jsx(x,{variant:"outlined",startIcon:a.jsx(J,{}),onClick:yr,sx:{borderRadius:2,textTransform:"none"},children:we("common.actions.clear")})]}),a.jsx(o,{ref:sr,sx:{display:"flex",justifyContent:"center",p:2,visibility:Yt?"visible":"hidden"},children:tr&&a.jsx(b,{size:24})})]})}),a.jsxs(y,{open:it,onClose:kr,maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:2}},children:[a.jsx(w,{children:a.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[a.jsx(j,{variant:"h6",children:null==rt?void 0:rt.name}),rt&&a.jsx(k,{label:we("templates.titleSingle"),color:"primary",size:"small"})]})}),a.jsxs(S,{children:[et&&a.jsx(p,{severity:"error",sx:{mb:2},children:et}),rt&&a.jsx(a.Fragment,{children:a.jsx(V,{work:rt,isStudent:!1,error:et,onTaskClick:e=>{rt&&je(`/works/${rt.id}?task_number=${e}&return_to=/templates`)},onStartWork:()=>{rt&&je(`/works/${rt.id}?continue=false`)},hideButtons:!0})})]}),a.jsxs(C,{sx:{display:"flex",justifyContent:"space-between",px:2,pb:2},children:[a.jsx(o,{sx:{display:"flex",gap:1},children:vr&&a.jsxs(a.Fragment,{children:[a.jsx(x,{color:"primary",onClick:e=>{e.stopPropagation(),ut(e.currentTarget)},"aria-label":"actions","aria-controls":mt?"actions-menu":void 0,"aria-haspopup":"true","aria-expanded":mt?"true":void 0,startIcon:a.jsx(X,{}),children:we("common.actions.actions")}),a.jsxs(F,{anchorEl:ct,open:mt,onClose:Sr,MenuListProps:{"aria-labelledby":"actions-button"},children:[a.jsxs(c,{onClick:()=>{Sr(),rt&&je(`/works/assign/?work_id=${rt.id}&copy=true&send=true&return_to=/templates`)},children:[a.jsx(Y,{fontSize:"small",sx:{mr:1}}),we("templates.actions.sendToStudent")]}),a.jsxs(c,{onClick:()=>{var e;Sr(),e=rt.id,je(`/works/assign/?work_id=${e}&edit=true&return_to=/templates`)},children:[a.jsx(Z,{fontSize:"small",sx:{mr:1}}),we("common.actions.edit")]}),a.jsxs(c,{onClick:()=>{Sr(),rt&&je(`/works/assign/?work_id=${rt.id}&copy=true&template=true&return_to=/templates`)},children:[a.jsx(ee,{fontSize:"small",sx:{mr:1}}),we("common.actions.copy")]}),a.jsxs(c,{onClick:()=>{Sr(),kr(),rt&&(hr({type:"template",id:rt.id}),xr(!0)),Sr()},children:[a.jsx(te,{fontSize:"small",sx:{mr:1}}),we("common.actions.moveTo")]}),a.jsxs(c,{onClick:()=>{Sr(),nt(!0)},disabled:lt,sx:{color:"error.main",borderTop:1,borderColor:"divider"},children:[lt?a.jsx(b,{size:20,sx:{mr:1}}):a.jsx(re,{fontSize:"small",sx:{mr:1}}),we("common.actions.delete")]})]})]})}),a.jsx(o,{children:a.jsx(x,{onClick:kr,children:we("common.actions.close")})})]})]}),a.jsxs(y,{open:ot,onClose:()=>nt(!1),maxWidth:"xs",fullWidth:!0,children:[a.jsx(w,{children:we("common.dialog.delete.title",{item:we("templates.titleSingle")})}),a.jsx(S,{children:a.jsx(j,{children:we("common.dialog.delete.message",{name:null==rt?void 0:rt.name})})}),a.jsxs(C,{children:[a.jsx(x,{onClick:()=>nt(!1),disabled:lt,children:we("common.actions.cancel")}),a.jsx(x,{onClick:async()=>{if(rt){at(!0),tt(null);try{await A.works.delete(rt.id),$e((e=>e.filter((e=>e.id!==rt.id)))),Gt((e=>e.filter((e=>e.id!==rt.id)))),kr(),ye(we("templates.status.templateDeleted"),"success")}catch(e){const t=e instanceof Error?e.message:"Failed to delete work. Please try again.";be(t)}finally{at(!1),nt(!1)}}},color:"error",variant:"contained",disabled:lt,startIcon:lt?a.jsx(b,{size:20}):a.jsx(re,{}),children:we(lt?"common.status.deleting":"common.actions.delete")})]})]}),a.jsxs(y,{open:Tt,onClose:()=>!It&&Dt(!1),maxWidth:"sm",fullWidth:!0,children:[a.jsx(w,{children:we(Bt?"common.actions.edit":"common.actions.create")}),a.jsx(S,{children:a.jsxs(T,{spacing:2,sx:{mt:1},children:[a.jsx(o,{sx:{display:"flex",justifyContent:"center",mb:2},children:Kt?a.jsx(o,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:180,width:120},children:a.jsx(b,{})}):a.jsx(v,{variant:"square",src:_t.cover||void 0,sx:{width:120,height:180,borderRadius:3,bgcolor:"primary.main",cursor:"pointer","&:hover":{opacity:.8}},onClick:()=>{dr(!0),qt(!1)},children:!_t.cover&&a.jsx(se,{})})}),a.jsx(u,{label:we("templates.dialog.createFolder.name"),value:_t.title,onChange:e=>zt((t=>({...t,title:e.target.value}))),fullWidth:!0,required:!0,disabled:It,error:_t.title.length>100,helperText:_t.title.length>100?we("templates.validation.titleLength"):""}),a.jsx(u,{label:we("templates.dialog.createFolder.description"),value:_t.description,onChange:e=>zt((t=>({...t,description:e.target.value}))),fullWidth:!0,multiline:!0,rows:2,disabled:It,error:(null==(I=_t.description)?void 0:I.length)>1e3,helperText:(null==(W=_t.description)?void 0:W.length)>1e3?we("templates.validation.descriptionLength"):""})]})}),a.jsxs(C,{children:[a.jsx(x,{onClick:()=>{Dt(!1),At(!1),zt({title:"",description:"",type:P.BOOK,cover:void 0})},disabled:It,children:we("common.actions.cancel")}),a.jsx(x,{onClick:async()=>{var e;if(!_t.title.trim())return;const t=ne(ie,{..._t,type:P.BOOK});if(t.isValid){Wt(!0);try{if(Bt&&Lt){const e=await A.folders.update(Lt.id,{..._t});Ae.currentFolder?Ae.currentFolder.id===Lt.id?Re((t=>({...t,currentFolder:{...t.currentFolder,...e,subfolders:t.currentFolder.subfolders,works:t.currentFolder.works},breadcrumbs:t.breadcrumbs.map((t=>t.id===Lt.id?{...t,...e}:t))}))):Re((t=>({...t,currentFolder:{...t.currentFolder,subfolders:t.currentFolder.subfolders.map((t=>t.id===Lt.id?e:t))}}))):St((t=>t.map((t=>t.id===Lt.id?e:t)))),ye(we("folders.status.updated"),"success")}else{const t=await A.folders.create({..._t,parent_id:(null==(e=Ae.currentFolder)?void 0:e.id)||null});Ae.currentFolder?Re((e=>({...e,currentFolder:{...e.currentFolder,subfolders:[t,...e.currentFolder.subfolders]}}))):St((e=>[t,...e])),ye(we("templates.status.folderCreated"),"success")}zt({title:"",description:"",type:P.BOOK,cover:void 0}),Dt(!1),At(!1)}catch(r){be(R(r))}finally{Wt(!1)}}else{const e=Object.values(t.errors)[0];be(e)}},variant:"contained",disabled:It||!_t.title.trim()||_t.title.length>100||((null==(ue=_t.description)?void 0:ue.length)||0)>1e3,startIcon:It?a.jsx(b,{size:20}):null,children:we(It?"common.loading":Bt?"common.actions.save":"common.actions.create")})]})]}),a.jsxs(y,{open:ir,onClose:()=>dr(!1),maxWidth:"sm",fullWidth:!0,children:[a.jsx(w,{children:we("templates.dialog.createFolder.cover.title")}),a.jsx(S,{children:Kt?a.jsx(o,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:a.jsx(b,{})}):a.jsxs(a.Fragment,{children:[a.jsx(le,{onLoading:e=>{zt((e=>({...e,cover:void 0}))),qt(e),dr(!1)},onImageUpload:e=>{zt((t=>({...t,cover:e}))),dr(!1),qt(!1)},onClose:()=>{dr(!1),qt(!1)}}),_t.cover&&a.jsx(o,{sx:{display:"flex",justifyContent:"center",mt:2},children:a.jsx(x,{variant:"outlined",color:"error",startIcon:a.jsx(re,{}),onClick:()=>{zt((e=>({...e,cover:void 0}))),dr(!1)},children:we("templates.dialog.createFolder.cover.delete")})})]})})]}),a.jsxs(F,{anchorEl:Et,open:Boolean(Et),onClose:_r,children:[a.jsxs(c,{onClick:()=>{_r(),Lt&&(zt({title:Lt.title,description:Lt.description||"",type:Lt.type,cover:Lt.cover||void 0}),At(!0),Dt(!0)),_r()},children:[a.jsx(Z,{fontSize:"small",sx:{mr:1}}),we("common.actions.edit")]}),a.jsxs(c,{onClick:()=>{_r(),Lt&&(hr({type:"folder",id:Lt.id}),xr(!0)),_r()},children:[a.jsx(te,{fontSize:"small",sx:{mr:1}}),we("common.actions.moveTo")]}),a.jsxs(c,{onClick:()=>{_r(),Mt(Lt),Ht(!0)},disabled:$t,sx:{color:"error.main",borderTop:1,borderColor:"divider"},children:[$t?a.jsx(b,{size:20,sx:{mr:1}}):a.jsx(re,{fontSize:"small",sx:{mr:1}}),we("common.actions.delete")]})]}),a.jsxs(y,{open:Ut,onClose:()=>!$t&&Ht(!1),maxWidth:"xs",fullWidth:!0,children:[a.jsx(w,{children:we("common.dialog.delete.title",{item:we("templates.dialog.move.folder")})}),a.jsxs(S,{children:[a.jsx(j,{children:we("templates.dialog.delete.folder.message")}),a.jsx(j,{children:we("templates.dialog.delete.folder.moveTemplates")}),a.jsx(j,{children:we("templates.dialog.delete.folder.deleteSubfolders")})]}),a.jsxs(C,{children:[a.jsx(x,{onClick:()=>Ht(!1),disabled:$t,children:we("common.actions.cancel")}),a.jsx(x,{onClick:async()=>{if(Rt){Nt(!0);try{await A.folders.delete(Rt.id),Ae.currentFolder?Re((e=>({...e,currentFolder:{...e.currentFolder,subfolders:e.currentFolder.subfolders.filter((e=>e.id!==Rt.id))}}))):(St((e=>e.filter((e=>e.id!==Rt.id)))),await Tr()),Ht(!1),Mt(null),ye(we("templates.status.folderDeleted"),"success")}catch(e){be(R(e))}finally{Nt(!1)}}},color:"error",variant:"contained",disabled:$t,startIcon:$t?a.jsx(b,{size:20}):a.jsx(re,{}),children:we($t?"common.status.deleting":"common.actions.delete")})]})]}),a.jsx(D,{anchor:"right",open:mr,onClose:()=>{xr(!1),hr(null)},PaperProps:{sx:{width:{xs:"100%",sm:400},p:2}},children:a.jsxs(o,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[a.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[a.jsx(j,{variant:"h6",children:we("templates.dialog.move.title",{type:"folder"===(null==pr?void 0:pr.type)?we("templates.dialog.move.folder"):we("templates.dialog.move.template")})}),a.jsx(m,{onClick:()=>{xr(!1),hr(null)},children:a.jsx(ae,{})})]}),a.jsx(o,{sx:{flex:1,overflow:"auto"},children:a.jsx(oe,{onFolderSelect:async e=>{if(pr){gr(!0);try{"template"===pr.type?(e?await A.folders.addWork(e.id,pr.id):await A.folders.removeWork(Ae.currentFolder.id,pr.id),Ae.currentFolder?$e((e=>e.filter((e=>e.id!==pr.id)))):Gt((e=>e.filter((e=>e.id!==pr.id)))),ye(we("templates.status.templateMoved"),"success")):(await A.folders.update(pr.id,{parent_id:(null==e?void 0:e.id)||null}),Ae.currentFolder?Re((e=>({...e,currentFolder:{...e.currentFolder,subfolders:e.currentFolder.subfolders.filter((e=>e.id!==pr.id))}}))):St((e=>e.filter((e=>e.id!==pr.id)))),ye(we("templates.status.folderMoved"),"success")),xr(!1),hr(null)}catch(t){be(R(t))}finally{gr(!1)}}},isShowRoot:!0,currentFolder:null==(fe=Ae.currentFolder)?void 0:fe.id,movingFolder:"folder"===(null==pr?void 0:pr.type)?pr.id:void 0})})]})})]})};export{fe as default};
