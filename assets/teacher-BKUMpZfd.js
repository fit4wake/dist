import{a7 as e,a8 as t,r as s,j as n,d as a,e as i,L as r,B as o,v as l,o as c,y as d,x,a1 as m,w as u,h,I as p,i as g,ai as f,aj as j,C as y,b as k,a2 as b,a3 as v,a5 as w,N as C,M as S,D as I,l as _,m as F,n as z,X as T,Y as $,U as A,af as P,K as E,O as D,f as W,ae as R,ak as B,Q as M,z as O,al as L,am as N,A as H,F as V,W as U,H as q,an as J,J as Q}from"./vendor-VHbKv6Ho.js";import{u as K,a as G,b as Y,U as X,c as Z,S as ee,C as te,D as se,P as ne,A as ae,T as ie,d as re,e as oe,F as le,L as ce,E as de,M as xe,f as me,g as ue,h as he,i as pe,j as ge,k as fe,I as je,l as ye,R as ke,m as be,n as ve,o as we,p as Ce,B as Se,W as Ie,q as _e,r as Fe,s as ze,t as Te,O as $e,v as Ae,w as Pe,x as Ee,y as De,z as We,G as Re,H as Be,J as Me,K as Oe,N as Le,Q as Ne,V as He,X as Ve,Y as Ue,Z as qe,_ as Je,$ as Qe,a0 as Ke,a1 as Ge,a2 as Ye,a3 as Xe,a4 as Ze,a5 as et,a6 as tt,a7 as st,a8 as nt,a9 as at,aa as it,ab as rt,ac as ot,ad as lt,ae as ct,af as dt,ag as xt,ah as mt,ai as ut,aj as ht,ak as pt,al as gt,am as ft,an as jt,ao as yt,ap as kt,aq as bt,ar as vt,as as wt,at as Ct,au as St,av as It,aw as _t,ax as Ft,ay as zt,az as Tt,aA as $t,aB as At,aC as Pt,aD as Et,aE as Dt,aF as Wt,aG as Rt,aH as Bt,aI as Mt,aJ as Ot,aK as Lt,aL as Nt,aM as Ht,aN as Vt,aO as Ut,aP as qt,aQ as Jt}from"./main-CV7Ja_th.js";const Qt="tasksPageFilters",Kt=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const T=e(),[$]=t(),{user:A}=K(),{showErrorToast:P}=G(),[E,D]=s.useState([]),[W,R]=s.useState([]),[B,M]=s.useState(!0),[O,L]=s.useState(!1),[N,H]=s.useState(null),[V,U]=s.useState(0),[q,J]=s.useState([]),[Q,he]=s.useState(""),[pe,ge]=s.useState(""),[fe,je]=s.useState(null),[ye,ke]=s.useState(!1),[be,ve]=s.useState(null),[we,Ce]=s.useState(null),[Se,Ie]=s.useState(!1),[_e,Fe]=s.useState(new Set),[ze,Te]=s.useState(!1),[$e,Ae]=s.useState(!1),Pe=s.useRef(!0),Ee=Boolean(be),[De,We]=s.useState(0),[Re,Be]=s.useState(!0),Me=30,Oe=s.useRef(null),{t:Le}=Y(),Ne=(null==A?void 0:A.role)===X.ADMIN,He=(null==A?void 0:A.role)===X.TEACHER||Ne,Ve=s.useCallback((()=>{try{const e=localStorage.getItem(Qt);if(e){return JSON.parse(e)}}catch(e){}return{searchTerm:"",filterTagIds:[]}}),[]),Ue=s.useCallback((()=>{const e={searchTerm:Q,filterTagIds:q.map((e=>e.id))};localStorage.setItem(Qt,JSON.stringify(e))}),[Q,q]);s.useEffect((()=>{const e=setTimeout((()=>{he(pe)}),500);return()=>clearTimeout(e)}),[pe]),s.useEffect((()=>{Pe.current||Ue()}),[Q,q,Ue]),s.useEffect((()=>{(async()=>{if(Pe.current){M(!0),H(null);try{const e=Ve(),t=$.get("tag_id"),s=await Z.tags.getAll();R(s);let n=[];if(t){const e=s.find((e=>e.id===t));e&&(J([e]),n=[t])}else if(e.filterTagIds.length>0){const t=e.filterTagIds.map((e=>s.find((t=>t.id===e)))).filter((e=>void 0!==e));t.length>0&&(J(t),n=e.filterTagIds)}e.searchTerm&&(he(e.searchTerm),ge(e.searchTerm));const a=e.searchTerm||"",i=await Z.tasks.getAll(0,Me,a,n.join(","));D(i),We(0),Be(i.length===Me),Pe.current=!1,H(null)}catch(e){const t=ue(e);H(t),P(t)}finally{M(!1)}}})()}),[V,$,Ve]),s.useEffect((()=>{if(Pe.current)return;(async()=>{M(!0),H(null);try{const e=await Z.tasks.getAll(0,Me,Q,q.map((e=>e.id)).join(","));D(e),We(0),Be(e.length===Me)}catch(e){H("Failed to search tasks. Please try again.")}finally{M(!1)}})()}),[Q,q]),s.useEffect((()=>{const e=new IntersectionObserver((e=>{const[t]=e;t.isIntersecting&&Re&&!B&&!O&&qe()}),{threshold:.5}),t=Oe.current;return t&&e.observe(t),()=>{t&&e.unobserve(t)}}),[Re,B,O]);const qe=async()=>{if(!Re||O)return;L(!0);const e=De+1;try{const t=await Z.tasks.getAll(e*Me,Me,Q,q.map((e=>e.id)).join(","));if(t.length>0){const s=t.filter((e=>!E.some((t=>t.id===e.id))));D((e=>[...e,...s])),We(e),Be(t.length===Me)}else Be(!1)}catch(t){P("Failed to load more tasks. Please try again.")}finally{L(!1)}},Je=s.useCallback((()=>{U((e=>e+1))}),[]),Qe=()=>{localStorage.removeItem(Qt),he(""),ge(""),J([])},Ke=()=>{ke(!1)},Ge=(e,t)=>{e.stopPropagation(),ve(e.currentTarget),Ce(t)},Ye=()=>{ve(null)},Xe=()=>{Ie(!1),Ce(null)},Ze=e=>{Fe((t=>{const s=new Set(t);return s.has(e.id)?s.delete(e.id):s.add(e.id),s})),Te(!0),ke(!1)},et=()=>{Ae(!1)},tt=[n.jsxs(a,{onClick:e=>{e.stopPropagation(),Ze(we),Ye()},children:[n.jsx(i,{children:n.jsx(ee,{fontSize:"small"})}),n.jsx(r,{children:Le("common.actions.select")})]},"select"),n.jsxs(a,{onClick:()=>{we&&(T(`/tasks/new?copy_task_id=${we.id}`),Ye())},children:[n.jsx(i,{children:n.jsx(te,{fontSize:"small"})}),n.jsx(r,{children:Le("common.actions.copy")})]},"copy"),n.jsxs(a,{onClick:()=>{Ye(),Ie(!0)},sx:{color:"error.main"},children:[n.jsx(i,{children:n.jsx(se,{fontSize:"small",color:"error"})}),n.jsx(r,{children:Le("common.actions.delete")})]},"delete")];return n.jsxs(o,{children:[n.jsx(ne,{title:Le("tasks.title"),actionButton:He?[{label:Le("tasks.actions.createTask"),icon:n.jsx(ae,{}),onClick:()=>T("/tasks/new")}]:void 0}),N&&n.jsx(l,{severity:"error",sx:{mb:2},action:n.jsx(c,{color:"inherit",size:"small",onClick:Je,disabled:B,children:B?"Loading...":"Retry"}),children:N}),n.jsx(d,{sx:{p:2,mb:2},children:n.jsxs(x,{spacing:2,children:[n.jsxs(o,{sx:{display:"flex",flexDirection:"column",gap:2},children:[n.jsx(m,{multiple:!0,size:"small",options:W,getOptionLabel:e=>e.name,value:q,onChange:(e,t)=>J(t),renderInput:e=>n.jsx(h,{...e,label:Le("tasks.actions.filterByTags"),placeholder:Le("filters.selectTags"),variant:"outlined",InputProps:{...e.InputProps,startAdornment:n.jsxs(n.Fragment,{children:[n.jsx(ie,{sx:{ml:1,color:"text.secondary"},fontSize:"small"}),e.InputProps.startAdornment]})}}),renderTags:(e,t)=>e.map(((e,n)=>s.createElement(u,{color:"primary",label:e.name,...t({index:n}),key:e.id})))}),n.jsx(o,{sx:{display:"flex",gap:2},children:n.jsx(h,{label:Le("tasks.actions.searchByTitle"),placeholder:Le("filters.enterTitle"),variant:"outlined",fullWidth:!0,size:"small",value:pe,onChange:e=>{const t=e.target.value;ge(t)},InputProps:{startAdornment:n.jsx(oe,{sx:{mr:1,color:"text.secondary"},fontSize:"small"}),endAdornment:pe?n.jsx(p,{position:"end",children:n.jsx(g,{"aria-label":"clear search",onClick:()=>{ge(""),he("")},edge:"end",size:"small",children:n.jsx(re,{fontSize:"small"})})}):null}})})]}),(q.length>0||pe)&&n.jsx(o,{sx:{display:"flex",justifyContent:"center"},children:n.jsx(c,{variant:"outlined",startIcon:n.jsx(le,{}),onClick:Qe,children:Le("common.actions.clear")})})]})}),ze&&n.jsx(f,{position:"static",color:"default",elevation:1,sx:{mb:2},children:n.jsxs(j,{variant:"dense",children:[n.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,flex:1},children:[n.jsx(y,{edge:"start",checked:_e.size===E.length,indeterminate:_e.size>0&&_e.size<E.length,onChange:()=>{_e.size===E.length?Fe(new Set):Fe(new Set(E.map((e=>e.id))))}}),n.jsx(k,{variant:"body2",children:Le("tasks.selection.selected",{count:_e.size})})]}),n.jsxs(o,{sx:{display:"flex"},children:[He&&n.jsx(c,{color:"error",startIcon:n.jsx(se,{}),onClick:()=>{Ae(!0)},disabled:0===_e.size,children:Le("tasks.selection.deleteCount",{count:_e.size||0})}),n.jsx(c,{onClick:()=>{Fe(new Set),Te(!1)},children:Le("common.actions.cancel")})]})]})}),B?n.jsx(ce,{message:Le("common.loading")}):n.jsxs(n.Fragment,{children:[N||0!==E.length?n.jsxs(n.Fragment,{children:[n.jsx(o,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"repeat(2, 1fr)",lg:"repeat(3, 1fr)"},gap:2},children:E.map((e=>n.jsxs(b,{sx:{height:"100%",cursor:"pointer",position:"relative","&:hover":{boxShadow:6}},onClick:()=>!ze&&(e=>{je(e),ke(!0)})(e),children:[ze&&n.jsx(y,{edge:"start",checked:_e.has(e.id),onChange:t=>{t.stopPropagation(),Ze(e)},sx:{position:"absolute",top:8,right:8,zIndex:1}}),n.jsx(v,{sx:{p:2,"&:last-child":{paddingBottom:2}},children:n.jsxs(o,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",gap:1},children:[n.jsx(k,{sx:{flex:1,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.2},children:e.title}),n.jsx(o,{sx:{display:"flex",flexDirection:"row",gap:1,flexShrink:0},children:!ze&&n.jsxs(n.Fragment,{children:[n.jsx(g,{size:"small",onClick:t=>{t.stopPropagation(),T(`/tasks/${e.id}/edit`)},children:n.jsx(de,{})}),n.jsx(g,{size:"small",onClick:t=>Ge(t,e),children:n.jsx(xe,{})})]})})]})}),e.tags.length>0&&n.jsx(w,{sx:{pt:0,px:2,pb:2},children:n.jsx(o,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:e.tags.map((e=>n.jsx(u,{label:e.name,size:"small",variant:"outlined",onClick:t=>{t.stopPropagation(),q.some((t=>t.id===e.id))||J([...q,e])},sx:{cursor:"pointer","&:hover":{backgroundColor:"action.hover"}}},e.id)))})})]},e.id)))}),n.jsx(o,{ref:Oe,sx:{display:"flex",justifyContent:"center",p:2,visibility:Re?"visible":"hidden"},children:O&&n.jsx(C,{size:24})})]}):n.jsxs(o,{sx:{textAlign:"center",py:4},children:[n.jsx(k,{variant:"h6",color:"text.secondary",sx:{mb:1},children:Q.length<1&&q.length<1?Le(He?"tasks.empty.teacher":"tasks.empty.student"):Le("tasks.empty.noMatch")}),He&&Q.length<1&&q.length<1&&n.jsx(c,{variant:"outlined",startIcon:n.jsx(ae,{}),onClick:()=>T("/tasks/new"),sx:{mt:2},children:Le("tasks.actions.createFirst")}),(Q.length>0||q.length>0)&&n.jsx(c,{variant:"outlined",startIcon:n.jsx(le,{}),onClick:Qe,sx:{borderRadius:2,textTransform:"none"},children:Le("common.actions.clear")})]}),n.jsx(me,{open:ye,onClose:Ke,task:fe,hasQuizzes:!1,onValidateAnswers:()=>{},actionButtons:n.jsxs(o,{sx:{display:"flex",gap:1,width:"100%",justifyContent:"space-between"},children:[n.jsx(o,{sx:{display:"flex",gap:1},children:fe&&n.jsxs(n.Fragment,{children:[n.jsx(c,{size:"small",onClick:e=>Ge(e,fe),startIcon:n.jsx(xe,{}),children:Le("common.actions.actions")}),n.jsx(c,{size:"small",onClick:e=>{e.stopPropagation(),T(`/tasks/${fe.id}/edit`)},startIcon:n.jsx(de,{}),children:Le("common.actions.edit")})]})}),n.jsx(c,{onClick:Ke,children:Le("common.actions.close")})]})}),n.jsx(S,{anchorEl:be,open:Ee,onClose:Ye,onClick:e=>e.stopPropagation(),children:tt}),n.jsxs(I,{open:Se,onClose:Xe,maxWidth:"xs",fullWidth:!0,children:[n.jsx(_,{children:Le("common.dialog.delete.title",{item:"Task"})}),n.jsx(F,{children:n.jsx(k,{children:Le("common.dialog.delete.message",{name:null==we?void 0:we.title})})}),n.jsxs(z,{children:[n.jsx(c,{onClick:Xe,children:Le("common.actions.cancel")}),n.jsx(c,{onClick:async()=>{if(we)try{await Z.tasks.delete(we.id),D(E.filter((e=>e.id!==we.id)))}catch(e){const t=e instanceof Error?e.message:"Failed to delete task. Please try again.";P(t)}finally{Ie(!1),Ce(null)}},color:"error",variant:"contained",startIcon:n.jsx(se,{}),children:Le("common.actions.delete")})]})]}),n.jsxs(I,{open:$e,onClose:et,maxWidth:"xs",fullWidth:!0,children:[n.jsx(_,{children:Le("common.dialog.delete.title",{item:"Tasks"})}),n.jsx(F,{children:n.jsx(k,{children:Le("common.dialog.delete.messageBulk",{count:_e.size,item:1===_e.size?"task":"tasks"})})}),n.jsxs(z,{children:[n.jsx(c,{onClick:et,children:Le("common.actions.cancel")}),n.jsxs(c,{onClick:async()=>{try{await Z.tasks.batchDelete(Array.from(_e));D(E.filter((e=>!_e.has(e.id)))),Fe(new Set),Te(!1)}catch(e){const t=e instanceof Error?e.message:"Failed to delete tasks. Please try again.";P(t)}finally{Ae(!1)}},color:"error",variant:"contained",startIcon:n.jsx(se,{}),children:[Le("common.actions.delete")," ",_e.size," ",1===_e.size?"task":"tasks"]})]})]})]})]})}},Symbol.toStringTag,{value:"Module"})),Gt=({aiChatMessage:e,setAIChatMessage:t,isSendingAIMessage:i,aiChatHistory:l,isProcessingAttachment:x,setIsProcessingAttachment:m,aiChatMode:u,setAIChatMode:p,handleSendAIMessage:f,handleImprove:j,handleRestoreHistoryItem:y,handleRecognizedText:b})=>{const{t:v}=Y(),{showErrorToast:w}=G(),[I,_]=s.useState(null),[F,z]=s.useState(null),[A,P]=s.useState(!0);s.useEffect((()=>{const e=localStorage.getItem("aiChatHelpVisible");null!==e&&P(JSON.parse(e))}),[]);const E=()=>{_(null),z(null)};return n.jsxs(o,{sx:{display:"flex",flexDirection:"column",overflow:"hidden",borderRadius:2,p:1,...(i||x)&&{position:"relative","&::before":{content:'""',position:"absolute",top:0,left:0,right:0,bottom:0,background:"linear-gradient(45deg, transparent 30%, rgba(25, 118, 210, 0.08) 50%, transparent 70%)",backgroundSize:"400% 400%",borderRadius:"inherit",zIndex:1,pointerEvents:"none",animation:"shimmer 2s ease-in-out infinite"},"&::after":{content:'""',position:"absolute",top:-2,left:-2,right:-2,bottom:-2,background:"linear-gradient(45deg, rgba(25, 118, 210, 0.3), rgba(25, 118, 210, 0.1), rgba(25, 118, 210, 0.3))",backgroundSize:"400% 400%",borderRadius:"inherit",zIndex:-1,animation:"shimmer 3s ease-in-out infinite reverse"},animation:"pulse 2s ease-in-out infinite","& > *":{position:"relative",zIndex:2}},"@keyframes shimmer":{"0%":{backgroundPosition:"100% 0%"},"100%":{backgroundPosition:"-100% 0%"}},"@keyframes pulse":{"0%, 100%":{opacity:1,transform:"scale(1)"},"50%":{opacity:.95,transform:"scale(1.005)"}}},children:[n.jsxs(o,{sx:{flex:1,overflow:"auto"},children:[A&&n.jsxs(d,{sx:{p:2,backgroundColor:"background.default",position:"relative",borderColor:"divider",borderWidth:1,borderStyle:"solid",mb:2},children:[n.jsx(g,{onClick:()=>{const e=!A;P(e),localStorage.setItem("aiChatHelpVisible",JSON.stringify(e))},sx:{position:"absolute",top:8,right:8,zIndex:1},size:"small",children:n.jsx(he,{})}),n.jsxs(k,{variant:"body2",sx:{pr:3},children:["✍️  ",v("taskForm.ai.placeholder")]})]}),l.length>0&&n.jsxs(o,{sx:{mb:2},children:[n.jsxs(k,{variant:"subtitle2",sx:{mb:1},children:[v("taskForm.ai.history"),":"]}),n.jsx(T,{dense:!0,sx:{bgcolor:"background.paper",borderRadius:1,border:"1px solid",borderColor:"divider"},children:l.slice().reverse().map((e=>n.jsxs($,{onClick:t=>((e,t)=>{_(e.currentTarget),z(t)})(t,e),sx:{cursor:"pointer","&:hover":{bgcolor:"action.hover"}},secondaryAction:n.jsx(n.Fragment,{children:n.jsx(g,{size:"small",sx:{ml:1},children:n.jsx(xe,{fontSize:"small"})})}),children:[n.jsxs(o,{sx:{display:"flex",alignItems:"center",justifyContent:"center",width:"50px",height:"50px",mr:1,overflow:"hidden"},children:["processing"===e.status&&n.jsx(C,{size:16}),"done"===e.status&&!e.image&&n.jsx(pe,{fontSize:"small",color:"success"}),"done"===e.status&&e.image&&n.jsx("img",{src:e.image,style:{width:"100%"}}),"error"===e.status&&n.jsx(ge,{fontSize:"small",color:"error"})]}),n.jsx(r,{sx:{textAlign:"left",width:"100%"},primary:e.message||v("taskForm.ai.imageRecognizedText"),secondary:e.timestamp.toLocaleTimeString(v("locale"),{timeStyle:"short"})})]},e.id)))})]}),!1,n.jsx(h,{fullWidth:!0,multiline:!0,minRows:3,maxRows:20,variant:"outlined",placeholder:v("taskForm.ai.messageInputPlaceholder"),value:e,onChange:e=>t(e.target.value),disabled:i,onKeyDown:t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),e.trim()&&!i&&f())},onPaste:async e=>{const t=e.clipboardData.items;for(const n of t)if(n.type.startsWith("image/")){e.preventDefault();const t=n.getAsFile();if(t){m(!0);try{const e=await new Promise((e=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.readAsDataURL(t)})),s=await Z.files.recognizeText({imageBase64:e,mode:"text"});s&&await b(s,e)}catch(s){w(v("taskForm.ai.errors.imageProcessing"))}finally{m(!1)}}}else if("text/plain"===n.type){const t=await new Promise((e=>n.getAsString(e)));if(t.match(/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)$/i)){e.preventDefault(),m(!0);try{const e=await fetch(t),s=await e.blob(),n=await new Promise((e=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(s)})),a=await Z.files.recognizeText({imageBase64:n,mode:"text"});a&&await b(a,n)}catch(s){w(v("taskForm.ai.errors.imageURLProcessing"))}finally{m(!1)}}}},sx:{mb:2},inputProps:{maxLength:1e3}}),n.jsx(o,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:n.jsx(g,{title:v("taskForm.ai.send"),onClick:()=>f(),disabled:i||!e.trim(),sx:{backgroundColor:"primary.main",color:"white","&:hover":{backgroundColor:"primary.dark",color:"white"}},children:n.jsx(fe,{})})}),n.jsxs(o,{sx:{display:"flex",flexDirection:"column",gap:1,justifyContent:"flex-end"},children:[n.jsx(c,{onClick:()=>{var e;return null==(e=document.getElementById("image-input"))?void 0:e.click()},disabled:x,startIcon:n.jsx(je,{}),children:v("taskForm.ai.recognize")}),n.jsx(c,{onClick:j,disabled:i,startIcon:n.jsx(ye,{}),children:v("taskForm.ai.improve")})]}),n.jsx("input",{type:"file",accept:"image/*",style:{display:"none"},id:"image-input",onChange:async e=>{var t;const s=null==(t=e.target.files)?void 0:t[0];if(s){m(!0);try{const e=await new Promise((e=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(s)})),t=await Z.files.recognizeText({imageBase64:e,mode:"text"});t?await b(t,e):w(v("taskForm.ai.errors.noTextRecognized"))}catch(n){w(v("taskForm.ai.errors.imageProcessing"))}finally{m(!1)}}}})]}),n.jsx(S,{anchorEl:I,open:Boolean(I),onClose:E,children:n.jsxs(a,{onClick:()=>{F&&(y(F),E())},children:[n.jsx(ke,{fontSize:"small",sx:{mr:1}}),v("taskForm.ai.rollback")]})})]})},Yt=({title:e,text:t,url:s,tagIds:a,tags:i,teacherId:r,onFullscreen:l,onValidateAnswers:d,hasQuizzes:x})=>{const{t:m}=Y();return n.jsxs(o,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[n.jsxs(o,{sx:{display:"flex",gap:1,alignItems:"center"},children:[n.jsx(k,{variant:"h4",sx:{flex:1},children:e||m("common.actions.preview")}),n.jsx(g,{sx:{marginLeft:"auto",display:{xs:"none",sm:"block"}},size:"small",onClick:l,children:n.jsx(be,{})})]}),n.jsx(ve,{task:{id:"preview",title:e,text:t,url:s||"",tags:i.filter((e=>a.includes(e.id))),teacher_id:r},isSaveAnswer:!1,workId:"preview",isTeacher:!1}),x&&n.jsx(o,{sx:{p:2,borderTop:1,borderColor:"divider",display:"flex",justifyContent:"center",mt:"auto",flex:"flex-end"},children:n.jsx(c,{variant:"contained",color:"primary",onClick:d,startIcon:n.jsx(pe,{}),children:m("common.actions.checkAnswers")})})]})},Xt=()=>{const{t:e}=Y(),t=we(Ce),[a,i]=s.useState(null),[r,l]=s.useState(null),d=()=>{i(null)},x=Boolean(a),m=(e,t)=>{const s=!!r&&((null==r?void 0:r.row)>=e&&(null==r?void 0:r.col)>=t);return{minWidth:"40px",height:"40px",backgroundColor:s?"primary.main":"transparent",color:s?"primary.contrastText":"primary.main","&:hover":{backgroundColor:"primary.main"},transition:"all 0.5s ease"}};return n.jsxs(n.Fragment,{children:[n.jsx(Se,{title:e("taskForm.table.title"),children:n.jsx("span",{onClick:e=>{i(e.currentTarget)},children:n.jsx(Ie,{fontSize:"small"})})}),n.jsx(A,{open:x,anchorEl:a,onClose:d,anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:n.jsx(o,{sx:{p:2},children:n.jsx(o,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:1,width:140},children:Array.from({length:5},((e,t)=>t+1)).map((e=>Array.from({length:3},((e,t)=>t+1)).map((s=>n.jsxs(c,{variant:"outlined",size:"small",onClick:()=>(t({rows:e,columns:s}),void d()),onMouseEnter:()=>l({row:e,col:s}),onMouseLeave:()=>l(null),sx:m(e,s),children:[e,"x",s]},`${e}-${s}`)))))})})})]})},Zt=({onChange:e})=>{const{t:t}=Y(),[a,l]=s.useState(!0);s.useEffect((()=>{const e=localStorage.getItem("componentsHelpVisible");null!==e&&l(JSON.parse(e))}),[]);const c=[{icon:n.jsx(_e,{}),title:t("components.hiddenText.title"),description:t("components.hiddenText.hint"),isInline:!0,mdText:` ${t("components.defaults.question")} 1 :hidden[${t("components.defaults.answer")} 1] , ${t("components.defaults.question")} 2 :hidden[${t("components.defaults.answer")} 2] `},{icon:n.jsx(Fe,{}),title:t("components.draggableAnswers.title"),description:t("components.draggableAnswers.hint"),isInline:!1,mdText:` ::answers{sticky="true"} \n${t("components.defaults.question")} 1 :hidden[${t("components.defaults.answer")} 1]\n${t("components.defaults.question")} 2 :hidden[${t("components.defaults.answer")} 2] \n`},{icon:n.jsx(ze,{}),title:t("components.multipleChoice.title"),description:t("components.multipleChoice.hint"),isInline:!0,mdText:` ${t("components.defaults.question")} :select[${t("components.defaults.option")} 1]{alt="${t("components.defaults.option")} 1;${t("components.defaults.option")} 2;${t("components.defaults.option")} 3" ordered="false"} `},{icon:n.jsx(Te,{}),title:t("components.checklist.title"),description:t("components.checklist.hint"),isInline:!1,mdText:`${t("components.defaults.question")}\n* [x] ${t("components.defaults.option")} 1\n* [ ] ${t("components.defaults.option")} 2\n* [ ] ${t("components.defaults.option")} 3\n`},{icon:n.jsx($e,{}),title:t("components.sortingOrdering.title"),description:t("components.sortingOrdering.hint"),isInline:!1,mdText:` :::sort\n- ${t("components.defaults.part.one")} 1\n- ${t("components.defaults.part.one")} 2\n- ${t("components.defaults.part.hintAdd")}\n- ${t("components.defaults.part.hintDelete")}\n:::\n`}],x=[{icon:n.jsx(je,{}),title:t("components.image.title"),description:t("components.image.hint"),isInline:!1,mdText:"![](https://teachair.app/apple-touch-icon.png)"},{icon:n.jsx(Ae,{}),title:t("components.audio.title"),description:t("components.audio.hint"),isInline:!1,mdText:` :audio[${t("components.defaults.audio")}]{src="https://teachair.app/assets/audio/w-${t("locale")}.mp3"} `},{icon:n.jsx(Pe,{}),title:t("components.embed.title"),description:t("components.embed.hint"),isInline:!1,mdText:' :iframe[]{src="https://www.youtube.com/watch?v=mvhmCKNQfu8" } '}],m=[{icon:n.jsx(Ie,{}),title:t("components.table.title"),description:t("components.table.hint"),isInline:!1,mdText:`\n|  ${t("components.defaults.question")}  |             |\n| :------: | :---------------------------------------: |\n| ${t("components.defaults.question")} 1 |  :select[A]{alt="A;B;C" ordered="false"}  |\n| ${t("components.defaults.question")} 2 |  :select[B]{alt="A;B;C" ordered="false"}  |\n| ${t("components.defaults.question")} 3 |  :select[C]{alt="A;B;C" ordered="false"}  |\n      `},{icon:n.jsx(Ee,{}),title:t("components.tip.title"),description:t("components.tip.hint"),isInline:!1,mdText:`\n:::tip\n${t("components.tip.hint")}\n:::\n      `}];return n.jsx(o,{children:n.jsxs(o,{sx:{display:"flex",flexDirection:"column",width:"100%",gap:2},children:[a&&n.jsxs(d,{sx:{px:3,py:2,backgroundColor:"background.default",position:"relative",borderColor:"divider",borderWidth:1,borderStyle:"solid"},children:[n.jsx(g,{onClick:()=>{const e=!a;l(e),localStorage.setItem("componentsHelpVisible",JSON.stringify(e))},sx:{position:"absolute",top:8,right:8,zIndex:1},size:"small",children:n.jsx(he,{})}),n.jsx(k,{variant:"body2",sx:{mb:2},children:t("components.help.title")}),n.jsx(o,{sx:{display:"flex",justifyContent:"center",borderRadius:"10px",border:"1px solid",borderColor:"divider",overflow:"hidden"},children:n.jsx("img",{style:{height:"27px",width:"320px",marginTop:"-2px"},src:"/icon-elements.gif"})})]}),n.jsx(b,{sx:{height:"100%",cursor:"pointer",borderColor:"primary.main",borderWidth:1,borderStyle:"solid","&:hover":{backgroundColor:"action.hover"}},onClick:()=>e(!1,`${t("components.defaults.task")}\n&nbsp;\n::essay`),children:n.jsxs(v,{children:[n.jsxs(o,{sx:{display:"flex",alignItems:"center",mb:2},children:[n.jsx(i,{sx:{minWidth:40},children:n.jsx(De,{})}),n.jsx(r,{primary:t("components.studentsSection.title"),primaryTypographyProps:{variant:"subtitle1",sx:{fontWeight:500}}}),n.jsxs(i,{sx:{minWidth:40,color:"primary.main",fontSize:16,display:"flex",alignItems:"center",justifyContent:"center"},children:[n.jsx(ye,{sx:{mr:1}}),"  AI"]})]}),n.jsx(k,{variant:"body2",color:"text.secondary",sx:{mb:1},children:t("components.studentsSection.hint")}),n.jsx(k,{variant:"body2",color:"text.secondary",sx:{mb:1},children:t("components.studentsSection.hint2")})]})}),n.jsx(k,{variant:"h6",sx:{mt:1,textAlign:"center"},children:t("components.help.text.title")}),c.map(((t,s)=>n.jsx(b,{sx:{height:"100%",cursor:"pointer",borderColor:"divider",borderWidth:1,borderStyle:"solid","&:hover":{backgroundColor:"action.hover"}},onClick:()=>e(t.isInline,t.mdText),children:n.jsxs(v,{children:[n.jsxs(o,{sx:{display:"flex",alignItems:"center",mb:2},children:[n.jsx(i,{sx:{minWidth:40},children:t.icon}),n.jsx(r,{primary:t.title,primaryTypographyProps:{variant:"subtitle1",sx:{fontWeight:500}}})]}),n.jsx(k,{variant:"body2",color:"text.secondary",children:t.description})]})},`text-component-${s}`))),n.jsx(k,{variant:"h6",sx:{mt:1,textAlign:"center"},children:t("components.help.media.title")}),[...x,...m].map(((t,s)=>n.jsx(b,{sx:{height:"100%",cursor:"pointer",borderColor:"divider",borderWidth:1,borderStyle:"solid","&:hover":{backgroundColor:"action.hover"}},onClick:()=>e(t.isInline,t.mdText),children:n.jsxs(v,{children:[n.jsxs(o,{sx:{display:"flex",alignItems:"center",mb:2},children:[n.jsx(i,{sx:{minWidth:40},children:t.icon}),n.jsx(r,{primary:t.title,primaryTypographyProps:{variant:"subtitle1",sx:{fontWeight:500}}})]}),n.jsx(k,{variant:"body2",color:"text.secondary",children:t.description})]})},`media-other-component-${s}`)))]})})},es=()=>{const e=we(We),{t:t}=Y();return n.jsx(Se,{title:t("taskForm.admonition.add"),children:n.jsx("span",{onClick:()=>{e({type:"containerDirective",name:"tip"})},children:n.jsx(Ee,{fontSize:"small"})})})},ts=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{var a;const i=e(),{taskId:r}=P(),[l]=t(),x=l.get("return_to")||"/tasks",u=l.get("copy_task_id"),p=l.get("work_id"),f=l.get("sharingKey"),j=l.get("title"),{user:y}=K(),{showErrorToast:b}=G(),{mode:v}=Re(),w=s.useRef(null),[C,S]=s.useState(null),[T,$]=s.useState(!0),[A,H]=s.useState(!1),[V,U]=s.useState([]),[q,J]=s.useState({title:j||"",text:"",url:"",tag_ids:[]}),[Q,ee]=s.useState(null),[te,se]=s.useState({}),[ne,re]=s.useState(!1),[oe,le]=s.useState(!1),[de,xe]=s.useState(0),[ue,pe]=s.useState((()=>localStorage.getItem("taskForm_sidePanelMode")||"components-help")),[ge,fe]=s.useState(""),[je,ke]=s.useState(!1),[be,ve]=s.useState([]),[we,Ce]=s.useState(!1),[Se,Ie]=s.useState("text");s.useEffect((()=>{ue?localStorage.setItem("taskForm_sidePanelMode",ue):localStorage.removeItem("taskForm_sidePanelMode")}),[ue]),s.useEffect((()=>{const e=["live-preview","ai-chat","components-help"].indexOf(ue||"live-preview");-1!==e&&e!==de&&xe(e)}),[ue,de]);const[_e,Fe]=s.useState(""),[ze,Te]=s.useState(null),[$e,Ae]=s.useState(!1),[Pe,Ee]=s.useState(""),[De,We]=s.useState(!1);s.useEffect((()=>{if(Pe){const t=`ai_${Pe}`,s=localStorage.getItem(t);if(s)try{const e=JSON.parse(s).map((e=>({...e,timestamp:new Date(e.timestamp)})));ve(e)}catch(e){}}}),[Pe]),s.useEffect((()=>{if(Pe){const e=`ai_${Pe}`;be.length>0?localStorage.setItem(e,JSON.stringify(be)):localStorage.removeItem(e)}}),[be,Pe]);const[It,_t]=s.useState(!1),[Ft,zt]=s.useState(null),[Tt,$t]=s.useState(null),At=(null==y?void 0:y.role)===X.ADMIN,Pt=(null==y?void 0:y.role)===X.TEACHER||At,Et=Boolean(r),[Dt,Wt]=s.useState(!1),Rt=E(),Bt=D(Rt.breakpoints.only("xs")),Mt=D(Rt.breakpoints.down("md")),Ot=D(Rt.breakpoints.up("lg")),{t:Lt}=Y(),Nt=s.useRef({title:j||"",text:"",url:"",tag_ids:[]});s.useEffect((()=>{_t(!0)}),[]),s.useEffect((()=>{if(!It)return;const e=r?`task_${r}`:"new_task";Ee(e);const t=localStorage.getItem(e);t&&(Te(t),Ae(!0))}),[r,It]);const Ht=e=>{if(Ae(!1),e&&ze)try{const e=JSON.parse(ze);Nt.current={...Nt.current,...e},J({...Nt.current});const s=document.querySelector('input[name="title"]');if(s&&(s.value=e.title||""),w.current&&(w.current.setMarkdown(e.text||""),w.current.focus()),Pe){const e=`ai_${Pe}`,s=localStorage.getItem(e);if(s)try{const e=JSON.parse(s).map((e=>({...e,timestamp:new Date(e.timestamp)})));ve(e)}catch(t){}}}catch(t){}else if(localStorage.removeItem(Pe),Te(null),Pe){const e=`ai_${Pe}`;localStorage.removeItem(e),ve([])}},Vt=s.useCallback(W((()=>{J({...Nt.current}),se((e=>{const t={...e};return Nt.current.title&&t.title&&delete t.title,Nt.current.text&&t.text&&delete t.text,Nt.current.tag_ids.length>0&&t.tag_ids&&delete t.tag_ids,t})),Pe&&localStorage.setItem(Pe,JSON.stringify(Nt.current))}),500),[Pe]),Ut=e=>{if(!e)return!1;const t=e.includes(":hidden")||e.includes(":essay")||e.includes(":sort")||e.includes(":select"),s=e.includes("[ ]")||e.includes("[x]");return t||s},qt=()=>{window.dispatchEvent(new CustomEvent("validateAllQuizzes",{detail:{taskId:"preview"}}))},Jt=(e,t)=>{xe(t);pe(["live-preview","ai-chat","components-help"][t])},Qt=()=>{le(!oe)},Kt=async e=>{const t=e||ge;if(!t||"string"!=typeof t||!t.trim())return;const s={id:Date.now().toString(),message:t,text:q.text||"",timestamp:new Date,status:"processing",type:Se};ve((e=>[s,...e])),fe(""),ke(!0);try{const e=await Z.tasks.chat({text:q.text,message:s.message,type:s.type});ve((e=>e.map((e=>e.id===s.id?{...e,status:"done"}:e)))),"text"===Se&&e&&(Fe(q.text),Nt.current.text=e,J({...Nt.current}),w.current&&(w.current.setMarkdown(e||""),w.current.focus()),Vt())}catch(n){ve((e=>e.map((e=>e.id===s.id?{...e,status:"error"}:e)))),b("Failed to get AI response. "+n)}finally{ke(!1)}},ts=()=>{null!==localStorage.getItem(Pe)?We(!0):i(x)},ss=e=>{e?(Te(null),localStorage.removeItem(Pe),ve([]),We(!1),i(x)):We(!1)};if(s.useEffect((()=>{let e=!0;return(async()=>{if(e){$(!0);try{const t=await Z.tags.getAll();if(!e)return;if(U(t),r){const t=await Z.tasks.getById(r);if(!e)return;S(t),Fe(t.text||"");const s={title:t.title,text:t.text||"",tag_ids:t.tags.map((e=>e.id))};Nt.current=s,J(s)}else if(u){const t=await Z.tasks.getById(u);if(!e)return;S(t),Fe(t.text||"");const s={title:`Copy of ${t.title}`,text:t.text||"",tag_ids:t.tags.map((e=>e.id))};Nt.current=s,J(s)}else if(f){const t=await Z.tasks.getBySharingKey(f);if(!e)return;S(t),Fe(t.text||"");const s={title:t.title,text:t.text||"",tag_ids:t.tags.map((e=>e.id))};Nt.current=s,J(s)}else if(j&&!r&&!u&&!f){const e={title:j,text:"",tag_ids:[]};Nt.current=e,J(e)}p&&ee(await Z.works.getById(p))}catch(t){const s=t instanceof Error?t.message:"Failed to load data. Please try again.";if(!e)return;b(s),i(x)}finally{if(!e)return;$(!1)}}})(),()=>{e=!1}}),[r,u,f,j,i,x]),!Pt)return i(x),null;function ns(e=!1){return n.jsxs(o,{sx:{display:"flex",gap:0,opacity:e?1:.5,pointerEvents:e?"auto":"none"},children:[n.jsx(mt,{options:["Bold","Italic"]}),n.jsx(ut,{options:["bullet","number"]}),n.jsx(ht,{}),n.jsx(pt,{editorRef:w}),n.jsx(gt,{editorRef:w}),n.jsx(ft,{editorRef:w}),n.jsx(jt,{editorRef:w}),n.jsx(yt,{editorRef:w}),n.jsx(kt,{editorRef:w}),n.jsx(bt,{}),n.jsx(vt,{}),n.jsx(wt,{}),n.jsx(Xt,{}),n.jsx(es,{})]})}return n.jsxs(o,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[T?n.jsx(ce,{message:Lt(Et?"taskForm.loading.task":"taskForm.loading.default")}):n.jsxs(o,{sx:{display:{xs:"block",lg:"flex"},gap:2,height:"100%",overflow:"hidden",justifyContent:"center",alignItems:"center"},children:[n.jsxs(o,{sx:{display:"flex",flex:"3 1",flexDirection:"column",width:"100%",maxWidth:"800px",height:"100%",position:"relative",overflow:"hidden",margin:"0 auto"},children:[n.jsx(o,{sx:{flex:1,overflow:"auto",p:1,pt:0},children:n.jsx(o,{width:"100%",sx:{display:"flex",justifyContent:"space-between"},children:n.jsx(o,{sx:{flex:1,display:"flex",flexDirection:"column",width:"100%",position:"relative"},children:n.jsxs(o,{component:"form",noValidate:!0,sx:{display:"flex",flexDirection:"column",height:"100%",minHeight:0,flex:1},children:[Q&&n.jsx(o,{sx:{mb:1},children:n.jsx(c,{variant:"text",color:"primary",size:"small",startIcon:n.jsx(Be,{}),onClick:ts,children:Q.name})}),n.jsxs(d,{sx:{p:2,pt:0,pb:1},children:[n.jsx(h,{margin:"normal",name:"title",label:Lt("taskForm.title.label"),type:"text",size:"small",fullWidth:!0,variant:"outlined",defaultValue:q.title,onChange:e=>{Nt.current.title=e.target.value,Vt()},error:!!te.title,helperText:te.title,inputProps:{autoComplete:"off",maxLength:100},InputProps:{startAdornment:n.jsx(Me,{sx:{mr:1,color:"text.secondary"},fontSize:"small"})}}),n.jsx(m,{multiple:!0,size:"small",options:V,getOptionLabel:e=>e.name,value:V.filter((e=>Nt.current.tag_ids.includes(e.id))),onChange:(e,t)=>{const s=t.map((e=>e.id));Nt.current.tag_ids=s,J({...Nt.current}),Vt()},disabled:Dt,disableCloseOnSelect:!0,renderInput:e=>n.jsxs(o,{sx:{position:"relative"},children:[n.jsx(h,{...e,label:Lt("taskForm.tags.label"),margin:"normal",error:!!te.tag_ids,InputProps:{...e.InputProps,startAdornment:n.jsxs(n.Fragment,{children:[n.jsx(ie,{sx:{m:.25,ml:1,color:"text.secondary"},fontSize:"small"}),e.InputProps.startAdornment]})}}),Dt&&n.jsx(R,{sx:{position:"absolute",bottom:0,left:0,right:0,height:2}})]}),filterOptions:(e,{inputValue:t})=>{const s=e.filter((e=>e.name.toLowerCase().includes(t.toLowerCase())));return t&&!s.length?[{id:"new",name:t,creator_id:(null==y?void 0:y.id)||""}]:s},renderOption:(e,t)=>"new"===t.id?n.jsx("li",{...e,onClick:async e=>{e.stopPropagation(),Wt(!0);try{const e=await Z.tags.create({name:t.name});U((t=>[...t,e])),Nt.current.tag_ids=[...Nt.current.tag_ids,e.id],J({...Nt.current})}catch(s){const e=s instanceof Error?s.message:"Failed to create tag. Please try again.";b(e)}finally{Wt(!1)}},children:Lt("taskForm.tags.create",{name:t.name})}):n.jsx("li",{...e,children:t.name})}),te.tag_ids&&n.jsx(B,{error:!0,children:te.tag_ids}),n.jsxs(o,{sx:{display:"flex",flexDirection:"row",gap:1,justifyContent:"flex-end",mt:1},children:[n.jsxs(c,{size:"small",onClick:()=>{Jt(0,2),Qt()},children:[n.jsx(ae,{sx:{mr:1}}),Lt("taskForm.buttons.addElement")]}),n.jsxs(c,{size:"small",onClick:()=>{Jt(0,1),Qt()},children:[n.jsx(ye,{sx:{mr:1}}),Lt("taskForm.ai.title")]})]})]}),n.jsx(d,{id:"task-form-editor-paper",sx:{flex:1,display:"flex",flexDirection:"column",minHeight:0,position:"relative",mt:2,mb:2,border:"1px solid",borderColor:"divider"},children:n.jsx(Oe,{ref:w,markdown:q.text,autoFocus:!1,onChange:e=>{Nt.current.text=e,Vt()},placeholder:Lt("taskForm.editor.placeholder"),className:"dark"===v?"mdxeditor dark-theme dark-editor":"mdxeditor light-theme light-editor",translation:(e,t,s)=>Lt("editor."+e,{defaultValue:t,...s}),plugins:[Le(),Ne(),He(),Ve({disableImageResize:!0,disableImageSettingsButton:!0,imageUploadHandler:async e=>{const t=URL.createObjectURL(e);zt(t);const s=await Z.files.uploadImage(e);return s.url?(zt(null),URL.revokeObjectURL(t),s.url):(b("Failed to upload image. Please try again."),t)},EditImageToolbar:et}),Ue(),qe(),Je(),Qe({disableAutoLink:!0}),Ke(),Ge({viewMode:"rich-text",diffMarkdown:_e}),Ye({escapeUnknownTextDirectives:!0,directiveDescriptors:[tt,st,nt,at,it,rt,ot,lt]}),Xe(1e5),Ze({toolbarClassName:"mdxeditor-toolbar-full ",toolbarContents:()=>n.jsx(ct,{options:Mt?[]:["source"],children:n.jsx(dt,{options:[{when:e=>{var t;return"root"!==(null==(t=null==e?void 0:e.rootNode)?void 0:t.getType())},contents:()=>ns(!1)},{fallback:()=>ns(!0)}]})})})]})})]})})})}),n.jsxs(o,{sx:{width:"100%",p:1,display:"flex",justifyContent:"space-between",position:"sticky",bottom:0,left:0,zIndex:1},children:[n.jsx(o,{sx:{display:"flex-start",gap:2},children:n.jsx(c,{size:Mt?"small":"medium",variant:"outlined",color:"inherit",onClick:ts,children:Lt("taskForm.buttons.cancel")})}),n.jsxs(o,{sx:{display:"flex",gap:2,alignItems:"center"},children:[n.jsx(M,{title:Lt("taskForm.buttons.preview"),children:n.jsx(c,{size:Mt?"small":"medium",variant:"outlined",startIcon:n.jsx(xt,{}),onClick:()=>{Jt(0,0),Qt()},children:Lt("taskForm.buttons.preview")})}),n.jsx(M,{title:A?Lt("taskForm.loading.saving"):q.title.trim()?q.text.trim()?"":Lt("taskForm.content.error.required"):Lt("taskForm.title.error.required"),children:n.jsx("span",{children:n.jsx(c,{size:Mt?"small":"medium",variant:"contained",color:"primary",onClick:async()=>{const{isValid:e,errors:t}=Ct(St,q);if(e){H(!0);try{if(Et&&r)await Z.tasks.update(r,q);else{const e=await Z.tasks.create(q);p&&await Z.works.addTask(p,e.id)}Te(null),localStorage.removeItem(Pe),ve([]),i(x)}catch(s){const e=s instanceof Error?s.message:"Failed to save task. Please try again.";b(e)}finally{H(!1)}}else se(t)},disabled:A||!q.title.trim()||!q.text.trim(),children:Lt(A?"taskForm.loading.saving":Et?"common.actions.save":"taskForm.buttons.create")})})})]})]})]}),n.jsx(O,{anchor:"right",open:oe,onClose:Qt,variant:Ot?"permanent":"temporary",sx:{width:"93%",maxWidth:"400px",flexShrink:0,"& .MuiDrawer-paper":{width:"93%",maxWidth:"400px"}},children:n.jsxs(o,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[n.jsxs(o,{sx:{borderBottom:1,borderColor:"divider",display:"flex",alignItems:"center",px:1},children:[!Ot&&n.jsx(g,{onClick:()=>le(!1),sx:{mr:1},children:Bt?n.jsx(Be,{}):n.jsx(he,{})}),n.jsxs(L,{value:de,onChange:Jt,variant:"fullWidth",sx:{flex:1,"& .MuiTab-root":{minHeight:48,fontSize:"0.875rem"}},children:[n.jsx(N,{value:2,label:Lt("taskForm.buttons.elements"),iconPosition:"start"}),n.jsx(N,{icon:n.jsx(ye,{}),value:1,label:Lt("taskForm.ai.titleShort"),iconPosition:"start"}),n.jsx(N,{icon:n.jsx(xt,{}),value:0,label:Lt("taskForm.buttons.preview"),iconPosition:"start"})]})]}),n.jsxs(o,{sx:{flex:1,overflow:"auto",p:2},children:[0===de&&n.jsx(n.Fragment,{children:(null==(a=null==q?void 0:q.text)?void 0:a.length)>0?n.jsx(Yt,{title:q.title||"",text:q.text||"",tagIds:q.tag_ids,tags:V,teacherId:(null==y?void 0:y.id)||"",onClose:()=>le(!1),onFullscreen:()=>re(!0),onValidateAnswers:qt,hasQuizzes:Ut(q.text||"")}):n.jsx(k,{variant:"body1",sx:{textAlign:"center",mt:2},children:Lt("taskForm.preview.empty")})}),1===de&&n.jsx(Gt,{aiChatMessage:ge,setAIChatMessage:fe,isSendingAIMessage:je,aiChatHistory:be,isProcessingAttachment:we,setIsProcessingAttachment:Ce,aiChatMode:Se,setAIChatMode:Ie,handleSendAIMessage:Kt,handleImprove:async()=>{if(!q.text)return void b(Lt("taskForm.preview.empty"));const e="✨ "+Lt("taskForm.ai.improve");fe(e),Kt(e)},handleRestoreHistoryItem:e=>{fe(e.message),Nt.current.text=e.text,J({...Nt.current}),w.current&&(w.current.setMarkdown(e.text||""),w.current.focus()),Vt(),ve((t=>{const s=t.findIndex((t=>t.id===e.id));return-1===s?t:t.slice(s+1)}))},handleRecognizedText:async(e,t)=>{const s={id:Date.now().toString(),message:"",text:q.text,timestamp:new Date,status:"done",image:void 0,type:Se};ve((e=>[s,...e]));const n=`\n${e}\n`,a=q.text+n;Nt.current.text=a,J({...Nt.current}),w.current&&(w.current.setMarkdown(a),w.current.focus()),Vt()}}),2===de&&n.jsx(Zt,{onChange:(e,t="")=>{if(!w.current)return;const s=e?`&nbsp;${t}&nbsp;`:`&nbsp;\n${t}\n&nbsp;`;w.current&&w.current.focus((()=>{var e;null==(e=w.current)||e.insertMarkdown(s)}),{defaultSelection:"rootEnd"}),le(!1)}})]})]})})]}),n.jsx(me,{open:ne,onClose:()=>re(!1),task:{id:"preview",title:q.title||"",text:q.text||"",tags:V.filter((e=>q.tag_ids.includes(e.id))),teacher_id:(null==y?void 0:y.id)||""},hasQuizzes:Ut(q.text),onValidateAnswers:qt}),n.jsxs(I,{open:$e,onClose:()=>Ae(!1),children:[n.jsx(_,{children:Lt("taskForm.dialog.unsavedChanges.title")}),n.jsx(F,{children:n.jsx(k,{children:Lt("taskForm.dialog.unsavedChanges.message")})}),n.jsxs(z,{children:[n.jsx(c,{onClick:()=>Ht(!1),color:"error",children:Lt("taskForm.dialog.unsavedChanges.discard")}),n.jsx(c,{onClick:()=>Ht(!0),variant:"contained",children:Lt("taskForm.dialog.unsavedChanges.restore")})]})]}),n.jsxs(I,{open:De,onClose:()=>We(!1),children:[n.jsx(_,{children:Lt("taskForm.dialog.cancel.title")}),n.jsx(F,{children:n.jsx(k,{children:Lt("taskForm.dialog.cancel.message")})}),n.jsxs(z,{children:[n.jsx(c,{onClick:()=>ss(!1),children:Lt("taskForm.dialog.cancel.keep")}),n.jsx(c,{onClick:()=>ss(!0),variant:"contained",color:"error",children:Lt("taskForm.dialog.cancel.confirm")})]})]}),n.jsxs(I,{open:!!Ft,onClose:()=>zt(null),maxWidth:"sm",fullWidth:!0,children:[n.jsx(_,{children:Lt("taskForm.dialog.image.title")}),n.jsxs(F,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[n.jsx(o,{component:"img",src:Ft||"",alt:"Preview",sx:{maxWidth:"100%",maxHeight:"300px",objectFit:"contain"}}),n.jsx(ce,{message:Lt("taskForm.loading.image")})]})]}),n.jsxs(I,{open:!!Tt,onClose:()=>$t(null),maxWidth:"sm",fullWidth:!0,children:[n.jsx(_,{children:Lt("taskForm.dialog.generatedImage.title")}),n.jsx(F,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:n.jsx(o,{component:"img",src:(as=Tt,as?as.startsWith("data:image")?as:`data:image/jpeg;base64,${as}`:""),alt:"Generated",sx:{maxWidth:"100%",maxHeight:"300px",objectFit:"contain"}})}),n.jsx(z,{children:n.jsx(c,{onClick:()=>$t(null),children:Lt("taskForm.dialog.image.close")})})]})]});var as}},Symbol.toStringTag,{value:"Module"})),ss=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const{t:l}=Y(),{user:x}=K(),u=e(),[p]=t(),f=p.get("return_to")||"",j=p.get("studentId"),b=p.get("work_id"),v="true"===p.get("edit"),w="true"===p.get("copy"),C="true"===p.get("send"),T="true"===p.get("onboarding"),$="true"===p.get("template"),A=p.get("folder"),[P,W]=s.useState([]),[R,B]=s.useState(null),[U,q]=s.useState([]),[J,Q]=s.useState(null),[ee,te]=s.useState(""),[se,ne]=s.useState(!1),[ie,oe]=s.useState(null),[le,pe]=s.useState(0),[ge,fe]=s.useState([]),[je,ye]=s.useState(!0),[ke,be]=s.useState(!1),[ve,we]=s.useState(null),[Ce,Se]=s.useState({}),[Ie,_e]=s.useState(v||$?1:0),[Fe,ze]=s.useState(!1),Te=(null==x?void 0:x.role)===X.TEACHER||(null==x?void 0:x.role)===X.ADMIN,{showErrorToast:$e,showToast:Ae}=G(),[Pe,Ee]=s.useState(null),[De,We]=s.useState(!1),[Re,Me]=s.useState(0),[Oe,Le]=s.useState(0),[Ne,He]=s.useState(null),[Ve,Ue]=s.useState([]),[qe,Je]=s.useState(null),[Qe,Ke]=s.useState(null),[Ge,Ye]=s.useState(!1),[Xe,Ze]=s.useState(null),[et,tt]=s.useState(0),st=E(),nt=D(st.breakpoints.up("lg")),at=D(st.breakpoints.only("xs")),it=J&&J.student_id===J.teacher_id;s.useEffect((()=>{(async()=>{try{const e=await Z.folders.getAll(0,100);if(Ue(e),A){const t=e.find((e=>e.id===A));if(t)He(t);else{const e=await Z.folders.getById(A);e&&He(e)}}}catch(e){$e(ue(e))}})()}),[A]),s.useEffect((()=>{(async()=>{ye(!0),we(null);try{const e=await Z.contracts.getAll(0,100),t=e.filter((e=>e.status===It.AGREED||e.status===It.PENDING));fe(t);const s=new Map;e.forEach((e=>{e.student&&!s.has(e.student_id)&&s.set(e.student_id,e.student)}));const n=Array.from(s.values()).sort(((e,t)=>{const s=_t(e).toLowerCase(),n=_t(t).toLowerCase();return s.localeCompare(n)}));if(Te&&!C){const e={id:x.id,first_name:l("templates.titleSingle"),last_name:null,photo_url:null,is_template:!0};n.unshift(e)}if(W(n),we(null),$&&Te&&x){const e=n.find((e=>e.id===x.id&&e.is_template));if(e){B(e);const t=new Date,s=t.getDate().toString().padStart(2,"0"),n=(t.getMonth()+1).toString().padStart(2,"0"),a=`${s}.${n}.${t.getFullYear()}`;te(`${l("templates.titleSingle")} - ${a}`)}}else if(j){const e=n.find((e=>e.id===j));if(e){B(e);const t=new Date,s=t.getDate().toString().padStart(2,"0"),n=(t.getMonth()+1).toString().padStart(2,"0"),a=`${s}.${n}.${t.getFullYear()}`;te(`${l("works.creator.forStudent")} ${_t(e)||e.id} - ${a}`),He(null),_e(1)}}b&&(v||w)&&await rt(b)}catch(e){const t=ue(e);we(t),$e(t)}finally{ye(!1)}})()}),[j,b,v,w,Re,$]);const rt=async e=>{try{const t=await Z.works.getById(e);Q(t),te(w&&!C?`Copy of ${t.name}`:t.name);const s=(await Promise.all(t.task_states.sort(((e,t)=>(e.order||0)-(t.order||0))).map((async e=>{if(!e.task)try{return await Z.tasks.getById(e.task_id)}catch(t){return null}return e.task})))).filter((e=>null!==e));q(s)}catch(t){const e=t instanceof Error?t.message:"Failed to load work data. Please try again.";we(e),$e(e)}};s.useEffect((()=>{if(J&&P.length>0&&v){const e=P.find((e=>e.id===J.student_id));e?B(e):$e("Student for this work could not be found. Please select a student manually.")}}),[J,P,v]),s.useEffect((()=>{if(R&&!R.is_template){const e=ge.find((e=>e.student_id===R.id&&e.teacher_id===(null==x?void 0:x.id)&&e.status===It.AGREED)),t=ge.find((e=>e.student_id===R.id&&e.teacher_id===(null==x?void 0:x.id)&&e.status===It.PENDING)),s=e||t;oe(s||null),s?(pe(s.balance),s.balance>0?ne(!0):ne(!1)):(pe(0),ne(!1))}else oe(null),pe(0),ne(!1)}),[R,ge,null==x?void 0:x.id]);const ot=e=>{if(B(e),e){const t=new Date,s=`${t.getDate().toString().padStart(2,"0")}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getFullYear()}`;e.is_template?te(`${l("templates.titleSingle")} - ${s}`):te(`${l("works.creator.forStudent")} ${_t(e)||e.id} - ${s}`)}else te("")},lt=e=>{q((t=>t.some((t=>t.id===e.id))?t.filter((t=>t.id!==e.id)):[...t,e]))},ct=async(e=!0)=>{if(!R)return void we("Please select a student");const t={name:ee,student_id:R.id,task_ids:U.map((e=>e.id)),contract_id:se&&ie?ie.id:void 0,folder_id:null==Ne?void 0:Ne.id,is_draft:!e},{isValid:s,errors:n}=Ct(Lt,t);if(!s)return void Se(n);be(!0),we(null);let a=null;try{if(v&&J){a=(await Z.works.update(J.id,t)).id}else{a=(await Z.works.create(t)).id}if(e){if(Ae(l(v&&J?"templates.message.workSuccessfullyUpdated":"templates.message.workSuccessfullyCreated"),"success"),f&&"null"!=f){const e=f+(f.includes("?")?"&":"?")+"new_work_id="+a;return void u(e)}return(null==R?void 0:R.is_template)?void u("/templates?new_work_id="+a):void u("/works?new_work_id="+a)}return a}catch(i){const e=i instanceof Error?i.message:`Failed to ${v?"update":"create"} work. Please try again.`;we(e),$e(e),be(!1)}},dt=e=>{Ee(e),We(!0)},xt=()=>{We(!1)};s.useCallback((()=>{Me((e=>e+1))}),[]);const mt=()=>{if(Ie>=1)ze(!0);else if(f){const e=f+(f.includes("?")?"&":"?")+"share_key="+(null==J?void 0:J.share_key);u(e)}else(null==R?void 0:R.is_template)?u("/templates?share_key="+(null==J?void 0:J.share_key)):u("/works?share_key="+(null==J?void 0:J.share_key))},ut=()=>{ze(!1)},ht=()=>{Je(null),Ke(null)},pt=e=>{Ze(e),Ye(!0),tt(0)};if(je)return n.jsx(ce,{message:l("common.loading")});const gt=Ge&&(!!Xe||0!==et);return n.jsxs(o,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[je?n.jsx(ce,{message:l(v?"taskForm.loading.task":"taskForm.loading.default")}):n.jsxs(o,{sx:{display:gt?{xs:"block",lg:"flex"}:"block",gap:2,height:"100%",overflow:"hidden",justifyContent:"center",alignItems:"center"},children:[n.jsxs(o,{sx:{display:"flex",flex:"3 1",flexDirection:"column",width:"100%",maxWidth:"800px",height:"100%",position:"relative",overflow:"hidden",margin:"0 auto"},children:[n.jsx("style",{children:`\n          .dragged-item {\n            background-color: ${st.palette.primary.main} !important;\n          }\n        `}),n.jsxs(o,{sx:{display:"flex",flexDirection:"column",flex:1,overflow:"auto",p:1,pt:0,height:"100%",".sortable-list":{position:"relative","& .item":{transition:"background-color 0.2s, box-shadow 0.2s, transform 0.1s","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.04)"},userSelect:"none",cursor:"default"},"& .dragged-item":{backgroundColor:"primary.main!important",color:"white!important",boxShadow:"0 10px 20px rgba(0, 0, 0, 0.3)!important",opacity:.95,zIndex:1e3,transform:"scale(1.03)",borderRadius:"4px",pointerEvents:"none",cursor:"grabbing","& .MuiTypography-root":{color:"white!important"},"& svg":{color:"white!important"}}}},children:[n.jsx(o,{sx:{mb:2,ml:1,flexShrink:0,display:w||C||v?"flex":"none"},children:n.jsxs(k,{variant:"body2",children:[l(v?"works.tabs.step1.edit":w?C?"works.tabs.step1.send":"works.tabs.step1.copy":"works.tabs.step1.create"),' "',null==J?void 0:J.name,'"']})}),0===Ie&&n.jsxs(n.Fragment,{children:[n.jsxs(d,{sx:{py:1,px:3,mb:1,display:"flex",flexDirection:"column"},children:[n.jsx(o,{sx:{mt:1},children:(null==R?void 0:R.is_template)?n.jsxs(k,{variant:"h6",gutterBottom:!0,sx:{my:1},children:[l("works.creator.templateHint"),Ne?` ${l("works.creator.inFolder")} "${null==Ne?void 0:Ne.title}"`:""]}):n.jsx(k,{variant:"h6",gutterBottom:!0,sx:{my:1},children:l("templates.createForStudent.title")})}),n.jsx(o,{sx:{mt:1,mb:1},children:P.length>0?n.jsxs(n.Fragment,{children:[it&&n.jsx(k,{variant:"body2",color:"text.secondary",sx:{mb:3},children:l("templates.createForStudent.description")}),n.jsx(m,{value:R,onChange:(e,t)=>ot(t),options:P,getOptionLabel:e=>_t(e),renderInput:e=>n.jsx(h,{...e,placeholder:l("works.creator.selectStudent"),required:!0,autoFocus:!0,error:!!Ce.student_id,helperText:Ce.student_id,InputProps:{...e.InputProps,startAdornment:n.jsxs(n.Fragment,{children:[R&&(R.is_template?n.jsx(Ft,{sx:{mr:1,color:"primary.main"}}):n.jsx(H,{src:R.photo_url||void 0,sx:{width:24,height:24,mr:1},children:zt(R)})),e.InputProps.startAdornment]})}}),renderOption:(e,t)=>n.jsx(o,{component:"li",...e,sx:{display:"flex",alignItems:"center",borderBottom:t.is_template?"1px solid":"none",borderColor:t.is_template?"divider":"transparent"},children:n.jsxs(o,{sx:{display:"flex",alignItems:"center",p:1},onClick:()=>ot(t),children:[t.is_template?n.jsx(Ft,{sx:{mr:1,color:"primary.main"}}):n.jsx(H,{src:t.photo_url||void 0,sx:{width:24,height:24,mr:1},children:zt(t)}),n.jsx(k,{sx:{fontWeight:t.is_template?500:400,color:t.is_template?"primary.main":"inherit"},children:t.is_template?l("templates.titleSingle"):_t(t)||t.id})]})})}),n.jsx(c,{variant:R?"contained":"text",color:"primary",fullWidth:!0,onClick:()=>_e(1),disabled:!R,endIcon:n.jsx(Tt,{}),sx:{mt:2},children:l("works.actions.continue")})]}):n.jsx(n.Fragment,{children:it&&n.jsx(k,{variant:"body2",color:"text.secondary",children:l("templates.addFirstStudentDescription")})})}),R&&n.jsx(n.Fragment,{children:n.jsx(c,{variant:"text",color:"secondary",size:"small",onClick:()=>B(null),disabled:!R,children:l("common.actions.change")})})]}),!R&&n.jsxs(d,{sx:{p:3,pt:1,mt:3,display:"flex",flexDirection:"column"},children:[n.jsx(k,{variant:"h6",gutterBottom:!0,sx:{my:2},children:l("templates.templateLinks.title")}),C&&J&&!(null==J?void 0:J.share_key)&&n.jsx(n.Fragment,{children:n.jsx(k,{variant:"body1",color:"text.secondary",sx:{mb:1},children:l("templates.templateLinks.description")})}),C&&J&&n.jsx(n.Fragment,{children:n.jsx(k,{variant:"body2",color:"text.secondary",sx:{mb:3},children:l("templates.templateLinks.description2")})}),!C&&n.jsx(n.Fragment,{children:n.jsxs(o,{sx:{display:"flex",flexDirection:"column",alignItems:"flex-start",gap:1},children:[n.jsx(k,{variant:"body1",color:"text.secondary",sx:{mb:1},children:l("templates.createNewTemplate.description")}),n.jsxs(o,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},justifyContent:"space-between",gap:2,width:"100%",mt:1},children:[n.jsx(c,{variant:"outlined",fullWidth:!0,color:"primary",onClick:()=>{ot(P[0])},children:l("templates.createNewTemplate.title")}),n.jsxs(c,{variant:"text",fullWidth:!0,color:"secondary",onClick:()=>{u("/templates")},children:[l("common.my.many")," ",l("navigation.templates")]})]})]})}),w&&it&&J&&n.jsx($t,{work:J,onCreate:e=>{Q((t=>t?{...t,share_key:e}:t))},onDelete:()=>{Q((e=>e?{...e,share_key:null}:e))},onDone:()=>mt()})]})]}),1===Ie&&n.jsxs(d,{sx:{py:1,px:3,display:"flex",flexDirection:"column",overflow:"hidden",height:"100%"},children:[n.jsx(o,{sx:{mt:1,mb:0,display:"flex",alignItems:"center",gap:1},children:n.jsxs(o,{sx:{flex:1,display:"flex",alignItems:"center",borderBottom:1,borderColor:"divider",pb:1},children:[!0===(null==R?void 0:R.is_template)&&n.jsx(n.Fragment,{children:n.jsxs(k,{variant:"h6",gutterBottom:!0,sx:{my:1},children:[l(v?"works.creator.templateHintEditing":"works.creator.templateHint"),"  ",Ne?`${l("works.creator.inFolder")} "${null==Ne?void 0:Ne.title}"`:""]})}),R&&!R.is_template&&n.jsxs(o,{sx:{flex:1,display:"flex",justifyContent:"space-between"},children:[n.jsxs(o,{sx:{display:"flex",flexDirection:"column",alignItems:"flex-start",gap:1},children:[n.jsx(k,{variant:"body2",sx:{mb:.5},children:l("works.creator.byStudent")}),n.jsxs(o,{sx:{display:"flex",flexDirection:"row",alignItems:"center",gap:1},children:[n.jsx(H,{src:(null==R?void 0:R.photo_url)||void 0,sx:{width:32,height:32,mr:1},children:zt(R)}),n.jsx(k,{variant:"h6",sx:{flex:1,overflow:"hidden"},children:_t(R)})]})]}),v?null:n.jsxs(o,{sx:{display:"flex",flexDirection:"column",alignItems:"flex-start",gap:1},children:[ie&&le>0&&n.jsx(k,{variant:"body2",children:l("works.creator.availableLessons",{count:le})}),ie&&le<=0&&n.jsx(k,{variant:"body2",children:l("works.creator.noLessonsAvailable")}),ie&&le>0&&n.jsx(V,{control:n.jsx(y,{checked:se,onChange:e=>ne(e.target.checked),color:"primary"}),label:n.jsx(k,{sx:{whiteSpace:"nowrap"},color:se?"primary":"default",children:l("works.creator.redeemLesson")})})]})]})]})}),n.jsxs(o,{sx:{my:1},children:[n.jsx(h,{fullWidth:!0,autoFocus:!0,label:(null==R?void 0:R.is_template)?l("templates.actions.templateName"):l("templates.actions.workName"),value:ee,onChange:e=>te(e.target.value),margin:"normal",required:!0,error:!!Ce.name,helperText:Ce.name}),!R||!ee.trim()&&n.jsx(k,{variant:"body2",color:"error.main",sx:{p:1,textAlign:"center"},children:R?ee.trim()?"":l("works.creator.enterWorkName"):l("works.creator.selectStudent")})]}),n.jsxs(n.Fragment,{children:[n.jsxs(d,{id:"tasks-list-paper",variant:"outlined",sx:{mt:1,mb:1,overflow:"hidden",maxHeight:"100%",overflowY:"auto",overflowX:"hidden",position:"relative",...T&&{animation:"pulse 3s ease-in-out","@keyframes pulse":{"0%":{boxShadow:"0 0 0 0 rgba(25, 118, 210, 0.7)",transform:"scale(1)"},"50%":{boxShadow:"0 0 0 10px rgba(25, 118, 210, 0)",transform:"scale(1.02)"},"100%":{boxShadow:"0 0 0 0 rgba(25, 118, 210, 0)",transform:"scale(1)"}}}},children:[U.length>0?n.jsx(At,{onSortEnd:(e,t)=>{e<0||t<0||e>=U.length||t>=U.length||e===t||(q((s=>{const n=[...s],[a]=n.splice(e,1);return n.splice(t,0,a),n})),Le((e=>e+1)))},lockAxis:"y",className:"sortable-list",draggedItemClassName:"dragged-item",allowDrag:!0,as:"div",children:U.map(((e,t)=>n.jsx(Pt,{children:n.jsxs(o,{sx:{display:"flex",alignItems:"center",px:2,py:1,borderBottom:1,borderColor:"divider",cursor:"pointer","&:hover":{backgroundColor:"action.hover"}},children:[n.jsxs(o,{sx:{display:"flex",alignItems:"center",flex:1},children:[n.jsx(Et,{children:n.jsx(Dt,{sx:{mr:1,color:"primary.main",cursor:"grab"}})}),n.jsx(o,{sx:{flex:1},onClick:()=>pt(e),children:n.jsx(k,{variant:"body1",sx:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden",textOverflow:"ellipsis"},children:`${t+1}. ${e.title}`})})]}),n.jsx(o,{sx:{display:"flex",alignItems:"center"},children:n.jsx(M,{title:l("common.actions.actions"),children:n.jsx(g,{edge:"end",onClick:t=>((e,t)=>{e.preventDefault(),e.stopPropagation(),Je(e.currentTarget),Ke(t)})(t,e),size:"small",children:n.jsx(xe,{})})})})]})},`task-${e.id}-pos-${t}`)))},`sortable-list-${Oe}`):null,n.jsx(o,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},justifyContent:"flex-end",gap:0,width:"100%",p:1},children:R&&n.jsxs(n.Fragment,{children:[n.jsx(c,{variant:"text",color:"primary",onClick:()=>{ct(!1).then((e=>{e&&u(`/tasks/new?work_id=${e}&return_to=/works/assign/%3Fwork_id=${e}%26folder_id=${null==Ne?void 0:Ne.id}%26edit=true%26return_to=${f}`)}))},startIcon:n.jsx(ae,{}),disabled:ke||!R||!ee.trim(),children:l("tasks.actions.createTask")}),n.jsx(c,{variant:"text",color:"primary",onClick:()=>{tt(1),Ye(!0)},startIcon:n.jsx(Wt,{}),children:l("works.creator.addExistingTask")})]})})]}),n.jsxs(S,{anchorEl:qe,open:Boolean(qe),onClose:ht,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:[n.jsxs(a,{onClick:()=>{Qe&&pt(Qe),ht()},sx:{borderBottom:1,borderColor:"divider"},children:[n.jsx(i,{children:n.jsx(Rt,{fontSize:"small"})}),n.jsx(r,{primary:l("common.actions.preview")})]}),n.jsxs(a,{onClick:()=>{Qe&&lt(Qe),ht()},children:[n.jsx(i,{children:n.jsx(re,{fontSize:"small"})}),n.jsx(r,{primary:l("common.actions.remove")})]}),n.jsxs(a,{onClick:()=>{Qe&&ct(!1).then((e=>{e&&u(`/tasks/${Qe.id}/edit?work_id=${e}&return_to=/works/assign/%3Fwork_id=${e}%26folder_id=${null==Ne?void 0:Ne.id}%26edit=true%26return_to=${f}`)})),ht()},children:[n.jsx(i,{children:n.jsx(de,{fontSize:"small"})}),n.jsx(r,{primary:l("common.actions.edit")})]}),n.jsxs(a,{onClick:()=>{Qe&&ct(!1).then((e=>{e&&u(`/tasks/new?work_id=${e}&copy_task_id=${Qe.id}&return_to=/works/assign/%3Fwork_id=${e}%26folder_id=${null==Ne?void 0:Ne.id}%26edit=true%26return_to=${f}`)})),ht()},children:[n.jsx(i,{children:n.jsx(Bt,{fontSize:"small"})}),n.jsx(r,{primary:l("common.actions.copy")})]})]})]})]})]}),n.jsxs(o,{sx:{width:"100%",p:1,display:"flex",justifyContent:"space-between",position:"sticky",bottom:0,left:0,zIndex:1,flexShrink:0},children:[n.jsx(o,{sx:{display:"flex-start",gap:2},children:n.jsx(c,{variant:"outlined",size:"small",color:"inherit",onClick:mt,children:l("common.actions.cancel")})}),n.jsx(o,{sx:{display:"flex",gap:2,alignItems:"center"},children:Ie<1?n.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>_e(1),disabled:!R,children:l("common.actions.next")}):n.jsxs(n.Fragment,{children:[!v&&n.jsx(c,{variant:"outlined",color:"primary",size:"small",onClick:()=>_e(0),sx:{ml:1},children:l("common.actions.back")}),n.jsx(c,{variant:"contained",color:"primary",onClick:()=>ct(!0),disabled:ke||!R||!ee.trim()||0===U.length,children:ke?l("common.status.loading"):v?(null==J?void 0:J.status)===Mt.DRAFT?(null==R?void 0:R.is_template)?l("templates.actions.createTemplate"):l("templates.actions.sendToStudent"):l("common.actions.save"):(null==R?void 0:R.is_template)?l("templates.actions.createTemplate"):l(v?"common.actions.save":"templates.actions.sendToStudent")})]})})]})]}),n.jsx(O,{anchor:"right",open:gt,onClose:()=>{Ge&&Ze(null),Ye(!Ge)},variant:nt?"persistent":"temporary",sx:{width:"93%",maxWidth:"400px",flexShrink:0,"& .MuiDrawer-paper":{width:"93%",maxWidth:"400px"}},children:n.jsxs(o,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[n.jsxs(o,{sx:{borderBottom:1,borderColor:"divider",display:"flex",alignItems:"center",px:1},children:[n.jsx(g,{onClick:()=>Ye(!1),sx:{mr:1},children:at?n.jsx(Be,{}):n.jsx(he,{})}),n.jsxs(L,{value:et,onChange:(e,t)=>{tt(t)},variant:"fullWidth",sx:{flex:1,"& .MuiTab-root":{minHeight:48,fontSize:"0.875rem"}},children:[Xe&&n.jsx(N,{value:0,label:l("taskForm.buttons.preview")}),n.jsx(N,{value:1,label:l("works.creator.addTasks")})]})]}),n.jsxs(o,{sx:{flex:1,overflow:"auto",p:2},children:[0===et&&n.jsx(n.Fragment,{children:Xe?n.jsx(Yt,{title:Xe.title||"",text:Xe.text||"",tagIds:[],tags:[],teacherId:"",onClose:()=>Ye(!1),onFullscreen:()=>{dt(Xe)},onValidateAnswers:()=>{},hasQuizzes:!1}):null}),1===et&&n.jsx(Ot,{selectedTasks:U,onTaskToggle:lt,onPreviewTask:e=>{dt(e)}})]})]})})]}),n.jsx(me,{open:De,onClose:xt,task:Pe,hasQuizzes:!1,onValidateAnswers:()=>{},actionButtons:n.jsxs(o,{sx:{display:"flex",gap:1,width:"100%",justifyContent:"space-between"},children:[n.jsx(o,{sx:{display:"flex",gap:1},children:Pe&&n.jsxs(n.Fragment,{children:[n.jsx(M,{title:l("works.creator.autoSaveHint"),children:n.jsx(c,{size:"small",variant:"text",startIcon:n.jsx(de,{}),onClick:()=>{ct(!1).then((e=>{e&&(u(`/tasks/${Pe.id}/edit?return_to=/works/assign/%3Fwork_id=${e}%26edit=true`),xt())}))},children:l("common.actions.edit")})}),n.jsx(c,{size:"small",onClick:e=>{e.stopPropagation(),lt(Pe),xt()},startIcon:U.some((e=>e.id===Pe.id))?n.jsx(re,{}):n.jsx(ae,{}),children:U.some((e=>e.id===Pe.id))?l("common.actions.remove"):l("common.actions.add")})]})}),n.jsx(c,{onClick:xt,children:l("common.actions.close")})]})}),n.jsxs(I,{open:Fe,onClose:ut,maxWidth:"xs",fullWidth:!0,children:[n.jsx(_,{children:l("common.dialog.cancel.title")}),n.jsx(F,{children:n.jsx(k,{children:l("common.dialog.cancel.message")})}),n.jsxs(z,{children:[n.jsx(c,{onClick:ut,children:l("common.actions.no")}),n.jsx(c,{onClick:()=>{ze(!1),f?u(f):(null==R?void 0:R.is_template)?u("/templates"):u("/works")},color:"error",children:l("common.actions.yes")})]})]})]})}},Symbol.toStringTag,{value:"Module"})),ns=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const{t:t}=Y(),{user:l}=K(),{showErrorToast:x}=G(),m=s.useRef(null),[f,j]=s.useState([]),[y,b]=s.useState(!0),[v,w]=s.useState(null),[C,T]=s.useState(0),[$,A]=s.useState(""),[P,E]=s.useState(!1),[D,W]=s.useState({}),[R,B]=s.useState(null),[M,O]=s.useState(null),[L,N]=s.useState(!1),[H,V]=s.useState(""),[U,q]=s.useState(!1),J=e(),Q=(null==l?void 0:l.role)===X.ADMIN,ee=(null==l?void 0:l.role)===X.TEACHER||Q;s.useEffect((()=>{(async()=>{b(!0),w(null);try{const e=await Z.tags.getAll();j(e),w(null)}catch(e){const t=ue(e);w(t),x(t)}finally{b(!1)}})()}),[C]),s.useCallback((()=>{T((e=>e+1))}),[]);const te=async()=>{var e;const{isValid:t,errors:s}=Ct(Vt,{name:$});if(t){E(!0);try{const t=await Z.tags.create({name:$.trim()});j((e=>[t,...e])),A(""),W({}),null==(e=m.current)||e.focus()}catch(n){const e=n instanceof Error?n.message:"Failed to create tag. Please try again.";x(e)}finally{E(!1)}}else W(s)},ae=()=>{B(null)},ie=()=>{N(!1),V("")},oe=()=>{q(!1)};return n.jsxs(o,{children:[n.jsx(ne,{title:t("navigation.tags")}),y?n.jsx(ce,{message:t(y?"common.loading":"tags.loading.tags")}):n.jsxs(n.Fragment,{children:[n.jsx(d,{sx:{p:3,mb:3,mx:"auto",maxWidth:"1200px"},children:n.jsxs(o,{sx:{display:"flex",gap:1,alignItems:"center"},children:[n.jsx(h,{inputRef:m,fullWidth:!0,autoComplete:"off",autoCapitalize:"off",size:"small",placeholder:t("tags.input.placeholder"),value:$,onChange:e=>{A(e.target.value),D.name&&W((e=>({...e,name:""})))},onKeyPress:e=>{"Enter"===e.key&&$.trim()&&te()},error:!!D.name,helperText:D.name,InputProps:{endAdornment:$?n.jsx(p,{position:"end",children:n.jsx(g,{size:"small",onClick:()=>{A(""),W({})},edge:"end",children:n.jsx(re,{})})}):null}}),$.trim()&&n.jsx(c,{size:"small",startIcon:n.jsx(Nt,{}),onClick:te,disabled:P,children:t(P?"common.status.saving":"common.actions.create")})]})}),v||0!==f.length?n.jsx(d,{sx:{p:3,mx:"auto",maxWidth:"1200px"},children:n.jsx(o,{sx:{display:"flex",flexWrap:"wrap",gap:1,mt:1},children:f.map((e=>n.jsx(o,{children:n.jsx(u,{onClick:t=>((e,t)=>{e.stopPropagation(),O(t),B(e.currentTarget)})(t,e),label:e.name,sx:{m:.5,height:"auto",borderRadius:"16px","& .MuiChip-label":{px:1.5,py:.5}},variant:"outlined"})},e.id)))})}):n.jsx(o,{sx:{textAlign:"center",py:4},children:n.jsx(k,{variant:"h6",color:"text.secondary",sx:{mb:1},children:t(ee?"tags.empty.teacher":"tags.empty.default")})})]}),n.jsxs(S,{anchorEl:R,open:Boolean(R),onClose:ae,onClick:e=>e.stopPropagation(),children:[n.jsxs(a,{onClick:()=>{ae(),J(`/tasks?tag_id=${null==M?void 0:M.id}`)},children:[n.jsx(i,{children:n.jsx(Ht,{fontSize:"small"})}),n.jsx(r,{children:t("tags.actions.showTasks")})]}),n.jsxs(a,{onClick:()=>{M&&(V(M.name),N(!0)),ae()},children:[n.jsx(i,{children:n.jsx(de,{fontSize:"small"})}),n.jsx(r,{children:t("common.actions.rename")})]}),n.jsxs(a,{onClick:()=>{ae(),q(!0)},sx:{color:"error.main"},children:[n.jsx(i,{sx:{color:"error.main"},children:n.jsx(se,{fontSize:"small"})}),n.jsx(r,{children:t("common.actions.delete")})]})]}),n.jsxs(I,{open:L,onClose:ie,maxWidth:"xs",fullWidth:!0,children:[n.jsx(_,{children:t("tags.dialog.rename.title")}),n.jsx(F,{children:n.jsx(h,{autoFocus:!0,margin:"dense",label:t("tags.input.label"),type:"text",fullWidth:!0,value:H,onChange:e=>V(e.target.value),variant:"outlined"})}),n.jsxs(z,{children:[n.jsx(c,{onClick:ie,children:t("common.actions.cancel")}),n.jsx(c,{onClick:async()=>{if(!M||!H.trim())return;const{isValid:e,errors:t}=Ct(Vt,{name:H});if(e)try{const e=await Z.tags.update(M.id,{name:H.trim()});j((t=>t.map((t=>t.id===M.id?e:t)))),N(!1),V(""),O(null)}catch(s){const e=s instanceof Error?s.message:"Failed to rename tag. Please try again.";x(e)}else x(t.name)},variant:"contained",disabled:!H.trim()||H===(null==M?void 0:M.name),children:t("common.actions.rename")})]})]}),n.jsxs(I,{open:U,onClose:oe,maxWidth:"xs",fullWidth:!0,children:[n.jsx(_,{children:t("tags.dialog.delete.title")}),n.jsx(F,{children:n.jsx(k,{children:t("tags.dialog.delete.message",{name:null==M?void 0:M.name})})}),n.jsxs(z,{children:[n.jsx(c,{onClick:oe,children:t("common.actions.cancel")}),n.jsx(c,{onClick:async()=>{M&&(await(async e=>{try{await Z.tags.delete(e),j((t=>t.filter((t=>t.id!==e))))}catch(t){const e=t instanceof Error?t.message:"Failed to delete tag. Please try again.";x(e)}})(M.id),q(!1))},color:"error",variant:"contained",children:t("common.actions.delete")})]})]})]})}},Symbol.toStringTag,{value:"Module"})),as=()=>{var i;const{t:r}=Y(),l=e(),{contractId:x}=P(),[m]=t(),u=m.get("return_to")||"/contracts",{user:p}=K(),{showErrorToast:g,showToast:f}=G(),j="true"===m.get("testStudent"),y="teachair_test_student",[b,v]=s.useState(!0),[w,C]=s.useState(!1),[S,T]=s.useState(null),[$,A]=s.useState([]),[E,D]=s.useState({username:"",price:"",currency:null,balance:null,description:""}),[W,R]=s.useState({}),[B,M]=s.useState(null),[O,L]=s.useState(null),[N,ee]=s.useState(!1),[te,se]=s.useState(!1),[ne,ae]=s.useState(!0),ie=(null==p?void 0:p.role)===X.ADMIN,re=(null==p?void 0:p.role)===X.TEACHER||ie,oe=Boolean(x);s.useEffect((()=>{(async()=>{v(!0);try{const e=await Z.contracts.getCurrencies();A(e);const t=e.find((e=>"RUR"===e.code))||e[0];if(x){const t=await Z.contracts.getById(x);T(t);let s=null;t.currency?s=t.currency:e.length>0&&(s=e[0].code),D({username:t.student_id,price:t.price,currency:s,balance:t.balance,description:t.description||""})}else j?(D((e=>({...e,username:y||"",price:1e3,currency:"RUR",balance:10,description:r("contracts.form.testStudentDescription")}))),ae(!0)):t&&!E.currency&&D((e=>({...e,currency:t.code})))}catch(e){const t=e instanceof Error?e.message:"Failed to load data. Please try again.";g(t),l("/contracts")}finally{v(!1)}})()}),[x,l,g,j,y,r]);return re?n.jsxs(o,{sx:{display:"flex",flexDirection:"column",overflowX:"hidden",overflowY:"auto"},children:[b?n.jsx(ce,{message:r(oe?"contracts.status.loadingContract":"common.loading")}):n.jsx(n.Fragment,{children:n.jsxs(o,{sx:{flex:1,display:"flex",flexDirection:"column",mx:"auto",width:"100%",maxWidth:"800px",pb:1},children:[n.jsxs(d,{sx:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",p:2,py:1},children:[n.jsx(k,{variant:"h6",gutterBottom:!0,sx:{my:1},children:r(oe?"contracts.actions.edit":"contracts.actions.create")}),n.jsxs(o,{component:"form",noValidate:!0,children:[oe?n.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:2,mb:3},children:[n.jsx(H,{src:(null==(i=null==S?void 0:S.student)?void 0:i.photo_url)||void 0,sx:{width:48,height:48},children:zt(null==S?void 0:S.student)}),n.jsxs(o,{children:[n.jsx(k,{variant:"h6",children:_t(null==S?void 0:S.student)}),n.jsx(k,{variant:"body2",color:"text.secondary",children:r("common.student.one")})]})]}):n.jsx(h,{autoFocus:!0,margin:"normal",name:"username",label:r("contracts.form.studentUsername"),type:"text",fullWidth:!0,variant:"outlined",value:E.username,onChange:e=>{const t=e.target.value;let s;s=t.includes("@")&&t.indexOf("@")>0?t.split("@")[0]:t.replace(/^@/,""),D((e=>({...e,username:s}))),W.username&&R((e=>{const t={...e};return delete t.username,t}))},error:!!W.username,helperText:W.username||r("contracts.form.telegramUsername"),placeholder:r("contracts.form.usernamePlaceholder"),InputProps:{startAdornment:n.jsx(k,{sx:{mr:.5},children:"@"})}}),!oe&&n.jsx(V,{control:n.jsx(U,{checked:ne,onChange:e=>{ae(e.target.checked),e.target.checked||D((e=>({...e,price:0,balance:null})))}}),label:r("contracts.form.trackLessonsLabel"),sx:{my:1}}),ne&&n.jsxs(o,{sx:{display:"flex",gap:2,alignItems:"flex-start"},children:[n.jsx(h,{margin:"normal",name:"price",label:r("contracts.form.pricePerLesson"),type:"number",sx:{flex:1},variant:"outlined",value:0===E.price?"":E.price,onChange:e=>{const t=e.target.value,s=""===t?0:Number(t.replace(/^0+/,""));D((e=>({...e,price:s}))),W.price&&R((e=>{const t={...e};return delete t.price,t}))},error:!!W.price,helperText:W.price}),n.jsxs(q,{margin:"normal",sx:{minWidth:120},error:!!W.currency,children:[n.jsx(J,{id:"currency-label",children:r("contracts.form.currency")}),n.jsx(Q,{labelId:"currency-label",name:"currency",value:E.currency||"",label:r("contracts.form.currency"),onChange:e=>{const{name:t,value:s}=e.target;D((e=>({...e,[t]:s}))),W[t]&&R((e=>{const s={...e};return delete s[t],s}))},children:$.map((e=>n.jsxs(a,{value:e.code,children:[e.emoji,"   ",e.code]},e.code)))})]})]}),!oe&&ne?n.jsx(h,{margin:"normal",name:"balance",label:r("contracts.form.balanceLabel"),type:"number",fullWidth:!0,variant:"outlined",value:null===E.balance?"":E.balance,onChange:e=>{const t=e.target.value,s=""===t?null:Number(t.replace(/^0+/,""));D((e=>({...e,balance:s}))),W.balance&&R((e=>{const t={...e};return delete t.balance,t}))},error:!!W.balance,helperText:W.balance||r("contracts.form.balanceHint")}):oe?n.jsxs(k,{variant:"body1",color:"text.secondary",sx:{mt:1},children:[r("contracts.form.currentBalance"),": ",E.balance]}):null,n.jsx(h,{margin:"normal",name:"description",label:r("contracts.form.description"),type:"text",fullWidth:!0,variant:"outlined",value:E.description,onChange:e=>{const{name:t,value:s}=e.target;D((e=>({...e,[t]:"price"===t||"balance"===t?Number(s):s}))),W[t]&&R((e=>{const s={...e};return delete s[t],s}))},multiline:!0,rows:3,error:!!W.description,helperText:W.description||r("contracts.form.descriptionHint")})]})]}),n.jsxs(o,{sx:{mt:2,display:"flex",justifyContent:"space-between",flexShrink:0},children:[n.jsx(o,{sx:{display:"flex",alignItems:"center"},children:n.jsx(c,{variant:"outlined",color:"inherit",sx:{mr:2},onClick:()=>{l(u)},children:r("common.actions.cancel")})}),n.jsx(o,{children:n.jsx(c,{variant:"contained",color:"primary",onClick:async()=>{const e={...E,price:ne?E.price:0,balance:ne?E.balance??0:0},{isValid:t,errors:s}=Ct(oe?qt:Jt,e);if(t){C(!0);try{if(oe&&x)await Z.contracts.update(x,{price:e.price,currency:e.currency,balance:e.balance,description:e.description}),l(u);else{const t=await Z.contracts.create({...e});if("new_user_created"===t.create_code)M(t.id),L(t.student_id),ee(!0),f(r("contracts.status.contractCreatedShort"),"info");else if("already_exists"===t.create_code)M(t.id),L(t.student_id),se(!0);else{M(t.id),L(t.student_id),ee(!1),se(!1),f(r("contracts.status.contractCreatedShort"),"success");const e=u.includes("?")?`${u}&studentId=${t.student_id}`:`${u}?studentId=${t.student_id}`;l(e)}}}catch(n){const e=n instanceof Error?n.message:r("contracts.status.errorCreating");if(e.includes("student_is_self"))return void g(r("contracts.status.studentIsSelf"));if(e.includes("student_is_teacher"))return void g(r("contracts.status.studentIsTeacher"));g(e)}finally{C(!1)}}else R(s)},disabled:w||!oe&&!E.username.trim(),children:r(w?"common.status.saving":oe?"contracts.actions.update":"contracts.actions.create")})})]})]})}),n.jsx(Ut,{open:N,onClose:()=>ee(!1),onCancel:()=>{ee(!1);const e=u.includes("?")?`${u}&studentId=${O}`:`${u}?studentId=${O}`;l(e)},botUrl:"https://t.me/teachair_bot",cancelButtonText:r("common.actions.done")}),n.jsxs(I,{open:te,onClose:()=>se(!1),maxWidth:"xs",fullWidth:!0,children:[n.jsx(_,{children:r("contracts.dialog.existingContract.title")}),n.jsx(F,{children:n.jsx(k,{children:r("contracts.dialog.existingContract.message")})}),n.jsxs(z,{children:[n.jsx(c,{onClick:()=>se(!1),children:r("common.actions.cancel")}),n.jsx(c,{onClick:()=>{se(!1),B&&l(`/contracts/${B}/edit`)},color:"primary",variant:"contained",children:r("contracts.actions.editExisting")})]})]})]}):(l("/contracts"),null)},is=Object.freeze(Object.defineProperty({__proto__:null,ContractFormPage:as,default:as},Symbol.toStringTag,{value:"Module"}));export{Xt as A,is as C,Yt as P,Kt as T,ts as a,ss as b,ns as c};
