import{Z as e,a7 as s,aa as n,r as t,j as r,u as a,B as l,x as o,b as i,Q as c,ak as d,U as m,d as u,A as x,ah as h,w as p,z as f,E as y,f as j,n as b,H as v}from"./vendor-BGxxnuh9.js";import{b as g,u as _,U as I,a as P,aH as S,L as w,aI as C,aJ as T,A as E,aK as U,aL as A,c as z}from"./main-CXFYNVDD.js";import{v as D,z as L}from"./teacher-AKpCy0JX.js";const O=L.object({type:L.nativeEnum(S,{errorMap:()=>({message:"transactions.validation.typeRequired"})}),contract_id:L.string().uuid("transactions.validation.contractRequired"),amount:L.number().optional().nullable(),currency:L.string().optional().nullable(),lessons_number:L.number().int("transactions.validation.minimumLessons").min(1,"transactions.validation.minimumLessons").optional().nullable()}).refine((e=>void 0!==e.lessons_number&&null!==e.lessons_number||void 0!==e.amount&&null!==e.amount&&e.currency),{message:"transactions.validation.lessonsOrAmount",path:["form"]}),W=()=>{const{t:L}=g(),W=e();s();const[R]=n(),k=R.get("return_to")||"/transactions",{user:M}=_(),B=(null==M?void 0:M.role)===I.ADMIN,H=(null==M?void 0:M.role)===I.TEACHER||B,{showToast:q,showErrorToast:V}=P(),J=R.get("contract_id"),[K,N]=t.useState(!0),[Q,X]=t.useState(!1),[Y,Z]=t.useState([]),[F,G]=t.useState([]),[$,ee]=t.useState(null),[se,ne]=t.useState({}),[te,re]=t.useState({type:S.TOP_UP,lessons_number:1,amount:null,currency:null,contract_id:J||void 0});t.useEffect((()=>{(async()=>{N(!0),ee(null);try{const e=await z.contracts.getAll(0,100);Z(e);const s=await z.contracts.getCurrencies();if(G(s),J){const s=e.find((e=>e.id===J));s&&re((e=>({...e,contract_id:J,currency:s.currency})))}}catch(e){ee(L("common.error")),V(e.message)}finally{N(!1)}})()}),[V,J]);const ae=e=>{const{name:s,value:n}=e.target;let t=n;"lessons_number"!==s&&"amount"!==s||(t=""===n?null:Math.max(0,parseInt(n,10))),re((e=>({...e,[s]:t}))),se[s]&&ne((e=>{const n={...e};return delete n[s],n}))},le=e=>{const{name:s,value:n}=e.target;if("contract_id"===s){const e=Y.find((e=>e.id===n));re(e?t=>({...t,[s]:n,currency:e.currency}):e=>({...e,[s]:n}))}else re((e=>({...e,[s]:n})));se[s]&&ne((e=>{const n={...e};return delete n[s],n}))},oe=async e=>{e.preventDefault();const s=D(O,te);if(s.isValid){X(!0),ee(null);try{await z.transactions.create(te),q(L("transactions.actions.createdSuccess"),"success"),W(k)}catch(n){ee(L("common.error")),V(n.message)}finally{X(!1)}}else ne(s.errors)};if(K)return r.jsx(w,{message:L("common.loading")});if(!H)return r.jsx(a,{severity:"error",children:L("common.error")});const ie=e=>{var s,n;return((null==(s=e.student)?void 0:s.first_name)||"")+" "+((null==(n=e.student)?void 0:n.last_name)||"")};return r.jsx(l,{sx:{display:"flex",flexDirection:"column",overflowX:"hidden",overflowY:"auto"},children:r.jsxs(l,{sx:{flex:1,display:"flex",flexDirection:"column",mx:"auto",width:"100%",maxWidth:"800px",pb:1},children:[r.jsxs(o,{sx:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",p:3,pt:1},children:[r.jsx(l,{sx:{mt:2,mb:3},children:r.jsx(i,{variant:"h4",children:L("transactions.form.title")})}),$&&r.jsx(a,{severity:"error",sx:{mb:3},children:$}),se.form&&r.jsx(a,{severity:"error",sx:{mb:3},children:L(se.form)}),r.jsxs(l,{component:"form",onSubmit:oe,noValidate:!0,children:[r.jsxs(c,{fullWidth:!0,error:!!se.contract_id,sx:{mb:3},children:[r.jsx(d,{id:"contract-label",children:L("transactions.form.contract")}),r.jsx(m,{labelId:"contract-label",name:"contract_id",value:te.contract_id||"",label:L("transactions.form.contract"),onChange:le,children:0===Y.length?r.jsx(u,{disabled:!0,children:L("transactions.form.noActiveContracts")}):Y.map((e=>{var s,n,t;return r.jsx(u,{value:e.id,children:r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[r.jsx(x,{src:(null==(s=e.student)?void 0:s.photo_url)||void 0,sx:{width:24,height:24},children:((null==(t=null==(n=e.student)?void 0:n.first_name)?void 0:t[0])+"").toUpperCase()}),r.jsx(i,{children:ie(e)})]})},e.id)}))}),se.contract_id&&r.jsx(h,{children:L(se.contract_id)})]}),te.contract_id&&r.jsx(o,{elevation:0,variant:"outlined",sx:{p:2,mb:3},children:(()=>{const e=Y.find((e=>e.id===te.contract_id));return e?r.jsxs(p,{spacing:2,children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(C,{sx:{mr:1,color:"text.secondary"}}),r.jsxs(i,{children:[L("transactions.form.contractInfo.paidLessons"),": ",e.balance]})]}),r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(T,{sx:{mr:1,color:"text.secondary"}}),r.jsxs(i,{children:[L("transactions.form.contractInfo.pricePerLesson"),": ",e.price," ",e.currency]})]})]}):null})()}),r.jsxs(c,{fullWidth:!0,error:!!se.type,sx:{mb:3},children:[r.jsxs(f,{value:te.type,exclusive:!0,onChange:(e,s)=>{null!==s&&(re((e=>({...e,type:s}))),se.type&&ne((e=>{const s={...e};return delete s.type,s})))},"aria-label":L("transactions.form.type.label"),fullWidth:!0,color:"primary",children:[r.jsx(y,{value:S.TOP_UP,children:r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(E,{fontSize:"small",color:"success",sx:{mr:.5}}),r.jsx(i,{children:L("transactions.form.type.topUp")})]})}),r.jsx(y,{value:S.REDEEM,children:r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(U,{fontSize:"small",color:"error",sx:{mr:.5}}),r.jsx(i,{children:L("transactions.form.type.redeem")})]})})]}),se.type&&r.jsx(h,{children:L(se.type)})]}),r.jsxs(p,{spacing:3,children:[r.jsxs(l,{children:[r.jsxs(i,{variant:"body1",gutterBottom:!0,sx:{display:"flex",alignItems:"center",mb:2},children:[te.type===S.TOP_UP?r.jsx(E,{fontSize:"small",color:"success",sx:{mr:.5}}):r.jsx(U,{fontSize:"small",color:"error",sx:{mr:.5}}),L("transactions.form.lessons.title",{action:te.type===S.TOP_UP?L("transactions.toAdd"):L("transactions.toRedeem")})]}),r.jsx(j,{fullWidth:!0,name:"lessons_number",label:L("transactions.form.lessons.label"),type:"number",value:null===te.lessons_number?"":te.lessons_number,onChange:ae,error:!!se.lessons_number,helperText:se.lessons_number?L(se.lessons_number):"",InputProps:{inputProps:{min:1}}})]}),te.type===S.TOP_UP&&r.jsxs(l,{id:"payment-section",children:[r.jsxs(i,{variant:"body1",gutterBottom:!0,sx:{display:"flex",alignItems:"center",mb:2},children:[r.jsx(A,{fontSize:"small",sx:{mr:1}}),L("transactions.form.payment.title")]}),r.jsxs(l,{sx:{display:"flex",gap:2},children:[r.jsx(j,{sx:{flex:1},name:"amount",label:L("transactions.form.payment.amount"),type:"number",value:null===te.amount?"":te.amount,onChange:ae,error:!!se.amount,helperText:se.amount?L(se.amount):"",InputProps:{inputProps:{min:0}}}),r.jsxs(c,{sx:{minWidth:120},error:!!se.currency,children:[r.jsx(d,{id:"currency-label",children:L("transactions.form.payment.currency")}),r.jsx(m,{labelId:"currency-label",name:"currency",value:te.currency||"",label:L("transactions.form.payment.currency"),onChange:le,children:F.map((e=>r.jsxs(u,{value:e.code,children:[e.emoji," ",e.code]},e.code)))}),se.currency&&r.jsx(h,{children:L(se.currency)})]})]})]})]})]})]}),r.jsxs(l,{sx:{mt:2,display:"flex",justifyContent:"space-between",flexShrink:0},children:[r.jsx(l,{sx:{display:"flex",alignItems:"center"},children:r.jsx(b,{variant:"outlined",color:"inherit",sx:{mr:2},onClick:()=>{W(k)},disabled:Q,children:L("common.actions.cancel")})}),r.jsx(l,{children:r.jsx(b,{type:"submit",variant:"contained",color:"primary",onClick:oe,disabled:Q,startIcon:Q?r.jsx(v,{size:20}):null,children:L(Q?"transactions.actions.creating":"transactions.actions.create")})})]})]})})};export{W as default};
