import{r as e,j as s,B as a,u as l,n as r,an as n,x as t,ao as i,ap as c,aq as o,ar as d,as as u,v as h,h as x,H as j,D as m,i as f,l as g,b as y,V as p,am as v,W as S,d as b,m as C}from"./vendor-DJLE-ZBj.js";import{u as E,a as R,U as T,c as A,g as U,P as w,L as D,E as N}from"./main-DLLQni-K.js";const _=()=>{const{user:_}=E(),{showErrorToast:k}=R(),[z,I]=e.useState([]),[L,W]=e.useState(!0),[H,B]=e.useState(!1),[F,M]=e.useState(null),[P,q]=e.useState(0),[O,V]=e.useState(null),[G,J]=e.useState(!1),[K,Q]=e.useState(""),[X,Y]=e.useState(!1),[Z,$]=e.useState({username:"",first_name:"",last_name:"",role:T.STUDENT}),[ee,se]=e.useState(0),[ae,le]=e.useState(!0),re=e.useRef(null);e.useEffect((()=>{(async()=>{W(!0),M(null);try{const e=await A.users.getAll(0,20);I(e),se(0),le(20===e.length),M(null)}catch(e){const s=U(e);M(s),k(s)}finally{W(!1)}})()}),[P]),e.useEffect((()=>{const e=new IntersectionObserver((e=>{const[s]=e;s.isIntersecting&&ae&&!L&&!H&&ne()}),{threshold:.5}),s=re.current;return s&&e.observe(s),()=>{s&&e.unobserve(s)}}),[ae,L,H]);const ne=async()=>{if(!ae||H)return;B(!0);const e=ee+1;try{const s=await A.users.getAll(20*e,20);s.length>0?(I((e=>[...e,...s])),se(e),le(20===s.length)):le(!1)}catch(s){const e=U(s);k(e)}finally{B(!1)}},te=e.useCallback((()=>{q((e=>e+1))}),[]),ie=()=>{J(!1),V(null)},ce=e=>{switch(e){case T.ADMIN:return"error";case T.TEACHER:return"primary";case T.STUDENT:return"success";default:return"default"}};return s.jsxs(a,{children:[s.jsx(w,{title:"Users"}),F&&s.jsx(l,{severity:"error",sx:{mb:2,mx:"auto",maxWidth:"1200px"},action:s.jsx(r,{color:"inherit",size:"small",onClick:te,disabled:L,children:L?"Loading...":"Retry"}),children:F}),L?s.jsx(a,{sx:{display:"flex",justifyContent:"center",py:4},children:s.jsx(D,{message:L&&F?"Loading...":"Loading users..."})}):!F&&s.jsxs(s.Fragment,{children:[s.jsx(n,{component:t,sx:{mt:3,mx:"auto",maxWidth:"1200px"},children:s.jsxs(i,{children:[s.jsx(c,{children:s.jsxs(o,{children:[s.jsx(d,{children:"Name"}),s.jsx(d,{children:"Username"}),s.jsx(d,{children:"Role"}),s.jsx(d,{align:"right",children:"Actions"})]})}),s.jsx(u,{children:z.map((e=>s.jsxs(o,{hover:!0,children:[s.jsxs(d,{children:[e.first_name," ",e.last_name||""]}),s.jsx(d,{children:e.username}),s.jsx(d,{children:s.jsx(h,{label:e.role,color:ce(e.role),size:"small"})}),s.jsx(d,{align:"right",children:s.jsx(x,{size:"small",onClick:()=>(e=>{V(e),Q(e.role),J(!0)})(e),children:s.jsx(N,{fontSize:"small"})})})]},e.id)))})]})}),s.jsx(a,{ref:re,sx:{display:"flex",justifyContent:"center",p:2,visibility:ae?"visible":"hidden"},children:H&&s.jsx(j,{size:24})}),s.jsxs(m,{open:G,onClose:ie,children:[s.jsx(f,{children:"Edit User Role"}),s.jsxs(g,{children:[s.jsxs(y,{variant:"body1",gutterBottom:!0,children:["Change role for ",null==O?void 0:O.first_name," ",(null==O?void 0:O.last_name)||""]}),s.jsxs(p,{fullWidth:!0,sx:{mt:2},children:[s.jsx(v,{id:"role-label",children:"Role"}),s.jsxs(S,{labelId:"role-label",id:"role",value:K,label:"Role",onChange:e=>{Q(e.target.value)},children:[s.jsx(b,{value:T.STUDENT,children:"Student"}),s.jsx(b,{value:T.TEACHER,children:"Teacher"}),s.jsx(b,{value:T.ADMIN,children:"Admin"})]})]})]}),s.jsxs(C,{children:[s.jsx(r,{onClick:ie,children:"Cancel"}),s.jsx(r,{onClick:async()=>{if(O)try{await A.users.updateRole(O.id,{role:K}),I((e=>e.map((e=>e.id===O.id?{...e,role:K}:e)))),ie()}catch(e){const s=e instanceof Error?e.message:"Failed to update user role. Please try again.";k(s)}},color:"primary",variant:"contained",children:"Update Role"})]})]})]})]})};export{_ as default};
