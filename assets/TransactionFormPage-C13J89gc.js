import{a5 as e,aa as s,ad as n,r as t,j as r,u as a,B as l,x as o,b as c,V as i,am as d,W as m,d as u,A as x,aj as h,w as p,z as f,E as y,f as j,n as b,H as v}from"./vendor-5I4LDDhx.js";import{b as g,u as _,U as I,a as S,aS as P,L as w,as as C,aT as T,aU as E,A,aV as U,aW as W,c as z,am as D,aq as O,aX as L}from"./main-CRu-gqtW.js";const R=L.object({type:L.nativeEnum(P,{errorMap:()=>({message:"transactions.validation.typeRequired"})}),contract_id:L.string().uuid("transactions.validation.contractRequired"),amount:L.number().optional().nullable(),currency:L.string().optional().nullable(),lessons_number:L.number().int("transactions.validation.minimumLessons").min(1,"transactions.validation.minimumLessons").optional().nullable()}).refine((e=>void 0!==e.lessons_number&&null!==e.lessons_number||void 0!==e.amount&&null!==e.amount&&e.currency),{message:"transactions.validation.lessonsOrAmount",path:["form"]}),M=()=>{const{t:L}=g(),M=e();s();const[V]=n(),k=V.get("return_to")||"/transactions",{user:q}=_(),B=(null==q?void 0:q.role)===I.ADMIN,H=(null==q?void 0:q.role)===I.TEACHER||B,{showToast:X,showErrorToast:N}=S(),Y=V.get("contract_id"),[F,G]=t.useState(!0),[J,K]=t.useState(!1),[Q,Z]=t.useState([]),[$,ee]=t.useState([]),[se,ne]=t.useState(null),[te,re]=t.useState({}),[ae,le]=t.useState({type:P.TOP_UP,lessons_number:1,amount:null,currency:null,contract_id:Y||void 0});t.useEffect((()=>{(async()=>{G(!0),ne(null);try{const e=await z.contracts.getAll(0,100);Z(e);const s=await z.contracts.getCurrencies();if(ee(s),Y){const s=e.find((e=>e.id===Y));s&&le((e=>({...e,contract_id:Y,currency:s.currency})))}}catch(e){ne(L("common.error")),N(e.message)}finally{G(!1)}})()}),[N,Y]);const oe=e=>{const{name:s,value:n}=e.target;let t=n;"lessons_number"!==s&&"amount"!==s||(t=""===n?null:Math.max(0,parseInt(n,10))),le((e=>({...e,[s]:t}))),te[s]&&re((e=>{const n={...e};return delete n[s],n}))},ce=e=>{const{name:s,value:n}=e.target;if("contract_id"===s){const e=Q.find((e=>e.id===n));le(e?t=>({...t,[s]:n,currency:e.currency}):e=>({...e,[s]:n}))}else le((e=>({...e,[s]:n})));te[s]&&re((e=>{const n={...e};return delete n[s],n}))},ie=async e=>{e.preventDefault();const s=D(R,ae);if(s.isValid){K(!0),ne(null);try{await z.transactions.create(ae),X(L("transactions.actions.createdSuccess"),"success"),M(k)}catch(n){ne(L("common.error")),N(n.message)}finally{K(!1)}}else re(s.errors)};if(F)return r.jsx(w,{message:L("common.loading")});if(!H)return r.jsx(a,{severity:"error",children:L("common.error")});const de=e=>O(e.student);return r.jsx(l,{sx:{display:"flex",flexDirection:"column",overflowX:"hidden",overflowY:"auto"},children:r.jsxs(l,{sx:{flex:1,display:"flex",flexDirection:"column",mx:"auto",width:"100%",maxWidth:"800px",pb:1},children:[r.jsxs(o,{sx:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",p:3,pt:1},children:[r.jsx(l,{sx:{mt:2,mb:3},children:r.jsx(c,{variant:"h4",children:L("transactions.form.title")})}),se&&r.jsx(a,{severity:"error",sx:{mb:3},children:se}),te.form&&r.jsx(a,{severity:"error",sx:{mb:3},children:L(te.form)}),r.jsxs(l,{component:"form",onSubmit:ie,noValidate:!0,children:[r.jsxs(i,{fullWidth:!0,error:!!te.contract_id,sx:{mb:3},children:[r.jsx(d,{id:"contract-label",children:L("transactions.form.contract")}),r.jsx(m,{labelId:"contract-label",name:"contract_id",value:ae.contract_id||"",label:L("transactions.form.contract"),onChange:ce,children:0===Q.length?r.jsx(u,{disabled:!0,children:L("transactions.form.noActiveContracts")}):Q.map((e=>{var s;return r.jsx(u,{value:e.id,children:r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[r.jsx(x,{src:(null==(s=e.student)?void 0:s.photo_url)||void 0,sx:{width:24,height:24},children:C(e.student)}),r.jsx(c,{children:de(e)})]})},e.id)}))}),te.contract_id&&r.jsx(h,{children:L(te.contract_id)})]}),ae.contract_id&&r.jsx(o,{elevation:0,variant:"outlined",sx:{p:2,mb:3},children:(()=>{const e=Q.find((e=>e.id===ae.contract_id));return e?r.jsxs(p,{spacing:2,children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(T,{sx:{mr:1,color:"text.secondary"}}),r.jsxs(c,{children:[L("transactions.form.contractInfo.paidLessons"),": ",e.balance]})]}),r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(E,{sx:{mr:1,color:"text.secondary"}}),r.jsxs(c,{children:[L("transactions.form.contractInfo.pricePerLesson"),": ",e.price," ",e.currency]})]})]}):null})()}),r.jsxs(i,{fullWidth:!0,error:!!te.type,sx:{mb:3},children:[r.jsxs(f,{value:ae.type,exclusive:!0,onChange:(e,s)=>{null!==s&&(le((e=>({...e,type:s}))),te.type&&re((e=>{const s={...e};return delete s.type,s})))},"aria-label":L("transactions.form.type.label"),fullWidth:!0,color:"primary",children:[r.jsx(y,{value:P.TOP_UP,children:r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(A,{fontSize:"small",color:"success",sx:{mr:.5}}),r.jsx(c,{children:L("transactions.form.type.topUp")})]})}),r.jsx(y,{value:P.REDEEM,children:r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(U,{fontSize:"small",color:"error",sx:{mr:.5}}),r.jsx(c,{children:L("transactions.form.type.redeem")})]})})]}),te.type&&r.jsx(h,{children:L(te.type)})]}),r.jsxs(p,{spacing:3,children:[r.jsxs(l,{children:[r.jsxs(c,{variant:"body1",gutterBottom:!0,sx:{display:"flex",alignItems:"center",mb:2},children:[ae.type===P.TOP_UP?r.jsx(A,{fontSize:"small",color:"success",sx:{mr:.5}}):r.jsx(U,{fontSize:"small",color:"error",sx:{mr:.5}}),L("transactions.form.lessons.title",{action:ae.type===P.TOP_UP?L("transactions.toAdd"):L("transactions.toRedeem")})]}),r.jsx(j,{fullWidth:!0,name:"lessons_number",label:L("transactions.form.lessons.label"),type:"number",value:null===ae.lessons_number?"":ae.lessons_number,onChange:oe,error:!!te.lessons_number,helperText:te.lessons_number?L(te.lessons_number):"",InputProps:{inputProps:{min:1}}})]}),ae.type===P.TOP_UP&&r.jsxs(l,{id:"payment-section",children:[r.jsxs(c,{variant:"body1",gutterBottom:!0,sx:{display:"flex",alignItems:"center",mb:2},children:[r.jsx(W,{fontSize:"small",sx:{mr:1}}),L("transactions.form.payment.title")]}),r.jsxs(l,{sx:{display:"flex",gap:2},children:[r.jsx(j,{sx:{flex:1},name:"amount",label:L("transactions.form.payment.amount"),type:"number",value:null===ae.amount?"":ae.amount,onChange:oe,error:!!te.amount,helperText:te.amount?L(te.amount):"",InputProps:{inputProps:{min:0}}}),r.jsxs(i,{sx:{minWidth:120},error:!!te.currency,children:[r.jsx(d,{id:"currency-label",children:L("transactions.form.payment.currency")}),r.jsx(m,{labelId:"currency-label",name:"currency",value:ae.currency||"",label:L("transactions.form.payment.currency"),onChange:ce,children:$.map((e=>r.jsxs(u,{value:e.code,children:[e.emoji," ",e.code]},e.code)))}),te.currency&&r.jsx(h,{children:L(te.currency)})]})]})]})]})]})]}),r.jsxs(l,{sx:{mt:2,display:"flex",justifyContent:"space-between",flexShrink:0},children:[r.jsx(l,{sx:{display:"flex",alignItems:"center"},children:r.jsx(b,{variant:"outlined",color:"inherit",sx:{mr:2},onClick:()=>{M(k)},disabled:J,children:L("common.actions.cancel")})}),r.jsx(l,{children:r.jsx(b,{type:"submit",variant:"contained",color:"primary",onClick:ie,disabled:J,startIcon:J?r.jsx(v,{size:20}):null,children:L(J?"transactions.actions.creating":"transactions.actions.create")})})]})]})})};export{M as default};
