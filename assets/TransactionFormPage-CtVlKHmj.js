import{a5 as e,aa as s,ad as n,r as t,j as r,u as a,B as l,x as o,b as i,V as c,am as d,W as m,d as u,A as x,aj as p,w as h,z as f,E as y,f as j,n as b,H as v}from"./vendor-DJLE-ZBj.js";import{b as g,u as _,U as I,a as P,aI as S,L as w,aJ as C,aK as T,A as E,aL as A,aM as U,c as z}from"./main-BEbWEhVC.js";import{v as W,z as D}from"./teacher-Ct-lP7mv.js";const L=D.object({type:D.nativeEnum(S,{errorMap:()=>({message:"transactions.validation.typeRequired"})}),contract_id:D.string().uuid("transactions.validation.contractRequired"),amount:D.number().optional().nullable(),currency:D.string().optional().nullable(),lessons_number:D.number().int("transactions.validation.minimumLessons").min(1,"transactions.validation.minimumLessons").optional().nullable()}).refine((e=>void 0!==e.lessons_number&&null!==e.lessons_number||void 0!==e.amount&&null!==e.amount&&e.currency),{message:"transactions.validation.lessonsOrAmount",path:["form"]}),O=()=>{const{t:D}=g(),O=e();s();const[M]=n(),R=M.get("return_to")||"/transactions",{user:k}=_(),B=(null==k?void 0:k.role)===I.ADMIN,V=(null==k?void 0:k.role)===I.TEACHER||B,{showToast:q,showErrorToast:H}=P(),J=M.get("contract_id"),[K,N]=t.useState(!0),[X,Y]=t.useState(!1),[F,G]=t.useState([]),[Q,Z]=t.useState([]),[$,ee]=t.useState(null),[se,ne]=t.useState({}),[te,re]=t.useState({type:S.TOP_UP,lessons_number:1,amount:null,currency:null,contract_id:J||void 0});t.useEffect((()=>{(async()=>{N(!0),ee(null);try{const e=await z.contracts.getAll(0,100);G(e);const s=await z.contracts.getCurrencies();if(Z(s),J){const s=e.find((e=>e.id===J));s&&re((e=>({...e,contract_id:J,currency:s.currency})))}}catch(e){ee(D("common.error")),H(e.message)}finally{N(!1)}})()}),[H,J]);const ae=e=>{const{name:s,value:n}=e.target;let t=n;"lessons_number"!==s&&"amount"!==s||(t=""===n?null:Math.max(0,parseInt(n,10))),re((e=>({...e,[s]:t}))),se[s]&&ne((e=>{const n={...e};return delete n[s],n}))},le=e=>{const{name:s,value:n}=e.target;if("contract_id"===s){const e=F.find((e=>e.id===n));re(e?t=>({...t,[s]:n,currency:e.currency}):e=>({...e,[s]:n}))}else re((e=>({...e,[s]:n})));se[s]&&ne((e=>{const n={...e};return delete n[s],n}))},oe=async e=>{e.preventDefault();const s=W(L,te);if(s.isValid){Y(!0),ee(null);try{await z.transactions.create(te),q(D("transactions.actions.createdSuccess"),"success"),O(R)}catch(n){ee(D("common.error")),H(n.message)}finally{Y(!1)}}else ne(s.errors)};if(K)return r.jsx(w,{message:D("common.loading")});if(!V)return r.jsx(a,{severity:"error",children:D("common.error")});const ie=e=>{var s,n;return((null==(s=e.student)?void 0:s.first_name)||"")+" "+((null==(n=e.student)?void 0:n.last_name)||"")};return r.jsx(l,{sx:{display:"flex",flexDirection:"column",overflowX:"hidden",overflowY:"auto"},children:r.jsxs(l,{sx:{flex:1,display:"flex",flexDirection:"column",mx:"auto",width:"100%",maxWidth:"800px",pb:1},children:[r.jsxs(o,{sx:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",p:3,pt:1},children:[r.jsx(l,{sx:{mt:2,mb:3},children:r.jsx(i,{variant:"h4",children:D("transactions.form.title")})}),$&&r.jsx(a,{severity:"error",sx:{mb:3},children:$}),se.form&&r.jsx(a,{severity:"error",sx:{mb:3},children:D(se.form)}),r.jsxs(l,{component:"form",onSubmit:oe,noValidate:!0,children:[r.jsxs(c,{fullWidth:!0,error:!!se.contract_id,sx:{mb:3},children:[r.jsx(d,{id:"contract-label",children:D("transactions.form.contract")}),r.jsx(m,{labelId:"contract-label",name:"contract_id",value:te.contract_id||"",label:D("transactions.form.contract"),onChange:le,children:0===F.length?r.jsx(u,{disabled:!0,children:D("transactions.form.noActiveContracts")}):F.map((e=>{var s,n,t;return r.jsx(u,{value:e.id,children:r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[r.jsx(x,{src:(null==(s=e.student)?void 0:s.photo_url)||void 0,sx:{width:24,height:24},children:((null==(t=null==(n=e.student)?void 0:n.first_name)?void 0:t[0])+"").toUpperCase()}),r.jsx(i,{children:ie(e)})]})},e.id)}))}),se.contract_id&&r.jsx(p,{children:D(se.contract_id)})]}),te.contract_id&&r.jsx(o,{elevation:0,variant:"outlined",sx:{p:2,mb:3},children:(()=>{const e=F.find((e=>e.id===te.contract_id));return e?r.jsxs(h,{spacing:2,children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(C,{sx:{mr:1,color:"text.secondary"}}),r.jsxs(i,{children:[D("transactions.form.contractInfo.paidLessons"),": ",e.balance]})]}),r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(T,{sx:{mr:1,color:"text.secondary"}}),r.jsxs(i,{children:[D("transactions.form.contractInfo.pricePerLesson"),": ",e.price," ",e.currency]})]})]}):null})()}),r.jsxs(c,{fullWidth:!0,error:!!se.type,sx:{mb:3},children:[r.jsxs(f,{value:te.type,exclusive:!0,onChange:(e,s)=>{null!==s&&(re((e=>({...e,type:s}))),se.type&&ne((e=>{const s={...e};return delete s.type,s})))},"aria-label":D("transactions.form.type.label"),fullWidth:!0,color:"primary",children:[r.jsx(y,{value:S.TOP_UP,children:r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(E,{fontSize:"small",color:"success",sx:{mr:.5}}),r.jsx(i,{children:D("transactions.form.type.topUp")})]})}),r.jsx(y,{value:S.REDEEM,children:r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(A,{fontSize:"small",color:"error",sx:{mr:.5}}),r.jsx(i,{children:D("transactions.form.type.redeem")})]})})]}),se.type&&r.jsx(p,{children:D(se.type)})]}),r.jsxs(h,{spacing:3,children:[r.jsxs(l,{children:[r.jsxs(i,{variant:"body1",gutterBottom:!0,sx:{display:"flex",alignItems:"center",mb:2},children:[te.type===S.TOP_UP?r.jsx(E,{fontSize:"small",color:"success",sx:{mr:.5}}):r.jsx(A,{fontSize:"small",color:"error",sx:{mr:.5}}),D("transactions.form.lessons.title",{action:te.type===S.TOP_UP?D("transactions.toAdd"):D("transactions.toRedeem")})]}),r.jsx(j,{fullWidth:!0,name:"lessons_number",label:D("transactions.form.lessons.label"),type:"number",value:null===te.lessons_number?"":te.lessons_number,onChange:ae,error:!!se.lessons_number,helperText:se.lessons_number?D(se.lessons_number):"",InputProps:{inputProps:{min:1}}})]}),te.type===S.TOP_UP&&r.jsxs(l,{id:"payment-section",children:[r.jsxs(i,{variant:"body1",gutterBottom:!0,sx:{display:"flex",alignItems:"center",mb:2},children:[r.jsx(U,{fontSize:"small",sx:{mr:1}}),D("transactions.form.payment.title")]}),r.jsxs(l,{sx:{display:"flex",gap:2},children:[r.jsx(j,{sx:{flex:1},name:"amount",label:D("transactions.form.payment.amount"),type:"number",value:null===te.amount?"":te.amount,onChange:ae,error:!!se.amount,helperText:se.amount?D(se.amount):"",InputProps:{inputProps:{min:0}}}),r.jsxs(c,{sx:{minWidth:120},error:!!se.currency,children:[r.jsx(d,{id:"currency-label",children:D("transactions.form.payment.currency")}),r.jsx(m,{labelId:"currency-label",name:"currency",value:te.currency||"",label:D("transactions.form.payment.currency"),onChange:le,children:Q.map((e=>r.jsxs(u,{value:e.code,children:[e.emoji," ",e.code]},e.code)))}),se.currency&&r.jsx(p,{children:D(se.currency)})]})]})]})]})]})]}),r.jsxs(l,{sx:{mt:2,display:"flex",justifyContent:"space-between",flexShrink:0},children:[r.jsx(l,{sx:{display:"flex",alignItems:"center"},children:r.jsx(b,{variant:"outlined",color:"inherit",sx:{mr:2},onClick:()=>{O(R)},disabled:X,children:D("common.actions.cancel")})}),r.jsx(l,{children:r.jsx(b,{type:"submit",variant:"contained",color:"primary",onClick:oe,disabled:X,startIcon:X?r.jsx(v,{size:20}):null,children:D(X?"transactions.actions.creating":"transactions.actions.create")})})]})]})})};export{O as default};
