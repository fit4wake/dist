import{a6 as e,ab as t,r,J as s,N as l,j as a,B as o,x as n,G as i,H as d,d as c,f as u,h as m,n as x,u as p,ac as h,av as f,aw as g,b as j,A as v,K as y,D as b,i as w,v as k,l as S,m as C,M as F,w as T,y as D,a1 as _,ae as I,a2 as z,O as W}from"./vendor-VLBVWaDG.js";import{u as E,a as O,b as L,aS as B,U as A,c as P,h as M,P as R,aT as $,A as U,ax as N,d as H,e as K,aU as q,f as J,m as Z,E as G,L as V,aV as X,M as Y,aW as Q,aX as ee,D as te,I as re,aY as se,i as le,aC as ae,aZ as oe,at as ne,a_ as ie}from"./main-mWCWJs1P.js";const de=e=>{const t=e?`/#/templates?folder=${e}`:"/#/templates";window.history.replaceState({},"",t)};function ce(e){let t,r=0;for(t=0;t<e.length;t+=1)r=e.charCodeAt(t)+((r<<5)-r);let s="#";for(t=0;t<3;t+=1){const e=r>>8*t&255;s+=`00${Math.min(255,Math.floor((e+128)/2)).toString(16)}`.slice(-2)}return s}function ue(e){if(!e)return"?";const t=e.split(" ");return 1===t.length?t[0][0].toUpperCase():`${t[0][0]}${t[1][0]}`.toUpperCase()}const me="templatesPageFilters",xe="templatesPageOrder",pe=({work:t,onClick:s,onDelete:l})=>{const n=e(),[i,d]=r.useState(null),[u,p]=r.useState(!1),[h,f]=r.useState(!1),{showErrorToast:g,showToast:v}=O(),{t:k}=L(),[T]=I(),D="true"===T.get("onboarding"),E=()=>{d(null)},B=()=>{const e=D?"/":"/templates";n(`/works/assign/?work_id=${t.id}&copy=true&return_to=${e}`)};return a.jsxs(a.Fragment,{children:[a.jsx(_,{className:"template-card",draggable:!0,onDragStart:e=>{e.dataTransfer.setData("text/plain",t.id),e.currentTarget.style.opacity="0.5"},onDragEnd:e=>{e.currentTarget.style.opacity="1"},onDragOver:e=>{e.preventDefault(),e.stopPropagation(),e.currentTarget.style.cursor="default"},sx:{height:"100%",cursor:"pointer","&:hover":{boxShadow:6},position:"relative",borderLeft:"4px solid",borderLeftColor:"primary.main",borderRadius:3,borderTopLeftRadius:2,borderBottomLeftRadius:3},onClick:()=>s(t,"view"),children:a.jsx(z,{sx:{p:2,"&:last-child":{paddingBottom:2}},children:a.jsxs(o,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",gap:1},children:[a.jsx(j,{sx:{flex:1,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.2},children:t.name}),a.jsx(W,{title:k("templates.actions.sendToStudent"),children:a.jsx(m,{size:"small",onClick:B,sx:{flexShrink:0},children:a.jsx(oe,{fontSize:"small"})})}),a.jsx(m,{size:"small",onClick:e=>{e.stopPropagation(),d(e.currentTarget)},sx:{flexShrink:0},children:a.jsx(Y,{fontSize:"small"})})]})})},t.id),a.jsxs(F,{anchorEl:i,open:Boolean(i),onClose:E,onClick:e=>e.stopPropagation(),children:[a.jsxs(c,{onClick:()=>{n(`/works/assign/?work_id=${t.id}&edit=true&return_to=/templates`)},children:[a.jsx(G,{fontSize:"small",sx:{mr:1}}),k("common.actions.edit")]}),a.jsxs(c,{onClick:B,children:[a.jsx(Q,{fontSize:"small",sx:{mr:1}}),k("common.actions.copy")]}),a.jsxs(c,{onClick:()=>{E(),s(t,"move")},children:[a.jsx(ee,{fontSize:"small",sx:{mr:1}}),k("common.actions.moveTo")]}),a.jsxs(c,{onClick:()=>{E(),p(!0)},disabled:h,sx:{color:"error.main"},children:[h?a.jsx(y,{size:20,sx:{mr:1}}):a.jsx(te,{fontSize:"small",sx:{mr:1}}),k("common.actions.delete")]})]}),a.jsxs(b,{open:u,onClose:()=>!h&&p(!1),maxWidth:"xs",fullWidth:!0,children:[a.jsx(w,{children:k("common.dialog.delete.title",{item:k("templates.titleSingle")})}),a.jsx(S,{children:a.jsx(j,{children:k("common.dialog.delete.message",{name:null==t?void 0:t.name})})}),a.jsxs(C,{children:[a.jsx(x,{onClick:()=>p(!1),disabled:h,children:k("common.actions.cancel")}),a.jsx(x,{onClick:async()=>{f(!0);try{await P.works.delete(t.id),l(t),v(k("templates.status.templateDeleted"),"success")}catch(e){g(M(e))}finally{f(!1),p(!1)}},color:"error",variant:"contained",disabled:h,startIcon:h?a.jsx(y,{size:20}):a.jsx(te,{}),children:k(h?"common.status.deleting":"common.actions.delete")})]})]})]})},he=({folder:e,onClick:t,onContextMenu:r,onDrop:s,onFolderDrop:l,allWorks:n,isNewFolder:i=!1})=>a.jsxs(o,{sx:{width:120},children:[a.jsx(_,{className:i?"folder-card":"","data-folder-id":e.id,draggable:!0,onDragStart:t=>{t.dataTransfer.setData("folder-id",e.id),t.currentTarget.style.opacity="0.5"},onDragEnd:e=>{e.currentTarget.style.opacity="1"},onDragOver:e=>{e.preventDefault(),e.currentTarget.style.boxShadow="0 0 10px 0 rgba(0, 0, 0, 0.1)",e.currentTarget.style.transform="scale(1.1)",e.currentTarget.style.transition="transform 0.2s ease"},onDragLeave:e=>{e.currentTarget.style.boxShadow="none",e.currentTarget.style.transform="scale(1)"},onDrop:t=>{t.preventDefault(),t.currentTarget.style.boxShadow="none",t.currentTarget.style.transform="scale(1)";const r=t.dataTransfer.getData("text/plain"),a=t.dataTransfer.getData("folder-id");if(r){const t=n.find((e=>e.id===r));t&&s(t,e.id)}else a&&l(a,e.id)},sx:{cursor:"pointer","&:hover":{boxShadow:6,transform:"scale(1.05)",transition:"transform 0.2s ease"},position:"relative",zIndex:0,width:"100%",display:"flex",flexDirection:"column","&.folder-card":{transition:"transform 0.2s ease",animation:"zoomIn 0.3s ease","@keyframes zoomIn":{"0%":{transform:"scale(0)",opacity:0},"80%":{transform:"scale(1.05)",opacity:1},"100%":{transform:"scale(1)",opacity:1}}}},onClick:()=>t(e),onContextMenu:t=>r(t,e),children:a.jsxs(o,{sx:{position:"relative",width:"100%",paddingTop:"150%",overflow:"hidden"},children:[a.jsx(v,{variant:"square",src:e.cover||void 0,sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",bgcolor:e.cover?"primary.main":ce(e.title),fontSize:"300%"},children:!e.cover&&ue(e.title)}),a.jsx(m,{size:"small",onClick:t=>{t.stopPropagation(),r(t,e)},sx:{position:"absolute",bottom:4,right:4,bgcolor:"background.paper",opacity:.5,"&:hover":{bgcolor:"background.default",opacity:1}},children:a.jsx(Y,{fontSize:"small"})})]})}),a.jsx(j,{sx:{mt:2,width:"100%",overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.2,textAlign:"center"},children:e.title})]}),fe=()=>{var _,I,z,W,oe,ue;const{user:fe}=E(),ge=e(),je=t(),{showErrorToast:ve,showToast:ye}=O(),{t:be}=L(),we=new URLSearchParams(je.search).get("teacher");new URLSearchParams(je.search).get("folder");const ke="true"===new URLSearchParams(je.search).get("clear_filters"),[Se,Ce]=r.useState(null),[Fe,Te]=r.useState((()=>{try{if(ke)return localStorage.removeItem(me),{teacherFilter:"",searchTerm:"",folderState:void 0};const e=localStorage.getItem(me);if(e){const t=JSON.parse(e);return Ce(t),t}}catch(e){}return{teacherFilter:"",searchTerm:"",folderState:void 0}})),[De,_e]=r.useState(Fe.teacherFilter),[Ie,ze]=r.useState(Fe.searchTerm),[We,Ee]=r.useState(Fe.searchTerm),[Oe,Le]=r.useState((()=>(()=>{try{return localStorage.getItem(xe)||"created_at_desc"}catch(Ve){return"created_at_desc"}})())),[Be,Ae]=r.useState(Fe.folderState||{currentFolder:null,breadcrumbs:[]}),[Pe,Me]=r.useState([]),[Re,$e]=r.useState([]),[Ue,Ne]=r.useState([]),[He,Ke]=r.useState(!0),[qe,Je]=r.useState(!1),[Ze,Ge]=r.useState(!0),[Ve,Xe]=r.useState(null),[Ye,Qe]=r.useState(null),[et,tt]=r.useState(null),[rt,st]=r.useState(!1),[lt,at]=r.useState(!1),[ot,nt]=r.useState(!1),[it,dt]=r.useState(null),ct=Boolean(it),[ut,mt]=r.useState(!1),[xt,pt]=r.useState(0),ht=r.useRef(!0),[ft,gt]=r.useState(0),[jt,vt]=r.useState(!0),yt=15,[bt,wt]=r.useState([]),[kt,St]=r.useState(!0),[Ct,Ft]=r.useState(!1),[Tt,Dt]=r.useState({title:"",description:"",type:B.BOOK,cover:void 0}),[_t,It]=r.useState(!1),[zt,Wt]=r.useState(null),[Et,Ot]=r.useState(null),[Lt,Bt]=r.useState(!1),[At,Pt]=r.useState(null),[Mt,Rt]=r.useState(!1),[$t,Ut]=r.useState(!1),[Nt,Ht]=r.useState(!1),[Kt,qt]=r.useState([]),[Jt,Zt]=r.useState(!0),[Gt,Vt]=r.useState(0),[Xt,Yt]=r.useState(!0),[Qt,er]=r.useState(!1),tr=r.useRef(null),[rr,sr]=r.useState(!1),[lr,ar]=r.useState((()=>{try{const e=localStorage.getItem("templatesAccordionState");return e?JSON.parse(e):{folders:!0,allTemplates:!0}}catch{return{folders:!0,allTemplates:!0}}})),[or,nr]=r.useState(!1),[ir,dr]=r.useState(!1),[cr,ur]=r.useState(!1),[mr,xr]=r.useState(null),[pr,hr]=r.useState(!1);r.useEffect((()=>{const e=setTimeout((()=>{We!==Ie&&ze(We)}),500);return()=>clearTimeout(e)}),[We]);const fr=(null==fe?void 0:fe.role)===A.ADMIN,gr=(null==fe?void 0:fe.role)===A.TEACHER||fr;r.useEffect((()=>{if(!ht.current){const e={teacherFilter:De,searchTerm:Ie,folderState:Be};localStorage.setItem(me,JSON.stringify(e))}}),[De,Ie,Be]),r.useEffect((()=>{ht.current||(e=>{localStorage.setItem(xe,e)})(Oe)}),[Oe]),r.useEffect((()=>{(async()=>{if(!ut){Ge(!0),Xe(null);try{if(we&&_e(we),fr){const e=(await P.users.getAll(0,100,void 0,A.TEACHER)).sort(((e,t)=>{const r=N(e).toLowerCase(),s=N(t).toLowerCase();return r.localeCompare(s)}));Ne(e)}ht.current=!1}catch(e){const t=M(e);Xe(t),mt(!0),ve(t)}finally{Ge(!1)}}})()}),[we,fr,ut]),r.useEffect((()=>{(async()=>{if(!Ze&&!ht.current){St(!0);try{if(!Be.currentFolder){const e=await P.folders.getAll(0,100,void 0,void 0,De||(null==fe?void 0:fe.id),Ie,"name_asc"===Oe||"name_desc"===Oe?Oe.replace("name_","title_"):Oe);wt(e)}}catch(e){ve(M(e))}finally{St(!1)}}})()}),[De,null==fe?void 0:fe.id,Ie,Oe,Be.currentFolder,Ze]),r.useEffect((()=>{(async()=>{if(!Ze&&!ht.current){Ke(!0),Xe(null);try{const e=De||(null==fe?void 0:fe.id);let t=[];Be.currentFolder?(t=(Be.currentFolder.works||[]).filter((e=>e.name.toLowerCase().includes(Ie.toLowerCase()))),t=[...t].sort(((e,t)=>"name_asc"===Oe?e.name.localeCompare(t.name):"name_desc"===Oe?t.name.localeCompare(e.name):"created_at_asc"===Oe?new Date(e.created_at).getTime()-new Date(t.created_at).getTime():new Date(t.created_at).getTime()-new Date(e.created_at).getTime()))):t=await P.works.getAll(0,yt,void 0,e,e,Ie,Oe),Me(t),gt(0),vt(t.length===yt),Xe(null)}catch(e){const t=M(e);Xe(t),ve(t)}finally{Ke(!1)}}})()}),[De,null==fe?void 0:fe.id,Be.currentFolder,Ie,Oe,Ze]),r.useEffect((()=>{var e,t,r;Se&&(null==(e=Se.folderState)?void 0:e.currentFolder)&&P.folders.getById(null==(r=null==(t=Se.folderState)?void 0:t.currentFolder)?void 0:r.id).then((e=>{Ae((t=>({...t,currentFolder:e})))}))}),[Se]),r.useEffect((()=>{(async()=>{if(!Ze&&!ht.current){Zt(!0);try{const e=De||(null==fe?void 0:fe.id),t=await P.works.getAll(0,yt,void 0,e,e,Ie,Oe);qt(t),Vt(0),Yt(t.length===yt)}catch(e){ve(M(e))}finally{Zt(!1)}}})()}),[De,null==fe?void 0:fe.id,Ie,Oe,Ze]);const jr=r.useCallback((async()=>{if(!Xt||Qt)return;er(!0);const e=Gt+1;try{const t=De||(null==fe?void 0:fe.id),r=await P.works.getAll(e*yt,yt,void 0,t,t,Ie,Oe);r.length>0?(qt((e=>[...e,...r])),Vt(e),Yt(r.length===yt)):Yt(!1)}catch(t){ve(M(t))}finally{er(!1)}}),[Xt,Qt,Gt,De,null==fe?void 0:fe.id,Ie,Oe,yt]);r.useEffect((()=>{const e=new IntersectionObserver((e=>{const[t]=e;t.isIntersecting&&Xt&&!Jt&&!Qt&&jr()}),{threshold:.5}),t=tr.current;return t&&e.observe(t),()=>{t&&e.unobserve(t)}}),[Xt,Jt,Qt,jr]);const vr=()=>{localStorage.removeItem(me),_e(""),ze(""),Ee("")},yr=(e,t="view")=>{tt(e),"move"===t?(xr({type:"template",id:e.id}),ur(!0),nt(!1)):nt(!0)},br=()=>{nt(!1),tt(null),Qe(null),at(!1)},wr=()=>{dt(null)},kr=r.useCallback((()=>{pt((e=>e+1))}),[]),Sr=async e=>{St(!0);try{const t=await P.folders.getById(e.id);Ae((r=>({currentFolder:t,breadcrumbs:[...r.breadcrumbs,e]}))),Me(t.works||[]),de(e.id)}catch(t){ve(M(t))}finally{St(!1)}},Cr=async()=>{try{Ae({currentFolder:null,breadcrumbs:[]});const e=De||(null==fe?void 0:fe.id),t=await P.works.getAll(0,yt,void 0,e,e,Ie,Oe);qt(t),Vt(0),Yt(t.length===yt),de(null)}catch(e){ve(M(e))}},Fr=(e,t)=>{e.preventDefault(),e.stopPropagation(),Ot(t),Wt(e.currentTarget)},Tr=()=>{Wt(null)},Dr=async(e,t)=>{try{t?await P.folders.addWork(t,e.id):null!==Be.currentFolder&&await P.folders.removeWork(Be.currentFolder.id,e.id),null!==Be.currentFolder?Me((t=>t.filter((t=>t.id!==e.id)))):qt((t=>t.filter((t=>t.id!==e.id)))),ye(be("templates.status.templateMoved"),"success")}catch(r){ve(M(r))}},_r=e=>{Me((t=>t.filter((t=>t.id!==e.id)))),qt((t=>t.filter((t=>t.id!==e.id))))},Ir=async(e,t)=>{try{if(e===t)return;await P.folders.update(e,{parent_id:t}),Be.currentFolder?Ae((t=>({...t,currentFolder:{...t.currentFolder,subfolders:t.currentFolder.subfolders.filter((t=>t.id!==e))}}))):wt((t=>t.filter((t=>t.id!==e)))),ye(be("templates.status.folderMoved"),"success")}catch(r){ve(M(r))}},zr=s(),Wr=l(zr.breakpoints.down("md")),Er=e=>{e.dataTransfer.getData("text/plain")||e.dataTransfer.getData("folder-id")?sr(!0):e.preventDefault()},Or=()=>{sr(!1)};r.useEffect((()=>(document.addEventListener("dragstart",Er),document.addEventListener("dragend",Or),document.addEventListener("drop",Or),()=>{document.removeEventListener("dragstart",Er),document.removeEventListener("dragend",Or),document.removeEventListener("drop",Or)})),[]);return a.jsxs(o,{children:[a.jsx(R,{title:be("templates.title"),actionButton:[{label:be(Wr?"templates.actions.folder":"templates.actions.addFolder"),icon:a.jsx($,{}),onClick:()=>Ft(!0)},{label:be(Wr?"templates.actions.template":"templates.actions.createTemplate"),icon:a.jsx(U,{}),onClick:()=>ge(`/works/assign?template=true${Be.currentFolder?`&folder=${Be.currentFolder.id}`:""}&return_to=/templates`)}]}),a.jsx(n,{sx:{p:2,mb:2},children:a.jsxs(o,{sx:{display:"flex",flexDirection:"column",gap:2},children:[fr&&a.jsx(i,{fullWidth:!0,size:"small",sx:{"& .MuiOutlinedInput-root":{borderRadius:2}},children:a.jsxs(d,{value:De,onChange:e=>_e(e.target.value),displayEmpty:!0,children:[a.jsx(c,{value:null==fe?void 0:fe.id,children:be("templates.filters.onlyMy")}),Ue.map((e=>a.jsx(c,{value:e.id,children:N(e)||e.id},e.id)))]})}),a.jsxs(o,{sx:{display:"flex",flexDirection:{xs:"column",lg:"row"},gap:2,alignItems:{xs:"stretch",lg:"flex-start"}},children:[a.jsx(u,{label:be("templates.filters.search"),placeholder:Be.currentFolder?be("templates.filters.searchInside"):be("templates.filters.searchGlobal"),variant:"outlined",fullWidth:!0,size:"small",sx:{order:{xs:2,lg:1},flex:{lg:1}},value:We,onChange:e=>Ee(e.target.value),InputProps:{startAdornment:a.jsx(K,{sx:{mr:1,color:"text.secondary"},fontSize:"small"}),endAdornment:We?a.jsx(m,{"aria-label":"clear search",onClick:()=>{Ee(""),ze("")},edge:"end",size:"small",children:a.jsx(H,{fontSize:"small"})}):null}}),a.jsx(i,{size:"small",sx:{order:{xs:1,lg:2},minWidth:{xs:"auto",md:180},width:{xs:"100%",md:"auto"},"& .MuiOutlinedInput-root":{borderRadius:2}},children:a.jsxs(d,{value:Oe,onChange:e=>Le(e.target.value),displayEmpty:!0,startAdornment:a.jsx(q,{sx:{mr:1,color:"text.secondary"}}),children:[a.jsx(c,{value:"created_at_desc",children:be("templates.filters.order.newestFirst")}),a.jsx(c,{value:"created_at_asc",children:be("templates.filters.order.oldestFirst")}),a.jsx(c,{value:"name_asc",children:be("templates.filters.order.nameAZ")}),a.jsx(c,{value:"name_desc",children:be("templates.filters.order.nameZA")})]})})]}),(We||Ie||De)&&a.jsx(o,{sx:{display:"flex",justifyContent:"center"},children:a.jsx(x,{variant:"outlined",startIcon:a.jsx(J,{}),onClick:vr,children:be("common.actions.clear")})})]})}),Ve&&a.jsx(p,{severity:"error",sx:{mb:2},action:a.jsx(x,{color:"inherit",size:"small",onClick:kr,disabled:He,children:be(He?"common.status.loading":"common.actions.retry")}),children:Ve}),a.jsx(o,{sx:{mb:1,height:"2px"},children:kt&&a.jsx(h,{sx:{height:"2px"}})}),((null==(_=Be.currentFolder)?void 0:_.subfolders)||bt.length>0)&&a.jsxs(o,{sx:{mb:3},children:[a.jsxs(f,{sx:{ml:1,mb:2,transform:rr&&Be.breadcrumbs.length>0?"scale(2)":"scale(1)",transformOrigin:"left center",transition:"transform 0.3s ease-in-out"},children:[a.jsx(g,{onDrop:e=>{e.preventDefault();const t=e.dataTransfer.getData("text/plain"),r=e.dataTransfer.getData("folder-id");if(t){const e=Pe.find((e=>e.id===t));e&&Dr(e,null)}else r&&Ir(r,null)},onDragOver:e=>{e.preventDefault()},component:"button",variant:"body1",onClick:Cr,sx:{textDecoration:"none"},children:be("templates.title")}),Be.breadcrumbs.map(((e,t)=>t<Be.breadcrumbs.length-1?a.jsx(g,{onDrop:t=>{t.preventDefault();const r=t.dataTransfer.getData("text/plain"),s=t.dataTransfer.getData("folder-id");if(r){const t=Pe.find((e=>e.id===r));t&&Dr(t,e.id)}else s&&Ir(s,e.id)},onDragOver:e=>e.preventDefault(),component:"button",variant:"body1",onClick:()=>(async(e,t)=>{St(!0);try{const r=await P.folders.getById(e.id);Ae({currentFolder:r,breadcrumbs:Be.breadcrumbs.slice(0,t+1)}),de(e.id)}catch(r){ve(M(r))}finally{St(!1)}})(e,t),sx:{textDecoration:"none"},children:e.title},e.id):a.jsx(j,{variant:"body1",children:e.title},e.id)))]}),Be.currentFolder&&a.jsxs(n,{sx:{p:2,my:3,display:"flex",gap:3,alignItems:"flex-start",position:"relative"},children:[a.jsx(m,{size:"small",onClick:async()=>{if(Be.breadcrumbs.length>1){const t=Be.breadcrumbs[Be.breadcrumbs.length-2];try{const e=await P.folders.getById(t.id);Ae((t=>({currentFolder:e,breadcrumbs:t.breadcrumbs.slice(0,-1)}))),de(t.id)}catch(e){ve(M(e))}}else Cr()},sx:{position:"absolute",top:4,left:4,bgcolor:"background.paper",opacity:.5,zIndex:1e3,"&:hover":{bgcolor:"background.default",opacity:1}},children:a.jsx(Z,{fontSize:"small"})}),a.jsx(v,{variant:"square",src:Be.currentFolder.cover||void 0,sx:{m:-2,mr:1,width:120,height:180,borderRadius:3,bgcolor:Be.currentFolder.cover?"primary.main":ce(Be.currentFolder.title),fontSize:"300%"},children:!Be.currentFolder.cover&&Be.currentFolder.title.split(" ").map((e=>e[0])).join("").toUpperCase()}),a.jsxs(o,{sx:{flex:1},children:[a.jsxs(o,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",gap:1,mb:1},children:[a.jsx(j,{variant:"h5",sx:{flex:1,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.2,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:Be.currentFolder.title}),a.jsx(m,{"aria-label":"edit",onClick:()=>{Be.currentFolder&&(Ot(Be.currentFolder),Dt({title:Be.currentFolder.title,description:Be.currentFolder.description||"",type:Be.currentFolder.type,cover:Be.currentFolder.cover||void 0}),Bt(!0),Ft(!0))},children:a.jsx(G,{})})]}),Be.currentFolder.description&&a.jsxs(o,{onClick:()=>dr(!ir),children:[a.jsx(j,{variant:"body1",color:"text.secondary",sx:{display:"-webkit-box",WebkitLineClamp:ir?"unset":3,WebkitBoxOrient:"vertical",overflow:"hidden",textOverflow:"ellipsis",transition:"all 0.2s ease-in-out",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:Be.currentFolder.description}),Be.currentFolder.description.split("\n").length>3&&a.jsx(j,{variant:"caption",color:"primary",sx:{cursor:"pointer",display:"block",mt:1,"&:hover":{opacity:.8}},children:ir?"Show less":"Show more"})]})]})]}),a.jsx(o,{sx:{display:"flex",flexWrap:"wrap",gap:5,my:3,mx:1},children:Be.currentFolder?((null==(I=Be.currentFolder)?void 0:I.subfolders)||[]).slice().sort(((e,t)=>"name_asc"===Oe||"title_asc"===Oe?e.title.localeCompare(t.title):"name_desc"===Oe||"title_desc"===Oe?t.title.localeCompare(e.title):"created_at_asc"===Oe?new Date(e.created_at).getTime()-new Date(t.created_at).getTime():new Date(t.created_at).getTime()-new Date(e.created_at).getTime())).map((e=>a.jsx(he,{folder:e,onClick:Sr,onContextMenu:Fr,onDrop:Dr,onFolderDrop:Ir,allWorks:Pe},e.id))):bt.slice().sort(((e,t)=>"name_asc"===Oe||"title_asc"===Oe?e.title.localeCompare(t.title):"name_desc"===Oe||"title_desc"===Oe?t.title.localeCompare(e.title):"created_at_asc"===Oe?new Date(e.created_at).getTime()-new Date(t.created_at).getTime():new Date(t.created_at).getTime()-new Date(e.created_at).getTime())).map((e=>a.jsx(he,{folder:e,onClick:Sr,onContextMenu:Fr,onDrop:Dr,onFolderDrop:Ir,allWorks:Kt},e.id)))}),Be.breadcrumbs.length>0&&a.jsxs(a.Fragment,{children:[a.jsx(o,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"repeat(2, 1fr)",lg:"repeat(3, 1fr)"},gap:2,position:"relative"},children:Pe.map((e=>a.jsx(pe,{work:e,onClick:yr,onDelete:_r},e.id)))}),0===Pe.length&&a.jsxs(o,{sx:{textAlign:"center",py:4},children:[a.jsx(j,{variant:"h6",color:"text.secondary",sx:{mb:1},children:be("templates.empty.noTemplatesInFolder")}),a.jsx(x,{variant:"outlined",onClick:()=>ge(`/works/assign?template=true${Be.currentFolder?`&folder=${Be.currentFolder.id}`:""}&return_to=/templates`),children:be("templates.actions.create")})]})]})]}),null===Be.currentFolder&&a.jsx(o,{children:Jt?a.jsx(V,{message:be("common.loading")}):a.jsxs(a.Fragment,{children:[0!==Kt.length||Ve?a.jsx(o,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"repeat(2, 1fr)",lg:"repeat(3, 1fr)"},gap:2,position:"relative"},children:Kt.map((e=>a.jsx(pe,{work:e,onClick:yr,onDelete:_r},e.id)))}):a.jsxs(o,{sx:{textAlign:"center",py:4},children:[a.jsx(j,{variant:"h6",color:"text.secondary",sx:{mb:1},children:De||Ie?be("templates.empty.noMatch"):bt.length>0?be("templates.empty.noFolder"):be("templates.empty.noTemplates")}),a.jsx(j,{variant:"body2",color:"text.secondary",sx:{mb:3},children:De||Ie?be("templates.hint.adjust"):bt.length>0?"":be("onboarding.steps.createTemplate.description")}),gr&&0===Kt.length&&!De&&!Ie&&a.jsx(x,{variant:"outlined",onClick:()=>ge(`/works/assign?template=true${Be.currentFolder?`&folder=${Be.currentFolder.id}`:""}&return_to=/templates`),sx:{borderRadius:2,textTransform:"none",fontWeight:500},children:be("templates.actions.create")}),0===Kt.length&&(De||Ie)&&a.jsx(x,{variant:"outlined",startIcon:a.jsx(J,{}),onClick:vr,sx:{borderRadius:2,textTransform:"none"},children:be("common.actions.clear")})]}),a.jsx(o,{ref:tr,sx:{display:"flex",justifyContent:"center",p:2,visibility:Xt?"visible":"hidden"},children:Qt&&a.jsx(y,{size:24})})]})}),a.jsxs(b,{open:ot,onClose:br,maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:2}},children:[a.jsx(w,{children:a.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[a.jsx(j,{variant:"h6",children:null==et?void 0:et.name}),et&&a.jsx(k,{label:be("templates.titleSingle"),color:"primary",size:"small"})]})}),a.jsxs(S,{children:[Ye&&a.jsx(p,{severity:"error",sx:{mb:2},children:Ye}),et&&a.jsx(a.Fragment,{children:a.jsx(X,{work:et,isStudent:!1,error:Ye,onTaskClick:e=>{et&&ge(`/works/${et.id}?task_number=${e}&return_to=/templates`)},hideButtons:!0})})]}),a.jsxs(C,{sx:{display:"flex",justifyContent:"space-between",px:2,pb:2},children:[a.jsx(o,{sx:{display:"flex",gap:1},children:gr&&a.jsxs(a.Fragment,{children:[a.jsx(x,{color:"primary",onClick:e=>{e.stopPropagation(),dt(e.currentTarget)},"aria-label":"actions","aria-controls":ct?"actions-menu":void 0,"aria-haspopup":"true","aria-expanded":ct?"true":void 0,startIcon:a.jsx(Y,{}),children:be("common.actions.actions")}),a.jsxs(F,{id:"actions-menu",anchorEl:it,open:ct,onClose:wr,MenuListProps:{"aria-labelledby":"actions-button"},children:[a.jsxs(c,{onClick:()=>{var e;e=et.id,ge(`/works/assign/?work_id=${e}&edit=true&return_to=/templates`)},children:[a.jsx(G,{fontSize:"small",sx:{mr:1}}),be("works.actions.edit")]}),a.jsxs(c,{onClick:()=>{et&&ge(`/works/assign/?work_id=${et.id}&copy=true&return_to=/templates`)},children:[a.jsx(Q,{fontSize:"small",sx:{mr:1}}),be("common.actions.copy")]}),a.jsxs(c,{onClick:()=>{wr(),br(),et&&(xr({type:"template",id:et.id}),ur(!0)),wr()},children:[a.jsx(ee,{fontSize:"small",sx:{mr:1}}),be("common.actions.moveTo")]}),a.jsxs(c,{onClick:()=>{wr(),at(!0)},disabled:rt,sx:{color:"error.main"},children:[rt?a.jsx(y,{size:20,sx:{mr:1}}):a.jsx(te,{fontSize:"small",sx:{mr:1}}),be("common.actions.delete")]})]})]})}),a.jsx(o,{children:a.jsx(x,{onClick:br,children:be("common.actions.close")})})]})]}),a.jsxs(b,{open:lt,onClose:()=>at(!1),maxWidth:"xs",fullWidth:!0,children:[a.jsx(w,{children:be("common.dialog.delete.title",{item:be("templates.titleSingle")})}),a.jsx(S,{children:a.jsx(j,{children:be("common.dialog.delete.message",{name:null==et?void 0:et.name})})}),a.jsxs(C,{children:[a.jsx(x,{onClick:()=>at(!1),disabled:rt,children:be("common.actions.cancel")}),a.jsx(x,{onClick:async()=>{if(et){st(!0),Qe(null);try{await P.works.delete(et.id),Me((e=>e.filter((e=>e.id!==et.id)))),qt((e=>e.filter((e=>e.id!==et.id)))),br(),ye(be("templates.status.templateDeleted"),"success")}catch(e){const t=e instanceof Error?e.message:"Failed to delete work. Please try again.";ve(t)}finally{st(!1),at(!1)}}},color:"error",variant:"contained",disabled:rt,startIcon:rt?a.jsx(y,{size:20}):a.jsx(te,{}),children:be(rt?"common.status.deleting":"common.actions.delete")})]})]}),a.jsxs(b,{open:Ct,onClose:()=>!_t&&Ft(!1),maxWidth:"sm",fullWidth:!0,children:[a.jsx(w,{children:be(Lt?"common.actions.edit":"common.actions.create")}),a.jsx(S,{children:a.jsxs(T,{spacing:2,sx:{mt:1},children:[a.jsx(o,{sx:{display:"flex",justifyContent:"center",mb:2},children:Nt?a.jsx(o,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:180,width:120},children:a.jsx(y,{})}):a.jsx(v,{variant:"square",src:Tt.cover||void 0,sx:{width:120,height:180,borderRadius:3,bgcolor:"primary.main",cursor:"pointer","&:hover":{opacity:.8}},onClick:()=>{nr(!0),Ht(!1)},children:!Tt.cover&&a.jsx(re,{})})}),a.jsx(u,{label:be("templates.dialog.createFolder.name"),value:Tt.title,onChange:e=>Dt((t=>({...t,title:e.target.value}))),fullWidth:!0,required:!0,disabled:_t,error:Tt.title.length>100,helperText:Tt.title.length>100?be("templates.validation.titleLength"):""}),a.jsx(u,{label:be("templates.dialog.createFolder.description"),value:Tt.description,onChange:e=>Dt((t=>({...t,description:e.target.value}))),fullWidth:!0,multiline:!0,rows:2,disabled:_t,error:(null==(z=Tt.description)?void 0:z.length)>1e3,helperText:(null==(W=Tt.description)?void 0:W.length)>1e3?be("templates.validation.descriptionLength"):""})]})}),a.jsxs(C,{children:[a.jsx(x,{onClick:()=>{Ft(!1),Bt(!1),Dt({title:"",description:"",type:B.BOOK,cover:void 0})},disabled:_t,children:be("common.actions.cancel")}),a.jsx(x,{onClick:async()=>{var e;if(!Tt.title.trim())return;const t=ne(ie,{...Tt,type:B.BOOK});if(t.isValid){It(!0);try{if(Lt&&Et){const e=await P.folders.update(Et.id,{...Tt});Be.currentFolder?Be.currentFolder.id===Et.id?Ae((t=>({...t,currentFolder:{...t.currentFolder,...e,subfolders:t.currentFolder.subfolders,works:t.currentFolder.works},breadcrumbs:t.breadcrumbs.map((t=>t.id===Et.id?{...t,...e}:t))}))):Ae((t=>({...t,currentFolder:{...t.currentFolder,subfolders:t.currentFolder.subfolders.map((t=>t.id===Et.id?e:t))}}))):wt((t=>t.map((t=>t.id===Et.id?e:t)))),ye(be("folders.status.updated"),"success")}else{const t=await P.folders.create({...Tt,parent_id:(null==(e=Be.currentFolder)?void 0:e.id)||null});Be.currentFolder?Ae((e=>({...e,currentFolder:{...e.currentFolder,subfolders:[t,...e.currentFolder.subfolders]}}))):wt((e=>[t,...e])),ye(be("templates.status.folderCreated"),"success")}Dt({title:"",description:"",type:B.BOOK,cover:void 0}),Ft(!1),Bt(!1)}catch(r){ve(M(r))}finally{It(!1)}}else{const e=Object.values(t.errors)[0];ve(e)}},variant:"contained",disabled:_t||!Tt.title.trim()||Tt.title.length>100||((null==(oe=Tt.description)?void 0:oe.length)||0)>1e3,startIcon:_t?a.jsx(y,{size:20}):null,children:be(_t?"common.loading":Lt?"common.actions.save":"common.actions.create")})]})]}),a.jsxs(b,{open:or,onClose:()=>nr(!1),maxWidth:"sm",fullWidth:!0,children:[a.jsx(w,{children:be("templates.dialog.createFolder.cover.title")}),a.jsx(S,{children:Nt?a.jsx(o,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:a.jsx(y,{})}):a.jsxs(a.Fragment,{children:[a.jsx(se,{onLoading:e=>{Dt((e=>({...e,cover:void 0}))),Ht(e),nr(!1)},onImageUpload:e=>{Dt((t=>({...t,cover:e}))),nr(!1),Ht(!1)},onClose:()=>{nr(!1),Ht(!1)}}),Tt.cover&&a.jsx(o,{sx:{display:"flex",justifyContent:"center",mt:2},children:a.jsx(x,{variant:"outlined",color:"error",startIcon:a.jsx(te,{}),onClick:()=>{Dt((e=>({...e,cover:void 0}))),nr(!1)},children:be("templates.dialog.createFolder.cover.delete")})})]})})]}),a.jsxs(F,{anchorEl:zt,open:Boolean(zt),onClose:Tr,children:[a.jsxs(c,{onClick:()=>{Et&&(Dt({title:Et.title,description:Et.description||"",type:Et.type,cover:Et.cover||void 0}),Bt(!0),Ft(!0)),Tr()},children:[a.jsx(G,{fontSize:"small",sx:{mr:1}}),be("common.actions.edit")]}),a.jsxs(c,{onClick:()=>{Et&&(xr({type:"folder",id:Et.id}),ur(!0)),Tr()},children:[a.jsx(ee,{fontSize:"small",sx:{mr:1}}),be("common.actions.moveTo")]}),a.jsxs(c,{onClick:()=>{Tr(),Pt(Et),Ut(!0)},sx:{color:"error.main"},children:[a.jsx(te,{fontSize:"small",sx:{mr:1}}),be("common.actions.delete")]})]}),a.jsxs(b,{open:$t,onClose:()=>!Mt&&Ut(!1),maxWidth:"xs",fullWidth:!0,children:[a.jsx(w,{children:be("common.dialog.delete.title",{item:be("templates.dialog.move.folder")})}),a.jsxs(S,{children:[a.jsx(j,{children:be("templates.dialog.delete.folder.message")}),a.jsx(j,{children:be("templates.dialog.delete.folder.moveTemplates")}),a.jsx(j,{children:be("templates.dialog.delete.folder.deleteSubfolders")})]}),a.jsxs(C,{children:[a.jsx(x,{onClick:()=>Ut(!1),disabled:Mt,children:be("common.actions.cancel")}),a.jsx(x,{onClick:async()=>{if(At){Rt(!0);try{await P.folders.delete(At.id),Be.currentFolder?Ae((e=>({...e,currentFolder:{...e.currentFolder,subfolders:e.currentFolder.subfolders.filter((e=>e.id!==At.id))}}))):(wt((e=>e.filter((e=>e.id!==At.id)))),await Cr()),Ut(!1),Pt(null),ye(be("templates.status.folderDeleted"),"success")}catch(e){ve(M(e))}finally{Rt(!1)}}},color:"error",variant:"contained",disabled:Mt,startIcon:Mt?a.jsx(y,{size:20}):a.jsx(te,{}),children:be(Mt?"common.status.deleting":"common.actions.delete")})]})]}),a.jsx(D,{anchor:"right",open:cr,onClose:()=>{ur(!1),xr(null)},PaperProps:{sx:{width:{xs:"100%",sm:400},p:2}},children:a.jsxs(o,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[a.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[a.jsx(j,{variant:"h6",children:be("templates.dialog.move.title",{type:"folder"===(null==mr?void 0:mr.type)?be("templates.dialog.move.folder"):be("templates.dialog.move.template")})}),a.jsx(m,{onClick:()=>{ur(!1),xr(null)},children:a.jsx(le,{})})]}),a.jsx(o,{sx:{flex:1,overflow:"auto"},children:a.jsx(ae,{onFolderSelect:async e=>{if(mr){hr(!0);try{"template"===mr.type?(e?await P.folders.addWork(e.id,mr.id):await P.folders.removeWork(Be.currentFolder.id,mr.id),Be.currentFolder?Me((e=>e.filter((e=>e.id!==mr.id)))):qt((e=>e.filter((e=>e.id!==mr.id)))),ye(be("templates.status.templateMoved"),"success")):(await P.folders.update(mr.id,{parent_id:(null==e?void 0:e.id)||null}),Be.currentFolder?Ae((e=>({...e,currentFolder:{...e.currentFolder,subfolders:e.currentFolder.subfolders.filter((e=>e.id!==mr.id))}}))):wt((e=>e.filter((e=>e.id!==mr.id)))),ye(be("templates.status.folderMoved"),"success")),ur(!1),xr(null)}catch(t){ve(M(t))}finally{hr(!1)}}},isShowRoot:!0,currentFolder:null==(ue=Be.currentFolder)?void 0:ue.id,movingFolder:"folder"===(null==mr?void 0:mr.type)?mr.id:void 0})})]})})]})};export{fe as default};
