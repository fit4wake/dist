import{a7 as e,a8 as s,r as n,j as t,v as r,B as a,y as l,b as o,H as i,an as c,J as d,d as m,A as u,ak as x,x as p,E as h,G as f,h as y,o as j,N as b}from"./vendor-EJ2UFF3P.js";import{b as v,u as g,U as _,a as I,br as S,L as P,aw as w,aS as E,bt as C,A as T,bs as z,bu as A,c as D,ar as U,au as O,bv as R}from"./main-BnhaBm3Q.js";const W=R.object({type:R.nativeEnum(S,{errorMap:()=>({message:"transactions.validation.typeRequired"})}),contract_id:R.string().uuid("transactions.validation.contractRequired"),amount:R.number().optional().nullable(),currency:R.string().optional().nullable(),lessons_number:R.number().int("transactions.validation.minimumLessons").min(1,"transactions.validation.minimumLessons").optional().nullable()}).refine((e=>void 0!==e.lessons_number&&null!==e.lessons_number||void 0!==e.amount&&null!==e.amount&&e.currency),{message:"transactions.validation.lessonsOrAmount",path:["form"]}),L=()=>{const{t:R}=v(),L=e(),[M]=s(),k=M.get("return_to")||"/transactions",B="true"===M.get("is_top_up"),{user:q}=g(),H=(null==q?void 0:q.role)===_.ADMIN,N=(null==q?void 0:q.role)===_.TEACHER||H,{showToast:V,showErrorToast:G}=I(),J=M.get("contract_id"),[X,Y]=n.useState(!0),[F,K]=n.useState(!1),[Q,Z]=n.useState([]),[$,ee]=n.useState([]),[se,ne]=n.useState(null),[te,re]=n.useState({}),[ae,le]=n.useState({type:B?S.TOP_UP:S.REDEEM,lessons_number:1,amount:null,currency:null,contract_id:J||void 0});n.useEffect((()=>{(async()=>{Y(!0),ne(null);try{const e=await D.contracts.getAll(0,100);Z(e);const s=await D.contracts.getCurrencies();if(ee(s),J){const s=e.find((e=>e.id===J));s&&le((e=>({...e,contract_id:J,currency:s.currency})))}}catch(e){ne(R("common.error")),G(e.message)}finally{Y(!1)}})()}),[G,J]);const oe=e=>{const{name:s,value:n}=e.target;let t=n;"lessons_number"!==s&&"amount"!==s||(t=""===n?null:Math.max(0,parseInt(n,10))),le((e=>({...e,[s]:t}))),te[s]&&re((e=>{const n={...e};return delete n[s],n}))},ie=e=>{const{name:s,value:n}=e.target;if("contract_id"===s){const e=Q.find((e=>e.id===n));le(e?t=>({...t,[s]:n,currency:e.currency}):e=>({...e,[s]:n}))}else le((e=>({...e,[s]:n})));te[s]&&re((e=>{const n={...e};return delete n[s],n}))},ce=async e=>{e.preventDefault();const s=U(W,ae);if(s.isValid){K(!0),ne(null);try{await D.transactions.create(ae),V(R("transactions.actions.createdSuccess"),"success"),L(k)}catch(n){ne(R("common.error")),G(n.message)}finally{K(!1)}}else re(s.errors)};if(X)return t.jsx(P,{message:R("common.loading")});if(!N)return t.jsx(r,{severity:"error",children:R("common.error")});const de=e=>O(e.student);return t.jsx(a,{sx:{display:"flex",flexDirection:"column",overflowX:"hidden",overflowY:"auto"},children:t.jsxs(a,{sx:{flex:1,display:"flex",flexDirection:"column",mx:"auto",width:"100%",maxWidth:"800px",pb:1},children:[t.jsxs(l,{sx:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",p:3,pt:1},children:[t.jsx(o,{variant:"h6",gutterBottom:!0,sx:{mt:1,mb:2},children:R("transactions.form.title")}),se&&t.jsx(r,{severity:"error",sx:{mb:3},children:se}),te.form&&t.jsx(r,{severity:"error",sx:{mb:3},children:R(te.form)}),t.jsxs(a,{component:"form",onSubmit:ce,noValidate:!0,children:[t.jsxs(i,{fullWidth:!0,error:!!te.contract_id,sx:{mb:3},children:[t.jsx(c,{id:"contract-label",children:R("transactions.form.contract")}),t.jsx(d,{labelId:"contract-label",name:"contract_id",value:ae.contract_id||"",label:R("transactions.form.contract"),onChange:ie,children:0===Q.length?t.jsx(m,{disabled:!0,children:R("transactions.form.noActiveContracts")}):Q.map((e=>{var s;return t.jsx(m,{value:e.id,children:t.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1},children:[t.jsx(u,{src:(null==(s=e.student)?void 0:s.photo_url)||void 0,sx:{width:24,height:24},children:w(e.student)}),t.jsx(o,{children:de(e)})]})},e.id)}))}),te.contract_id&&t.jsx(x,{children:R(te.contract_id)})]}),ae.contract_id&&t.jsx(l,{elevation:0,variant:"outlined",sx:{p:2,mb:3},children:(()=>{const e=Q.find((e=>e.id===ae.contract_id));return e?t.jsxs(p,{spacing:2,children:[t.jsxs(a,{sx:{display:"flex",alignItems:"center"},children:[t.jsx(E,{sx:{mr:1,color:"text.secondary"}}),t.jsxs(o,{children:[R("transactions.form.contractInfo.paidLessons"),": ",e.balance]})]}),t.jsxs(a,{sx:{display:"flex",alignItems:"center"},children:[t.jsx(C,{sx:{mr:1,color:"text.secondary"}}),t.jsxs(o,{children:[R("transactions.form.contractInfo.pricePerLesson"),": ",e.price," ",e.currency]})]})]}):null})()}),t.jsxs(i,{fullWidth:!0,error:!!te.type,sx:{mb:3},children:[t.jsxs(h,{value:ae.type,exclusive:!0,onChange:(e,s)=>{null!==s&&(le((e=>({...e,type:s}))),te.type&&re((e=>{const s={...e};return delete s.type,s})))},"aria-label":R("transactions.form.type.label"),fullWidth:!0,color:"primary",children:[t.jsx(f,{value:S.TOP_UP,children:t.jsxs(a,{sx:{display:"flex",alignItems:"center"},children:[t.jsx(T,{fontSize:"small",color:"success",sx:{mr:.5}}),t.jsx(o,{children:R("transactions.form.type.topUp")})]})}),t.jsx(f,{value:S.REDEEM,children:t.jsxs(a,{sx:{display:"flex",alignItems:"center"},children:[t.jsx(z,{fontSize:"small",color:"error",sx:{mr:.5}}),t.jsx(o,{children:R("transactions.form.type.redeem")})]})})]}),te.type&&t.jsx(x,{children:R(te.type)})]}),t.jsxs(p,{spacing:3,children:[t.jsxs(a,{children:[t.jsxs(o,{variant:"body1",gutterBottom:!0,sx:{display:"flex",alignItems:"center",mb:2},children:[ae.type===S.TOP_UP?t.jsx(T,{fontSize:"small",color:"success",sx:{mr:.5}}):t.jsx(z,{fontSize:"small",color:"error",sx:{mr:.5}}),R("transactions.form.lessons.title",{action:ae.type===S.TOP_UP?R("transactions.toAdd"):R("transactions.toRedeem")})]}),t.jsx(y,{fullWidth:!0,name:"lessons_number",label:R("transactions.form.lessons.label"),type:"number",value:null===ae.lessons_number?"":ae.lessons_number,onChange:oe,error:!!te.lessons_number,helperText:te.lessons_number?R(te.lessons_number):"",InputProps:{inputProps:{min:1}}})]}),ae.type===S.TOP_UP&&t.jsxs(a,{id:"payment-section",children:[t.jsxs(o,{variant:"body1",gutterBottom:!0,sx:{display:"flex",alignItems:"center",mb:2},children:[t.jsx(A,{fontSize:"small",sx:{mr:1}}),R("transactions.form.payment.title")]}),t.jsxs(a,{sx:{display:"flex",gap:2},children:[t.jsx(y,{sx:{flex:1},name:"amount",label:R("transactions.form.payment.amount"),type:"number",value:null===ae.amount?"":ae.amount,onChange:oe,error:!!te.amount,helperText:te.amount?R(te.amount):"",InputProps:{inputProps:{min:0}}}),t.jsxs(i,{sx:{minWidth:120},error:!!te.currency,children:[t.jsx(c,{id:"currency-label",children:R("transactions.form.payment.currency")}),t.jsx(d,{labelId:"currency-label",name:"currency",value:ae.currency||"",label:R("transactions.form.payment.currency"),onChange:ie,children:$.map((e=>t.jsxs(m,{value:e.code,children:[e.emoji," ",e.code]},e.code)))}),te.currency&&t.jsx(x,{children:R(te.currency)})]})]})]})]})]})]}),t.jsxs(a,{sx:{mt:2,display:"flex",justifyContent:"space-between",flexShrink:0},children:[t.jsx(a,{sx:{display:"flex",alignItems:"center"},children:t.jsx(j,{variant:"outlined",size:"small",color:"inherit",sx:{mr:2},onClick:()=>{L(k)},disabled:F,children:R("common.actions.cancel")})}),t.jsx(a,{children:t.jsx(j,{type:"submit",variant:"contained",size:"small",color:"primary",onClick:ce,disabled:F,startIcon:F?t.jsx(b,{size:20}):null,children:R(F?"transactions.actions.creating":"transactions.actions.create")})})]})]})})};export{L as default};
