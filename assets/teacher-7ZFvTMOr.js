import{a7 as e,a8 as t,r as s,j as n,d as a,e as i,L as r,B as o,v as l,o as c,y as d,x,a1 as m,w as u,h,I as p,i as g,ai as f,aj as j,C as y,b as k,a2 as b,a3 as v,a5 as w,N as C,M as S,D as I,l as _,m as F,n as z,X as T,Y as $,U as P,af as A,K as E,O as D,f as W,ae as R,ak as M,Q as B,z as O,al as L,am as N,A as H,F as V,W as U,H as J,an as q,J as Q}from"./vendor-EJ2UFF3P.js";import{u as K,a as G,b as Y,U as X,c as Z,S as ee,C as te,D as se,P as ne,A as ae,T as ie,d as re,e as oe,F as le,L as ce,E as de,M as xe,f as me,g as ue,h as he,i as pe,j as ge,k as fe,I as je,l as ye,R as ke,m as be,n as ve,o as we,p as Ce,B as Se,W as Ie,q as _e,r as Fe,s as ze,t as Te,O as $e,v as Pe,w as Ae,x as Ee,y as De,z as We,G as Re,H as Me,J as Be,K as Oe,N as Le,Q as Ne,V as He,X as Ve,Y as Ue,Z as Je,_ as qe,$ as Qe,a0 as Ke,a1 as Ge,a2 as Ye,a3 as Xe,a4 as Ze,a5 as et,a6 as tt,a7 as st,a8 as nt,a9 as at,aa as it,ab as rt,ac as ot,ad as lt,ae as ct,af as dt,ag as xt,ah as mt,ai as ut,aj as ht,ak as pt,al as gt,am as ft,an as jt,ao as yt,ap as kt,aq as bt,ar as vt,as as wt,at as Ct,au as St,av as It,aw as _t,ax as Ft,ay as zt,az as Tt,aA as $t,aB as Pt,aC as At,aD as Et,aE as Dt,aF as Wt,aG as Rt,aH as Mt,aI as Bt,aJ as Ot,aK as Lt,aL as Nt,aM as Ht,aN as Vt,aO as Ut,aP as Jt,aQ as qt,aR as Qt}from"./main-FAEQQtJ7.js";const Kt="tasksPageFilters",Gt=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const T=e(),[$]=t(),{user:P}=K(),{showErrorToast:A}=G(),[E,D]=s.useState([]),[W,R]=s.useState([]),[M,B]=s.useState(!0),[O,L]=s.useState(!1),[N,H]=s.useState(null),[V,U]=s.useState(0),[J,q]=s.useState([]),[Q,he]=s.useState(""),[pe,ge]=s.useState(""),[fe,je]=s.useState(null),[ye,ke]=s.useState(!1),[be,ve]=s.useState(null),[we,Ce]=s.useState(null),[Se,Ie]=s.useState(!1),[_e,Fe]=s.useState(new Set),[ze,Te]=s.useState(!1),[$e,Pe]=s.useState(!1),Ae=s.useRef(!0),Ee=Boolean(be),[De,We]=s.useState(0),[Re,Me]=s.useState(!0),Be=30,Oe=s.useRef(null),{t:Le}=Y(),Ne=(null==P?void 0:P.role)===X.ADMIN,He=(null==P?void 0:P.role)===X.TEACHER||Ne,Ve=s.useCallback((()=>{try{const e=localStorage.getItem(Kt);if(e){return JSON.parse(e)}}catch(e){}return{searchTerm:"",filterTagIds:[]}}),[]),Ue=s.useCallback((()=>{const e={searchTerm:Q,filterTagIds:J.map((e=>e.id))};localStorage.setItem(Kt,JSON.stringify(e))}),[Q,J]);s.useEffect((()=>{const e=setTimeout((()=>{he(pe)}),500);return()=>clearTimeout(e)}),[pe]),s.useEffect((()=>{Ae.current||Ue()}),[Q,J,Ue]),s.useEffect((()=>{(async()=>{if(Ae.current){B(!0),H(null);try{const e=Ve(),t=$.get("tag_id"),s=await Z.tags.getAll();R(s);let n=[];if(t){const e=s.find((e=>e.id===t));e&&(q([e]),n=[t])}else if(e.filterTagIds.length>0){const t=e.filterTagIds.map((e=>s.find((t=>t.id===e)))).filter((e=>void 0!==e));t.length>0&&(q(t),n=e.filterTagIds)}e.searchTerm&&(he(e.searchTerm),ge(e.searchTerm));const a=e.searchTerm||"",i=await Z.tasks.getAll(0,Be,a,n.join(","));D(i),We(0),Me(i.length===Be),Ae.current=!1,H(null)}catch(e){const t=ue(e);H(t),A(t)}finally{B(!1)}}})()}),[V,$,Ve]),s.useEffect((()=>{if(Ae.current)return;(async()=>{B(!0),H(null);try{const e=await Z.tasks.getAll(0,Be,Q,J.map((e=>e.id)).join(","));D(e),We(0),Me(e.length===Be)}catch(e){H("Failed to search tasks. Please try again.")}finally{B(!1)}})()}),[Q,J]),s.useEffect((()=>{const e=new IntersectionObserver((e=>{const[t]=e;t.isIntersecting&&Re&&!M&&!O&&Je()}),{threshold:.5}),t=Oe.current;return t&&e.observe(t),()=>{t&&e.unobserve(t)}}),[Re,M,O]);const Je=async()=>{if(!Re||O)return;L(!0);const e=De+1;try{const t=await Z.tasks.getAll(e*Be,Be,Q,J.map((e=>e.id)).join(","));if(t.length>0){const s=t.filter((e=>!E.some((t=>t.id===e.id))));D((e=>[...e,...s])),We(e),Me(t.length===Be)}else Me(!1)}catch(t){A("Failed to load more tasks. Please try again.")}finally{L(!1)}},qe=s.useCallback((()=>{U((e=>e+1))}),[]),Qe=()=>{localStorage.removeItem(Kt),he(""),ge(""),q([])},Ke=()=>{ke(!1)},Ge=(e,t)=>{e.stopPropagation(),ve(e.currentTarget),Ce(t)},Ye=()=>{ve(null)},Xe=()=>{Ie(!1),Ce(null)},Ze=e=>{Fe((t=>{const s=new Set(t);return s.has(e.id)?s.delete(e.id):s.add(e.id),s})),Te(!0),ke(!1)},et=()=>{Pe(!1)},tt=[n.jsxs(a,{onClick:e=>{e.stopPropagation(),Ze(we),Ye()},children:[n.jsx(i,{children:n.jsx(ee,{fontSize:"small"})}),n.jsx(r,{children:Le("common.actions.select")})]},"select"),n.jsxs(a,{onClick:()=>{we&&(T(`/tasks/new?copy_task_id=${we.id}`),Ye())},children:[n.jsx(i,{children:n.jsx(te,{fontSize:"small"})}),n.jsx(r,{children:Le("common.actions.copy")})]},"copy"),n.jsxs(a,{onClick:()=>{Ye(),Ie(!0)},sx:{color:"error.main"},children:[n.jsx(i,{children:n.jsx(se,{fontSize:"small",color:"error"})}),n.jsx(r,{children:Le("common.actions.delete")})]},"delete")];return n.jsxs(o,{children:[n.jsx(ne,{title:Le("tasks.title"),actionButton:He?[{label:Le("tasks.actions.createTask"),icon:n.jsx(ae,{}),onClick:()=>T("/tasks/new")}]:void 0}),N&&n.jsx(l,{severity:"error",sx:{mb:2},action:n.jsx(c,{color:"inherit",size:"small",onClick:qe,disabled:M,children:M?"Loading...":"Retry"}),children:N}),n.jsx(d,{sx:{p:2,mb:2},children:n.jsxs(x,{spacing:2,children:[n.jsxs(o,{sx:{display:"flex",flexDirection:"column",gap:2},children:[n.jsx(m,{multiple:!0,size:"small",options:W,getOptionLabel:e=>e.name,value:J,onChange:(e,t)=>q(t),renderInput:e=>n.jsx(h,{...e,label:Le("tasks.actions.filterByTags"),placeholder:Le("filters.selectTags"),variant:"outlined",InputProps:{...e.InputProps,startAdornment:n.jsxs(n.Fragment,{children:[n.jsx(ie,{sx:{ml:1,color:"text.secondary"},fontSize:"small"}),e.InputProps.startAdornment]})}}),renderTags:(e,t)=>e.map(((e,n)=>s.createElement(u,{color:"primary",label:e.name,...t({index:n}),key:e.id})))}),n.jsx(o,{sx:{display:"flex",gap:2},children:n.jsx(h,{label:Le("tasks.actions.searchByTitle"),placeholder:Le("filters.enterTitle"),variant:"outlined",fullWidth:!0,size:"small",value:pe,onChange:e=>{const t=e.target.value;ge(t)},InputProps:{startAdornment:n.jsx(oe,{sx:{mr:1,color:"text.secondary"},fontSize:"small"}),endAdornment:pe?n.jsx(p,{position:"end",children:n.jsx(g,{"aria-label":"clear search",onClick:()=>{ge(""),he("")},edge:"end",size:"small",children:n.jsx(re,{fontSize:"small"})})}):null}})})]}),(J.length>0||pe)&&n.jsx(o,{sx:{display:"flex",justifyContent:"center"},children:n.jsx(c,{variant:"outlined",startIcon:n.jsx(le,{}),onClick:Qe,children:Le("common.actions.clear")})})]})}),ze&&n.jsx(f,{position:"static",color:"default",elevation:1,sx:{mb:2},children:n.jsxs(j,{variant:"dense",children:[n.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,flex:1},children:[n.jsx(y,{edge:"start",checked:_e.size===E.length,indeterminate:_e.size>0&&_e.size<E.length,onChange:()=>{_e.size===E.length?Fe(new Set):Fe(new Set(E.map((e=>e.id))))}}),n.jsx(k,{variant:"body2",children:Le("tasks.selection.selected",{count:_e.size})})]}),n.jsxs(o,{sx:{display:"flex"},children:[He&&n.jsx(c,{color:"error",startIcon:n.jsx(se,{}),onClick:()=>{Pe(!0)},disabled:0===_e.size,children:Le("tasks.selection.deleteCount",{count:_e.size||0})}),n.jsx(c,{onClick:()=>{Fe(new Set),Te(!1)},children:Le("common.actions.cancel")})]})]})}),M?n.jsx(ce,{message:Le("common.loading")}):n.jsxs(n.Fragment,{children:[N||0!==E.length?n.jsxs(n.Fragment,{children:[n.jsx(o,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"repeat(2, 1fr)",lg:"repeat(3, 1fr)"},gap:2},children:E.map((e=>n.jsxs(b,{sx:{height:"100%",cursor:"pointer",position:"relative","&:hover":{boxShadow:6}},onClick:()=>!ze&&(e=>{je(e),ke(!0)})(e),children:[ze&&n.jsx(y,{edge:"start",checked:_e.has(e.id),onChange:t=>{t.stopPropagation(),Ze(e)},sx:{position:"absolute",top:8,right:8,zIndex:1}}),n.jsx(v,{sx:{p:2,"&:last-child":{paddingBottom:2}},children:n.jsxs(o,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",gap:1},children:[n.jsx(k,{sx:{flex:1,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.2},children:e.title}),n.jsx(o,{sx:{display:"flex",flexDirection:"row",gap:1,flexShrink:0},children:!ze&&n.jsxs(n.Fragment,{children:[n.jsx(g,{size:"small",onClick:t=>{t.stopPropagation(),T(`/tasks/${e.id}/edit`)},children:n.jsx(de,{})}),n.jsx(g,{size:"small",onClick:t=>Ge(t,e),children:n.jsx(xe,{})})]})})]})}),e.tags.length>0&&n.jsx(w,{sx:{pt:0,px:2,pb:2},children:n.jsx(o,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:e.tags.map((e=>n.jsx(u,{label:e.name,size:"small",variant:"outlined",onClick:t=>{t.stopPropagation(),J.some((t=>t.id===e.id))||q([...J,e])},sx:{cursor:"pointer","&:hover":{backgroundColor:"action.hover"}}},e.id)))})})]},e.id)))}),n.jsx(o,{ref:Oe,sx:{display:"flex",justifyContent:"center",p:2,visibility:Re?"visible":"hidden"},children:O&&n.jsx(C,{size:24})})]}):n.jsxs(o,{sx:{textAlign:"center",py:4},children:[n.jsx(k,{variant:"h6",color:"text.secondary",sx:{mb:1},children:Q.length<1&&J.length<1?Le(He?"tasks.empty.teacher":"tasks.empty.student"):Le("tasks.empty.noMatch")}),He&&Q.length<1&&J.length<1&&n.jsx(c,{variant:"outlined",startIcon:n.jsx(ae,{}),onClick:()=>T("/tasks/new"),sx:{mt:2},children:Le("tasks.actions.createFirst")}),(Q.length>0||J.length>0)&&n.jsx(c,{variant:"outlined",startIcon:n.jsx(le,{}),onClick:Qe,sx:{borderRadius:2,textTransform:"none"},children:Le("common.actions.clear")})]}),n.jsx(me,{open:ye,onClose:Ke,task:fe,hasQuizzes:!1,onValidateAnswers:()=>{},actionButtons:n.jsxs(o,{sx:{display:"flex",gap:1,width:"100%",justifyContent:"space-between"},children:[n.jsx(o,{sx:{display:"flex",gap:1},children:fe&&n.jsxs(n.Fragment,{children:[n.jsx(c,{size:"small",onClick:e=>Ge(e,fe),startIcon:n.jsx(xe,{}),children:Le("common.actions.actions")}),n.jsx(c,{size:"small",onClick:e=>{e.stopPropagation(),T(`/tasks/${fe.id}/edit`)},startIcon:n.jsx(de,{}),children:Le("common.actions.edit")})]})}),n.jsx(c,{onClick:Ke,children:Le("common.actions.close")})]})}),n.jsx(S,{anchorEl:be,open:Ee,onClose:Ye,onClick:e=>e.stopPropagation(),children:tt}),n.jsxs(I,{open:Se,onClose:Xe,maxWidth:"xs",fullWidth:!0,children:[n.jsx(_,{children:Le("common.dialog.delete.title",{item:"Task"})}),n.jsx(F,{children:n.jsx(k,{children:Le("common.dialog.delete.message",{name:null==we?void 0:we.title})})}),n.jsxs(z,{children:[n.jsx(c,{onClick:Xe,children:Le("common.actions.cancel")}),n.jsx(c,{onClick:async()=>{if(we)try{await Z.tasks.delete(we.id),D(E.filter((e=>e.id!==we.id)))}catch(e){const t=e instanceof Error?e.message:"Failed to delete task. Please try again.";A(t)}finally{Ie(!1),Ce(null)}},color:"error",variant:"contained",startIcon:n.jsx(se,{}),children:Le("common.actions.delete")})]})]}),n.jsxs(I,{open:$e,onClose:et,maxWidth:"xs",fullWidth:!0,children:[n.jsx(_,{children:Le("common.dialog.delete.title",{item:"Tasks"})}),n.jsx(F,{children:n.jsx(k,{children:Le("common.dialog.delete.messageBulk",{count:_e.size,item:1===_e.size?"task":"tasks"})})}),n.jsxs(z,{children:[n.jsx(c,{onClick:et,children:Le("common.actions.cancel")}),n.jsxs(c,{onClick:async()=>{try{await Z.tasks.batchDelete(Array.from(_e));D(E.filter((e=>!_e.has(e.id)))),Fe(new Set),Te(!1)}catch(e){const t=e instanceof Error?e.message:"Failed to delete tasks. Please try again.";A(t)}finally{Pe(!1)}},color:"error",variant:"contained",startIcon:n.jsx(se,{}),children:[Le("common.actions.delete")," ",_e.size," ",1===_e.size?"task":"tasks"]})]})]})]})]})}},Symbol.toStringTag,{value:"Module"})),Yt=({aiChatMessage:e,setAIChatMessage:t,isSendingAIMessage:i,aiChatHistory:l,isProcessingAttachment:x,setIsProcessingAttachment:m,aiChatMode:u,setAIChatMode:p,handleSendAIMessage:f,handleImprove:j,handleRestoreHistoryItem:y,handleRecognizedText:b})=>{const{t:v}=Y(),{showErrorToast:w}=G(),[I,_]=s.useState(null),[F,z]=s.useState(null),[P,A]=s.useState(!0);s.useEffect((()=>{const e=localStorage.getItem("aiChatHelpVisible");null!==e&&A(JSON.parse(e))}),[]);const E=()=>{_(null),z(null)};return n.jsxs(o,{sx:{display:"flex",flexDirection:"column",overflow:"hidden",borderRadius:2,p:1,...(i||x)&&{position:"relative","&::before":{content:'""',position:"absolute",top:0,left:0,right:0,bottom:0,background:"linear-gradient(45deg, transparent 30%, rgba(25, 118, 210, 0.08) 50%, transparent 70%)",backgroundSize:"400% 400%",borderRadius:"inherit",zIndex:1,pointerEvents:"none",animation:"shimmer 2s ease-in-out infinite"},"&::after":{content:'""',position:"absolute",top:-2,left:-2,right:-2,bottom:-2,background:"linear-gradient(45deg, rgba(25, 118, 210, 0.3), rgba(25, 118, 210, 0.1), rgba(25, 118, 210, 0.3))",backgroundSize:"400% 400%",borderRadius:"inherit",zIndex:-1,animation:"shimmer 3s ease-in-out infinite reverse"},animation:"pulse 2s ease-in-out infinite","& > *":{position:"relative",zIndex:2}},"@keyframes shimmer":{"0%":{backgroundPosition:"100% 0%"},"100%":{backgroundPosition:"-100% 0%"}},"@keyframes pulse":{"0%, 100%":{opacity:1,transform:"scale(1)"},"50%":{opacity:.95,transform:"scale(1.005)"}}},children:[n.jsxs(o,{sx:{flex:1,overflow:"auto"},children:[P&&n.jsxs(d,{sx:{p:2,backgroundColor:"background.default",position:"relative",borderColor:"divider",borderWidth:1,borderStyle:"solid",mb:2},children:[n.jsx(g,{onClick:()=>{const e=!P;A(e),localStorage.setItem("aiChatHelpVisible",JSON.stringify(e))},sx:{position:"absolute",top:8,right:8,zIndex:1},size:"small",children:n.jsx(he,{})}),n.jsxs(k,{variant:"body1",sx:{mb:1,pr:2},children:["âœï¸  ",v("taskForm.ai.placeholder")]}),n.jsxs(k,{variant:"body1",sx:{mb:1},children:["âœ¨  ",v("taskForm.ai.helpImprove")]}),n.jsxs(k,{variant:"body1",children:["ðŸ“·  ",v("taskForm.ai.helpImage")]})]}),l.length>0&&n.jsxs(o,{sx:{mb:2},children:[n.jsxs(k,{variant:"subtitle2",sx:{mb:1},children:[v("taskForm.ai.history"),":"]}),n.jsx(T,{dense:!0,sx:{bgcolor:"background.paper",borderRadius:1,border:"1px solid",borderColor:"divider"},children:l.slice().reverse().map((e=>n.jsxs($,{onClick:t=>((e,t)=>{_(e.currentTarget),z(t)})(t,e),sx:{cursor:"pointer","&:hover":{bgcolor:"action.hover"}},secondaryAction:n.jsx(n.Fragment,{children:n.jsx(g,{size:"small",sx:{ml:1},children:n.jsx(xe,{fontSize:"small"})})}),children:[n.jsxs(o,{sx:{display:"flex",alignItems:"center",justifyContent:"center",width:"50px",height:"50px",mr:1,overflow:"hidden"},children:["processing"===e.status&&n.jsx(C,{size:16}),"done"===e.status&&!e.image&&n.jsx(pe,{fontSize:"small",color:"success"}),"done"===e.status&&e.image&&n.jsx("img",{src:e.image,style:{width:"100%"}}),"error"===e.status&&n.jsx(ge,{fontSize:"small",color:"error"})]}),n.jsx(r,{sx:{textAlign:"left",width:"100%"},primary:e.message||v("taskForm.ai.imageRecognizedText"),secondary:e.timestamp.toLocaleTimeString(v("locale"),{timeStyle:"short"})})]},e.id)))})]}),!1,n.jsx(h,{fullWidth:!0,multiline:!0,minRows:3,maxRows:20,variant:"outlined",placeholder:v("taskForm.ai.messageInputPlaceholder"),value:e,onChange:e=>t(e.target.value),disabled:i,onKeyDown:t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),e.trim()&&!i&&f())},onPaste:async e=>{const t=e.clipboardData.items;for(const n of t)if(n.type.startsWith("image/")){e.preventDefault();const t=n.getAsFile();if(t){m(!0);try{const e=await new Promise((e=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.readAsDataURL(t)})),s=await Z.files.recognizeText({imageBase64:e,mode:"text"});s&&await b(s,e)}catch(s){w(v("taskForm.ai.errors.imageProcessing"))}finally{m(!1)}}}else if("text/plain"===n.type){const t=await new Promise((e=>n.getAsString(e)));if(t.match(/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)$/i)){e.preventDefault(),m(!0);try{const e=await fetch(t),s=await e.blob(),n=await new Promise((e=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(s)})),a=await Z.files.recognizeText({imageBase64:n,mode:"text"});a&&await b(a,n)}catch(s){w(v("taskForm.ai.errors.imageURLProcessing"))}finally{m(!1)}}}},sx:{mb:2},inputProps:{maxLength:1e3}}),n.jsx(o,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:n.jsx(g,{title:v("taskForm.ai.send"),onClick:()=>f(),disabled:i||!e.trim(),sx:{backgroundColor:"primary.main",color:"white","&:hover":{backgroundColor:"primary.dark",color:"white"}},children:n.jsx(fe,{})})}),n.jsxs(o,{sx:{display:"flex",flexDirection:"column",gap:1,justifyContent:"flex-end"},children:[n.jsx(c,{onClick:()=>{var e;return null==(e=document.getElementById("image-input"))?void 0:e.click()},disabled:x,startIcon:n.jsx(je,{}),children:v("taskForm.ai.recognize")}),n.jsx(c,{onClick:j,disabled:i,startIcon:n.jsx(ye,{}),children:v("taskForm.ai.improve")})]}),n.jsx("input",{type:"file",accept:"image/*",style:{display:"none"},id:"image-input",onChange:async e=>{var t;const s=null==(t=e.target.files)?void 0:t[0];if(s){m(!0);try{const e=await new Promise((e=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(s)})),t=await Z.files.recognizeText({imageBase64:e,mode:"text"});t?await b(t,e):w(v("taskForm.ai.errors.noTextRecognized"))}catch(n){w(v("taskForm.ai.errors.imageProcessing"))}finally{m(!1)}}}})]}),n.jsx(S,{anchorEl:I,open:Boolean(I),onClose:E,children:n.jsxs(a,{onClick:()=>{F&&(y(F),E())},children:[n.jsx(ke,{fontSize:"small",sx:{mr:1}}),v("taskForm.ai.rollback")]})})]})},Xt=({title:e,text:t,url:s,tagIds:a,tags:i,teacherId:r,onFullscreen:l,onValidateAnswers:d,hasQuizzes:x})=>{const{t:m}=Y();return n.jsxs(o,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[n.jsxs(o,{sx:{display:"flex",gap:1,alignItems:"center"},children:[n.jsx(k,{variant:"h4",sx:{flex:1},children:e||m("common.actions.preview")}),n.jsx(g,{sx:{marginLeft:"auto",display:{xs:"none",sm:"block"}},size:"small",onClick:l,children:n.jsx(be,{})})]}),n.jsx(ve,{task:{id:"preview",title:e,text:t,url:s||"",tags:i.filter((e=>a.includes(e.id))),teacher_id:r},isSaveAnswer:!1,workId:"preview",isTeacher:!1}),x&&n.jsx(o,{sx:{p:2,borderTop:1,borderColor:"divider",display:"flex",justifyContent:"center",mt:"auto",flex:"flex-end"},children:n.jsx(c,{variant:"contained",color:"primary",onClick:d,startIcon:n.jsx(pe,{}),children:m("common.actions.checkAnswers")})})]})},Zt=()=>{const{t:e}=Y(),t=we(Ce),[a,i]=s.useState(null),[r,l]=s.useState(null),d=()=>{i(null)},x=Boolean(a),m=(e,t)=>{const s=!!r&&((null==r?void 0:r.row)>=e&&(null==r?void 0:r.col)>=t);return{minWidth:"40px",height:"40px",backgroundColor:s?"primary.main":"transparent",color:s?"primary.contrastText":"primary.main","&:hover":{backgroundColor:"primary.main"},transition:"all 0.5s ease"}};return n.jsxs(n.Fragment,{children:[n.jsx(Se,{title:e("taskForm.table.title"),children:n.jsx("span",{onClick:e=>{i(e.currentTarget)},children:n.jsx(Ie,{})})}),n.jsx(P,{open:x,anchorEl:a,onClose:d,anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:n.jsx(o,{sx:{p:2},children:n.jsx(o,{sx:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:1,width:200},children:Array.from({length:4},((e,t)=>t+1)).map((e=>Array.from({length:4},((e,t)=>t+1)).map((s=>n.jsxs(c,{variant:"outlined",size:"small",onClick:()=>(t({rows:e,columns:s}),void d()),onMouseEnter:()=>l({row:e,col:s}),onMouseLeave:()=>l(null),sx:m(e,s),children:[e,"x",s]},`${e}-${s}`)))))})})})]})},es=({onChange:e})=>{const{t:t}=Y(),[a,l]=s.useState(!0);s.useEffect((()=>{const e=localStorage.getItem("componentsHelpVisible");null!==e&&l(JSON.parse(e))}),[]);const c=[{icon:n.jsx(_e,{}),title:t("components.hiddenText.title"),description:t("components.hiddenText.hint"),isInline:!0,mdText:` ${t("components.defaults.question")} 1 :hidden[${t("components.defaults.answer")} 1] , ${t("components.defaults.question")} 2 :hidden[${t("components.defaults.answer")} 2] `},{icon:n.jsx(Fe,{}),title:t("components.draggableAnswers.title"),description:t("components.draggableAnswers.hint"),isInline:!1,mdText:` ::answers{sticky="true"} \n${t("components.defaults.question")} 1 :hidden[${t("components.defaults.answer")} 1]\n${t("components.defaults.question")} 2 :hidden[${t("components.defaults.answer")} 2] \n`},{icon:n.jsx(ze,{}),title:t("components.multipleChoice.title"),description:t("components.multipleChoice.hint"),isInline:!0,mdText:` ${t("components.defaults.question")} :select[${t("components.defaults.option")} 1]{alt="${t("components.defaults.option")} 1;${t("components.defaults.option")} 2;${t("components.defaults.option")} 3" ordered="false"} `},{icon:n.jsx(Te,{}),title:t("components.checklist.title"),description:t("components.checklist.hint"),isInline:!1,mdText:`${t("components.defaults.question")}\n* [x] ${t("components.defaults.option")} 1\n* [ ] ${t("components.defaults.option")} 2\n* [ ] ${t("components.defaults.option")} 3\n`},{icon:n.jsx($e,{}),title:t("components.sortingOrdering.title"),description:t("components.sortingOrdering.hint"),isInline:!1,mdText:` :::sort\n- ${t("components.defaults.option")} 1\n- ${t("components.defaults.option")} 2\n- ${t("components.defaults.option")} 3\n:::\n`}],x=[{icon:n.jsx(je,{}),title:t("components.image.title"),description:t("components.image.hint"),isInline:!1,mdText:"![](https://teachair.app/apple-touch-icon.png)"},{icon:n.jsx(Pe,{}),title:t("components.audio.title"),description:t("components.audio.hint"),isInline:!1,mdText:` :audio[${t("components.defaults.audio")}]{src="https://teachair.app/assets/audio/w-${t("locale")}.mp3"} `},{icon:n.jsx(Ae,{}),title:t("components.embed.title"),description:t("components.embed.hint"),isInline:!1,mdText:' :iframe[]{src="https://www.youtube.com/watch?v=mvhmCKNQfu8" } '}];return n.jsx(o,{children:n.jsxs(o,{sx:{display:"flex",flexDirection:"column",width:"100%",gap:2},children:[a&&n.jsxs(d,{sx:{px:3,py:2,backgroundColor:"background.default",position:"relative",borderColor:"divider",borderWidth:1,borderStyle:"solid"},children:[n.jsx(g,{onClick:()=>{const e=!a;l(e),localStorage.setItem("componentsHelpVisible",JSON.stringify(e))},sx:{position:"absolute",top:8,right:8,zIndex:1},size:"small",children:n.jsx(he,{})}),n.jsx(k,{variant:"h6",sx:{mb:2},children:t("components.help.title")}),n.jsx("img",{style:{height:"32px",width:"auto",maxWidth:"100%",borderRadius:"10px"},src:"/icon-elements.gif",alt:"Components Help"})]}),n.jsx(b,{sx:{height:"100%",cursor:"pointer",borderColor:"primary.main",borderWidth:1,borderStyle:"solid","&:hover":{backgroundColor:"action.hover"}},onClick:()=>e(!1,`${t("components.defaults.task")}\n&nbsp;\n::essay`),children:n.jsxs(v,{children:[n.jsxs(o,{sx:{display:"flex",alignItems:"center",mb:2},children:[n.jsx(i,{sx:{minWidth:40},children:n.jsx(Ee,{})}),n.jsx(r,{primary:t("components.studentsSection.title"),primaryTypographyProps:{variant:"subtitle1",sx:{fontWeight:500}}}),n.jsxs(i,{sx:{minWidth:40,color:"primary.main",fontSize:16,display:"flex",alignItems:"center",justifyContent:"center"},children:[n.jsx(ye,{sx:{mr:1}}),"  AI"]})]}),n.jsx(k,{variant:"body2",color:"text.secondary",sx:{mb:1},children:t("components.studentsSection.hint")}),n.jsx(k,{variant:"body2",color:"text.secondary",sx:{mb:1},children:t("components.studentsSection.hint2")})]})}),n.jsx(k,{variant:"h6",sx:{mt:1,textAlign:"center"},children:t("components.help.text.title")}),c.map(((t,s)=>n.jsx(b,{sx:{height:"100%",cursor:"pointer",borderColor:"divider",borderWidth:1,borderStyle:"solid","&:hover":{backgroundColor:"action.hover"}},onClick:()=>e(t.isInline,t.mdText),children:n.jsxs(v,{children:[n.jsxs(o,{sx:{display:"flex",alignItems:"center",mb:2},children:[n.jsx(i,{sx:{minWidth:40},children:t.icon}),n.jsx(r,{primary:t.title,primaryTypographyProps:{variant:"subtitle1",sx:{fontWeight:500}}})]}),n.jsx(k,{variant:"body2",color:"text.secondary",children:t.description})]})}))),n.jsx(k,{variant:"h6",sx:{mt:1,textAlign:"center"},children:t("components.help.media.title")}),x.map(((t,s)=>n.jsx(b,{sx:{height:"100%",cursor:"pointer",borderColor:"divider",borderWidth:1,borderStyle:"solid","&:hover":{backgroundColor:"action.hover"}},onClick:()=>e(t.isInline,t.mdText),children:n.jsxs(v,{children:[n.jsxs(o,{sx:{display:"flex",alignItems:"center",mb:2},children:[n.jsx(i,{sx:{minWidth:40},children:t.icon}),n.jsx(r,{primary:t.title,primaryTypographyProps:{variant:"subtitle1",sx:{fontWeight:500}}})]}),n.jsx(k,{variant:"body2",color:"text.secondary",children:t.description})]})})))]})})},ts=()=>{const e=we(De),{t:t}=Y();return n.jsx(Se,{title:t("taskForm.admonition.add"),children:n.jsx("span",{onClick:()=>{e({type:"containerDirective",name:"tip"})},children:n.jsx(We,{fontSize:"small"})})})},ss=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{var a;const i=e(),{taskId:r}=A(),[l]=t(),x=l.get("return_to")||"/tasks",u=l.get("copy_task_id"),p=l.get("work_id"),f=l.get("sharingKey"),j=l.get("title"),{user:y}=K(),{showErrorToast:b}=G(),{mode:v}=Re(),w=s.useRef(null),[C,S]=s.useState(null),[T,$]=s.useState(!0),[P,H]=s.useState(!1),[V,U]=s.useState([]),[J,q]=s.useState({title:j||"",text:"",url:"",tag_ids:[]}),[Q,ee]=s.useState(null),[te,se]=s.useState({}),[ne,re]=s.useState(!1),[oe,le]=s.useState(!1),[de,xe]=s.useState(0),[ue,pe]=s.useState((()=>localStorage.getItem("taskForm_sidePanelMode")||"components-help")),[ge,fe]=s.useState(""),[je,ke]=s.useState(!1),[be,ve]=s.useState([]),[we,Ce]=s.useState(!1),[Se,Ie]=s.useState("text");s.useEffect((()=>{ue?localStorage.setItem("taskForm_sidePanelMode",ue):localStorage.removeItem("taskForm_sidePanelMode")}),[ue]),s.useEffect((()=>{const e=["live-preview","ai-chat","components-help"].indexOf(ue||"live-preview");-1!==e&&e!==de&&xe(e)}),[ue,de]);const[_e,Fe]=s.useState(""),[ze,Te]=s.useState(null),[$e,Pe]=s.useState(!1),[Ae,Ee]=s.useState(""),[De,We]=s.useState(!1);s.useEffect((()=>{if(Ae){const t=`ai_${Ae}`,s=localStorage.getItem(t);if(s)try{const e=JSON.parse(s).map((e=>({...e,timestamp:new Date(e.timestamp)})));ve(e)}catch(e){}}}),[Ae]),s.useEffect((()=>{if(Ae){const e=`ai_${Ae}`;be.length>0?localStorage.setItem(e,JSON.stringify(be)):localStorage.removeItem(e)}}),[be,Ae]);const[_t,Ft]=s.useState(!1),[zt,Tt]=s.useState(null),[$t,Pt]=s.useState(null),At=(null==y?void 0:y.role)===X.ADMIN,Et=(null==y?void 0:y.role)===X.TEACHER||At,Dt=Boolean(r),[Wt,Rt]=s.useState(!1),Mt=E(),Bt=D(Mt.breakpoints.only("xs")),Ot=D(Mt.breakpoints.down("md")),Lt=D(Mt.breakpoints.up("lg")),{t:Nt}=Y(),Ht=s.useRef({title:j||"",text:"",url:"",tag_ids:[]});s.useEffect((()=>{Ft(!0)}),[]),s.useEffect((()=>{if(!_t)return;const e=r?`task_${r}`:"new_task";Ee(e);const t=localStorage.getItem(e);t&&(Te(t),Pe(!0))}),[r,_t]);const Vt=e=>{if(Pe(!1),e&&ze)try{const e=JSON.parse(ze);Ht.current={...Ht.current,...e},q({...Ht.current});const s=document.querySelector('input[name="title"]');if(s&&(s.value=e.title||""),w.current&&(w.current.setMarkdown(e.text||""),w.current.focus()),Ae){const e=`ai_${Ae}`,s=localStorage.getItem(e);if(s)try{const e=JSON.parse(s).map((e=>({...e,timestamp:new Date(e.timestamp)})));ve(e)}catch(t){}}}catch(t){}else if(localStorage.removeItem(Ae),Te(null),Ae){const e=`ai_${Ae}`;localStorage.removeItem(e),ve([])}},Ut=s.useCallback(W((()=>{q({...Ht.current}),se((e=>{const t={...e};return Ht.current.title&&t.title&&delete t.title,Ht.current.text&&t.text&&delete t.text,Ht.current.tag_ids.length>0&&t.tag_ids&&delete t.tag_ids,t})),Ae&&localStorage.setItem(Ae,JSON.stringify(Ht.current))}),500),[Ae]),Jt=e=>{if(!e)return!1;const t=e.includes(":hidden")||e.includes(":essay")||e.includes(":sort")||e.includes(":select"),s=e.includes("[ ]")||e.includes("[x]");return t||s},qt=()=>{window.dispatchEvent(new CustomEvent("validateAllQuizzes",{detail:{taskId:"preview"}}))},Qt=(e,t)=>{xe(t);pe(["live-preview","ai-chat","components-help"][t])},Kt=()=>{le(!oe)},Gt=async e=>{const t=e||ge;if(!t||"string"!=typeof t||!t.trim())return;const s={id:Date.now().toString(),message:t,text:J.text||"",timestamp:new Date,status:"processing",type:Se};ve((e=>[s,...e])),fe(""),ke(!0);try{const e=await Z.tasks.chat({text:J.text,message:s.message,type:s.type});ve((e=>e.map((e=>e.id===s.id?{...e,status:"done"}:e)))),"text"===Se&&e&&(Fe(J.text),Ht.current.text=e,q({...Ht.current}),w.current&&(w.current.setMarkdown(e||""),w.current.focus()),Ut())}catch(n){ve((e=>e.map((e=>e.id===s.id?{...e,status:"error"}:e)))),b("Failed to get AI response. "+n)}finally{ke(!1)}},ss=()=>{null!==localStorage.getItem(Ae)?We(!0):i(x)},ns=e=>{e?(Te(null),localStorage.removeItem(Ae),ve([]),We(!1),i(x)):We(!1)};if(s.useEffect((()=>{let e=!0;return(async()=>{if(e){$(!0);try{const t=await Z.tags.getAll();if(!e)return;if(U(t),r){const t=await Z.tasks.getById(r);if(!e)return;S(t),Fe(t.text||"");const s={title:t.title,text:t.text||"",tag_ids:t.tags.map((e=>e.id))};Ht.current=s,q(s)}else if(u){const t=await Z.tasks.getById(u);if(!e)return;S(t),Fe(t.text||"");const s={title:`Copy of ${t.title}`,text:t.text||"",tag_ids:t.tags.map((e=>e.id))};Ht.current=s,q(s)}else if(f){const t=await Z.tasks.getBySharingKey(f);if(!e)return;S(t),Fe(t.text||"");const s={title:t.title,text:t.text||"",tag_ids:t.tags.map((e=>e.id))};Ht.current=s,q(s)}else if(j&&!r&&!u&&!f){const e={title:j,text:"",tag_ids:[]};Ht.current=e,q(e)}p&&ee(await Z.works.getById(p))}catch(t){const s=t instanceof Error?t.message:"Failed to load data. Please try again.";if(!e)return;b(s),i(x)}finally{if(!e)return;$(!1)}}})(),()=>{e=!1}}),[r,u,f,j,i,x]),!Et)return i(x),null;function as(e=!1){return n.jsxs(o,{sx:{display:"flex",gap:0,opacity:e?1:.5,pointerEvents:e?"auto":"none"},children:[n.jsx(mt,{options:["Bold","Italic"]}),n.jsx(ut,{options:["bullet","number"]}),n.jsx(ht,{}),n.jsx(pt,{editorRef:w}),n.jsx(gt,{editorRef:w}),n.jsx(ft,{editorRef:w}),n.jsx(jt,{editorRef:w}),n.jsx(yt,{editorRef:w}),n.jsx(kt,{editorRef:w}),n.jsx(bt,{}),n.jsx(vt,{}),n.jsx(wt,{}),n.jsx(Ct,{}),n.jsx(Zt,{}),n.jsx(ts,{})]})}return n.jsxs(o,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[T?n.jsx(ce,{message:Nt(Dt?"taskForm.loading.task":"taskForm.loading.default")}):n.jsxs(o,{sx:{display:{xs:"block",lg:"flex"},gap:2,height:"100%",overflow:"hidden",justifyContent:"center",alignItems:"center"},children:[n.jsxs(o,{sx:{display:"flex",flex:"3 1",flexDirection:"column",width:"100%",maxWidth:"800px",height:"100%",position:"relative",overflow:"hidden",margin:"0 auto"},children:[n.jsx(o,{sx:{flex:1,overflow:"auto",p:1,pt:0},children:n.jsx(o,{width:"100%",sx:{display:"flex",justifyContent:"space-between"},children:n.jsx(o,{sx:{flex:1,display:"flex",flexDirection:"column",width:"100%",position:"relative"},children:n.jsxs(o,{component:"form",noValidate:!0,sx:{display:"flex",flexDirection:"column",height:"100%",minHeight:0,flex:1},children:[Q&&n.jsx(o,{sx:{mb:1},children:n.jsx(c,{variant:"text",color:"primary",size:"small",startIcon:n.jsx(Me,{}),onClick:ss,children:Q.name})}),n.jsxs(d,{sx:{p:2,pt:0,pb:1},children:[n.jsx(h,{margin:"normal",name:"title",label:Nt("taskForm.title.label"),type:"text",size:"small",fullWidth:!0,variant:"outlined",defaultValue:J.title,onChange:e=>{Ht.current.title=e.target.value,Ut()},error:!!te.title,helperText:te.title,inputProps:{autoComplete:"off",maxLength:100},InputProps:{startAdornment:n.jsx(Be,{sx:{mr:1,color:"text.secondary"},fontSize:"small"})}}),n.jsx(m,{multiple:!0,size:"small",options:V,getOptionLabel:e=>e.name,value:V.filter((e=>Ht.current.tag_ids.includes(e.id))),onChange:(e,t)=>{const s=t.map((e=>e.id));Ht.current.tag_ids=s,q({...Ht.current}),Ut()},disabled:Wt,disableCloseOnSelect:!0,renderInput:e=>n.jsxs(o,{sx:{position:"relative"},children:[n.jsx(h,{...e,label:Nt("taskForm.tags.label"),margin:"normal",error:!!te.tag_ids,InputProps:{...e.InputProps,startAdornment:n.jsxs(n.Fragment,{children:[n.jsx(ie,{sx:{m:.25,ml:1,color:"text.secondary"},fontSize:"small"}),e.InputProps.startAdornment]})}}),Wt&&n.jsx(R,{sx:{position:"absolute",bottom:0,left:0,right:0,height:2}})]}),filterOptions:(e,{inputValue:t})=>{const s=e.filter((e=>e.name.toLowerCase().includes(t.toLowerCase())));return t&&!s.length?[{id:"new",name:t,creator_id:(null==y?void 0:y.id)||""}]:s},renderOption:(e,t)=>"new"===t.id?n.jsx("li",{...e,onClick:async e=>{e.stopPropagation(),Rt(!0);try{const e=await Z.tags.create({name:t.name});U((t=>[...t,e])),Ht.current.tag_ids=[...Ht.current.tag_ids,e.id],q({...Ht.current})}catch(s){const e=s instanceof Error?s.message:"Failed to create tag. Please try again.";b(e)}finally{Rt(!1)}},children:Nt("taskForm.tags.create",{name:t.name})}):n.jsx("li",{...e,children:t.name})}),te.tag_ids&&n.jsx(M,{error:!0,children:te.tag_ids}),n.jsxs(o,{sx:{display:"flex",flexDirection:"row",gap:1,justifyContent:"flex-end",mt:1},children:[n.jsxs(c,{size:"small",onClick:()=>{Qt(0,2),Kt()},children:[n.jsx(ae,{sx:{mr:1}}),Nt("taskForm.buttons.addElement")]}),n.jsxs(c,{size:"small",onClick:()=>{Qt(0,1),Kt()},children:[n.jsx(ye,{sx:{mr:1}}),Nt("taskForm.ai.title")]})]})]}),n.jsx(d,{id:"task-form-editor-paper",sx:{flex:1,display:"flex",flexDirection:"column",minHeight:0,position:"relative",mt:2,mb:2,border:"1px solid",borderColor:"divider"},children:n.jsx(Oe,{ref:w,markdown:J.text,autoFocus:!1,onChange:e=>{Ht.current.text=e,Ut()},placeholder:Nt("taskForm.editor.placeholder"),className:"dark"===v?"mdxeditor dark-theme dark-editor":"mdxeditor light-theme light-editor",translation:(e,t,s)=>Nt("editor."+e,{defaultValue:t,...s}),plugins:[Le(),Ne(),He(),Ve({disableImageResize:!0,disableImageSettingsButton:!0,imageUploadHandler:async e=>{const t=URL.createObjectURL(e);Tt(t);const s=await Z.files.uploadImage(e);return s.url?(Tt(null),URL.revokeObjectURL(t),s.url):(b("Failed to upload image. Please try again."),t)},EditImageToolbar:et}),Ue(),Je(),qe(),Qe({disableAutoLink:!0}),Ke(),Ge({viewMode:"rich-text",diffMarkdown:_e}),Ye({escapeUnknownTextDirectives:!0,directiveDescriptors:[tt,st,nt,at,it,rt,ot,lt]}),Xe(1e5),Ze({toolbarClassName:"mdxeditor-toolbar-full ",toolbarContents:()=>n.jsx(ct,{options:Ot?[]:["source"],children:n.jsx(dt,{options:[{when:e=>{var t;return"root"!==(null==(t=null==e?void 0:e.rootNode)?void 0:t.getType())},contents:()=>as(!1)},{fallback:()=>as(!0)}]})})})]})})]})})})}),n.jsxs(o,{sx:{width:"100%",p:1,display:"flex",justifyContent:"space-between",position:"sticky",bottom:0,left:0,zIndex:1},children:[n.jsx(o,{sx:{display:"flex-start",gap:2},children:n.jsx(c,{size:Ot?"small":"medium",variant:"outlined",color:"inherit",onClick:ss,children:Nt("taskForm.buttons.cancel")})}),n.jsxs(o,{sx:{display:"flex",gap:2,alignItems:"center"},children:[n.jsx(B,{title:Nt("taskForm.buttons.preview"),children:n.jsx(c,{size:Ot?"small":"medium",variant:"outlined",startIcon:n.jsx(xt,{}),onClick:()=>{Qt(0,0),Kt()},children:Nt("taskForm.buttons.preview")})}),n.jsx(B,{title:P?Nt("taskForm.loading.saving"):J.title.trim()?J.text.trim()?"":Nt("taskForm.content.error.required"):Nt("taskForm.title.error.required"),children:n.jsx("span",{children:n.jsx(c,{size:Ot?"small":"medium",variant:"contained",color:"primary",onClick:async()=>{const{isValid:e,errors:t}=St(It,J);if(e){H(!0);try{if(Dt&&r)await Z.tasks.update(r,J);else{const e=await Z.tasks.create(J);p&&await Z.works.addTask(p,e.id)}Te(null),localStorage.removeItem(Ae),ve([]),i(x)}catch(s){const e=s instanceof Error?s.message:"Failed to save task. Please try again.";b(e)}finally{H(!1)}}else se(t)},disabled:P||!J.title.trim()||!J.text.trim(),children:Nt(P?"taskForm.loading.saving":Dt?"common.actions.save":"taskForm.buttons.create")})})})]})]})]}),n.jsx(O,{anchor:"right",open:oe,onClose:Kt,variant:Lt?"permanent":"temporary",sx:{width:"93%",maxWidth:"400px",flexShrink:0,"& .MuiDrawer-paper":{width:"93%",maxWidth:"400px"}},children:n.jsxs(o,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[n.jsxs(o,{sx:{borderBottom:1,borderColor:"divider",display:"flex",alignItems:"center",px:1},children:[!Lt&&n.jsx(g,{onClick:()=>le(!1),sx:{mr:1},children:Bt?n.jsx(Me,{}):n.jsx(he,{})}),n.jsxs(L,{value:de,onChange:Qt,variant:"fullWidth",sx:{flex:1,"& .MuiTab-root":{minHeight:48,fontSize:"0.875rem"}},children:[n.jsx(N,{value:2,label:Nt("taskForm.buttons.elements"),iconPosition:"start"}),n.jsx(N,{icon:n.jsx(ye,{}),value:1,label:Nt("taskForm.ai.titleShort"),iconPosition:"start"}),n.jsx(N,{icon:n.jsx(xt,{}),value:0,label:Nt("taskForm.buttons.preview"),iconPosition:"start"})]})]}),n.jsxs(o,{sx:{flex:1,overflow:"auto",p:2},children:[0===de&&n.jsx(n.Fragment,{children:(null==(a=null==J?void 0:J.text)?void 0:a.length)>0?n.jsx(Xt,{title:J.title||"",text:J.text||"",tagIds:J.tag_ids,tags:V,teacherId:(null==y?void 0:y.id)||"",onClose:()=>le(!1),onFullscreen:()=>re(!0),onValidateAnswers:qt,hasQuizzes:Jt(J.text||"")}):n.jsx(k,{variant:"body1",sx:{textAlign:"center",mt:2},children:Nt("taskForm.preview.empty")})}),1===de&&n.jsx(Yt,{aiChatMessage:ge,setAIChatMessage:fe,isSendingAIMessage:je,aiChatHistory:be,isProcessingAttachment:we,setIsProcessingAttachment:Ce,aiChatMode:Se,setAIChatMode:Ie,handleSendAIMessage:Gt,handleImprove:async()=>{if(!J.text)return void b(Nt("taskForm.preview.empty"));const e="âœ¨ "+Nt("taskForm.ai.improve");fe(e),Gt(e)},handleRestoreHistoryItem:e=>{fe(e.message),Ht.current.text=e.text,q({...Ht.current}),w.current&&(w.current.setMarkdown(e.text||""),w.current.focus()),Ut(),ve((t=>{const s=t.findIndex((t=>t.id===e.id));return-1===s?t:t.slice(s+1)}))},handleRecognizedText:async(e,t)=>{const s={id:Date.now().toString(),message:"",text:J.text,timestamp:new Date,status:"done",image:void 0,type:Se};ve((e=>[s,...e]));const n=`\n${e}\n`,a=J.text+n;Ht.current.text=a,q({...Ht.current}),w.current&&(w.current.setMarkdown(a),w.current.focus()),Ut()}}),2===de&&n.jsx(es,{onChange:(e,t="")=>{if(!w.current)return;const s=e?`&nbsp;${t}&nbsp;`:`&nbsp;\n${t}\n&nbsp;`;w.current&&w.current.focus((()=>{var e;null==(e=w.current)||e.insertMarkdown(s)}),{defaultSelection:"rootEnd"}),le(!1)}})]})]})})]}),n.jsx(me,{open:ne,onClose:()=>re(!1),task:{id:"preview",title:J.title||"",text:J.text||"",tags:V.filter((e=>J.tag_ids.includes(e.id))),teacher_id:(null==y?void 0:y.id)||""},hasQuizzes:Jt(J.text),onValidateAnswers:qt}),n.jsxs(I,{open:$e,onClose:()=>Pe(!1),children:[n.jsx(_,{children:Nt("taskForm.dialog.unsavedChanges.title")}),n.jsx(F,{children:n.jsx(k,{children:Nt("taskForm.dialog.unsavedChanges.message")})}),n.jsxs(z,{children:[n.jsx(c,{onClick:()=>Vt(!1),color:"error",children:Nt("taskForm.dialog.unsavedChanges.discard")}),n.jsx(c,{onClick:()=>Vt(!0),variant:"contained",children:Nt("taskForm.dialog.unsavedChanges.restore")})]})]}),n.jsxs(I,{open:De,onClose:()=>We(!1),children:[n.jsx(_,{children:Nt("taskForm.dialog.cancel.title")}),n.jsx(F,{children:n.jsx(k,{children:Nt("taskForm.dialog.cancel.message")})}),n.jsxs(z,{children:[n.jsx(c,{onClick:()=>ns(!1),children:Nt("taskForm.dialog.cancel.keep")}),n.jsx(c,{onClick:()=>ns(!0),variant:"contained",color:"error",children:Nt("taskForm.dialog.cancel.confirm")})]})]}),n.jsxs(I,{open:!!zt,onClose:()=>Tt(null),maxWidth:"sm",fullWidth:!0,children:[n.jsx(_,{children:Nt("taskForm.dialog.image.title")}),n.jsxs(F,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[n.jsx(o,{component:"img",src:zt||"",alt:"Preview",sx:{maxWidth:"100%",maxHeight:"300px",objectFit:"contain"}}),n.jsx(ce,{message:Nt("taskForm.loading.image")})]})]}),n.jsxs(I,{open:!!$t,onClose:()=>Pt(null),maxWidth:"sm",fullWidth:!0,children:[n.jsx(_,{children:Nt("taskForm.dialog.generatedImage.title")}),n.jsx(F,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:n.jsx(o,{component:"img",src:(is=$t,is?is.startsWith("data:image")?is:`data:image/jpeg;base64,${is}`:""),alt:"Generated",sx:{maxWidth:"100%",maxHeight:"300px",objectFit:"contain"}})}),n.jsx(z,{children:n.jsx(c,{onClick:()=>Pt(null),children:Nt("taskForm.dialog.image.close")})})]})]});var is}},Symbol.toStringTag,{value:"Module"})),ns=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const{t:l}=Y(),{user:x}=K(),u=e(),[p]=t(),f=p.get("return_to")||"",j=p.get("studentId"),b=p.get("work_id"),v="true"===p.get("edit"),w="true"===p.get("copy"),C="true"===p.get("send"),T="true"===p.get("onboarding"),$="true"===p.get("template"),P=p.get("folder"),[A,W]=s.useState([]),[R,M]=s.useState(null),[U,J]=s.useState([]),[q,Q]=s.useState(null),[ee,te]=s.useState(""),[se,ne]=s.useState(!1),[ie,oe]=s.useState(null),[le,pe]=s.useState(0),[ge,fe]=s.useState([]),[je,ye]=s.useState(!0),[ke,be]=s.useState(!1),[ve,we]=s.useState(null),[Ce,Se]=s.useState({}),[Ie,_e]=s.useState(v||$?1:0),[Fe,ze]=s.useState(!1),Te=(null==x?void 0:x.role)===X.TEACHER||(null==x?void 0:x.role)===X.ADMIN,{showErrorToast:$e,showToast:Pe}=G(),[Ae,Ee]=s.useState(null),[De,We]=s.useState(!1),[Re,Be]=s.useState(0),[Oe,Le]=s.useState(0),[Ne,He]=s.useState(null),[Ve,Ue]=s.useState([]),[Je,qe]=s.useState(null),[Qe,Ke]=s.useState(null),[Ge,Ye]=s.useState(!1),[Xe,Ze]=s.useState(null),[et,tt]=s.useState(0),st=E(),nt=D(st.breakpoints.up("lg")),at=D(st.breakpoints.only("xs")),it=q&&q.student_id===q.teacher_id;s.useEffect((()=>{(async()=>{try{const e=await Z.folders.getAll(0,100);if(Ue(e),P){const t=e.find((e=>e.id===P));if(t)He(t);else{const e=await Z.folders.getById(P);e&&He(e)}}}catch(e){$e(ue(e))}})()}),[P]),s.useEffect((()=>{(async()=>{ye(!0),we(null);try{const e=await Z.contracts.getAll(0,100),t=e.filter((e=>e.status===_t.AGREED||e.status===_t.PENDING));fe(t);const s=new Map;e.forEach((e=>{e.student&&!s.has(e.student_id)&&s.set(e.student_id,e.student)}));const n=Array.from(s.values()).sort(((e,t)=>{const s=Ft(e).toLowerCase(),n=Ft(t).toLowerCase();return s.localeCompare(n)}));if(Te&&!C){const e={id:x.id,first_name:l("templates.titleSingle"),last_name:null,photo_url:null,is_template:!0};n.unshift(e)}if(W(n),we(null),$&&Te&&x){const e=n.find((e=>e.id===x.id&&e.is_template));if(e){M(e);const t=new Date,s=t.getDate().toString().padStart(2,"0"),n=(t.getMonth()+1).toString().padStart(2,"0"),a=`${s}.${n}.${t.getFullYear()}`;te(`${l("templates.titleSingle")} - ${a}`)}}else if(j){const e=n.find((e=>e.id===j));if(e){M(e);const t=new Date,s=t.getDate().toString().padStart(2,"0"),n=(t.getMonth()+1).toString().padStart(2,"0"),a=`${s}.${n}.${t.getFullYear()}`;te(`${l("works.creator.forStudent")} ${Ft(e)||e.id} - ${a}`),He(null),_e(1)}}b&&(v||w)&&await rt(b)}catch(e){const t=ue(e);we(t),$e(t)}finally{ye(!1)}})()}),[j,b,v,w,Re,$]);const rt=async e=>{try{const t=await Z.works.getById(e);Q(t),te(w&&!C?`Copy of ${t.name}`:t.name);const s=(await Promise.all(t.task_states.sort(((e,t)=>(e.order||0)-(t.order||0))).map((async e=>{if(!e.task)try{return await Z.tasks.getById(e.task_id)}catch(t){return null}return e.task})))).filter((e=>null!==e));J(s)}catch(t){const e=t instanceof Error?t.message:"Failed to load work data. Please try again.";we(e),$e(e)}};s.useEffect((()=>{if(q&&A.length>0&&v){const e=A.find((e=>e.id===q.student_id));e?M(e):$e("Student for this work could not be found. Please select a student manually.")}}),[q,A,v]),s.useEffect((()=>{if(R&&!R.is_template){const e=ge.find((e=>e.student_id===R.id&&e.teacher_id===(null==x?void 0:x.id)&&e.status===_t.AGREED)),t=ge.find((e=>e.student_id===R.id&&e.teacher_id===(null==x?void 0:x.id)&&e.status===_t.PENDING)),s=e||t;oe(s||null),s?(pe(s.balance),s.balance>0?ne(!0):ne(!1)):(pe(0),ne(!1))}else oe(null),pe(0),ne(!1)}),[R,ge,null==x?void 0:x.id]);const ot=e=>{if(M(e),e){const t=new Date,s=`${t.getDate().toString().padStart(2,"0")}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getFullYear()}`;e.is_template?te(`${l("templates.titleSingle")} - ${s}`):te(`${l("works.creator.forStudent")} ${Ft(e)||e.id} - ${s}`)}else te("")},lt=e=>{J((t=>t.some((t=>t.id===e.id))?t.filter((t=>t.id!==e.id)):[...t,e]))},ct=async(e=!0)=>{if(!R)return void we("Please select a student");const t={name:ee,student_id:R.id,task_ids:U.map((e=>e.id)),contract_id:se&&ie?ie.id:void 0,folder_id:null==Ne?void 0:Ne.id,is_draft:!e},{isValid:s,errors:n}=St(Nt,t);if(!s)return void Se(n);be(!0),we(null);let a=null;try{if(v&&q){a=(await Z.works.update(q.id,t)).id}else{a=(await Z.works.create(t)).id}if(e){if(Pe(l(v&&q?"templates.message.workSuccessfullyUpdated":"templates.message.workSuccessfullyCreated"),"success"),f&&"null"!=f){const e=f+(f.includes("?")?"&":"?")+"new_work_id="+a;return void u(e)}return(null==R?void 0:R.is_template)?void u("/templates?new_work_id="+a):void u("/works?new_work_id="+a)}return a}catch(i){const e=i instanceof Error?i.message:`Failed to ${v?"update":"create"} work. Please try again.`;we(e),$e(e),be(!1)}},dt=e=>{Ee(e),We(!0)},xt=()=>{We(!1)};s.useCallback((()=>{Be((e=>e+1))}),[]);const mt=()=>{if(Ie>=1)ze(!0);else if(f){const e=f+(f.includes("?")?"&":"?")+"share_key="+(null==q?void 0:q.share_key);u(e)}else(null==R?void 0:R.is_template)?u("/templates?share_key="+(null==q?void 0:q.share_key)):u("/works?share_key="+(null==q?void 0:q.share_key))},ut=()=>{ze(!1)},ht=()=>{qe(null),Ke(null)},pt=e=>{Ze(e),Ye(!0),tt(0)};if(je)return n.jsx(ce,{message:l("common.loading")});const gt=Ge&&(!!Xe||0!==et);return n.jsxs(o,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[je?n.jsx(ce,{message:l(v?"taskForm.loading.task":"taskForm.loading.default")}):n.jsxs(o,{sx:{display:gt?{xs:"block",lg:"flex"}:"block",gap:2,height:"100%",overflow:"hidden",justifyContent:"center",alignItems:"center"},children:[n.jsxs(o,{sx:{display:"flex",flex:"3 1",flexDirection:"column",width:"100%",maxWidth:"800px",height:"100%",position:"relative",overflow:"hidden",margin:"0 auto"},children:[n.jsx("style",{children:`\n          .dragged-item {\n            background-color: ${st.palette.primary.main} !important;\n          }\n        `}),n.jsxs(o,{sx:{display:"flex",flexDirection:"column",flex:1,overflow:"auto",p:1,pt:0,height:"100%",".sortable-list":{position:"relative","& .item":{transition:"background-color 0.2s, box-shadow 0.2s, transform 0.1s","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.04)"},userSelect:"none",cursor:"default"},"& .dragged-item":{backgroundColor:"primary.main!important",color:"white!important",boxShadow:"0 10px 20px rgba(0, 0, 0, 0.3)!important",opacity:.95,zIndex:1e3,transform:"scale(1.03)",borderRadius:"4px",pointerEvents:"none",cursor:"grabbing","& .MuiTypography-root":{color:"white!important"},"& svg":{color:"white!important"}}}},children:[n.jsx(o,{sx:{mb:2,ml:1,flexShrink:0,display:w||C||v?"flex":"none"},children:n.jsxs(k,{variant:"body2",children:[l(v?"works.tabs.step1.edit":w?C?"works.tabs.step1.send":"works.tabs.step1.copy":"works.tabs.step1.create"),' "',null==q?void 0:q.name,'"']})}),0===Ie&&n.jsxs(n.Fragment,{children:[n.jsxs(d,{sx:{py:1,px:3,mb:1,display:"flex",flexDirection:"column"},children:[n.jsx(o,{sx:{mt:1},children:(null==R?void 0:R.is_template)?n.jsxs(k,{variant:"h6",gutterBottom:!0,sx:{my:1},children:[l("works.creator.templateHint"),Ne?` ${l("works.creator.inFolder")} "${null==Ne?void 0:Ne.title}"`:""]}):n.jsx(k,{variant:"h6",gutterBottom:!0,sx:{my:1},children:l("templates.createForStudent.title")})}),n.jsx(o,{sx:{mt:1,mb:1},children:A.length>0?n.jsxs(n.Fragment,{children:[it&&n.jsx(k,{variant:"body2",color:"text.secondary",sx:{mb:3},children:l("templates.createForStudent.description")}),n.jsx(m,{value:R,onChange:(e,t)=>ot(t),options:A,getOptionLabel:e=>Ft(e),renderInput:e=>n.jsx(h,{...e,placeholder:l("works.creator.selectStudent"),required:!0,autoFocus:!0,error:!!Ce.student_id,helperText:Ce.student_id,InputProps:{...e.InputProps,startAdornment:n.jsxs(n.Fragment,{children:[R&&(R.is_template?n.jsx(zt,{sx:{mr:1,color:"primary.main"}}):n.jsx(H,{src:R.photo_url||void 0,sx:{width:24,height:24,mr:1},children:Tt(R)})),e.InputProps.startAdornment]})}}),renderOption:(e,t)=>n.jsx(o,{component:"li",...e,sx:{display:"flex",alignItems:"center",borderBottom:t.is_template?"1px solid":"none",borderColor:t.is_template?"divider":"transparent"},children:n.jsxs(o,{sx:{display:"flex",alignItems:"center",p:1},onClick:()=>ot(t),children:[t.is_template?n.jsx(zt,{sx:{mr:1,color:"primary.main"}}):n.jsx(H,{src:t.photo_url||void 0,sx:{width:24,height:24,mr:1},children:Tt(t)}),n.jsx(k,{sx:{fontWeight:t.is_template?500:400,color:t.is_template?"primary.main":"inherit"},children:t.is_template?l("templates.titleSingle"):Ft(t)||t.id})]})})}),n.jsx(c,{variant:R?"contained":"text",color:"primary",fullWidth:!0,onClick:()=>_e(1),disabled:!R,endIcon:n.jsx($t,{}),sx:{mt:2},children:l("works.actions.continue")})]}):n.jsx(n.Fragment,{children:it&&n.jsx(k,{variant:"body2",color:"text.secondary",children:l("templates.addFirstStudentDescription")})})}),R&&n.jsx(n.Fragment,{children:n.jsx(c,{variant:"text",color:"secondary",size:"small",onClick:()=>M(null),disabled:!R,children:l("common.actions.change")})})]}),!R&&n.jsxs(d,{sx:{p:3,pt:1,mt:3,display:"flex",flexDirection:"column"},children:[n.jsx(k,{variant:"h6",gutterBottom:!0,sx:{my:2},children:l("templates.templateLinks.title")}),C&&q&&!(null==q?void 0:q.share_key)&&n.jsx(n.Fragment,{children:n.jsx(k,{variant:"body1",color:"text.secondary",sx:{mb:1},children:l("templates.templateLinks.description")})}),C&&q&&n.jsx(n.Fragment,{children:n.jsx(k,{variant:"body2",color:"text.secondary",sx:{mb:3},children:l("templates.templateLinks.description2")})}),!C&&n.jsx(n.Fragment,{children:n.jsxs(o,{sx:{display:"flex",flexDirection:"column",alignItems:"flex-start",gap:1},children:[n.jsx(k,{variant:"body1",color:"text.secondary",sx:{mb:1},children:l("templates.createNewTemplate.description")}),n.jsxs(o,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},justifyContent:"space-between",gap:2,width:"100%",mt:1},children:[n.jsx(c,{variant:"outlined",fullWidth:!0,color:"primary",onClick:()=>{ot(A[0])},children:l("templates.createNewTemplate.title")}),n.jsxs(c,{variant:"text",fullWidth:!0,color:"secondary",onClick:()=>{u("/templates")},children:[l("common.my.many")," ",l("navigation.templates")]})]})]})}),w&&it&&q&&n.jsx(Pt,{work:q,onCreate:e=>{Q((t=>t?{...t,share_key:e}:t))},onDelete:()=>{Q((e=>e?{...e,share_key:null}:e))},onDone:()=>mt()})]})]}),1===Ie&&n.jsxs(d,{sx:{py:1,px:3,display:"flex",flexDirection:"column",overflow:"hidden",height:"100%"},children:[n.jsx(o,{sx:{mt:1,mb:0,display:"flex",alignItems:"center",gap:1},children:n.jsxs(o,{sx:{flex:1,display:"flex",alignItems:"center",borderBottom:1,borderColor:"divider",pb:1},children:[!0===(null==R?void 0:R.is_template)&&n.jsx(n.Fragment,{children:n.jsxs(k,{variant:"h6",gutterBottom:!0,sx:{my:1},children:[l(v?"works.creator.templateHintEditing":"works.creator.templateHint"),"  ",Ne?`${l("works.creator.inFolder")} "${null==Ne?void 0:Ne.title}"`:""]})}),R&&!R.is_template&&n.jsxs(o,{sx:{flex:1,display:"flex",justifyContent:"space-between"},children:[n.jsxs(o,{sx:{display:"flex",flexDirection:"column",alignItems:"flex-start",gap:1},children:[n.jsx(k,{variant:"body2",sx:{mb:.5},children:l("works.creator.byStudent")}),n.jsxs(o,{sx:{display:"flex",flexDirection:"row",alignItems:"center",gap:1},children:[n.jsx(H,{src:(null==R?void 0:R.photo_url)||void 0,sx:{width:32,height:32,mr:1},children:Tt(R)}),n.jsx(k,{variant:"h6",sx:{flex:1,overflow:"hidden"},children:Ft(R)})]})]}),v?null:n.jsxs(o,{sx:{display:"flex",flexDirection:"column",alignItems:"flex-start",gap:1},children:[ie&&le>0&&n.jsx(k,{variant:"body2",children:l("works.creator.availableLessons",{count:le})}),ie&&le<=0&&n.jsx(k,{variant:"body2",children:l("works.creator.noLessonsAvailable")}),ie&&le>0&&n.jsx(V,{control:n.jsx(y,{checked:se,onChange:e=>ne(e.target.checked),color:"primary"}),label:n.jsx(k,{sx:{whiteSpace:"nowrap"},color:se?"primary":"default",children:l("works.creator.redeemLesson")})})]})]})]})}),n.jsxs(o,{sx:{my:1},children:[n.jsx(h,{fullWidth:!0,autoFocus:!0,label:(null==R?void 0:R.is_template)?l("templates.actions.templateName"):l("templates.actions.workName"),value:ee,onChange:e=>te(e.target.value),margin:"normal",required:!0,error:!!Ce.name,helperText:Ce.name}),!R||!ee.trim()&&n.jsx(k,{variant:"body2",color:"error.main",sx:{p:1,textAlign:"center"},children:R?ee.trim()?"":l("works.creator.enterWorkName"):l("works.creator.selectStudent")})]}),n.jsxs(n.Fragment,{children:[n.jsxs(d,{id:"tasks-list-paper",variant:"outlined",sx:{mt:1,mb:1,overflow:"hidden",maxHeight:"100%",overflowY:"auto",overflowX:"hidden",position:"relative",...T&&{animation:"pulse 3s ease-in-out","@keyframes pulse":{"0%":{boxShadow:"0 0 0 0 rgba(25, 118, 210, 0.7)",transform:"scale(1)"},"50%":{boxShadow:"0 0 0 10px rgba(25, 118, 210, 0)",transform:"scale(1.02)"},"100%":{boxShadow:"0 0 0 0 rgba(25, 118, 210, 0)",transform:"scale(1)"}}}},children:[U.length>0?n.jsx(At,{onSortEnd:(e,t)=>{e<0||t<0||e>=U.length||t>=U.length||e===t||(J((s=>{const n=[...s],[a]=n.splice(e,1);return n.splice(t,0,a),n})),Le((e=>e+1)))},lockAxis:"y",className:"sortable-list",draggedItemClassName:"dragged-item",allowDrag:!0,as:"div",children:U.map(((e,t)=>n.jsx(Et,{children:n.jsxs(o,{sx:{display:"flex",alignItems:"center",px:2,py:1,borderBottom:1,borderColor:"divider",cursor:"pointer","&:hover":{backgroundColor:"action.hover"}},children:[n.jsxs(o,{sx:{display:"flex",alignItems:"center",flex:1},children:[n.jsx(Dt,{children:n.jsx(Wt,{sx:{mr:1,color:"primary.main",cursor:"grab"}})}),n.jsx(o,{sx:{flex:1},onClick:()=>pt(e),children:n.jsx(k,{variant:"body1",sx:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden",textOverflow:"ellipsis"},children:`${t+1}. ${e.title}`})})]}),n.jsx(o,{sx:{display:"flex",alignItems:"center"},children:n.jsx(B,{title:l("common.actions.actions"),children:n.jsx(g,{edge:"end",onClick:t=>((e,t)=>{e.preventDefault(),e.stopPropagation(),qe(e.currentTarget),Ke(t)})(t,e),size:"small",children:n.jsx(xe,{})})})})]})},`task-${e.id}-pos-${t}`)))},`sortable-list-${Oe}`):null,n.jsx(o,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},justifyContent:"flex-end",gap:0,width:"100%",p:1},children:R&&n.jsxs(n.Fragment,{children:[n.jsx(c,{variant:"text",color:"primary",onClick:()=>{ct(!1).then((e=>{e&&u(`/tasks/new?work_id=${e}&return_to=/works/assign/%3Fwork_id=${e}%26folder_id=${null==Ne?void 0:Ne.id}%26edit=true%26return_to=${f}`)}))},startIcon:n.jsx(ae,{}),disabled:ke||!R||!ee.trim(),children:l("tasks.actions.createTask")}),n.jsx(c,{variant:"text",color:"primary",onClick:()=>{tt(1),Ye(!0)},startIcon:n.jsx(Rt,{}),children:l("works.creator.addExistingTask")})]})})]}),n.jsxs(S,{anchorEl:Je,open:Boolean(Je),onClose:ht,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:[n.jsxs(a,{onClick:()=>{Qe&&pt(Qe),ht()},sx:{borderBottom:1,borderColor:"divider"},children:[n.jsx(i,{children:n.jsx(Mt,{fontSize:"small"})}),n.jsx(r,{primary:l("common.actions.preview")})]}),n.jsxs(a,{onClick:()=>{Qe&&lt(Qe),ht()},children:[n.jsx(i,{children:n.jsx(re,{fontSize:"small"})}),n.jsx(r,{primary:l("common.actions.remove")})]}),n.jsxs(a,{onClick:()=>{Qe&&ct(!1).then((e=>{e&&u(`/tasks/${Qe.id}/edit?work_id=${e}&return_to=/works/assign/%3Fwork_id=${e}%26folder_id=${null==Ne?void 0:Ne.id}%26edit=true%26return_to=${f}`)})),ht()},children:[n.jsx(i,{children:n.jsx(de,{fontSize:"small"})}),n.jsx(r,{primary:l("common.actions.edit")})]}),n.jsxs(a,{onClick:()=>{Qe&&ct(!1).then((e=>{e&&u(`/tasks/new?work_id=${e}&copy_task_id=${Qe.id}&return_to=/works/assign/%3Fwork_id=${e}%26folder_id=${null==Ne?void 0:Ne.id}%26edit=true%26return_to=${f}`)})),ht()},children:[n.jsx(i,{children:n.jsx(Bt,{fontSize:"small"})}),n.jsx(r,{primary:l("common.actions.copy")})]})]})]})]})]}),n.jsxs(o,{sx:{width:"100%",p:1,display:"flex",justifyContent:"space-between",position:"sticky",bottom:0,left:0,zIndex:1,flexShrink:0},children:[n.jsx(o,{sx:{display:"flex-start",gap:2},children:n.jsx(c,{variant:"outlined",size:"small",color:"inherit",onClick:mt,children:l("common.actions.cancel")})}),n.jsx(o,{sx:{display:"flex",gap:2,alignItems:"center"},children:Ie<1?n.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>_e(1),disabled:!R,children:l("common.actions.next")}):n.jsxs(n.Fragment,{children:[!v&&n.jsx(c,{variant:"outlined",color:"primary",size:"small",onClick:()=>_e(0),sx:{ml:1},children:l("common.actions.back")}),n.jsx(c,{variant:"contained",color:"primary",onClick:()=>ct(!0),disabled:ke||!R||!ee.trim()||0===U.length,children:ke?l("common.status.loading"):v?(null==q?void 0:q.status)===Ot.DRAFT?(null==R?void 0:R.is_template)?l("templates.actions.createTemplate"):l("templates.actions.sendToStudent"):l("common.actions.save"):(null==R?void 0:R.is_template)?l("templates.actions.createTemplate"):l(v?"common.actions.save":"templates.actions.sendToStudent")})]})})]})]}),n.jsx(O,{anchor:"right",open:gt,onClose:()=>{Ge&&Ze(null),Ye(!Ge)},variant:nt?"persistent":"temporary",sx:{width:"93%",maxWidth:"400px",flexShrink:0,"& .MuiDrawer-paper":{width:"93%",maxWidth:"400px"}},children:n.jsxs(o,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[n.jsxs(o,{sx:{borderBottom:1,borderColor:"divider",display:"flex",alignItems:"center",px:1},children:[n.jsx(g,{onClick:()=>Ye(!1),sx:{mr:1},children:at?n.jsx(Me,{}):n.jsx(he,{})}),n.jsxs(L,{value:et,onChange:(e,t)=>{tt(t)},variant:"fullWidth",sx:{flex:1,"& .MuiTab-root":{minHeight:48,fontSize:"0.875rem"}},children:[Xe&&n.jsx(N,{value:0,label:l("taskForm.buttons.preview")}),n.jsx(N,{value:1,label:l("works.creator.addTasks")})]})]}),n.jsxs(o,{sx:{flex:1,overflow:"auto",p:2},children:[0===et&&n.jsx(n.Fragment,{children:Xe?n.jsx(Xt,{title:Xe.title||"",text:Xe.text||"",tagIds:[],tags:[],teacherId:"",onClose:()=>Ye(!1),onFullscreen:()=>{dt(Xe)},onValidateAnswers:()=>{},hasQuizzes:!1}):null}),1===et&&n.jsx(Lt,{selectedTasks:U,onTaskToggle:lt,onPreviewTask:e=>{dt(e)}})]})]})})]}),n.jsx(me,{open:De,onClose:xt,task:Ae,hasQuizzes:!1,onValidateAnswers:()=>{},actionButtons:n.jsxs(o,{sx:{display:"flex",gap:1,width:"100%",justifyContent:"space-between"},children:[n.jsx(o,{sx:{display:"flex",gap:1},children:Ae&&n.jsxs(n.Fragment,{children:[n.jsx(B,{title:l("works.creator.autoSaveHint"),children:n.jsx(c,{size:"small",variant:"text",startIcon:n.jsx(de,{}),onClick:()=>{ct(!1).then((e=>{e&&(u(`/tasks/${Ae.id}/edit?return_to=/works/assign/%3Fwork_id=${e}%26edit=true`),xt())}))},children:l("common.actions.edit")})}),n.jsx(c,{size:"small",onClick:e=>{e.stopPropagation(),lt(Ae),xt()},startIcon:U.some((e=>e.id===Ae.id))?n.jsx(re,{}):n.jsx(ae,{}),children:U.some((e=>e.id===Ae.id))?l("common.actions.remove"):l("common.actions.add")})]})}),n.jsx(c,{onClick:xt,children:l("common.actions.close")})]})}),n.jsxs(I,{open:Fe,onClose:ut,maxWidth:"xs",fullWidth:!0,children:[n.jsx(_,{children:l("common.dialog.cancel.title")}),n.jsx(F,{children:n.jsx(k,{children:l("common.dialog.cancel.message")})}),n.jsxs(z,{children:[n.jsx(c,{onClick:ut,children:l("common.actions.no")}),n.jsx(c,{onClick:()=>{ze(!1),f?u(f):(null==R?void 0:R.is_template)?u("/templates"):u("/works")},color:"error",children:l("common.actions.yes")})]})]})]})}},Symbol.toStringTag,{value:"Module"})),as=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const{t:t}=Y(),{user:l}=K(),{showErrorToast:x}=G(),m=s.useRef(null),[f,j]=s.useState([]),[y,b]=s.useState(!0),[v,w]=s.useState(null),[C,T]=s.useState(0),[$,P]=s.useState(""),[A,E]=s.useState(!1),[D,W]=s.useState({}),[R,M]=s.useState(null),[B,O]=s.useState(null),[L,N]=s.useState(!1),[H,V]=s.useState(""),[U,J]=s.useState(!1),q=e(),Q=(null==l?void 0:l.role)===X.ADMIN,ee=(null==l?void 0:l.role)===X.TEACHER||Q;s.useEffect((()=>{(async()=>{b(!0),w(null);try{const e=await Z.tags.getAll();j(e),w(null)}catch(e){const t=ue(e);w(t),x(t)}finally{b(!1)}})()}),[C]),s.useCallback((()=>{T((e=>e+1))}),[]);const te=async()=>{var e;const{isValid:t,errors:s}=St(Ut,{name:$});if(t){E(!0);try{const t=await Z.tags.create({name:$.trim()});j((e=>[t,...e])),P(""),W({}),null==(e=m.current)||e.focus()}catch(n){const e=n instanceof Error?n.message:"Failed to create tag. Please try again.";x(e)}finally{E(!1)}}else W(s)},ae=()=>{M(null)},ie=()=>{N(!1),V("")},oe=()=>{J(!1)};return n.jsxs(o,{children:[n.jsx(ne,{title:t("navigation.tags")}),y?n.jsx(ce,{message:t(y?"common.loading":"tags.loading.tags")}):n.jsxs(n.Fragment,{children:[n.jsx(d,{sx:{p:3,mb:3,mx:"auto",maxWidth:"1200px"},children:n.jsxs(o,{sx:{display:"flex",gap:1,alignItems:"center"},children:[n.jsx(h,{inputRef:m,fullWidth:!0,autoComplete:"off",autoCapitalize:"off",size:"small",placeholder:t("tags.input.placeholder"),value:$,onChange:e=>{P(e.target.value),D.name&&W((e=>({...e,name:""})))},onKeyPress:e=>{"Enter"===e.key&&$.trim()&&te()},error:!!D.name,helperText:D.name,InputProps:{endAdornment:$?n.jsx(p,{position:"end",children:n.jsx(g,{size:"small",onClick:()=>{P(""),W({})},edge:"end",children:n.jsx(re,{})})}):null}}),$.trim()&&n.jsx(c,{size:"small",startIcon:n.jsx(Ht,{}),onClick:te,disabled:A,children:t(A?"common.status.saving":"common.actions.create")})]})}),v||0!==f.length?n.jsx(d,{sx:{p:3,mx:"auto",maxWidth:"1200px"},children:n.jsx(o,{sx:{display:"flex",flexWrap:"wrap",gap:1,mt:1},children:f.map((e=>n.jsx(o,{children:n.jsx(u,{onClick:t=>((e,t)=>{e.stopPropagation(),O(t),M(e.currentTarget)})(t,e),label:e.name,sx:{m:.5,height:"auto",borderRadius:"16px","& .MuiChip-label":{px:1.5,py:.5}},variant:"outlined"})},e.id)))})}):n.jsx(o,{sx:{textAlign:"center",py:4},children:n.jsx(k,{variant:"h6",color:"text.secondary",sx:{mb:1},children:t(ee?"tags.empty.teacher":"tags.empty.default")})})]}),n.jsxs(S,{anchorEl:R,open:Boolean(R),onClose:ae,onClick:e=>e.stopPropagation(),children:[n.jsxs(a,{onClick:()=>{ae(),q(`/tasks?tag_id=${null==B?void 0:B.id}`)},children:[n.jsx(i,{children:n.jsx(Vt,{fontSize:"small"})}),n.jsx(r,{children:t("tags.actions.showTasks")})]}),n.jsxs(a,{onClick:()=>{B&&(V(B.name),N(!0)),ae()},children:[n.jsx(i,{children:n.jsx(de,{fontSize:"small"})}),n.jsx(r,{children:t("common.actions.rename")})]}),n.jsxs(a,{onClick:()=>{ae(),J(!0)},sx:{color:"error.main"},children:[n.jsx(i,{sx:{color:"error.main"},children:n.jsx(se,{fontSize:"small"})}),n.jsx(r,{children:t("common.actions.delete")})]})]}),n.jsxs(I,{open:L,onClose:ie,maxWidth:"xs",fullWidth:!0,children:[n.jsx(_,{children:t("tags.dialog.rename.title")}),n.jsx(F,{children:n.jsx(h,{autoFocus:!0,margin:"dense",label:t("tags.input.label"),type:"text",fullWidth:!0,value:H,onChange:e=>V(e.target.value),variant:"outlined"})}),n.jsxs(z,{children:[n.jsx(c,{onClick:ie,children:t("common.actions.cancel")}),n.jsx(c,{onClick:async()=>{if(!B||!H.trim())return;const{isValid:e,errors:t}=St(Ut,{name:H});if(e)try{const e=await Z.tags.update(B.id,{name:H.trim()});j((t=>t.map((t=>t.id===B.id?e:t)))),N(!1),V(""),O(null)}catch(s){const e=s instanceof Error?s.message:"Failed to rename tag. Please try again.";x(e)}else x(t.name)},variant:"contained",disabled:!H.trim()||H===(null==B?void 0:B.name),children:t("common.actions.rename")})]})]}),n.jsxs(I,{open:U,onClose:oe,maxWidth:"xs",fullWidth:!0,children:[n.jsx(_,{children:t("tags.dialog.delete.title")}),n.jsx(F,{children:n.jsx(k,{children:t("tags.dialog.delete.message",{name:null==B?void 0:B.name})})}),n.jsxs(z,{children:[n.jsx(c,{onClick:oe,children:t("common.actions.cancel")}),n.jsx(c,{onClick:async()=>{B&&(await(async e=>{try{await Z.tags.delete(e),j((t=>t.filter((t=>t.id!==e))))}catch(t){const e=t instanceof Error?t.message:"Failed to delete tag. Please try again.";x(e)}})(B.id),J(!1))},color:"error",variant:"contained",children:t("common.actions.delete")})]})]})]})}},Symbol.toStringTag,{value:"Module"})),is=()=>{var i;const{t:r}=Y(),l=e(),{contractId:x}=A(),[m]=t(),u=m.get("return_to")||"/contracts",{user:p}=K(),{showErrorToast:g,showToast:f}=G(),j="true"===m.get("testStudent"),y="teachair_test_student",[b,v]=s.useState(!0),[w,C]=s.useState(!1),[S,T]=s.useState(null),[$,P]=s.useState([]),[E,D]=s.useState({username:"",price:"",currency:null,balance:null,description:""}),[W,R]=s.useState({}),[M,B]=s.useState(null),[O,L]=s.useState(null),[N,ee]=s.useState(!1),[te,se]=s.useState(!1),[ne,ae]=s.useState(!0),ie=(null==p?void 0:p.role)===X.ADMIN,re=(null==p?void 0:p.role)===X.TEACHER||ie,oe=Boolean(x);s.useEffect((()=>{(async()=>{v(!0);try{const e=await Z.contracts.getCurrencies();P(e);const t=e.find((e=>"RUR"===e.code))||e[0];if(x){const t=await Z.contracts.getById(x);T(t);let s=null;t.currency?s=t.currency:e.length>0&&(s=e[0].code),D({username:t.student_id,price:t.price,currency:s,balance:t.balance,description:t.description||""})}else j?(D((e=>({...e,username:y||"",price:1e3,currency:"RUR",balance:10,description:r("contracts.form.testStudentDescription")}))),ae(!0)):t&&!E.currency&&D((e=>({...e,currency:t.code})))}catch(e){const t=e instanceof Error?e.message:"Failed to load data. Please try again.";g(t),l("/contracts")}finally{v(!1)}})()}),[x,l,g,j,y,r]);return re?n.jsxs(o,{sx:{display:"flex",flexDirection:"column",overflowX:"hidden",overflowY:"auto"},children:[b?n.jsx(ce,{message:r(oe?"contracts.status.loadingContract":"common.loading")}):n.jsx(n.Fragment,{children:n.jsxs(o,{sx:{flex:1,display:"flex",flexDirection:"column",mx:"auto",width:"100%",maxWidth:"800px",pb:1},children:[n.jsxs(d,{sx:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",p:2,py:1},children:[n.jsx(k,{variant:"h6",gutterBottom:!0,sx:{my:1},children:r(oe?"contracts.actions.edit":"contracts.actions.create")}),n.jsxs(o,{component:"form",noValidate:!0,children:[oe?n.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:2,mb:3},children:[n.jsx(H,{src:(null==(i=null==S?void 0:S.student)?void 0:i.photo_url)||void 0,sx:{width:48,height:48},children:Tt(null==S?void 0:S.student)}),n.jsxs(o,{children:[n.jsx(k,{variant:"h6",children:Ft(null==S?void 0:S.student)}),n.jsx(k,{variant:"body2",color:"text.secondary",children:r("common.student.one")})]})]}):n.jsx(h,{autoFocus:!0,margin:"normal",name:"username",label:r("contracts.form.studentUsername"),type:"text",fullWidth:!0,variant:"outlined",value:E.username,onChange:e=>{const t=e.target.value;let s;s=t.includes("@")&&t.indexOf("@")>0?t.split("@")[0]:t.replace(/^@/,""),D((e=>({...e,username:s}))),W.username&&R((e=>{const t={...e};return delete t.username,t}))},error:!!W.username,helperText:W.username||r("contracts.form.telegramUsername"),placeholder:r("contracts.form.usernamePlaceholder"),InputProps:{startAdornment:n.jsx(k,{sx:{mr:.5},children:"@"})}}),!oe&&n.jsx(V,{control:n.jsx(U,{checked:ne,onChange:e=>{ae(e.target.checked),e.target.checked||D((e=>({...e,price:0,balance:null})))}}),label:r("contracts.form.trackLessonsLabel"),sx:{my:1}}),ne&&n.jsxs(o,{sx:{display:"flex",gap:2,alignItems:"flex-start"},children:[n.jsx(h,{margin:"normal",name:"price",label:r("contracts.form.pricePerLesson"),type:"number",sx:{flex:1},variant:"outlined",value:0===E.price?"":E.price,onChange:e=>{const t=e.target.value,s=""===t?0:Number(t.replace(/^0+/,""));D((e=>({...e,price:s}))),W.price&&R((e=>{const t={...e};return delete t.price,t}))},error:!!W.price,helperText:W.price}),n.jsxs(J,{margin:"normal",sx:{minWidth:120},error:!!W.currency,children:[n.jsx(q,{id:"currency-label",children:r("contracts.form.currency")}),n.jsx(Q,{labelId:"currency-label",name:"currency",value:E.currency||"",label:r("contracts.form.currency"),onChange:e=>{const{name:t,value:s}=e.target;D((e=>({...e,[t]:s}))),W[t]&&R((e=>{const s={...e};return delete s[t],s}))},children:$.map((e=>n.jsxs(a,{value:e.code,children:[e.emoji," Â  ",e.code]},e.code)))})]})]}),!oe&&ne?n.jsx(h,{margin:"normal",name:"balance",label:r("contracts.form.balanceLabel"),type:"number",fullWidth:!0,variant:"outlined",value:null===E.balance?"":E.balance,onChange:e=>{const t=e.target.value,s=""===t?null:Number(t.replace(/^0+/,""));D((e=>({...e,balance:s}))),W.balance&&R((e=>{const t={...e};return delete t.balance,t}))},error:!!W.balance,helperText:W.balance||r("contracts.form.balanceHint")}):oe?n.jsxs(k,{variant:"body1",color:"text.secondary",sx:{mt:1},children:[r("contracts.form.currentBalance"),": ",E.balance]}):null,n.jsx(h,{margin:"normal",name:"description",label:r("contracts.form.description"),type:"text",fullWidth:!0,variant:"outlined",value:E.description,onChange:e=>{const{name:t,value:s}=e.target;D((e=>({...e,[t]:"price"===t||"balance"===t?Number(s):s}))),W[t]&&R((e=>{const s={...e};return delete s[t],s}))},multiline:!0,rows:3,error:!!W.description,helperText:W.description||r("contracts.form.descriptionHint")})]})]}),n.jsxs(o,{sx:{mt:2,display:"flex",justifyContent:"space-between",flexShrink:0},children:[n.jsx(o,{sx:{display:"flex",alignItems:"center"},children:n.jsx(c,{variant:"outlined",color:"inherit",sx:{mr:2},onClick:()=>{l(u)},children:r("common.actions.cancel")})}),n.jsx(o,{children:n.jsx(c,{variant:"contained",color:"primary",onClick:async()=>{const e={...E,price:ne?E.price:0,balance:ne?E.balance??0:0},{isValid:t,errors:s}=St(oe?qt:Qt,e);if(t){C(!0);try{if(oe&&x)await Z.contracts.update(x,{price:e.price,currency:e.currency,balance:e.balance,description:e.description}),l(u);else{const t=await Z.contracts.create({...e});if("new_user_created"===t.create_code)B(t.id),L(t.student_id),ee(!0),f(r("contracts.status.contractCreatedShort"),"info");else if("already_exists"===t.create_code)B(t.id),L(t.student_id),se(!0);else{B(t.id),L(t.student_id),ee(!1),se(!1),f(r("contracts.status.contractCreatedShort"),"success");const e=u.includes("?")?`${u}&studentId=${t.student_id}`:`${u}?studentId=${t.student_id}`;l(e)}}}catch(n){const e=n instanceof Error?n.message:r("contracts.status.errorCreating");if(e.includes("student_is_self"))return void g(r("contracts.status.studentIsSelf"));if(e.includes("student_is_teacher"))return void g(r("contracts.status.studentIsTeacher"));g(e)}finally{C(!1)}}else R(s)},disabled:w||!oe&&!E.username.trim(),children:r(w?"common.status.saving":oe?"contracts.actions.update":"contracts.actions.create")})})]})]})}),n.jsx(Jt,{open:N,onClose:()=>ee(!1),onCancel:()=>{ee(!1);const e=u.includes("?")?`${u}&studentId=${O}`:`${u}?studentId=${O}`;l(e)},botUrl:"https://t.me/teachair_bot",cancelButtonText:r("common.actions.done")}),n.jsxs(I,{open:te,onClose:()=>se(!1),maxWidth:"xs",fullWidth:!0,children:[n.jsx(_,{children:r("contracts.dialog.existingContract.title")}),n.jsx(F,{children:n.jsx(k,{children:r("contracts.dialog.existingContract.message")})}),n.jsxs(z,{children:[n.jsx(c,{onClick:()=>se(!1),children:r("common.actions.cancel")}),n.jsx(c,{onClick:()=>{se(!1),M&&l(`/contracts/${M}/edit`)},color:"primary",variant:"contained",children:r("contracts.actions.editExisting")})]})]})]}):(l("/contracts"),null)},rs=Object.freeze(Object.defineProperty({__proto__:null,ContractFormPage:is,default:is},Symbol.toStringTag,{value:"Module"}));export{Zt as A,rs as C,Xt as P,Gt as T,ss as a,ns as b,as as c};
