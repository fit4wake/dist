import{a5 as e,aa as t,r,G as s,J as l,j as a,B as o,x as n,V as i,W as d,d as c,f as u,h as m,n as x,u as p,ab as h,au as f,av as g,b as j,A as v,H as y,D as b,i as w,v as k,l as S,m as C,M as F,w as T,y as D,a0 as _,ad as I,a1 as z,K as W}from"./vendor-5I4LDDhx.js";import{u as E,a as O,b as L,az as B,U as $,c as A,g as P,P as M,aA as R,A as U,e as H,f as N,aB as q,d as K,aC as J,E as G,L as V,aD as Z,M as Q,aE as X,aF as Y,D as ee,I as te,aG as re,h as se,aq as le,k as ae}from"./main-CRXzfybP.js";import{v as oe,f as ne}from"./teacher-COdW5Dho.js";const ie=e=>{const t=e?`/#/templates?folder=${e}`:"/#/templates";window.history.replaceState({},"",t)};function de(e){let t,r=0;for(t=0;t<e.length;t+=1)r=e.charCodeAt(t)+((r<<5)-r);let s="#";for(t=0;t<3;t+=1){const e=r>>8*t&255;s+=`00${Math.min(255,Math.floor((e+128)/2)).toString(16)}`.slice(-2)}return s}function ce(e){if(!e)return"?";const t=e.split(" ");return 1===t.length?t[0][0].toUpperCase():`${t[0][0]}${t[1][0]}`.toUpperCase()}const ue="templatesPageFilters",me="templatesPageOrder",xe=({work:t,onClick:s,onDelete:l})=>{const n=e(),[i,d]=r.useState(null),[u,p]=r.useState(!1),[h,f]=r.useState(!1),{showErrorToast:g,showToast:v}=O(),{t:k}=L(),[T]=I(),D="true"===T.get("onboarding"),E=()=>{d(null)},B=()=>{const e=D?"/":"/templates";n(`/works/assign/?work_id=${t.id}&copy=true&return_to=${e}`)};return a.jsxs(a.Fragment,{children:[a.jsx(_,{className:"template-card",draggable:!0,onDragStart:e=>{e.dataTransfer.setData("text/plain",t.id),e.currentTarget.style.opacity="0.5"},onDragEnd:e=>{e.currentTarget.style.opacity="1"},onDragOver:e=>{e.preventDefault(),e.stopPropagation(),e.currentTarget.style.cursor="default"},sx:{height:"100%",cursor:"pointer","&:hover":{boxShadow:6},position:"relative",borderLeft:"4px solid",borderLeftColor:"primary.main",borderRadius:3,borderTopLeftRadius:2,borderBottomLeftRadius:3},onClick:()=>s(t,"view"),children:a.jsx(z,{sx:{p:2,"&:last-child":{paddingBottom:2}},children:a.jsxs(o,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",gap:1},children:[a.jsx(j,{sx:{flex:1,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.2},children:t.name}),a.jsx(W,{title:k("templates.actions.sendToStudent"),children:a.jsx(m,{size:"small",onClick:B,sx:{flexShrink:0},children:a.jsx(ae,{fontSize:"small"})})}),a.jsx(m,{size:"small",onClick:e=>{e.stopPropagation(),d(e.currentTarget)},sx:{flexShrink:0},children:a.jsx(Q,{fontSize:"small"})})]})})},t.id),a.jsxs(F,{anchorEl:i,open:Boolean(i),onClose:E,onClick:e=>e.stopPropagation(),children:[a.jsxs(c,{onClick:()=>{n(`/works/assign/?work_id=${t.id}&edit=true&return_to=/templates`)},children:[a.jsx(G,{fontSize:"small",sx:{mr:1}}),k("common.actions.edit")]}),a.jsxs(c,{onClick:B,children:[a.jsx(X,{fontSize:"small",sx:{mr:1}}),k("common.actions.copy")]}),a.jsxs(c,{onClick:()=>{E(),s(t,"move")},children:[a.jsx(Y,{fontSize:"small",sx:{mr:1}}),k("common.actions.moveTo")]}),a.jsxs(c,{onClick:()=>{E(),p(!0)},disabled:h,sx:{color:"error.main"},children:[h?a.jsx(y,{size:20,sx:{mr:1}}):a.jsx(ee,{fontSize:"small",sx:{mr:1}}),k("common.actions.delete")]})]}),a.jsxs(b,{open:u,onClose:()=>!h&&p(!1),maxWidth:"xs",fullWidth:!0,children:[a.jsx(w,{children:k("common.dialog.delete.title",{item:k("templates.titleSingle")})}),a.jsx(S,{children:a.jsx(j,{children:k("common.dialog.delete.message",{name:null==t?void 0:t.name})})}),a.jsxs(C,{children:[a.jsx(x,{onClick:()=>p(!1),disabled:h,children:k("common.actions.cancel")}),a.jsx(x,{onClick:async()=>{f(!0);try{await A.works.delete(t.id),l(t),v(k("templates.status.templateDeleted"),"success")}catch(e){g(P(e))}finally{f(!1),p(!1)}},color:"error",variant:"contained",disabled:h,startIcon:h?a.jsx(y,{size:20}):a.jsx(ee,{}),children:k(h?"common.status.deleting":"common.actions.delete")})]})]})]})},pe=({folder:e,onClick:t,onContextMenu:r,onDrop:s,onFolderDrop:l,allWorks:n,isNewFolder:i=!1})=>a.jsxs(o,{sx:{width:120},children:[a.jsx(_,{className:i?"folder-card":"","data-folder-id":e.id,draggable:!0,onDragStart:t=>{t.dataTransfer.setData("folder-id",e.id),t.currentTarget.style.opacity="0.5"},onDragEnd:e=>{e.currentTarget.style.opacity="1"},onDragOver:e=>{e.preventDefault(),e.currentTarget.style.boxShadow="0 0 10px 0 rgba(0, 0, 0, 0.1)",e.currentTarget.style.transform="scale(1.1)",e.currentTarget.style.transition="transform 0.2s ease"},onDragLeave:e=>{e.currentTarget.style.boxShadow="none",e.currentTarget.style.transform="scale(1)"},onDrop:t=>{t.preventDefault(),t.currentTarget.style.boxShadow="none",t.currentTarget.style.transform="scale(1)";const r=t.dataTransfer.getData("text/plain"),a=t.dataTransfer.getData("folder-id");if(r){const t=n.find((e=>e.id===r));t&&s(t,e.id)}else a&&l(a,e.id)},sx:{cursor:"pointer","&:hover":{boxShadow:6,transform:"scale(1.05)",transition:"transform 0.2s ease"},position:"relative",zIndex:0,width:"100%",display:"flex",flexDirection:"column","&.folder-card":{transition:"transform 0.2s ease",animation:"zoomIn 0.3s ease","@keyframes zoomIn":{"0%":{transform:"scale(0)",opacity:0},"80%":{transform:"scale(1.05)",opacity:1},"100%":{transform:"scale(1)",opacity:1}}}},onClick:()=>t(e),onContextMenu:t=>r(t,e),children:a.jsxs(o,{sx:{position:"relative",width:"100%",paddingTop:"150%",overflow:"hidden"},children:[a.jsx(v,{variant:"square",src:e.cover||void 0,sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",bgcolor:e.cover?"primary.main":de(e.title),fontSize:"300%"},children:!e.cover&&ce(e.title)}),a.jsx(m,{size:"small",onClick:t=>{t.stopPropagation(),r(t,e)},sx:{position:"absolute",bottom:4,right:4,bgcolor:"background.paper",opacity:.5,"&:hover":{bgcolor:"background.default",opacity:1}},children:a.jsx(Q,{fontSize:"small"})})]})}),a.jsx(j,{sx:{mt:2,width:"100%",overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.2,textAlign:"center"},children:e.title})]}),he=()=>{var _,I,z,W,ae,ce;const{user:he}=E(),fe=e(),ge=t(),{showErrorToast:je,showToast:ve}=O(),{t:ye}=L(),be=new URLSearchParams(ge.search).get("teacher");new URLSearchParams(ge.search).get("folder");const we="true"===new URLSearchParams(ge.search).get("clear_filters"),[ke,Se]=r.useState(null),[Ce,Fe]=r.useState((()=>{try{if(we)return localStorage.removeItem(ue),{teacherFilter:"",searchTerm:"",folderState:void 0};const e=localStorage.getItem(ue);if(e){const t=JSON.parse(e);return Se(t),t}}catch(e){}return{teacherFilter:"",searchTerm:"",folderState:void 0}})),[Te,De]=r.useState(Ce.teacherFilter),[_e,Ie]=r.useState(Ce.searchTerm),[ze,We]=r.useState(Ce.searchTerm),[Ee,Oe]=r.useState((()=>(()=>{try{return localStorage.getItem(me)||"created_at_desc"}catch(Ve){return"created_at_desc"}})())),[Le,Be]=r.useState(Ce.folderState||{currentFolder:null,breadcrumbs:[]}),[$e,Ae]=r.useState([]),[Pe,Me]=r.useState([]),[Re,Ue]=r.useState([]),[He,Ne]=r.useState(!0),[qe,Ke]=r.useState(!1),[Je,Ge]=r.useState(!0),[Ve,Ze]=r.useState(null),[Qe,Xe]=r.useState(null),[Ye,et]=r.useState(null),[tt,rt]=r.useState(!1),[st,lt]=r.useState(!1),[at,ot]=r.useState(!1),[nt,it]=r.useState(null),dt=Boolean(nt),[ct,ut]=r.useState(!1),[mt,xt]=r.useState(0),pt=r.useRef(!0),[ht,ft]=r.useState(0),[gt,jt]=r.useState(!0),vt=15,[yt,bt]=r.useState([]),[wt,kt]=r.useState(!0),[St,Ct]=r.useState(!1),[Ft,Tt]=r.useState({title:"",description:"",type:B.BOOK,cover:void 0}),[Dt,_t]=r.useState(!1),[It,zt]=r.useState(null),[Wt,Et]=r.useState(null),[Ot,Lt]=r.useState(!1),[Bt,$t]=r.useState(null),[At,Pt]=r.useState(!1),[Mt,Rt]=r.useState(!1),[Ut,Ht]=r.useState(!1),[Nt,qt]=r.useState([]),[Kt,Jt]=r.useState(!0),[Gt,Vt]=r.useState(0),[Zt,Qt]=r.useState(!0),[Xt,Yt]=r.useState(!1),er=r.useRef(null),[tr,rr]=r.useState(!1),[sr,lr]=r.useState((()=>{try{const e=localStorage.getItem("templatesAccordionState");return e?JSON.parse(e):{folders:!0,allTemplates:!0}}catch{return{folders:!0,allTemplates:!0}}})),[ar,or]=r.useState(!1),[nr,ir]=r.useState(!1),[dr,cr]=r.useState(!1),[ur,mr]=r.useState(null),[xr,pr]=r.useState(!1);r.useEffect((()=>{const e=setTimeout((()=>{ze!==_e&&Ie(ze)}),500);return()=>clearTimeout(e)}),[ze]);const hr=(null==he?void 0:he.role)===$.ADMIN,fr=(null==he?void 0:he.role)===$.TEACHER||hr;r.useEffect((()=>{if(!pt.current){const e={teacherFilter:Te,searchTerm:_e,folderState:Le};localStorage.setItem(ue,JSON.stringify(e))}}),[Te,_e,Le]),r.useEffect((()=>{pt.current||(e=>{localStorage.setItem(me,e)})(Ee)}),[Ee]),r.useEffect((()=>{(async()=>{if(!ct){Ge(!0),Ze(null);try{if(be&&De(be),hr){const e=(await A.users.getAll(0,100,void 0,$.TEACHER)).sort(((e,t)=>{const r=`${e.first_name||""} ${e.last_name||""}`.trim().toLowerCase(),s=`${t.first_name||""} ${t.last_name||""}`.trim().toLowerCase();return r.localeCompare(s)}));Ue(e)}pt.current=!1}catch(e){const t=P(e);Ze(t),ut(!0),je(t)}finally{Ge(!1)}}})()}),[be,hr,ct]),r.useEffect((()=>{(async()=>{if(!Je&&!pt.current){kt(!0);try{if(!Le.currentFolder){const e=await A.folders.getAll(0,100,void 0,void 0,Te||(null==he?void 0:he.id),_e,"name_asc"===Ee||"name_desc"===Ee?Ee.replace("name_","title_"):Ee);bt(e)}}catch(e){je(P(e))}finally{kt(!1)}}})()}),[Te,null==he?void 0:he.id,_e,Ee,Le.currentFolder,Je]),r.useEffect((()=>{(async()=>{if(!Je&&!pt.current){Ne(!0),Ze(null);try{const e=Te||(null==he?void 0:he.id);let t=[];Le.currentFolder?(t=(Le.currentFolder.works||[]).filter((e=>e.name.toLowerCase().includes(_e.toLowerCase()))),t=[...t].sort(((e,t)=>"name_asc"===Ee?e.name.localeCompare(t.name):"name_desc"===Ee?t.name.localeCompare(e.name):"created_at_asc"===Ee?new Date(e.created_at).getTime()-new Date(t.created_at).getTime():new Date(t.created_at).getTime()-new Date(e.created_at).getTime()))):t=await A.works.getAll(0,vt,void 0,e,e,_e,Ee),Ae(t),ft(0),jt(t.length===vt),Ze(null)}catch(e){const t=P(e);Ze(t),je(t)}finally{Ne(!1)}}})()}),[Te,null==he?void 0:he.id,Le.currentFolder,_e,Ee,Je]),r.useEffect((()=>{var e,t,r;ke&&(null==(e=ke.folderState)?void 0:e.currentFolder)&&A.folders.getById(null==(r=null==(t=ke.folderState)?void 0:t.currentFolder)?void 0:r.id).then((e=>{Be((t=>({...t,currentFolder:e})))}))}),[ke]),r.useEffect((()=>{(async()=>{if(!Je&&!pt.current){Jt(!0);try{const e=Te||(null==he?void 0:he.id),t=await A.works.getAll(0,vt,void 0,e,e,_e,Ee);qt(t),Vt(0),Qt(t.length===vt)}catch(e){je(P(e))}finally{Jt(!1)}}})()}),[Te,null==he?void 0:he.id,_e,Ee,Je]);const gr=r.useCallback((async()=>{if(!Zt||Xt)return;Yt(!0);const e=Gt+1;try{const t=Te||(null==he?void 0:he.id),r=await A.works.getAll(e*vt,vt,void 0,t,t,_e,Ee);r.length>0?(qt((e=>[...e,...r])),Vt(e),Qt(r.length===vt)):Qt(!1)}catch(t){je(P(t))}finally{Yt(!1)}}),[Zt,Xt,Gt,Te,null==he?void 0:he.id,_e,Ee,vt]);r.useEffect((()=>{const e=new IntersectionObserver((e=>{const[t]=e;t.isIntersecting&&Zt&&!Kt&&!Xt&&gr()}),{threshold:.5}),t=er.current;return t&&e.observe(t),()=>{t&&e.unobserve(t)}}),[Zt,Kt,Xt,gr]);const jr=()=>{localStorage.removeItem(ue),De(""),Ie(""),We("")},vr=(e,t="view")=>{et(e),"move"===t?(mr({type:"template",id:e.id}),cr(!0),ot(!1)):ot(!0)},yr=()=>{ot(!1),et(null),Xe(null),lt(!1)},br=()=>{it(null)},wr=r.useCallback((()=>{xt((e=>e+1))}),[]),kr=async e=>{kt(!0);try{const t=await A.folders.getById(e.id);Be((r=>({currentFolder:t,breadcrumbs:[...r.breadcrumbs,e]}))),Ae(t.works||[]),ie(e.id)}catch(t){je(P(t))}finally{kt(!1)}},Sr=async()=>{try{Be({currentFolder:null,breadcrumbs:[]});const e=Te||(null==he?void 0:he.id),t=await A.works.getAll(0,vt,void 0,e,e,_e,Ee);qt(t),Vt(0),Qt(t.length===vt),ie(null)}catch(e){je(P(e))}},Cr=(e,t)=>{e.preventDefault(),e.stopPropagation(),Et(t),zt(e.currentTarget)},Fr=()=>{zt(null)},Tr=async(e,t)=>{try{t?await A.folders.addWork(t,e.id):null!==Le.currentFolder&&await A.folders.removeWork(Le.currentFolder.id,e.id),null!==Le.currentFolder?Ae((t=>t.filter((t=>t.id!==e.id)))):qt((t=>t.filter((t=>t.id!==e.id)))),ve(ye("templates.status.templateMoved"),"success")}catch(r){je(P(r))}},Dr=e=>{Ae((t=>t.filter((t=>t.id!==e.id)))),qt((t=>t.filter((t=>t.id!==e.id))))},_r=async(e,t)=>{try{if(e===t)return;await A.folders.update(e,{parent_id:t}),Le.currentFolder?Be((t=>({...t,currentFolder:{...t.currentFolder,subfolders:t.currentFolder.subfolders.filter((t=>t.id!==e))}}))):bt((t=>t.filter((t=>t.id!==e)))),ve(ye("templates.status.folderMoved"),"success")}catch(r){je(P(r))}},Ir=s(),zr=l(Ir.breakpoints.down("md")),Wr=e=>{e.dataTransfer.getData("text/plain")||e.dataTransfer.getData("folder-id")?rr(!0):e.preventDefault()},Er=()=>{rr(!1)};r.useEffect((()=>(document.addEventListener("dragstart",Wr),document.addEventListener("dragend",Er),document.addEventListener("drop",Er),()=>{document.removeEventListener("dragstart",Wr),document.removeEventListener("dragend",Er),document.removeEventListener("drop",Er)})),[]);return a.jsxs(o,{children:[a.jsx(M,{title:ye("templates.title"),actionButton:[{label:ye(zr?"templates.actions.folder":"templates.actions.addFolder"),icon:a.jsx(R,{}),onClick:()=>Ct(!0)},{label:ye(zr?"templates.actions.template":"templates.actions.createTemplate"),icon:a.jsx(U,{}),onClick:()=>fe(`/works/assign?template=true${Le.currentFolder?`&folder=${Le.currentFolder.id}`:""}&return_to=/templates`)}]}),a.jsx(n,{sx:{p:2,mb:2},children:a.jsxs(o,{sx:{display:"flex",flexDirection:"column",gap:2},children:[hr&&a.jsx(i,{fullWidth:!0,size:"small",sx:{"& .MuiOutlinedInput-root":{borderRadius:2}},children:a.jsxs(d,{value:Te,onChange:e=>De(e.target.value),displayEmpty:!0,children:[a.jsx(c,{value:null==he?void 0:he.id,children:ye("templates.filters.onlyMy")}),Re.map((e=>a.jsx(c,{value:e.id,children:`${e.first_name||""} ${e.last_name||""}`.trim()||e.id},e.id)))]})}),a.jsxs(o,{sx:{display:"flex",flexDirection:{xs:"column",lg:"row"},gap:2,alignItems:{xs:"stretch",lg:"flex-start"}},children:[a.jsx(u,{label:ye("templates.filters.search"),placeholder:Le.currentFolder?ye("templates.filters.searchInside"):ye("templates.filters.searchGlobal"),variant:"outlined",fullWidth:!0,size:"small",sx:{order:{xs:2,lg:1},flex:{lg:1}},value:ze,onChange:e=>We(e.target.value),InputProps:{startAdornment:a.jsx(N,{sx:{mr:1,color:"text.secondary"}}),endAdornment:ze?a.jsx(m,{"aria-label":"clear search",onClick:()=>{We(""),Ie("")},edge:"end",size:"small",children:a.jsx(H,{fontSize:"small"})}):null}}),a.jsx(i,{size:"small",sx:{order:{xs:1,lg:2},minWidth:{xs:"auto",md:180},width:{xs:"100%",md:"auto"},"& .MuiOutlinedInput-root":{borderRadius:2}},children:a.jsxs(d,{value:Ee,onChange:e=>Oe(e.target.value),displayEmpty:!0,startAdornment:a.jsx(q,{sx:{mr:1,color:"text.secondary"}}),children:[a.jsx(c,{value:"created_at_desc",children:ye("templates.filters.order.newestFirst")}),a.jsx(c,{value:"created_at_asc",children:ye("templates.filters.order.oldestFirst")}),a.jsx(c,{value:"name_asc",children:ye("templates.filters.order.nameAZ")}),a.jsx(c,{value:"name_desc",children:ye("templates.filters.order.nameZA")})]})})]}),(ze||_e||Te)&&a.jsx(o,{sx:{display:"flex",justifyContent:"center"},children:a.jsx(x,{variant:"outlined",startIcon:a.jsx(K,{}),onClick:jr,children:ye("common.actions.clear")})})]})}),Ve&&a.jsx(p,{severity:"error",sx:{mb:2},action:a.jsx(x,{color:"inherit",size:"small",onClick:wr,disabled:He,children:ye(He?"common.status.loading":"common.actions.retry")}),children:Ve}),a.jsx(o,{sx:{mb:1,height:"2px"},children:wt&&a.jsx(h,{sx:{height:"2px"}})}),((null==(_=Le.currentFolder)?void 0:_.subfolders)||yt.length>0)&&a.jsxs(o,{sx:{mb:3},children:[a.jsxs(f,{sx:{ml:1,mb:2,transform:tr&&Le.breadcrumbs.length>0?"scale(2)":"scale(1)",transformOrigin:"left center",transition:"transform 0.3s ease-in-out"},children:[a.jsx(g,{onDrop:e=>{e.preventDefault();const t=e.dataTransfer.getData("text/plain"),r=e.dataTransfer.getData("folder-id");if(t){const e=$e.find((e=>e.id===t));e&&Tr(e,null)}else r&&_r(r,null)},onDragOver:e=>{e.preventDefault()},component:"button",variant:"body1",onClick:Sr,sx:{textDecoration:"none"},children:ye("templates.title")}),Le.breadcrumbs.map(((e,t)=>t<Le.breadcrumbs.length-1?a.jsx(g,{onDrop:t=>{t.preventDefault();const r=t.dataTransfer.getData("text/plain"),s=t.dataTransfer.getData("folder-id");if(r){const t=$e.find((e=>e.id===r));t&&Tr(t,e.id)}else s&&_r(s,e.id)},onDragOver:e=>e.preventDefault(),component:"button",variant:"body1",onClick:()=>(async(e,t)=>{kt(!0);try{const r=await A.folders.getById(e.id);Be({currentFolder:r,breadcrumbs:Le.breadcrumbs.slice(0,t+1)}),ie(e.id)}catch(r){je(P(r))}finally{kt(!1)}})(e,t),sx:{textDecoration:"none"},children:e.title},e.id):a.jsx(j,{variant:"body1",children:e.title},e.id)))]}),Le.currentFolder&&a.jsxs(n,{sx:{p:2,my:3,display:"flex",gap:3,alignItems:"flex-start",position:"relative"},children:[a.jsx(m,{size:"small",onClick:async()=>{if(Le.breadcrumbs.length>1){const t=Le.breadcrumbs[Le.breadcrumbs.length-2];try{const e=await A.folders.getById(t.id);Be((t=>({currentFolder:e,breadcrumbs:t.breadcrumbs.slice(0,-1)}))),ie(t.id)}catch(e){je(P(e))}}else Sr()},sx:{position:"absolute",top:4,left:4,bgcolor:"background.paper",opacity:.5,zIndex:1e3,"&:hover":{bgcolor:"background.default",opacity:1}},children:a.jsx(J,{fontSize:"small"})}),a.jsx(v,{variant:"square",src:Le.currentFolder.cover||void 0,sx:{m:-2,mr:1,width:120,height:180,borderRadius:3,bgcolor:Le.currentFolder.cover?"primary.main":de(Le.currentFolder.title),fontSize:"300%"},children:!Le.currentFolder.cover&&Le.currentFolder.title.split(" ").map((e=>e[0])).join("").toUpperCase()}),a.jsxs(o,{sx:{flex:1},children:[a.jsxs(o,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",gap:1,mb:1},children:[a.jsx(j,{variant:"h5",sx:{flex:1,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.2,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:Le.currentFolder.title}),a.jsx(m,{"aria-label":"edit",onClick:()=>{Le.currentFolder&&(Et(Le.currentFolder),Tt({title:Le.currentFolder.title,description:Le.currentFolder.description||"",type:Le.currentFolder.type,cover:Le.currentFolder.cover||void 0}),Lt(!0),Ct(!0))},children:a.jsx(G,{})})]}),Le.currentFolder.description&&a.jsxs(o,{onClick:()=>ir(!nr),children:[a.jsx(j,{variant:"body1",color:"text.secondary",sx:{display:"-webkit-box",WebkitLineClamp:nr?"unset":3,WebkitBoxOrient:"vertical",overflow:"hidden",textOverflow:"ellipsis",transition:"all 0.2s ease-in-out",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:Le.currentFolder.description}),Le.currentFolder.description.split("\n").length>3&&a.jsx(j,{variant:"caption",color:"primary",sx:{cursor:"pointer",display:"block",mt:1,"&:hover":{opacity:.8}},children:nr?"Show less":"Show more"})]})]})]}),a.jsx(o,{sx:{display:"flex",flexWrap:"wrap",gap:5,my:3,mx:1},children:Le.currentFolder?((null==(I=Le.currentFolder)?void 0:I.subfolders)||[]).slice().sort(((e,t)=>"name_asc"===Ee||"title_asc"===Ee?e.title.localeCompare(t.title):"name_desc"===Ee||"title_desc"===Ee?t.title.localeCompare(e.title):"created_at_asc"===Ee?new Date(e.created_at).getTime()-new Date(t.created_at).getTime():new Date(t.created_at).getTime()-new Date(e.created_at).getTime())).map((e=>a.jsx(pe,{folder:e,onClick:kr,onContextMenu:Cr,onDrop:Tr,onFolderDrop:_r,allWorks:$e},e.id))):yt.slice().sort(((e,t)=>"name_asc"===Ee||"title_asc"===Ee?e.title.localeCompare(t.title):"name_desc"===Ee||"title_desc"===Ee?t.title.localeCompare(e.title):"created_at_asc"===Ee?new Date(e.created_at).getTime()-new Date(t.created_at).getTime():new Date(t.created_at).getTime()-new Date(e.created_at).getTime())).map((e=>a.jsx(pe,{folder:e,onClick:kr,onContextMenu:Cr,onDrop:Tr,onFolderDrop:_r,allWorks:Nt},e.id)))}),Le.breadcrumbs.length>0&&a.jsxs(a.Fragment,{children:[a.jsx(o,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"repeat(2, 1fr)",lg:"repeat(3, 1fr)"},gap:2,position:"relative"},children:$e.map((e=>a.jsx(xe,{work:e,onClick:vr,onDelete:Dr},e.id)))}),0===$e.length&&a.jsxs(o,{sx:{textAlign:"center",py:4},children:[a.jsx(j,{variant:"h6",color:"text.secondary",sx:{mb:1},children:ye("templates.empty.noTemplatesInFolder")}),a.jsx(x,{variant:"outlined",onClick:()=>fe(`/works/assign?template=true${Le.currentFolder?`&folder=${Le.currentFolder.id}`:""}&return_to=/templates`),children:ye("templates.actions.create")})]})]})]}),null===Le.currentFolder&&a.jsx(o,{children:Kt?a.jsx(V,{message:ye("common.loading")}):a.jsxs(a.Fragment,{children:[0!==Nt.length||Ve?a.jsx(o,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"repeat(2, 1fr)",lg:"repeat(3, 1fr)"},gap:2,position:"relative"},children:Nt.map((e=>a.jsx(xe,{work:e,onClick:vr,onDelete:Dr},e.id)))}):a.jsxs(o,{sx:{textAlign:"center",py:4},children:[a.jsx(j,{variant:"h6",color:"text.secondary",sx:{mb:1},children:Te||_e?ye("templates.empty.noMatch"):yt.length>0?ye("templates.empty.noFolder"):ye("templates.empty.noTemplates")}),a.jsx(j,{variant:"body2",color:"text.secondary",sx:{mb:3},children:Te||_e?ye("templates.hint.adjust"):yt.length>0?"":ye("templates.hint.createFirst")}),fr&&0===Nt.length&&!Te&&!_e&&a.jsx(x,{variant:"outlined",onClick:()=>fe(`/works/assign?template=true${Le.currentFolder?`&folder=${Le.currentFolder.id}`:""}&return_to=/templates`),sx:{borderRadius:2,textTransform:"none",fontWeight:500},children:ye("templates.actions.create")}),0===Nt.length&&(Te||_e)&&a.jsx(x,{variant:"outlined",startIcon:a.jsx(K,{}),onClick:jr,sx:{borderRadius:2,textTransform:"none"},children:ye("common.actions.clear")})]}),a.jsx(o,{ref:er,sx:{display:"flex",justifyContent:"center",p:2,visibility:Zt?"visible":"hidden"},children:Xt&&a.jsx(y,{size:24})})]})}),a.jsxs(b,{open:at,onClose:yr,maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:2}},children:[a.jsx(w,{children:a.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[a.jsx(j,{variant:"h6",children:null==Ye?void 0:Ye.name}),Ye&&a.jsx(k,{label:"Template",color:"primary",size:"small"})]})}),a.jsxs(S,{children:[Qe&&a.jsx(p,{severity:"error",sx:{mb:2},children:Qe}),Ye&&a.jsx(a.Fragment,{children:a.jsx(Z,{work:Ye,isStudent:!1,error:Qe,onTaskClick:e=>{Ye&&fe(`/works/${Ye.id}?task_number=${e}&return_to=/templates`)},hideButtons:!0})})]}),a.jsxs(C,{sx:{display:"flex",justifyContent:"space-between",px:2,pb:2},children:[a.jsx(o,{sx:{display:"flex",gap:1},children:fr&&a.jsxs(a.Fragment,{children:[a.jsx(x,{color:"primary",onClick:e=>{e.stopPropagation(),it(e.currentTarget)},"aria-label":"actions","aria-controls":dt?"actions-menu":void 0,"aria-haspopup":"true","aria-expanded":dt?"true":void 0,startIcon:a.jsx(Q,{}),children:ye("common.actions.actions")}),a.jsxs(F,{id:"actions-menu",anchorEl:nt,open:dt,onClose:br,MenuListProps:{"aria-labelledby":"actions-button"},children:[a.jsxs(c,{onClick:()=>{var e;e=Ye.id,fe(`/works/assign/?work_id=${e}&edit=true&return_to=/templates`)},children:[a.jsx(G,{fontSize:"small",sx:{mr:1}}),ye("works.actions.edit")]}),a.jsxs(c,{onClick:()=>{Ye&&fe(`/works/assign/?work_id=${Ye.id}&copy=true&return_to=/templates`)},children:[a.jsx(X,{fontSize:"small",sx:{mr:1}}),ye("common.actions.copy")]}),a.jsxs(c,{onClick:()=>{br(),yr(),Ye&&(mr({type:"template",id:Ye.id}),cr(!0)),br()},children:[a.jsx(Y,{fontSize:"small",sx:{mr:1}}),ye("common.actions.moveTo")]}),a.jsxs(c,{onClick:()=>{br(),lt(!0)},disabled:tt,sx:{color:"error.main"},children:[tt?a.jsx(y,{size:20,sx:{mr:1}}):a.jsx(ee,{fontSize:"small",sx:{mr:1}}),ye("common.actions.delete")]})]})]})}),a.jsx(o,{children:a.jsx(x,{onClick:yr,children:ye("common.actions.close")})})]})]}),a.jsxs(b,{open:st,onClose:()=>lt(!1),maxWidth:"xs",fullWidth:!0,children:[a.jsx(w,{children:ye("common.dialog.delete.title",{item:ye("templates.titleSingle")})}),a.jsx(S,{children:a.jsx(j,{children:ye("common.dialog.delete.message",{name:null==Ye?void 0:Ye.name})})}),a.jsxs(C,{children:[a.jsx(x,{onClick:()=>lt(!1),disabled:tt,children:ye("common.actions.cancel")}),a.jsx(x,{onClick:async()=>{if(Ye){rt(!0),Xe(null);try{await A.works.delete(Ye.id),Ae((e=>e.filter((e=>e.id!==Ye.id)))),qt((e=>e.filter((e=>e.id!==Ye.id)))),yr(),ve(ye("templates.status.templateDeleted"),"success")}catch(e){const t=e instanceof Error?e.message:"Failed to delete work. Please try again.";je(t)}finally{rt(!1),lt(!1)}}},color:"error",variant:"contained",disabled:tt,startIcon:tt?a.jsx(y,{size:20}):a.jsx(ee,{}),children:ye(tt?"common.status.deleting":"common.actions.delete")})]})]}),a.jsxs(b,{open:St,onClose:()=>!Dt&&Ct(!1),maxWidth:"sm",fullWidth:!0,children:[a.jsx(w,{children:ye(Ot?"common.actions.edit":"common.actions.create")}),a.jsx(S,{children:a.jsxs(T,{spacing:2,sx:{mt:1},children:[a.jsx(o,{sx:{display:"flex",justifyContent:"center",mb:2},children:Ut?a.jsx(o,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:180,width:120},children:a.jsx(y,{})}):a.jsx(v,{variant:"square",src:Ft.cover||void 0,sx:{width:120,height:180,borderRadius:3,bgcolor:"primary.main",cursor:"pointer","&:hover":{opacity:.8}},onClick:()=>{or(!0),Ht(!1)},children:!Ft.cover&&a.jsx(te,{})})}),a.jsx(u,{label:ye("templates.dialog.createFolder.name"),value:Ft.title,onChange:e=>Tt((t=>({...t,title:e.target.value}))),fullWidth:!0,required:!0,disabled:Dt,error:Ft.title.length>100,helperText:Ft.title.length>100?ye("templates.validation.titleLength"):""}),a.jsx(u,{label:ye("templates.dialog.createFolder.description"),value:Ft.description,onChange:e=>Tt((t=>({...t,description:e.target.value}))),fullWidth:!0,multiline:!0,rows:2,disabled:Dt,error:(null==(z=Ft.description)?void 0:z.length)>1e3,helperText:(null==(W=Ft.description)?void 0:W.length)>1e3?ye("templates.validation.descriptionLength"):""})]})}),a.jsxs(C,{children:[a.jsx(x,{onClick:()=>{Ct(!1),Lt(!1),Tt({title:"",description:"",type:B.BOOK,cover:void 0})},disabled:Dt,children:ye("common.actions.cancel")}),a.jsx(x,{onClick:async()=>{var e;if(!Ft.title.trim())return;const t=oe(ne,{...Ft,type:B.BOOK});if(t.isValid){_t(!0);try{if(Ot&&Wt){const e=await A.folders.update(Wt.id,{...Ft});Le.currentFolder?Le.currentFolder.id===Wt.id?Be((t=>({...t,currentFolder:{...t.currentFolder,...e,subfolders:t.currentFolder.subfolders,works:t.currentFolder.works},breadcrumbs:t.breadcrumbs.map((t=>t.id===Wt.id?{...t,...e}:t))}))):Be((t=>({...t,currentFolder:{...t.currentFolder,subfolders:t.currentFolder.subfolders.map((t=>t.id===Wt.id?e:t))}}))):bt((t=>t.map((t=>t.id===Wt.id?e:t)))),ve(ye("folders.status.updated"),"success")}else{const t=await A.folders.create({...Ft,parent_id:(null==(e=Le.currentFolder)?void 0:e.id)||null});Le.currentFolder?Be((e=>({...e,currentFolder:{...e.currentFolder,subfolders:[t,...e.currentFolder.subfolders]}}))):bt((e=>[t,...e])),ve(ye("templates.status.folderCreated"),"success")}Tt({title:"",description:"",type:B.BOOK,cover:void 0}),Ct(!1),Lt(!1)}catch(r){je(P(r))}finally{_t(!1)}}else{const e=Object.values(t.errors)[0];je(e)}},variant:"contained",disabled:Dt||!Ft.title.trim()||Ft.title.length>100||((null==(ae=Ft.description)?void 0:ae.length)||0)>1e3,startIcon:Dt?a.jsx(y,{size:20}):null,children:ye(Dt?"common.loading":Ot?"common.actions.save":"common.actions.create")})]})]}),a.jsxs(b,{open:ar,onClose:()=>or(!1),maxWidth:"sm",fullWidth:!0,children:[a.jsx(w,{children:ye("templates.dialog.createFolder.cover.title")}),a.jsx(S,{children:Ut?a.jsx(o,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:a.jsx(y,{})}):a.jsxs(a.Fragment,{children:[a.jsx(re,{onLoading:e=>{Tt((e=>({...e,cover:void 0}))),Ht(e),or(!1)},onImageUpload:e=>{Tt((t=>({...t,cover:e}))),or(!1),Ht(!1)},onClose:()=>{or(!1),Ht(!1)}}),Ft.cover&&a.jsx(o,{sx:{display:"flex",justifyContent:"center",mt:2},children:a.jsx(x,{variant:"outlined",color:"error",startIcon:a.jsx(ee,{}),onClick:()=>{Tt((e=>({...e,cover:void 0}))),or(!1)},children:ye("templates.dialog.createFolder.cover.delete")})})]})})]}),a.jsxs(F,{anchorEl:It,open:Boolean(It),onClose:Fr,children:[a.jsxs(c,{onClick:()=>{Wt&&(Tt({title:Wt.title,description:Wt.description||"",type:Wt.type,cover:Wt.cover||void 0}),Lt(!0),Ct(!0)),Fr()},children:[a.jsx(G,{fontSize:"small",sx:{mr:1}}),ye("common.actions.edit")]}),a.jsxs(c,{onClick:()=>{Wt&&(mr({type:"folder",id:Wt.id}),cr(!0)),Fr()},children:[a.jsx(Y,{fontSize:"small",sx:{mr:1}}),ye("common.actions.moveTo")]}),a.jsxs(c,{onClick:()=>{Fr(),$t(Wt),Rt(!0)},sx:{color:"error.main"},children:[a.jsx(ee,{fontSize:"small",sx:{mr:1}}),ye("common.actions.delete")]})]}),a.jsxs(b,{open:Mt,onClose:()=>!At&&Rt(!1),maxWidth:"xs",fullWidth:!0,children:[a.jsx(w,{children:ye("common.dialog.delete.title",{item:ye("templates.dialog.move.folder")})}),a.jsxs(S,{children:[a.jsx(j,{children:ye("templates.dialog.delete.folder.message")}),a.jsx(j,{children:ye("templates.dialog.delete.folder.moveTemplates")}),a.jsx(j,{children:ye("templates.dialog.delete.folder.deleteSubfolders")})]}),a.jsxs(C,{children:[a.jsx(x,{onClick:()=>Rt(!1),disabled:At,children:ye("common.actions.cancel")}),a.jsx(x,{onClick:async()=>{if(Bt){Pt(!0);try{await A.folders.delete(Bt.id),Le.currentFolder?Be((e=>({...e,currentFolder:{...e.currentFolder,subfolders:e.currentFolder.subfolders.filter((e=>e.id!==Bt.id))}}))):(bt((e=>e.filter((e=>e.id!==Bt.id)))),await Sr()),Rt(!1),$t(null),ve(ye("templates.status.folderDeleted"),"success")}catch(e){je(P(e))}finally{Pt(!1)}}},color:"error",variant:"contained",disabled:At,startIcon:At?a.jsx(y,{size:20}):a.jsx(ee,{}),children:ye(At?"common.status.deleting":"common.actions.delete")})]})]}),a.jsx(D,{anchor:"right",open:dr,onClose:()=>{cr(!1),mr(null)},PaperProps:{sx:{width:{xs:"100%",sm:400},p:2}},children:a.jsxs(o,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[a.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[a.jsx(j,{variant:"h6",children:ye("templates.dialog.move.title",{type:"folder"===(null==ur?void 0:ur.type)?ye("templates.dialog.move.folder"):ye("templates.dialog.move.template")})}),a.jsx(m,{onClick:()=>{cr(!1),mr(null)},children:a.jsx(se,{})})]}),a.jsx(o,{sx:{flex:1,overflow:"auto"},children:a.jsx(le,{onFolderSelect:async e=>{if(ur){pr(!0);try{"template"===ur.type?(e?await A.folders.addWork(e.id,ur.id):await A.folders.removeWork(Le.currentFolder.id,ur.id),Le.currentFolder?Ae((e=>e.filter((e=>e.id!==ur.id)))):qt((e=>e.filter((e=>e.id!==ur.id)))),ve(ye("templates.status.templateMoved"),"success")):(await A.folders.update(ur.id,{parent_id:(null==e?void 0:e.id)||null}),Le.currentFolder?Be((e=>({...e,currentFolder:{...e.currentFolder,subfolders:e.currentFolder.subfolders.filter((e=>e.id!==ur.id))}}))):bt((e=>e.filter((e=>e.id!==ur.id)))),ve(ye("templates.status.folderMoved"),"success")),cr(!1),mr(null)}catch(t){je(P(t))}finally{pr(!1)}}},isShowRoot:!0,currentFolder:null==(ce=Le.currentFolder)?void 0:ce.id,movingFolder:"folder"===(null==ur?void 0:ur.type)?ur.id:void 0})})]})})]})};export{he as default};
