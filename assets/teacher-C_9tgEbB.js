const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./main-C0pfxit8.js","./vendor-CLrGhTW1.js","./main-Uetmd9Uh.css"])))=>i.map(i=>d[i]);
import{u as e,a as t,b as s,U as a,c as n,S as i,C as r,F as o,D as l,P as c,A as d,T as m,d as x,e as u,f as h,L as p,E as g,M as f,g as j,h as y,_ as k,i as b,j as v,k as w,I as C,l as S,m as I,R as _,n as F,o as T,p as z,q as P,B as A,W as E,r as $,s as D,t as R,v as W,O,w as M,x as L,y as B,z as N,G as H,H as V,J as U,K as J,N as q,Q,V as K,X as G,Y,Z as X,$ as Z,a0 as ee,a1 as te,a2 as se,a3 as ae,a4 as ne,a5 as ie,a6 as re,a7 as oe,a8 as le,a9 as ce,aa as de,ab as me,ac as xe,ad as ue,ae as he,af as pe,ag as ge,ah as fe,ai as je,aj as ye,ak as ke,al as be,am as ve,an as we,ao as Ce,ap as Se,aq as Ie,ar as _e,as as Fe,at as Te,au as ze,av as Pe,aw as Ae,ax as Ee,ay as $e,az as De,aA as Re,aB as We,aC as Oe,aD as Me,aE as Le,aF as Be,aG as Ne,aH as He,aI as Ve,aJ as Ue,aK as Je,aL as qe,aM as Qe,aN as Ke,aO as Ge,aP as Ye}from"./main-C0pfxit8.js";import{a5 as Xe,ad as Ze,r as et,j as tt,d as st,e as at,L as nt,H as it,B as rt,u as ot,n as lt,x as ct,w as dt,$ as mt,v as xt,f as ut,I as ht,h as pt,ag as gt,ah as ft,C as jt,b as yt,a0 as kt,a1 as bt,a3 as vt,M as wt,D as Ct,i as St,l as It,m as _t,X as Ft,Y as Tt,N as zt,ac as Pt,G as At,J as Et,ai as $t,ab as Dt,aj as Rt,K as Wt,ak as Ot,al as Mt,am as Lt,A as Bt,F as Nt,y as Ht,Q as Vt,V as Ut,an as Jt,W as qt}from"./vendor-CLrGhTW1.js";const Qt="tasksPageFilters",Kt=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const b=Xe(),[v]=Ze(),{user:w}=e(),{showErrorToast:C}=t(),[S,I]=et.useState([]),[_,F]=et.useState([]),[T,z]=et.useState(!0),[P,A]=et.useState(!1),[E,$]=et.useState(null),[D,R]=et.useState(0),[W,O]=et.useState([]),[M,L]=et.useState(""),[B,N]=et.useState(""),[H,V]=et.useState(null),[U,J]=et.useState(!1),[q,Q]=et.useState(null),[K,G]=et.useState(null),[Y,X]=et.useState(!1),[Z,ee]=et.useState(new Set),[te,se]=et.useState(!1),[ae,ne]=et.useState(!1),[ie,re]=et.useState(!1),oe=et.useRef(!0),le=Boolean(q),[ce,de]=et.useState(0),[me,xe]=et.useState(!0),ue=15,he=et.useRef(null),{t:pe}=s(),ge=(null==w?void 0:w.role)===a.ADMIN,fe=(null==w?void 0:w.role)===a.TEACHER||ge,je=et.useCallback((()=>{try{const e=localStorage.getItem(Qt);if(e){return JSON.parse(e)}}catch(e){}return{searchTerm:"",filterTagIds:[]}}),[]),ye=et.useCallback((()=>{const e={searchTerm:M,filterTagIds:W.map((e=>e.id))};localStorage.setItem(Qt,JSON.stringify(e))}),[M,W]);et.useEffect((()=>{const e=setTimeout((()=>{L(B)}),500);return()=>clearTimeout(e)}),[B]),et.useEffect((()=>{oe.current||ye()}),[M,W,ye]),et.useEffect((()=>{(async()=>{if(oe.current){z(!0),$(null);try{const e=je(),t=v.get("tag_id"),s=await n.tags.getAll();F(s);let a=[];if(t){const e=s.find((e=>e.id===t));e&&(O([e]),a=[t])}else if(e.filterTagIds.length>0){const t=e.filterTagIds.map((e=>s.find((t=>t.id===e)))).filter((e=>void 0!==e));t.length>0&&(O(t),a=e.filterTagIds)}e.searchTerm&&(L(e.searchTerm),N(e.searchTerm));const i=e.searchTerm||"",r=await n.tasks.getAll(0,ue,i,a.join(","));I(r),de(0),xe(r.length===ue),oe.current=!1,$(null)}catch(e){const t=y(e);$(t),C(t)}finally{z(!1)}}})()}),[D,v,je]),et.useEffect((()=>{if(oe.current)return;(async()=>{z(!0),$(null);try{const e=await n.tasks.getAll(0,ue,M,W.map((e=>e.id)).join(","));I(e),de(0),xe(e.length===ue)}catch(e){$("Failed to search tasks. Please try again.")}finally{z(!1)}})()}),[M,W]),et.useEffect((()=>{const e=new IntersectionObserver((e=>{const[t]=e;t.isIntersecting&&me&&!T&&!P&&ke()}),{threshold:.5}),t=he.current;return t&&e.observe(t),()=>{t&&e.unobserve(t)}}),[me,T,P]);const ke=async()=>{if(!me||P)return;A(!0);const e=ce+1;try{const t=await n.tasks.getAll(e*ue,ue,M,W.map((e=>e.id)).join(","));if(t.length>0){const s=t.filter((e=>!S.some((t=>t.id===e.id))));I((e=>[...e,...s])),de(e),xe(t.length===ue)}else xe(!1)}catch(t){C("Failed to load more tasks. Please try again.")}finally{A(!1)}},be=et.useCallback((()=>{R((e=>e+1))}),[]),ve=()=>{localStorage.removeItem(Qt),L(""),N(""),O([])},we=()=>{J(!1)},Ce=(e,t)=>{e.stopPropagation(),Q(e.currentTarget),G(t)},Se=()=>{Q(null)},Ie=()=>{X(!1),G(null)},_e=e=>{ee((t=>{const s=new Set(t);return s.has(e.id)?s.delete(e.id):s.add(e.id),s})),se(!0),J(!1)},Fe=()=>{ne(!1)},Te=[tt.jsxs(st,{onClick:e=>{e.stopPropagation(),_e(K),Se()},children:[tt.jsx(at,{children:tt.jsx(i,{fontSize:"small"})}),tt.jsx(nt,{children:pe("common.actions.select")})]},"select"),tt.jsxs(st,{onClick:()=>{K&&(b(`/tasks/new?copy_task_id=${K.id}`),Se())},children:[tt.jsx(at,{children:tt.jsx(r,{fontSize:"small"})}),tt.jsx(nt,{children:pe("common.actions.copy")})]},"copy"),tt.jsxs(st,{onClick:async()=>{if(K){re(!0);try{const{exportToDocx:e}=await k((async()=>{const{exportToDocx:e}=await import("./main-C0pfxit8.js").then((e=>e.dQ));return{exportToDocx:e}}),__vite__mapDeps([0,1,2]),import.meta.url),t=await e(K),s=URL.createObjectURL(t),a=document.createElement("a");a.href=s,a.download=`${K.title}.docx`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)}catch(e){C("Failed to export task to DOCX. Please try again.")}finally{re(!1),Se()}}},disabled:ie,children:[tt.jsx(at,{children:ie?tt.jsx(it,{size:20}):tt.jsx(o,{fontSize:"small"})}),tt.jsx(nt,{children:pe("common.actions.export")})]},"export"),tt.jsxs(st,{onClick:()=>{Se(),X(!0)},sx:{color:"error.main"},children:[tt.jsx(at,{children:tt.jsx(l,{fontSize:"small",color:"error"})}),tt.jsx(nt,{children:pe("common.actions.delete")})]},"delete")];return tt.jsxs(rt,{children:[tt.jsx(c,{title:pe("tasks.title"),actionButton:fe?[{label:pe("tasks.actions.createTask"),icon:tt.jsx(d,{}),onClick:()=>b("/tasks/new")}]:void 0}),E&&tt.jsx(ot,{severity:"error",sx:{mb:2},action:tt.jsx(lt,{color:"inherit",size:"small",onClick:be,disabled:T,children:T?"Loading...":"Retry"}),children:E}),tt.jsx(ct,{sx:{p:2,mb:2},children:tt.jsxs(dt,{spacing:2,children:[tt.jsxs(rt,{sx:{display:"flex",flexDirection:"column",gap:2},children:[tt.jsx(mt,{multiple:!0,size:"small",options:_,getOptionLabel:e=>e.name,value:W,onChange:(e,t)=>O(t),renderInput:e=>tt.jsx(ut,{...e,label:pe("tasks.actions.filterByTags"),placeholder:pe("filters.selectTags"),variant:"outlined",InputProps:{...e.InputProps,startAdornment:tt.jsxs(tt.Fragment,{children:[tt.jsx(m,{sx:{ml:1,color:"text.secondary"},fontSize:"small"}),e.InputProps.startAdornment]})}}),renderTags:(e,t)=>e.map(((e,s)=>et.createElement(xt,{color:"primary",label:e.name,...t({index:s}),key:e.id})))}),tt.jsx(rt,{sx:{display:"flex",gap:2},children:tt.jsx(ut,{label:pe("tasks.actions.searchByTitle"),placeholder:pe("filters.enterTitle"),variant:"outlined",fullWidth:!0,size:"small",value:B,onChange:e=>{const t=e.target.value;N(t)},InputProps:{startAdornment:tt.jsx(u,{sx:{mr:1,color:"text.secondary"},fontSize:"small"}),endAdornment:B?tt.jsx(ht,{position:"end",children:tt.jsx(pt,{"aria-label":"clear search",onClick:()=>{N(""),L("")},edge:"end",size:"small",children:tt.jsx(x,{fontSize:"small"})})}):null}})})]}),(W.length>0||B)&&tt.jsx(rt,{sx:{display:"flex",justifyContent:"center"},children:tt.jsx(lt,{variant:"outlined",startIcon:tt.jsx(h,{}),onClick:ve,children:pe("common.actions.clear")})})]})}),te&&tt.jsx(gt,{position:"static",color:"default",elevation:1,sx:{mb:2},children:tt.jsxs(ft,{variant:"dense",children:[tt.jsxs(rt,{sx:{display:"flex",alignItems:"center",gap:1,flex:1},children:[tt.jsx(jt,{edge:"start",checked:Z.size===S.length,indeterminate:Z.size>0&&Z.size<S.length,onChange:()=>{Z.size===S.length?ee(new Set):ee(new Set(S.map((e=>e.id))))}}),tt.jsx(yt,{variant:"body2",children:pe("tasks.selection.selected",{count:Z.size})})]}),tt.jsxs(rt,{sx:{display:"flex"},children:[fe&&tt.jsx(lt,{color:"error",startIcon:tt.jsx(l,{}),onClick:()=>{ne(!0)},disabled:0===Z.size,children:pe("tasks.selection.deleteCount",{count:Z.size||0})}),tt.jsx(lt,{onClick:()=>{ee(new Set),se(!1)},children:pe("common.actions.cancel")})]})]})}),T?tt.jsx(p,{message:pe("common.loading")}):tt.jsxs(tt.Fragment,{children:[E||0!==S.length?tt.jsxs(tt.Fragment,{children:[tt.jsx(rt,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"repeat(2, 1fr)",lg:"repeat(3, 1fr)"},gap:2},children:S.map((e=>tt.jsxs(kt,{sx:{height:"100%",cursor:"pointer",position:"relative","&:hover":{boxShadow:6}},onClick:()=>!te&&(e=>{V(e),J(!0)})(e),children:[te&&tt.jsx(jt,{edge:"start",checked:Z.has(e.id),onChange:t=>{t.stopPropagation(),_e(e)},sx:{position:"absolute",top:8,right:8,zIndex:1}}),tt.jsx(bt,{sx:{p:2,"&:last-child":{paddingBottom:2}},children:tt.jsxs(rt,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",gap:1},children:[tt.jsx(yt,{sx:{flex:1,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.2},children:e.title}),tt.jsx(rt,{sx:{display:"flex",flexDirection:"row",gap:1,flexShrink:0},children:!te&&tt.jsxs(tt.Fragment,{children:[tt.jsx(pt,{size:"small",onClick:t=>{t.stopPropagation(),b(`/tasks/${e.id}/edit`)},children:tt.jsx(g,{})}),tt.jsx(pt,{size:"small",onClick:t=>Ce(t,e),children:tt.jsx(f,{})})]})})]})}),e.tags.length>0&&tt.jsx(vt,{sx:{pt:0,px:2,pb:2},children:tt.jsx(rt,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:e.tags.map((e=>tt.jsx(xt,{label:e.name,size:"small",variant:"outlined",onClick:t=>{t.stopPropagation(),W.some((t=>t.id===e.id))||O([...W,e])},sx:{cursor:"pointer","&:hover":{backgroundColor:"action.hover"}}},e.id)))})})]},e.id)))}),tt.jsx(rt,{ref:he,sx:{display:"flex",justifyContent:"center",p:2,visibility:me?"visible":"hidden"},children:P&&tt.jsx(it,{size:24})})]}):tt.jsxs(rt,{sx:{textAlign:"center",py:4},children:[tt.jsx(yt,{variant:"h6",color:"text.secondary",sx:{mb:1},children:M.length<1&&W.length<1?pe(fe?"tasks.empty.teacher":"tasks.empty.student"):pe("tasks.empty.noMatch")}),fe&&M.length<1&&W.length<1&&tt.jsx(lt,{variant:"outlined",startIcon:tt.jsx(d,{}),onClick:()=>b("/tasks/new"),sx:{mt:2},children:pe("tasks.actions.createFirst")}),(M.length>0||W.length>0)&&tt.jsx(lt,{variant:"outlined",startIcon:tt.jsx(h,{}),onClick:ve,sx:{borderRadius:2,textTransform:"none"},children:pe("common.actions.clear")})]}),tt.jsx(j,{open:U,onClose:we,task:H,hasQuizzes:!1,onValidateAnswers:()=>{},actionButtons:tt.jsxs(rt,{sx:{display:"flex",gap:1,width:"100%",justifyContent:"space-between"},children:[tt.jsx(rt,{sx:{display:"flex",gap:1},children:H&&tt.jsxs(tt.Fragment,{children:[tt.jsx(lt,{size:"small",onClick:e=>Ce(e,H),startIcon:tt.jsx(f,{}),children:pe("common.actions.actions")}),tt.jsx(lt,{size:"small",onClick:e=>{e.stopPropagation(),b(`/tasks/${H.id}/edit`)},startIcon:tt.jsx(g,{}),children:pe("common.actions.edit")})]})}),tt.jsx(lt,{onClick:we,children:pe("common.actions.close")})]})}),tt.jsx(wt,{anchorEl:q,open:le,onClose:Se,onClick:e=>e.stopPropagation(),children:Te}),tt.jsxs(Ct,{open:Y,onClose:Ie,maxWidth:"xs",fullWidth:!0,children:[tt.jsx(St,{children:pe("common.dialog.delete.title",{item:"Task"})}),tt.jsx(It,{children:tt.jsx(yt,{children:pe("common.dialog.delete.message",{name:null==K?void 0:K.title})})}),tt.jsxs(_t,{children:[tt.jsx(lt,{onClick:Ie,children:pe("common.actions.cancel")}),tt.jsx(lt,{onClick:async()=>{if(K)try{await n.tasks.delete(K.id),I(S.filter((e=>e.id!==K.id)))}catch(e){const t=e instanceof Error?e.message:"Failed to delete task. Please try again.";C(t)}finally{X(!1),G(null)}},color:"error",variant:"contained",startIcon:tt.jsx(l,{}),children:pe("common.actions.delete")})]})]}),tt.jsxs(Ct,{open:ae,onClose:Fe,maxWidth:"xs",fullWidth:!0,children:[tt.jsx(St,{children:pe("common.dialog.delete.title",{item:"Tasks"})}),tt.jsx(It,{children:tt.jsx(yt,{children:pe("common.dialog.delete.messageBulk",{count:Z.size,item:1===Z.size?"task":"tasks"})})}),tt.jsxs(_t,{children:[tt.jsx(lt,{onClick:Fe,children:pe("common.actions.cancel")}),tt.jsxs(lt,{onClick:async()=>{try{await n.tasks.batchDelete(Array.from(Z));I(S.filter((e=>!Z.has(e.id)))),ee(new Set),se(!1)}catch(e){const t=e instanceof Error?e.message:"Failed to delete tasks. Please try again.";C(t)}finally{ne(!1)}},color:"error",variant:"contained",startIcon:tt.jsx(l,{}),children:[pe("common.actions.delete")," ",Z.size," ",1===Z.size?"task":"tasks"]})]})]})]})]})}},Symbol.toStringTag,{value:"Module"})),Gt=({aiChatMessage:e,setAIChatMessage:a,isSendingAIMessage:i,aiChatHistory:r,isProcessingAttachment:o,setIsProcessingAttachment:l,aiChatMode:c,setAIChatMode:d,handleSendAIMessage:m,handleImprove:x,handleRestoreHistoryItem:u,handleRecognizedText:h})=>{const{t:p}=s(),{showErrorToast:g}=t(),[j,y]=et.useState(null),[k,F]=et.useState(null),[T,z]=et.useState(!0);et.useEffect((()=>{const e=localStorage.getItem("aiChatHelpVisible");null!==e&&z(JSON.parse(e))}),[]);const P=()=>{y(null),F(null)};return tt.jsxs(rt,{sx:{display:"flex",flexDirection:"column",overflow:"hidden",borderRadius:2,p:1,...(i||o)&&{position:"relative","&::before":{content:'""',position:"absolute",top:0,left:0,right:0,bottom:0,background:"linear-gradient(45deg, transparent 30%, rgba(25, 118, 210, 0.08) 50%, transparent 70%)",backgroundSize:"400% 400%",borderRadius:"inherit",zIndex:1,pointerEvents:"none",animation:"shimmer 2s ease-in-out infinite"},"&::after":{content:'""',position:"absolute",top:-2,left:-2,right:-2,bottom:-2,background:"linear-gradient(45deg, rgba(25, 118, 210, 0.3), rgba(25, 118, 210, 0.1), rgba(25, 118, 210, 0.3))",backgroundSize:"400% 400%",borderRadius:"inherit",zIndex:-1,animation:"shimmer 3s ease-in-out infinite reverse"},animation:"pulse 2s ease-in-out infinite","& > *":{position:"relative",zIndex:2}},"@keyframes shimmer":{"0%":{backgroundPosition:"100% 0%"},"100%":{backgroundPosition:"-100% 0%"}},"@keyframes pulse":{"0%, 100%":{opacity:1,transform:"scale(1)"},"50%":{opacity:.95,transform:"scale(1.005)"}}},children:[tt.jsxs(rt,{sx:{flex:1,overflow:"auto"},children:[T&&tt.jsxs(ct,{sx:{p:2,backgroundColor:"background.default",position:"relative",borderColor:"divider",borderWidth:1,borderStyle:"solid",mb:2},children:[tt.jsx(pt,{onClick:()=>{const e=!T;z(e),localStorage.setItem("aiChatHelpVisible",JSON.stringify(e))},sx:{position:"absolute",top:8,right:8,zIndex:1},size:"small",children:tt.jsx(b,{})}),tt.jsxs(yt,{variant:"body1",sx:{mb:1,pr:2},children:["✍️  ",p("taskForm.ai.placeholder")]}),tt.jsxs(yt,{variant:"body1",sx:{mb:1},children:["✨  ",p("taskForm.ai.helpImprove")]}),tt.jsxs(yt,{variant:"body1",children:["📷  ",p("taskForm.ai.helpImage")]})]}),r.length>0&&tt.jsxs(rt,{sx:{mb:2},children:[tt.jsxs(yt,{variant:"subtitle2",sx:{mb:1},children:[p("taskForm.ai.history"),":"]}),tt.jsx(Ft,{dense:!0,sx:{bgcolor:"background.paper",borderRadius:1,border:"1px solid",borderColor:"divider"},children:r.slice().reverse().map((e=>tt.jsxs(Tt,{onClick:t=>((e,t)=>{y(e.currentTarget),F(t)})(t,e),sx:{cursor:"pointer","&:hover":{bgcolor:"action.hover"}},secondaryAction:tt.jsx(tt.Fragment,{children:tt.jsx(pt,{size:"small",sx:{ml:1},children:tt.jsx(f,{fontSize:"small"})})}),children:[tt.jsxs(rt,{sx:{display:"flex",alignItems:"center",justifyContent:"center",width:"50px",height:"50px",mr:1,overflow:"hidden"},children:["processing"===e.status&&tt.jsx(it,{size:16}),"done"===e.status&&!e.image&&tt.jsx(v,{fontSize:"small",color:"success"}),"done"===e.status&&e.image&&tt.jsx("img",{src:e.image,style:{width:"100%"}}),"error"===e.status&&tt.jsx(w,{fontSize:"small",color:"error"})]}),tt.jsx(nt,{sx:{textAlign:"left",width:"100%"},primary:e.message||p("taskForm.ai.imageRecognizedText"),secondary:e.timestamp.toLocaleTimeString(p("locale"),{timeStyle:"short"})})]},e.id)))})]}),!1,tt.jsx(ut,{fullWidth:!0,multiline:!0,minRows:3,maxRows:20,variant:"outlined",placeholder:p("taskForm.ai.messageInputPlaceholder"),value:e,onChange:e=>a(e.target.value),disabled:i,onKeyDown:t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),e.trim()&&!i&&m())},onPaste:async e=>{const t=e.clipboardData.items;for(const a of t)if(a.type.startsWith("image/")){e.preventDefault();const t=a.getAsFile();if(t){l(!0);try{const e=await new Promise((e=>{const s=new FileReader;s.onloadend=()=>e(s.result),s.readAsDataURL(t)})),s=await n.files.recognizeText({imageBase64:e,mode:"text"});s&&await h(s,e)}catch(s){g(p("taskForm.ai.errors.imageProcessing"))}finally{l(!1)}}}else if("text/plain"===a.type){const t=await new Promise((e=>a.getAsString(e)));if(t.match(/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)$/i)){e.preventDefault(),l(!0);try{const e=await fetch(t),s=await e.blob(),a=await new Promise((e=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(s)})),i=await n.files.recognizeText({imageBase64:a,mode:"text"});i&&await h(i,a)}catch(s){g(p("taskForm.ai.errors.imageURLProcessing"))}finally{l(!1)}}}},sx:{mb:2},inputProps:{maxLength:1e3}}),tt.jsxs(rt,{sx:{display:"flex",gap:1,mb:2,justifyContent:"space-between"},children:[tt.jsxs(rt,{children:[tt.jsx(lt,{onClick:()=>{var e;return null==(e=document.getElementById("image-input"))?void 0:e.click()},disabled:o,startIcon:tt.jsx(C,{}),children:p("taskForm.ai.recognize")}),tt.jsx(lt,{onClick:x,disabled:i,startIcon:tt.jsx(S,{}),children:p("taskForm.ai.improve")})]}),tt.jsx(pt,{title:p("taskForm.ai.send"),onClick:()=>m(),disabled:i||!e.trim(),sx:{backgroundColor:"primary.main",color:"white","&:hover":{backgroundColor:"primary.dark",color:"white"}},children:tt.jsx(I,{})})]}),tt.jsx("input",{type:"file",accept:"image/*",style:{display:"none"},id:"image-input",onChange:async e=>{var t;const s=null==(t=e.target.files)?void 0:t[0];if(s){l(!0);try{const e=await new Promise((e=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(s)})),t=await n.files.recognizeText({imageBase64:e,mode:"text"});t?await h(t,e):g(p("taskForm.ai.errors.noTextRecognized"))}catch(a){g(p("taskForm.ai.errors.imageProcessing"))}finally{l(!1)}}}})]}),tt.jsx(wt,{anchorEl:j,open:Boolean(j),onClose:P,children:tt.jsxs(st,{onClick:()=>{k&&(u(k),P())},children:[tt.jsx(_,{fontSize:"small",sx:{mr:1}}),p("taskForm.ai.rollback")]})})]})},Yt=({title:e,text:t,url:a,tagIds:n,tags:i,teacherId:r,onFullscreen:o,onValidateAnswers:l,hasQuizzes:c})=>{const{t:d}=s();return tt.jsxs(rt,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[tt.jsxs(rt,{sx:{display:"flex",gap:1,alignItems:"center"},children:[tt.jsx(yt,{variant:"h4",sx:{flex:1},children:e||d("common.actions.preview")}),tt.jsx(pt,{sx:{marginLeft:"auto",display:{xs:"none",sm:"block"}},size:"small",onClick:o,children:tt.jsx(F,{})})]}),tt.jsx(T,{task:{id:"preview",title:e,text:t,url:a||"",tags:i.filter((e=>n.includes(e.id))),teacher_id:r},isSaveAnswer:!1,workId:"preview"}),c&&tt.jsx(rt,{sx:{p:2,borderTop:1,borderColor:"divider",display:"flex",justifyContent:"center",mt:"auto",flex:"flex-end"},children:tt.jsx(lt,{variant:"contained",color:"primary",onClick:l,startIcon:tt.jsx(v,{}),children:d("common.actions.checkAnswers")})})]})},Xt=()=>{const{t:e}=s(),t=z(P),[a,n]=et.useState(null),[i,r]=et.useState(null),o=()=>{n(null)},l=Boolean(a),c=(e,t)=>{const s=!!i&&((null==i?void 0:i.row)>=e&&(null==i?void 0:i.col)>=t);return{minWidth:"40px",height:"40px",backgroundColor:s?"primary.main":"transparent",color:s?"primary.contrastText":"primary.main","&:hover":{backgroundColor:"primary.main"},transition:"all 0.5s ease"}};return tt.jsxs(tt.Fragment,{children:[tt.jsx(A,{title:e("taskForm.table.title"),children:tt.jsx("span",{onClick:e=>{n(e.currentTarget)},children:tt.jsx(E,{})})}),tt.jsx(zt,{open:l,anchorEl:a,onClose:o,anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:tt.jsx(rt,{sx:{p:2},children:tt.jsx(rt,{sx:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:1,width:200},children:Array.from({length:4},((e,t)=>t+1)).map((e=>Array.from({length:4},((e,t)=>t+1)).map((s=>tt.jsxs(lt,{variant:"outlined",size:"small",onClick:()=>(t({rows:e,columns:s}),void o()),onMouseEnter:()=>r({row:e,col:s}),onMouseLeave:()=>r(null),sx:c(e,s),children:[e,"x",s]},`${e}-${s}`)))))})})})]})},Zt=({onChange:e})=>{const{t:t}=s(),[a,n]=et.useState(!0);et.useEffect((()=>{const e=localStorage.getItem("componentsHelpVisible");null!==e&&n(JSON.parse(e))}),[]);const i=[{icon:tt.jsx($,{}),title:t("components.hiddenText.title"),description:t("components.hiddenText.hint"),isInline:!0,mdText:` ${t("components.defaults.question")} 1 :hidden[${t("components.defaults.answer")} 1] , ${t("components.defaults.question")} 2 :hidden[${t("components.defaults.answer")} 2] `},{icon:tt.jsx(D,{}),title:t("components.draggableAnswers.title"),description:t("components.draggableAnswers.hint"),isInline:!1,mdText:` :answers{sticky="true"} \n${t("components.defaults.question")} 1 :hidden[${t("components.defaults.answer")} 1]\n${t("components.defaults.question")} 2 :hidden[${t("components.defaults.answer")} 2] \n`},{icon:tt.jsx(R,{}),title:t("components.multipleChoice.title"),description:t("components.multipleChoice.hint"),isInline:!0,mdText:` ${t("components.defaults.question")} :select[${t("components.defaults.option")} 1]{alt="${t("components.defaults.option")} 1;${t("components.defaults.option")} 2;${t("components.defaults.option")} 3" ordered="false"} `},{icon:tt.jsx(W,{}),title:t("components.checklist.title"),description:t("components.checklist.hint"),isInline:!1,mdText:`${t("components.defaults.question")}\n* [x] ${t("components.defaults.option")} 1\n* [ ] ${t("components.defaults.option")} 2\n* [ ] ${t("components.defaults.option")} 3\n`},{icon:tt.jsx(O,{}),title:t("components.sortingOrdering.title"),description:t("components.sortingOrdering.hint"),isInline:!1,mdText:` :::sort\n- ${t("components.defaults.option")} 1\n- ${t("components.defaults.option")} 2\n- ${t("components.defaults.option")} 3\n:::\n`},{icon:tt.jsx(M,{}),title:t("components.studentsSection.title"),description:t("components.studentsSection.hint"),isInline:!1,mdText:"::essay"},{icon:tt.jsx(C,{}),title:t("components.image.title"),description:t("components.image.hint"),isInline:!1,mdText:"![](https://teachair.app/apple-touch-icon.png)"},{icon:tt.jsx(L,{}),title:t("components.audio.title"),description:t("components.audio.hint"),isInline:!1,mdText:` :audio[${t("components.defaults.audio")}]{src="https://teachair.app/assets/audio/w-${t("locale")}.mp3"} `},{icon:tt.jsx(B,{}),title:t("components.embed.title"),description:t("components.embed.hint"),isInline:!1,mdText:' :iframe[]{src="https://www.youtube.com/watch?v=mvhmCKNQfu8" } '}];return tt.jsx(rt,{children:tt.jsxs(rt,{sx:{display:"flex",flexDirection:"column",width:"100%",gap:2},children:[a&&tt.jsxs(ct,{sx:{px:3,py:2,backgroundColor:"background.default",position:"relative",borderColor:"divider",borderWidth:1,borderStyle:"solid"},children:[tt.jsx(pt,{onClick:()=>{const e=!a;n(e),localStorage.setItem("componentsHelpVisible",JSON.stringify(e))},sx:{position:"absolute",top:8,right:8,zIndex:1},size:"small",children:tt.jsx(b,{})}),tt.jsx(yt,{variant:"h6",sx:{mb:2},children:t("components.help.title")}),tt.jsx("img",{style:{height:"32px",width:"auto",maxWidth:"100%",borderRadius:"10px"},src:"/icon-elements.gif",alt:"Components Help"})]}),i.map(((t,s)=>tt.jsx(kt,{sx:{height:"100%",cursor:"pointer","&:hover":{backgroundColor:"action.hover"}},onClick:()=>e(t.isInline,t.mdText),children:tt.jsxs(bt,{children:[tt.jsxs(rt,{sx:{display:"flex",alignItems:"center",mb:2},children:[tt.jsx(at,{sx:{minWidth:40},children:t.icon}),tt.jsx(nt,{primary:t.title,primaryTypographyProps:{variant:"subtitle1",sx:{fontWeight:500}}})]}),tt.jsx(yt,{variant:"body2",color:"text.secondary",children:t.description})]})})))]})})},es=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{var i;const r=Xe(),{taskId:o}=Pt(),[l]=Ze(),c=l.get("return_to")||"/tasks",x=l.get("copy_task_id"),u=l.get("work_id"),h=l.get("sharingKey"),g=l.get("title"),{user:f}=e(),{showErrorToast:y}=t(),{mode:k}=N(),v=et.useRef(null),[w,C]=et.useState(null),[I,_]=et.useState(!0),[F,T]=et.useState(!1),[z,P]=et.useState([]),[A,E]=et.useState({title:g||"",text:"",url:"",tag_ids:[]}),[$,D]=et.useState(null),[R,W]=et.useState({}),[O,M]=et.useState(!1),[L,B]=et.useState(!1),[Pe,Ae]=et.useState(0),[Ee,$e]=et.useState((()=>localStorage.getItem("taskForm_sidePanelMode")||"components-help")),[De,Re]=et.useState(""),[We,Oe]=et.useState(!1),[Me,Le]=et.useState([]),[Be,Ne]=et.useState(!1),[He,Ve]=et.useState("text");et.useEffect((()=>{Ee?localStorage.setItem("taskForm_sidePanelMode",Ee):localStorage.removeItem("taskForm_sidePanelMode")}),[Ee]),et.useEffect((()=>{const e=["live-preview","ai-chat","components-help"].indexOf(Ee||"live-preview");-1!==e&&e!==Pe&&Ae(e)}),[Ee,Pe]);const[Ue,Je]=et.useState(""),[qe,Qe]=et.useState(null),[Ke,Ge]=et.useState(!1),[Ye,st]=et.useState(""),[at,nt]=et.useState(!1);et.useEffect((()=>{if(Ye){const t=`ai_${Ye}`,s=localStorage.getItem(t);if(s)try{const e=JSON.parse(s).map((e=>({...e,timestamp:new Date(e.timestamp)})));Le(e)}catch(e){}}}),[Ye]),et.useEffect((()=>{if(Ye){const e=`ai_${Ye}`;Me.length>0?localStorage.setItem(e,JSON.stringify(Me)):localStorage.removeItem(e)}}),[Me,Ye]);const[it,ot]=et.useState(!1),[dt,ht]=et.useState(null),[gt,ft]=et.useState(null),jt=(null==f?void 0:f.role)===a.ADMIN,kt=(null==f?void 0:f.role)===a.TEACHER||jt,bt=Boolean(o),[vt,wt]=et.useState(!1),Ft=At(),Tt=Et(Ft.breakpoints.only("xs")),zt=Et(Ft.breakpoints.down("md")),Bt=Et(Ft.breakpoints.up("lg")),{t:Nt}=s(),Ht=et.useRef({title:g||"",text:"",url:"",tag_ids:[]});et.useEffect((()=>{ot(!0)}),[]),et.useEffect((()=>{if(!it)return;const e=o?`task_${o}`:"new_task";st(e);const t=localStorage.getItem(e);t&&(Qe(t),Ge(!0))}),[o,it]);const Vt=e=>{if(Ge(!1),e&&qe)try{const e=JSON.parse(qe);Ht.current={...Ht.current,...e},E({...Ht.current});const s=document.querySelector('input[name="title"]');if(s&&(s.value=e.title||""),v.current&&(v.current.setMarkdown(e.text||""),v.current.focus()),Ye){const e=`ai_${Ye}`,s=localStorage.getItem(e);if(s)try{const e=JSON.parse(s).map((e=>({...e,timestamp:new Date(e.timestamp)})));Le(e)}catch(t){}}}catch(t){}else if(localStorage.removeItem(Ye),Qe(null),Ye){const e=`ai_${Ye}`;localStorage.removeItem(e),Le([])}},Ut=et.useCallback($t((()=>{E({...Ht.current}),W((e=>{const t={...e};return Ht.current.title&&t.title&&delete t.title,Ht.current.text&&t.text&&delete t.text,Ht.current.tag_ids.length>0&&t.tag_ids&&delete t.tag_ids,t})),Ye&&localStorage.setItem(Ye,JSON.stringify(Ht.current))}),500),[Ye]),Jt=e=>{if(!e)return!1;const t=e.includes(":hidden")||e.includes(":essay")||e.includes(":sort")||e.includes(":select"),s=e.includes("[ ]")||e.includes("[x]");return t||s},qt=()=>{window.dispatchEvent(new CustomEvent("validateAllQuizzes",{detail:{taskId:"preview"}}))},Qt=(e,t)=>{Ae(t);$e(["live-preview","ai-chat","components-help"][t])},Kt=()=>{B(!L)},es=async e=>{const t=e||De;if(!t||"string"!=typeof t||!t.trim())return;const s={id:Date.now().toString(),message:t,text:A.text||"",timestamp:new Date,status:"processing",type:He};Le((e=>[s,...e])),Re(""),Oe(!0);try{const e=await n.tasks.chat({text:A.text,message:s.message,type:s.type});Le((e=>e.map((e=>e.id===s.id?{...e,status:"done"}:e)))),"text"===He&&e&&(Je(A.text),Ht.current.text=e,E({...Ht.current}),v.current&&(v.current.setMarkdown(e||""),v.current.focus()),Ut())}catch(a){Le((e=>e.map((e=>e.id===s.id?{...e,status:"error"}:e)))),y("Failed to get AI response. "+a)}finally{Oe(!1)}},ts=e=>{e?(Qe(null),localStorage.removeItem(Ye),Le([]),nt(!1),r(c)):nt(!1)};if(et.useEffect((()=>{let e=!0;return(async()=>{if(e){_(!0);try{const t=await n.tags.getAll();if(!e)return;if(P(t),o){const t=await n.tasks.getById(o);if(!e)return;C(t),Je(t.text||"");const s={title:t.title,text:t.text||"",tag_ids:t.tags.map((e=>e.id))};Ht.current=s,E(s)}else if(x){const t=await n.tasks.getById(x);if(!e)return;C(t),Je(t.text||"");const s={title:`Copy of ${t.title}`,text:t.text||"",tag_ids:t.tags.map((e=>e.id))};Ht.current=s,E(s)}else if(h){const t=await n.tasks.getBySharingKey(h);if(!e)return;C(t),Je(t.text||"");const s={title:t.title,text:t.text||"",tag_ids:t.tags.map((e=>e.id))};Ht.current=s,E(s)}else if(g&&!o&&!x&&!h){const e={title:g,text:"",tag_ids:[]};Ht.current=e,E(e)}u&&D(await n.works.getById(u))}catch(t){const s=t instanceof Error?t.message:"Failed to load data. Please try again.";if(!e)return;y(s),r(c)}finally{if(!e)return;_(!1)}}})(),()=>{e=!1}}),[o,x,h,g,r,c]),!kt)return r(c),null;function ss(e=!1){return tt.jsxs(rt,{sx:{display:"flex",gap:0,opacity:e?1:.5,pointerEvents:e?"auto":"none"},children:[tt.jsx(ge,{options:["Bold","Italic"]}),tt.jsx(fe,{options:["bullet","number"]}),tt.jsx(je,{}),tt.jsx(ye,{editorRef:v}),tt.jsx(ke,{editorRef:v}),tt.jsx(be,{editorRef:v}),tt.jsx(ve,{editorRef:v}),tt.jsx(we,{editorRef:v}),tt.jsx(Ce,{editorRef:v}),tt.jsx(Se,{}),tt.jsx(Ie,{}),tt.jsx(_e,{}),tt.jsx(Fe,{}),tt.jsx(Xt,{})]})}return tt.jsxs(rt,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[I?tt.jsx(p,{message:Nt(bt?"taskForm.loading.task":"taskForm.loading.default")}):tt.jsxs(rt,{sx:{display:{xs:"block",lg:"flex"},gap:2,height:"100%",overflow:"hidden",justifyContent:"center",alignItems:"center"},children:[tt.jsxs(rt,{sx:{display:"flex",flex:"3 1",flexDirection:"column",width:"100%",maxWidth:"800px",height:"100%",position:"relative",overflow:"hidden",margin:"0 auto"},children:[tt.jsx(rt,{sx:{flex:1,overflow:"auto",p:1,pt:0},children:tt.jsx(rt,{width:"100%",sx:{display:"flex",justifyContent:"space-between"},children:tt.jsx(rt,{sx:{flex:1,display:"flex",flexDirection:"column",width:"100%",position:"relative"},children:tt.jsxs(rt,{component:"form",noValidate:!0,sx:{display:"flex",flexDirection:"column",height:"100%",minHeight:0,flex:1},children:[tt.jsxs(ct,{sx:{p:2,pt:0,pb:1},children:[$&&tt.jsx(rt,{sx:{my:2},children:tt.jsx(xt,{label:$.name,onDelete:()=>r(c),color:"primary"})}),tt.jsx(ut,{autoFocus:!0,margin:"normal",name:"title",label:Nt("taskForm.title.label"),type:"text",size:"small",fullWidth:!0,variant:"outlined",defaultValue:A.title,onChange:e=>{Ht.current.title=e.target.value,Ut()},error:!!R.title,helperText:R.title,inputProps:{autoComplete:"off",maxLength:100},InputProps:{startAdornment:tt.jsx(H,{sx:{mr:1,color:"text.secondary"},fontSize:"small"})}}),tt.jsx(mt,{multiple:!0,size:"small",options:z,getOptionLabel:e=>e.name,value:z.filter((e=>Ht.current.tag_ids.includes(e.id))),onChange:(e,t)=>{const s=t.map((e=>e.id));Ht.current.tag_ids=s,E({...Ht.current}),Ut()},disabled:vt,disableCloseOnSelect:!0,renderInput:e=>tt.jsxs(rt,{sx:{position:"relative"},children:[tt.jsx(ut,{...e,label:Nt("taskForm.tags.label"),margin:"normal",error:!!R.tag_ids,InputProps:{...e.InputProps,startAdornment:tt.jsxs(tt.Fragment,{children:[tt.jsx(m,{sx:{m:.25,ml:1,color:"text.secondary"},fontSize:"small"}),e.InputProps.startAdornment]})}}),vt&&tt.jsx(Dt,{sx:{position:"absolute",bottom:0,left:0,right:0,height:2}})]}),filterOptions:(e,{inputValue:t})=>{const s=e.filter((e=>e.name.toLowerCase().includes(t.toLowerCase())));return t&&!s.length?[{id:"new",name:t,creator_id:(null==f?void 0:f.id)||""}]:s},renderOption:(e,t)=>"new"===t.id?tt.jsx("li",{...e,onClick:async e=>{e.stopPropagation(),wt(!0);try{const e=await n.tags.create({name:t.name});P((t=>[...t,e])),Ht.current.tag_ids=[...Ht.current.tag_ids,e.id],E({...Ht.current})}catch(s){const e=s instanceof Error?s.message:"Failed to create tag. Please try again.";y(e)}finally{wt(!1)}},children:Nt("taskForm.tags.create",{name:t.name})}):tt.jsx("li",{...e,children:t.name})}),R.tag_ids&&tt.jsx(Rt,{error:!0,children:R.tag_ids}),tt.jsxs(rt,{sx:{display:"flex",flexDirection:"row",gap:1,justifyContent:"flex-end",mt:1},children:[tt.jsxs(lt,{size:"small",onClick:()=>{Qt(0,2),Kt()},children:[tt.jsx(d,{sx:{mr:1}}),Nt("taskForm.buttons.addElement")]}),tt.jsxs(lt,{size:"small",onClick:()=>{Qt(0,1),Kt()},children:[tt.jsx(S,{sx:{mr:1}}),Nt("taskForm.ai.title")]})]})]}),tt.jsx(ct,{id:"task-form-editor-paper",sx:{flex:1,display:"flex",flexDirection:"column",minHeight:0,position:"relative",mt:2,mb:2,border:"1px solid",borderColor:"divider"},children:tt.jsx(V,{ref:v,markdown:A.text,autoFocus:!0,onChange:e=>{Ht.current.text=e,Ut()},placeholder:Nt("taskForm.editor.placeholder"),className:"dark"===k?"mdxeditor dark-theme dark-editor":"mdxeditor light-theme light-editor",translation:(e,t,s)=>Nt("editor."+e,{defaultValue:t,...s}),plugins:[U(),J(),q(),Q({disableImageResize:!0,disableImageSettingsButton:!0,imageUploadHandler:async e=>{const t=URL.createObjectURL(e);ht(t);const s=await n.files.uploadImage(e);return s.url?(ht(null),URL.revokeObjectURL(t),s.url):(y("Failed to upload image. Please try again."),t)},EditImageToolbar:ne}),K(),G(),Y(),X({disableAutoLink:!0}),Z(),ee({viewMode:"rich-text",diffMarkdown:Ue}),te({escapeUnknownTextDirectives:!0,directiveDescriptors:[ie,re,oe,le,ce,de,me]}),se(1e5),ae({toolbarClassName:"mdxeditor-toolbar-full ",toolbarContents:()=>tt.jsx(xe,{options:zt?[]:["source"],children:tt.jsx(ue,{options:[{when:e=>{var t;return"root"!==(null==(t=null==e?void 0:e.rootNode)?void 0:t.getType())},contents:()=>ss(!1)},{fallback:()=>ss(!0)}]})})})]})})]})})})}),tt.jsxs(rt,{sx:{width:"100%",p:1,display:"flex",justifyContent:"space-between",position:"sticky",bottom:0,left:0,zIndex:1},children:[tt.jsx(rt,{sx:{display:"flex-start",gap:2},children:tt.jsx(lt,{size:zt?"small":"medium",variant:"outlined",color:"inherit",onClick:()=>{null!==localStorage.getItem(Ye)?nt(!0):r(c)},children:Nt("taskForm.buttons.cancel")})}),tt.jsxs(rt,{sx:{display:"flex",gap:2,alignItems:"center"},children:[tt.jsx(Wt,{title:Nt("taskForm.buttons.preview"),children:tt.jsx(lt,{size:zt?"small":"medium",variant:"outlined",startIcon:tt.jsx(he,{}),onClick:()=>{Qt(0,0),Kt()},children:Nt("taskForm.buttons.preview")})}),tt.jsx(Wt,{title:F?Nt("taskForm.loading.saving"):A.title.trim()?A.text.trim()?"":Nt("taskForm.content.error.required"):Nt("taskForm.title.error.required"),children:tt.jsx("span",{children:tt.jsx(lt,{size:zt?"small":"medium",variant:"contained",color:"primary",onClick:async()=>{const{isValid:e,errors:t}=Te(ze,A);if(e){T(!0);try{if(bt&&o)await n.tasks.update(o,A);else{const e=await n.tasks.create(A);u&&await n.works.addTask(u,e.id)}Qe(null),localStorage.removeItem(Ye),Le([]),r(c)}catch(s){const e=s instanceof Error?s.message:"Failed to save task. Please try again.";y(e)}finally{T(!1)}}else W(t)},disabled:F||!A.title.trim()||!A.text.trim(),children:Nt(F?"taskForm.loading.saving":bt?"common.actions.save":"taskForm.buttons.create")})})})]})]})]}),tt.jsx(Ot,{anchor:"right",open:L,onClose:Kt,onOpen:()=>B(!0),variant:Bt?"permanent":Tt?"persistent":"temporary",sx:{width:{xs:"100%",sm:"400px"},maxWidth:"400px",flexShrink:0,"& .MuiDrawer-paper":{width:{xs:"100%",sm:"400px"}}},children:tt.jsxs(rt,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[tt.jsxs(rt,{sx:{borderBottom:1,borderColor:"divider",display:"flex",alignItems:"center",px:1},children:[!Bt&&tt.jsx(pt,{onClick:()=>B(!1),sx:{mr:1},children:Tt?tt.jsx(pe,{}):tt.jsx(b,{})}),tt.jsxs(Mt,{value:Pe,onChange:Qt,variant:"fullWidth",sx:{flex:1,"& .MuiTab-root":{minHeight:48,fontSize:"0.875rem"}},children:[tt.jsx(Lt,{value:2,label:Nt("taskForm.buttons.elements"),iconPosition:"start"}),tt.jsx(Lt,{icon:tt.jsx(S,{}),value:1,label:Nt("taskForm.ai.titleShort"),iconPosition:"start"}),tt.jsx(Lt,{icon:tt.jsx(he,{}),value:0,label:Nt("taskForm.buttons.preview"),iconPosition:"start"})]})]}),tt.jsxs(rt,{sx:{flex:1,overflow:"auto",p:2},children:[0===Pe&&tt.jsx(tt.Fragment,{children:(null==(i=null==A?void 0:A.text)?void 0:i.length)>0?tt.jsx(Yt,{title:A.title||"",text:A.text||"",tagIds:A.tag_ids,tags:z,teacherId:(null==f?void 0:f.id)||"",onClose:()=>B(!1),onFullscreen:()=>M(!0),onValidateAnswers:qt,hasQuizzes:Jt(A.text||"")}):tt.jsx(yt,{variant:"body1",sx:{textAlign:"center",mt:2},children:Nt("taskForm.preview.empty")})}),1===Pe&&tt.jsx(Gt,{aiChatMessage:De,setAIChatMessage:Re,isSendingAIMessage:We,aiChatHistory:Me,isProcessingAttachment:Be,setIsProcessingAttachment:Ne,aiChatMode:He,setAIChatMode:Ve,handleSendAIMessage:es,handleImprove:async()=>{if(!A.text)return;const e="✨ "+Nt("taskForm.ai.improve");Re(e),es(e)},handleRestoreHistoryItem:e=>{Re(e.message),Ht.current.text=e.text,E({...Ht.current}),v.current&&(v.current.setMarkdown(e.text||""),v.current.focus()),Ut(),Le((t=>{const s=t.findIndex((t=>t.id===e.id));return-1===s?t:t.slice(s+1)}))},handleRecognizedText:async(e,t)=>{const s={id:Date.now().toString(),message:"",text:A.text,timestamp:new Date,status:"done",image:void 0,type:He};Le((e=>[s,...e]));const a=`\n${e}\n`,n=A.text+a;Ht.current.text=n,E({...Ht.current}),v.current&&(v.current.setMarkdown(n),v.current.focus()),Ut()}}),2===Pe&&tt.jsx(Zt,{onChange:(e,t="")=>{const s=e?`&nbsp;${t}&nbsp;`:`&nbsp;\n${t}\n&nbsp;`;v.current&&(v.current.focus((()=>{}),{defaultSelection:"rootEnd"}),setTimeout((()=>{var e;null==(e=v.current)||e.insertMarkdown(s),B(!1)}),100))}})]})]})})]}),tt.jsx(j,{open:O,onClose:()=>M(!1),task:{id:"preview",title:A.title||"",text:A.text||"",tags:z.filter((e=>A.tag_ids.includes(e.id))),teacher_id:(null==f?void 0:f.id)||""},hasQuizzes:Jt(A.text),onValidateAnswers:qt}),tt.jsxs(Ct,{open:Ke,onClose:()=>Ge(!1),children:[tt.jsx(St,{children:Nt("taskForm.dialog.unsavedChanges.title")}),tt.jsx(It,{children:tt.jsx(yt,{children:Nt("taskForm.dialog.unsavedChanges.message")})}),tt.jsxs(_t,{children:[tt.jsx(lt,{onClick:()=>Vt(!1),color:"error",children:Nt("taskForm.dialog.unsavedChanges.discard")}),tt.jsx(lt,{onClick:()=>Vt(!0),variant:"contained",children:Nt("taskForm.dialog.unsavedChanges.restore")})]})]}),tt.jsxs(Ct,{open:at,onClose:()=>nt(!1),children:[tt.jsx(St,{children:Nt("taskForm.dialog.cancel.title")}),tt.jsx(It,{children:tt.jsx(yt,{children:Nt("taskForm.dialog.cancel.message")})}),tt.jsxs(_t,{children:[tt.jsx(lt,{onClick:()=>ts(!1),children:Nt("taskForm.dialog.cancel.keep")}),tt.jsx(lt,{onClick:()=>ts(!0),variant:"contained",color:"error",children:Nt("taskForm.dialog.cancel.confirm")})]})]}),tt.jsxs(Ct,{open:!!dt,onClose:()=>ht(null),maxWidth:"sm",fullWidth:!0,children:[tt.jsx(St,{children:Nt("taskForm.dialog.image.title")}),tt.jsxs(It,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[tt.jsx(rt,{component:"img",src:dt||"",alt:"Preview",sx:{maxWidth:"100%",maxHeight:"300px",objectFit:"contain"}}),tt.jsx(p,{message:Nt("taskForm.loading.image")})]})]}),tt.jsxs(Ct,{open:!!gt,onClose:()=>ft(null),maxWidth:"sm",fullWidth:!0,children:[tt.jsx(St,{children:Nt("taskForm.dialog.generatedImage.title")}),tt.jsx(It,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:tt.jsx(rt,{component:"img",src:(as=gt,as?as.startsWith("data:image")?as:`data:image/jpeg;base64,${as}`:""),alt:"Generated",sx:{maxWidth:"100%",maxHeight:"300px",objectFit:"contain"}})}),tt.jsx(_t,{children:tt.jsx(lt,{onClick:()=>ft(null),children:Nt("taskForm.dialog.image.close")})})]})]});var as}},Symbol.toStringTag,{value:"Module"})),ts=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const{t:i}=s(),{user:r}=e(),o=Xe(),[l]=Ze(),c=l.get("return_to")||"",m=l.get("studentId"),u=l.get("work_id"),h="true"===l.get("edit"),f="true"===l.get("copy"),k="true"===l.get("template"),b=l.get("folder"),[v,w]=et.useState([]),[C,S]=et.useState(null),[I,_]=et.useState([]),[F,T]=et.useState(null),[z,P]=et.useState(""),[A,E]=et.useState(!1),[$,D]=et.useState(null),[R,W]=et.useState(0),[O,M]=et.useState([]),[L,B]=et.useState(!0),[N,H]=et.useState(!1),[V,U]=et.useState(null),[J,q]=et.useState({}),[Q,K]=et.useState(h||k?1:0),[G,Y]=et.useState(!1),X=(null==r?void 0:r.role)===a.TEACHER||(null==r?void 0:r.role)===a.ADMIN,{showErrorToast:Z,showToast:ee}=t(),[te,se]=et.useState(null),[ae,ne]=et.useState(!1),[ie,re]=et.useState(0),[oe,le]=et.useState(0),[ce,de]=et.useState(null),[me,xe]=et.useState([]);et.useEffect((()=>{(async()=>{try{const e=await n.folders.getAll(0,100);if(xe(e),b){const t=e.find((e=>e.id===b));if(t)de(t);else{const e=await n.folders.getById(b);e&&de(e)}}}catch(e){Z(y(e))}})()}),[b]);const[ue,he]=et.useState(!b);et.useEffect((()=>{(async()=>{B(!0),U(null);try{const e=await n.contracts.getAll(0,100),t=e.filter((e=>e.status===Pe.AGREED||e.status===Pe.PENDING));M(t);const s=new Map;e.forEach((e=>{e.student&&!s.has(e.student_id)&&s.set(e.student_id,e.student)}));const a=Array.from(s.values()).sort(((e,t)=>{const s=Ee(e).toLowerCase(),a=Ee(t).toLowerCase();return s.localeCompare(a)}));if(X&&r){const e={id:r.id,first_name:i("templates.titleSingle"),last_name:null,photo_url:null,is_template:!0};a.unshift(e)}if(w(a),U(null),k&&X&&r){const e=a.find((e=>e.id===r.id&&e.is_template));if(e){S(e);const t=new Date,s=t.getDate().toString().padStart(2,"0"),a=(t.getMonth()+1).toString().padStart(2,"0"),n=`${s}.${a}.${t.getFullYear()}`;P(`${i("templates.titleSingle")} - ${n}`)}}else if(m){const e=a.find((e=>e.id===m));if(e){S(e);const t=new Date,s=t.getDate().toString().padStart(2,"0"),a=(t.getMonth()+1).toString().padStart(2,"0"),n=`${s}.${a}.${t.getFullYear()}`;P(`${i("works.creator.forStudent")} ${Ee(e)||e.id} - ${n}`)}}u&&(h||f)&&await ge(u)}catch(e){const t=y(e);U(t),Z(t)}finally{B(!1)}})()}),[m,u,h,f,ie,k]);const ge=async e=>{try{const t=await n.works.getById(e);T(t),P(f?`Copy of ${t.name}`:t.name);const s=(await Promise.all(t.task_states.sort(((e,t)=>(e.order||0)-(t.order||0))).map((async e=>{if(!e.task)try{return await n.tasks.getById(e.task_id)}catch(t){return null}return e.task})))).filter((e=>null!==e));_(s)}catch(t){const e=t instanceof Error?t.message:"Failed to load work data. Please try again.";U(e),Z(e)}};et.useEffect((()=>{if(F&&v.length>0&&h){const e=v.find((e=>e.id===F.student_id));e?S(e):Z("Student for this work could not be found. Please select a student manually.")}}),[F,v,h]),et.useEffect((()=>{if(C&&!C.is_template){const e=O.find((e=>e.student_id===C.id&&e.teacher_id===(null==r?void 0:r.id)&&e.status===Pe.AGREED)),t=O.find((e=>e.student_id===C.id&&e.teacher_id===(null==r?void 0:r.id)&&e.status===Pe.PENDING)),s=e||t;D(s||null),s?(W(s.balance),s.balance>0?E(!0):E(!1)):(W(0),E(!1))}else D(null),W(0),E(!1)}),[C,O,null==r?void 0:r.id]);const fe=e=>{_((t=>t.some((t=>t.id===e.id))?t.filter((t=>t.id!==e.id)):[...t,e]))},je=async(e=!0)=>{if(!C)return void U("Please select a student");const t={name:z,student_id:C.id,task_ids:I.map((e=>e.id)),contract_id:A&&$?$.id:void 0,folder_id:null==ce?void 0:ce.id,is_draft:!e},{isValid:s,errors:a}=Te(Ue,t);if(!s)return void q(a);H(!0),U(null);let i=null;try{if(h&&F){i=(await n.works.update(F.id,t)).id}else{i=(await n.works.create(t)).id}return e?c&&"null"!=c?void o(c):(null==C?void 0:C.is_template)?void o("/templates"):void o("/works"):i}catch(r){const e=r instanceof Error?r.message:`Failed to ${h?"update":"create"} work. Please try again.`;U(e),Z(e),H(!1)}},ye=e=>{se(e),ne(!0)},ke=()=>{ne(!1)},be=et.useCallback((()=>{re((e=>e+1))}),[]),ve=()=>{Y(!1)},[we,Ce]=et.useState(!1),Se=()=>{Ce(!1)};return L?tt.jsx(p,{message:i("common.loading")}):tt.jsxs(rt,{sx:{mx:"auto",pb:1,height:"100%",display:"flex",flexDirection:"column",overflow:"hidden",width:"100%",".sortable-list":{position:"relative","& .item":{transition:"background-color 0.2s, box-shadow 0.2s, transform 0.1s","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.04)"},userSelect:"none",cursor:"default"},"& .dragged-item":{backgroundColor:"primary.main!important",color:"white!important",boxShadow:"0 10px 20px rgba(0, 0, 0, 0.3)!important",opacity:.95,zIndex:1e3,transform:"scale(1.03)",borderRadius:"4px",pointerEvents:"none",cursor:"grabbing","& .MuiTypography-root":{color:"white!important"},"& svg":{color:"white!important"}}}},children:[tt.jsx("style",{children:`\n          .dragged-item {\n            background-color: ${Ae.palette.primary.main} !important;\n          }\n        `}),V&&tt.jsx(ot,{severity:"error",sx:{mb:2},action:tt.jsx(lt,{color:"inherit",size:"small",onClick:be,disabled:N,children:i(N?"common.status.loading":"common.actions.retry")}),children:V}),tt.jsx(rt,{sx:{p:0,mx:"auto",width:"100%",maxWidth:"800px",flexShrink:0},children:tt.jsxs(Mt,{value:Q,onChange:(e,t)=>{C&&K(t)},centered:!0,variant:"fullWidth",sx:{mx:2},children:[tt.jsx(Lt,{label:i(h?"works.tabs.step1.edit":f?"works.tabs.step1.copy":"works.tabs.step1.create"),disabled:h}),tt.jsx(Lt,{label:i("works.tabs.step2")})]})}),0===Q&&tt.jsx(rt,{sx:{width:"100%",maxWidth:"800px",mx:"auto",flex:1,display:"flex",flexDirection:"column",overflow:"hidden",height:"100%"},children:tt.jsxs(ct,{sx:{p:2,mb:1,display:"flex",flexDirection:"column",overflow:"hidden",height:"100%"},children:[0===v.length&&tt.jsxs(rt,{sx:{textAlign:"center",py:3},children:[tt.jsx(yt,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:i("contracts.empty.noContracts")}),tt.jsx(yt,{variant:"body2",color:"text.secondary",sx:{mb:2},children:i("contracts.empty.hint")}),tt.jsx(lt,{variant:"outlined",color:"primary",startIcon:tt.jsx(d,{}),onClick:()=>o("/contracts/new"),children:i("contracts.actions.create")})]}),tt.jsx(rt,{sx:{mt:1,mb:2},children:tt.jsx(mt,{value:C,onChange:(e,t)=>(e=>{if(S(e),e){const t=new Date,s=`${t.getDate().toString().padStart(2,"0")}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getFullYear()}`;e.is_template?P(`${i("templates.titleSingle")} - ${s}`):P(`${i("works.creator.forStudent")} ${Ee(e)||e.id} - ${s}`)}else P("")})(t),options:v,getOptionLabel:e=>Ee(e),renderInput:e=>tt.jsx(ut,{...e,label:i("works.creator.forStudent"),placeholder:i("works.creator.selectStudent"),required:!0,error:!!J.student_id,helperText:J.student_id,InputProps:{...e.InputProps,startAdornment:tt.jsxs(tt.Fragment,{children:[C&&(C.is_template?tt.jsx($e,{sx:{mr:1,color:"primary.main"}}):tt.jsx(Bt,{src:C.photo_url||void 0,sx:{width:24,height:24,mr:1},children:De(C)})),e.InputProps.startAdornment]})}}),renderOption:(e,t)=>tt.jsx(rt,{component:"li",...e,children:tt.jsxs(rt,{sx:{display:"flex",alignItems:"center"},children:[t.is_template?tt.jsx($e,{sx:{mr:1,color:"primary.main"}}):tt.jsx(Bt,{src:t.photo_url||void 0,sx:{width:24,height:24,mr:1},children:De(t)}),tt.jsx(yt,{sx:{fontWeight:t.is_template?500:400,color:t.is_template?"primary.main":"inherit"},children:t.is_template?i("templates.titleSingle"):Ee(t)||t.id})]})})})}),tt.jsx(rt,{sx:{mt:1,mb:2},children:(null==C?void 0:C.is_template)?tt.jsx(yt,{variant:"body1",color:"primary",sx:{mt:1},children:i("works.creator.templateHint")}):C&&tt.jsx(yt,{variant:"body1",color:"warning",sx:{mt:1},children:i("works.creator.studentHint")})}),C&&tt.jsx(lt,{variant:"contained",color:"primary",onClick:()=>K(1),disabled:!C,endIcon:tt.jsx(Re,{}),sx:{my:1},children:i("works.actions.continue")}),(null==C?void 0:C.is_template)&&me.length>0&&tt.jsx(tt.Fragment,{children:h?tt.jsx(tt.Fragment,{children:null==F?void 0:F.folders.map((e=>tt.jsx(ut,{fullWidth:!0,disabled:!0,label:i("templates.actions.currentFolder"),placeholder:i("templates.actions.currentFolder"),value:e.title,InputProps:{readOnly:!0,startAdornment:tt.jsx(ht,{position:"start",children:tt.jsx(We,{color:"primary"})})}})))}):tt.jsx(tt.Fragment,{children:ce&&!ue?tt.jsx(ut,{fullWidth:!0,label:i("templates.actions.folder"),placeholder:i("templates.actions.selectFolder"),value:ce.title,InputProps:{readOnly:!0,startAdornment:tt.jsx(ht,{position:"start",children:tt.jsx(We,{color:"primary"})}),endAdornment:tt.jsx(ht,{position:"end",children:tt.jsx(lt,{variant:"contained",color:"primary",onClick:()=>{de(null),he(!0)},size:"small",children:i("common.actions.change")})})}}):ue&&tt.jsxs(tt.Fragment,{children:[tt.jsxs(yt,{variant:"body2",sx:{mb:2},children:[i("templates.actions.selectFolder")," (",i("common.optional"),"):"]}),tt.jsx(rt,{sx:{backgroundColor:"background.paper",flex:1,overflow:"auto",display:"flex",flexDirection:"column",borderRadius:3},children:tt.jsx(rt,{sx:{flex:1,overflow:"auto"},children:tt.jsx(Oe,{onFolderSelect:e=>{de(e),he(!1)}})})})]})})})]})}),1===Q&&tt.jsxs(rt,{sx:{width:"100%",maxWidth:"800px",mx:"auto",flex:1,display:"flex",flexDirection:"column",overflow:"hidden",height:"100%"},children:[tt.jsxs(ct,{sx:{p:2,mb:2,flexShrink:0},children:[tt.jsxs(rt,{sx:{display:"flex",alignItems:"center",gap:1},children:[!h&&tt.jsx(Wt,{title:i("common.actions.edit"),children:tt.jsx(pt,{onClick:()=>K(0),size:"small",children:tt.jsx(pe,{})})}),(null==C?void 0:C.is_template)?tt.jsx(yt,{variant:"body1",color:"primary",children:i("works.creator.templateHint")}):tt.jsxs(tt.Fragment,{children:[tt.jsx(Bt,{src:(null==C?void 0:C.photo_url)||void 0,sx:{width:32,height:32,mr:1},children:De(C)}),tt.jsx(yt,{children:(null==C?void 0:C.is_template)?i("templates.titleSingle"):Ee(C)||(null==C?void 0:C.id)})]})]}),!(null==C?void 0:C.is_template)&&((null==F?void 0:F.status)==Me.DRAFT||!h)&&tt.jsxs(rt,{sx:{ml:5,mt:1,p:1},children:[$&&R>0&&tt.jsx(yt,{variant:"body2",children:i("works.creator.availableLessons",{count:R})}),$&&R<=0&&tt.jsx(yt,{variant:"body2",color:"secondary",children:i("works.creator.noLessonsAvailable")}),!$&&tt.jsx(yt,{variant:"body2",color:"error",children:i("works.creator.noActiveContract")}),$&&R>0&&tt.jsx(rt,{sx:{mt:1},children:tt.jsx(Nt,{control:tt.jsx(jt,{checked:A,onChange:e=>E(e.target.checked),color:"primary"}),label:tt.jsx(yt,{variant:"h6",color:A?"primary":"default",children:i("works.creator.redeemLesson")})})})]})]}),tt.jsxs(ct,{variant:"outlined",sx:{height:"100%",overflow:"auto",mb:1,display:"flex",flexDirection:"column"},children:[tt.jsx(rt,{sx:{px:2,py:1},children:tt.jsx(ut,{fullWidth:!0,label:(null==C?void 0:C.is_template)?i("templates.actions.templateName"):i("templates.actions.workName"),value:z,onChange:e=>P(e.target.value),margin:"normal",required:!0,error:!!J.name,helperText:J.name})}),0===I.length&&tt.jsx(rt,{sx:{py:3,textAlign:"center"},children:tt.jsx(yt,{variant:"body1",color:"text.secondary",children:i("works.empty.noTasks")})}),tt.jsxs(Le,{onSortEnd:(e,t)=>{e<0||t<0||e>=I.length||t>=I.length||e===t||(_((s=>{const a=[...s],[n]=a.splice(e,1);return a.splice(t,0,n),a})),le((e=>e+1)))},lockAxis:"y",className:"sortable-list",draggedItemClassName:"dragged-item",allowDrag:!0,as:"div",style:{overflowY:"auto",overflowX:"hidden",padding:0,minHeight:"100px",position:"relative"},children:[I.map(((e,t)=>tt.jsx(Be,{children:tt.jsxs(rt,{sx:{display:"flex",alignItems:"center",px:2,py:1,borderBottom:1,borderColor:"divider","&:last-child":{borderBottom:0},cursor:"pointer","&:hover":{backgroundColor:"action.hover"}},children:[tt.jsxs(rt,{sx:{display:"flex",alignItems:"center",flex:1},children:[tt.jsx(Ne,{children:tt.jsx(He,{sx:{mr:1,color:"primary.main",cursor:"grab"}})}),tt.jsx(rt,{sx:{flex:1},onClick:()=>ye(e),children:tt.jsx(yt,{variant:"body1",sx:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden",textOverflow:"ellipsis"},children:`${t+1}. ${e.title}`})})]}),tt.jsx(rt,{sx:{display:"flex",alignItems:"center"},children:tt.jsx(Wt,{title:i("common.actions.remove"),children:tt.jsx(pt,{edge:"end",onClick:t=>{t.stopPropagation(),fe(e)},size:"small",children:tt.jsx(x,{})})})})]})},`task-${e.id}-pos-${t}`))),tt.jsxs(rt,{sx:{p:2,display:"flex",flexWrap:"wrap",justifyContent:"center",gap:2},children:[C&&tt.jsx(lt,{variant:"outlined",color:"primary",onClick:()=>{je(!1).then((e=>{e&&o(`/tasks/new?work_id=${e}&return_to=/works/assign/%3Fwork_id=${e}%26edit=true%26return_to=${c}`)}))},disabled:N||!C||!z.trim(),children:i("tasks.actions.createTask")}),tt.jsx(lt,{variant:"contained",color:"primary",onClick:()=>{Ce(!0)},children:i("works.creator.addExistingTask")})]}),!C||!z.trim()&&tt.jsx(yt,{variant:"body2",color:"error.main",sx:{p:2,textAlign:"center"},children:C?z.trim()?"":i("works.creator.enterWorkName"):i("works.creator.selectStudent")})]},`sortable-list-${oe}`)]}),J.task_ids&&tt.jsx(Rt,{error:!0,children:J.task_ids})]}),tt.jsxs(rt,{sx:{mt:1,display:"flex",justifyContent:"space-between",mx:"auto",width:"100%",maxWidth:"800px",flexShrink:0},children:[tt.jsx(lt,{variant:"outlined",color:"inherit",onClick:()=>{Q>=1?Y(!0):c?o(c):(null==C?void 0:C.is_template)?o("/templates"):o("/works")},sx:{mr:2},children:i("common.actions.cancel")}),tt.jsxs(rt,{sx:{display:"flex",gap:2},children:[Q>0&&!h&&tt.jsx(lt,{variant:"outlined",onClick:()=>K(0),children:i("common.actions.back")}),Q<1?tt.jsx(lt,{variant:"contained",color:"primary",onClick:()=>K(1),disabled:!C,children:i("common.actions.next")}):tt.jsx(tt.Fragment,{children:tt.jsx(lt,{variant:"contained",color:"primary",onClick:()=>je(!0),disabled:N||!C||!z.trim(),sx:{wordWrap:"nowrap"},children:N?i("common.status.loading"):h?(null==F?void 0:F.status)===Me.DRAFT?(null==C?void 0:C.is_template)?i("templates.actions.createTemplate"):i("templates.actions.sendToStudent"):i("common.actions.save"):(null==C?void 0:C.is_template)?i("templates.actions.createTemplate"):i("templates.actions.sendToStudent")})})]})]}),tt.jsx(j,{open:ae,onClose:ke,task:te,hasQuizzes:!1,onValidateAnswers:()=>{},actionButtons:tt.jsxs(rt,{sx:{display:"flex",gap:1,width:"100%",justifyContent:"space-between"},children:[tt.jsx(rt,{sx:{display:"flex",gap:1},children:te&&tt.jsxs(tt.Fragment,{children:[tt.jsx(Wt,{title:i("works.creator.autoSaveHint"),children:tt.jsx(lt,{size:"small",variant:"outlined",startIcon:tt.jsx(g,{}),onClick:()=>{je(!1).then((e=>{e&&(o(`/tasks/${te.id}/edit?return_to=/works/assign/%3Fwork_id=${e}%26edit=true`),ke())}))},children:i("common.actions.edit")})}),tt.jsx(lt,{size:"small",onClick:e=>{e.stopPropagation(),fe(te),ke()},startIcon:I.some((e=>e.id===te.id))?tt.jsx(x,{}):tt.jsx(d,{}),children:I.some((e=>e.id===te.id))?i("common.actions.remove"):i("common.actions.add")})]})}),tt.jsx(lt,{onClick:ke,children:i("common.actions.close")})]})}),tt.jsxs(Ct,{open:G,onClose:ve,maxWidth:"xs",fullWidth:!0,children:[tt.jsx(St,{children:i("common.dialog.cancel.title")}),tt.jsx(It,{children:tt.jsx(yt,{children:i("common.dialog.cancel.message")})}),tt.jsxs(_t,{children:[tt.jsx(lt,{onClick:ve,children:i("common.actions.no")}),tt.jsx(lt,{onClick:()=>{Y(!1),c?o(c):(null==C?void 0:C.is_template)?o("/templates"):o("/works")},color:"error",children:i("common.actions.yes")})]})]}),tt.jsxs(Ht,{anchor:"right",open:we,onClose:Se,sx:{"& .MuiDrawer-paper":{width:"100%",maxWidth:"800px",height:"100%",display:"flex",flexDirection:"column",borderRadius:0}},children:[tt.jsxs(rt,{sx:{py:2,px:4,display:"flex",justifyContent:"space-between",alignItems:"center",gap:2},children:[tt.jsx(lt,{onClick:Se,size:"small",variant:"contained",color:"primary",startIcon:tt.jsx(pe,{}),children:i("common.actions.done")}),tt.jsx(yt,{variant:"h6",children:i("works.creator.addTasks")})]}),tt.jsx(rt,{sx:{flex:1,overflow:"auto",px:2},children:tt.jsx(Ve,{selectedTasks:I,onTaskToggle:fe,onPreviewTask:ye})})]})]})}},Symbol.toStringTag,{value:"Module"})),ss=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const{t:i}=s(),{user:r}=e(),{showErrorToast:o}=t(),d=et.useRef(null),[m,u]=et.useState([]),[h,f]=et.useState(!0),[j,k]=et.useState(null),[b,v]=et.useState(0),[w,C]=et.useState(""),[S,I]=et.useState(!1),[_,F]=et.useState({}),[T,z]=et.useState(null),[P,A]=et.useState(null),[E,$]=et.useState(!1),[D,R]=et.useState(""),[W,O]=et.useState(!1),M=Xe(),L=(null==r?void 0:r.role)===a.ADMIN,B=(null==r?void 0:r.role)===a.TEACHER||L;et.useEffect((()=>{(async()=>{f(!0),k(null);try{const e=await n.tags.getAll();u(e),k(null)}catch(e){const t=y(e);k(t),o(t)}finally{f(!1)}})()}),[b]),et.useCallback((()=>{v((e=>e+1))}),[]);const N=async()=>{var e;const{isValid:t,errors:s}=Te(Qe,{name:w});if(t){I(!0);try{const t=await n.tags.create({name:w.trim()});u((e=>[t,...e])),C(""),F({}),null==(e=d.current)||e.focus()}catch(a){const e=a instanceof Error?a.message:"Failed to create tag. Please try again.";o(e)}finally{I(!1)}}else F(s)},H=()=>{z(null)},V=()=>{$(!1),R("")},U=()=>{O(!1)};return tt.jsxs(rt,{children:[tt.jsx(c,{title:i("navigation.tags")}),h?tt.jsx(p,{message:i(h?"common.loading":"tags.loading.tags")}):tt.jsxs(tt.Fragment,{children:[tt.jsx(ct,{sx:{p:3,mb:3,mx:"auto",maxWidth:"1200px"},children:tt.jsxs(rt,{sx:{display:"flex",gap:1,alignItems:"center"},children:[tt.jsx(ut,{inputRef:d,fullWidth:!0,autoComplete:"off",autoCapitalize:"off",size:"small",placeholder:i("tags.input.placeholder"),value:w,onChange:e=>{C(e.target.value),_.name&&F((e=>({...e,name:""})))},onKeyPress:e=>{"Enter"===e.key&&w.trim()&&N()},error:!!_.name,helperText:_.name,InputProps:{endAdornment:w?tt.jsx(ht,{position:"end",children:tt.jsx(pt,{size:"small",onClick:()=>{C(""),F({})},edge:"end",children:tt.jsx(x,{})})}):null}}),w.trim()&&tt.jsx(lt,{size:"small",startIcon:tt.jsx(Je,{}),onClick:N,disabled:S,children:i(S?"common.status.saving":"common.actions.create")})]})}),j||0!==m.length?tt.jsx(ct,{sx:{p:3,mx:"auto",maxWidth:"1200px"},children:tt.jsx(rt,{sx:{display:"flex",flexWrap:"wrap",gap:1,mt:1},children:m.map((e=>tt.jsx(rt,{children:tt.jsx(xt,{onClick:t=>((e,t)=>{e.stopPropagation(),A(t),z(e.currentTarget)})(t,e),label:e.name,sx:{m:.5,height:"auto",borderRadius:"16px","& .MuiChip-label":{px:1.5,py:.5}},variant:"outlined"})},e.id)))})}):tt.jsx(rt,{sx:{textAlign:"center",py:4},children:tt.jsx(yt,{variant:"h6",color:"text.secondary",sx:{mb:1},children:i(B?"tags.empty.teacher":"tags.empty.default")})})]}),tt.jsxs(wt,{anchorEl:T,open:Boolean(T),onClose:H,onClick:e=>e.stopPropagation(),children:[tt.jsxs(st,{onClick:()=>{H(),M(`/tasks?tag_id=${null==P?void 0:P.id}`)},children:[tt.jsx(at,{children:tt.jsx(qe,{fontSize:"small"})}),tt.jsx(nt,{children:i("tags.actions.showTasks")})]}),tt.jsxs(st,{onClick:()=>{P&&(R(P.name),$(!0)),H()},children:[tt.jsx(at,{children:tt.jsx(g,{fontSize:"small"})}),tt.jsx(nt,{children:i("common.actions.rename")})]}),tt.jsxs(st,{onClick:()=>{H(),O(!0)},sx:{color:"error.main"},children:[tt.jsx(at,{sx:{color:"error.main"},children:tt.jsx(l,{fontSize:"small"})}),tt.jsx(nt,{children:i("common.actions.delete")})]})]}),tt.jsxs(Ct,{open:E,onClose:V,maxWidth:"xs",fullWidth:!0,children:[tt.jsx(St,{children:i("tags.dialog.rename.title")}),tt.jsx(It,{children:tt.jsx(ut,{autoFocus:!0,margin:"dense",label:i("tags.input.label"),type:"text",fullWidth:!0,value:D,onChange:e=>R(e.target.value),variant:"outlined"})}),tt.jsxs(_t,{children:[tt.jsx(lt,{onClick:V,children:i("common.actions.cancel")}),tt.jsx(lt,{onClick:async()=>{if(!P||!D.trim())return;const{isValid:e,errors:t}=Te(Qe,{name:D});if(e)try{const e=await n.tags.update(P.id,{name:D.trim()});u((t=>t.map((t=>t.id===P.id?e:t)))),$(!1),R(""),A(null)}catch(s){const e=s instanceof Error?s.message:"Failed to rename tag. Please try again.";o(e)}else o(t.name)},variant:"contained",disabled:!D.trim()||D===(null==P?void 0:P.name),children:i("common.actions.rename")})]})]}),tt.jsxs(Ct,{open:W,onClose:U,maxWidth:"xs",fullWidth:!0,children:[tt.jsx(St,{children:i("tags.dialog.delete.title")}),tt.jsx(It,{children:tt.jsx(yt,{children:i("tags.dialog.delete.message",{name:null==P?void 0:P.name})})}),tt.jsxs(_t,{children:[tt.jsx(lt,{onClick:U,children:i("common.actions.cancel")}),tt.jsx(lt,{onClick:async()=>{P&&(await(async e=>{try{await n.tags.delete(e),u((t=>t.filter((t=>t.id!==e))))}catch(t){const e=t instanceof Error?t.message:"Failed to delete tag. Please try again.";o(e)}})(P.id),O(!1))},color:"error",variant:"contained",children:i("common.actions.delete")})]})]})]})}},Symbol.toStringTag,{value:"Module"})),as=()=>{var i;const{t:r}=s(),o=Xe(),{contractId:l}=Pt(),[c]=Ze(),d=c.get("return_to")||"/contracts",{user:m}=e(),{showErrorToast:x,showToast:u}=t(),h="true"===c.get("testStudent"),g="teachair_test_student",[f,j]=et.useState(!0),[y,k]=et.useState(!1),[b,v]=et.useState(null),[w,C]=et.useState([]),[S,I]=et.useState({username:"",price:"",currency:null,balance:null,description:""}),[_,F]=et.useState({}),[T,z]=et.useState(null),[P,A]=et.useState(!1),[E,$]=et.useState(!1),[D,R]=et.useState(!0),W=(null==m?void 0:m.role)===a.ADMIN,O=(null==m?void 0:m.role)===a.TEACHER||W,M=Boolean(l);et.useEffect((()=>{(async()=>{j(!0);try{const e=await n.contracts.getCurrencies();C(e);const t=e.find((e=>"RUR"===e.code))||e[0];if(l){const t=await n.contracts.getById(l);v(t);let s=null;t.currency?s=t.currency:e.length>0&&(s=e[0].code),I({username:t.student_id,price:t.price,currency:s,balance:t.balance,description:t.description||""})}else h?(I((e=>({...e,username:g||"",price:1e3,currency:"RUR",balance:10,description:r("contracts.form.testStudentDescription")}))),R(!0)):t&&!S.currency&&I((e=>({...e,currency:t.code})))}catch(e){const t=e instanceof Error?e.message:"Failed to load data. Please try again.";x(t),o("/contracts")}finally{j(!1)}})()}),[l,o,x,h,g,r]);return O?tt.jsxs(rt,{sx:{display:"flex",flexDirection:"column",overflowX:"hidden",overflowY:"auto"},children:[f?tt.jsx(p,{message:r(M?"contracts.status.loadingContract":"common.loading")}):tt.jsx(tt.Fragment,{children:tt.jsxs(rt,{sx:{flex:1,display:"flex",flexDirection:"column",mx:"auto",width:"100%",maxWidth:"800px",pb:1},children:[tt.jsxs(ct,{sx:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",p:2,py:1},children:[tt.jsx(rt,{sx:{mt:2,mb:3},children:tt.jsx(yt,{variant:"h4",children:r(M?"contracts.actions.edit":"contracts.actions.create")})}),tt.jsxs(rt,{component:"form",noValidate:!0,children:[M?tt.jsxs(rt,{sx:{display:"flex",alignItems:"center",gap:2,mb:3},children:[tt.jsx(Bt,{src:(null==(i=null==b?void 0:b.student)?void 0:i.photo_url)||void 0,sx:{width:48,height:48},children:De(null==b?void 0:b.student)}),tt.jsxs(rt,{children:[tt.jsx(yt,{variant:"h6",children:Ee(null==b?void 0:b.student)}),tt.jsx(yt,{variant:"body2",color:"text.secondary",children:r("common.student.one")})]})]}):tt.jsx(ut,{autoFocus:!0,margin:"normal",name:"username",label:r("contracts.form.studentUsername"),type:"text",fullWidth:!0,variant:"outlined",value:S.username,onChange:e=>{const t=e.target.value;let s;s=t.includes("@")&&t.indexOf("@")>0?t.split("@")[0]:t.replace(/^@/,""),I((e=>({...e,username:s}))),_.username&&F((e=>{const t={...e};return delete t.username,t}))},error:!!_.username,helperText:_.username||r("contracts.form.telegramUsername"),placeholder:r("contracts.form.usernamePlaceholder"),InputProps:{startAdornment:tt.jsx(yt,{sx:{mr:.5},children:"@"})}}),!M&&tt.jsx(Nt,{control:tt.jsx(Vt,{checked:D,onChange:e=>{R(e.target.checked),e.target.checked||I((e=>({...e,price:0,balance:null})))}}),label:r("contracts.form.trackLessonsLabel"),sx:{mt:2,mb:1}}),D&&tt.jsxs(rt,{sx:{display:"flex",gap:2,alignItems:"flex-start"},children:[tt.jsx(ut,{margin:"normal",name:"price",label:r("contracts.form.pricePerLesson"),type:"number",sx:{flex:1},variant:"outlined",value:0===S.price?"":S.price,onChange:e=>{const t=e.target.value,s=""===t?0:Number(t.replace(/^0+/,""));I((e=>({...e,price:s}))),_.price&&F((e=>{const t={...e};return delete t.price,t}))},error:!!_.price,helperText:_.price}),tt.jsxs(Ut,{margin:"normal",sx:{minWidth:120},error:!!_.currency,children:[tt.jsx(Jt,{id:"currency-label",children:r("contracts.form.currency")}),tt.jsx(qt,{labelId:"currency-label",name:"currency",value:S.currency||"",label:r("contracts.form.currency"),onChange:e=>{const{name:t,value:s}=e.target;I((e=>({...e,[t]:s}))),_[t]&&F((e=>{const s={...e};return delete s[t],s}))},children:w.map((e=>tt.jsxs(st,{value:e.code,children:[e.emoji,"   ",e.code]},e.code)))})]})]}),!M&&D?tt.jsx(ut,{margin:"normal",name:"balance",label:r("contracts.form.balanceLabel"),type:"number",fullWidth:!0,variant:"outlined",value:null===S.balance?"":S.balance,onChange:e=>{const t=e.target.value,s=""===t?null:Number(t.replace(/^0+/,""));I((e=>({...e,balance:s}))),_.balance&&F((e=>{const t={...e};return delete t.balance,t}))},error:!!_.balance,helperText:_.balance||r("contracts.form.balanceHint")}):M?tt.jsxs(yt,{variant:"body1",color:"text.secondary",sx:{mt:1},children:[r("contracts.form.currentBalance"),": ",S.balance]}):null,tt.jsx(ut,{margin:"normal",name:"description",label:r("contracts.form.description"),type:"text",fullWidth:!0,variant:"outlined",value:S.description,onChange:e=>{const{name:t,value:s}=e.target;I((e=>({...e,[t]:"price"===t||"balance"===t?Number(s):s}))),_[t]&&F((e=>{const s={...e};return delete s[t],s}))},multiline:!0,rows:3,error:!!_.description,helperText:_.description||r("contracts.form.descriptionHint")})]})]}),tt.jsxs(rt,{sx:{mt:2,display:"flex",justifyContent:"space-between",flexShrink:0},children:[tt.jsx(rt,{sx:{display:"flex",alignItems:"center"},children:tt.jsx(lt,{variant:"outlined",color:"inherit",sx:{mr:2},onClick:()=>o(d),children:r("common.actions.cancel")})}),tt.jsx(rt,{children:tt.jsx(lt,{variant:"contained",color:"primary",onClick:async()=>{const e={...S,price:D?S.price:0,balance:D?S.balance??0:0},{isValid:t,errors:s}=Te(M?Ge:Ye,e);if(t){k(!0);try{if(M&&l)await n.contracts.update(l,{price:e.price,currency:e.currency,balance:e.balance,description:e.description}),o(d);else{const t=await n.contracts.create({...e});"new_user_created"===t.create_code?(z(t.id),A(!0),u(r("contracts.status.contractCreatedShort"),"success")):"already_exists"===t.create_code?(z(t.id),$(!0)):(z(null),A(!1),$(!1),u(r("contracts.status.contractCreatedShort"),"success"),o(d))}}catch(a){const e=a instanceof Error?a.message:r("contracts.status.errorCreating");if(e.includes("student_is_self"))return void x(r("contracts.status.studentIsSelf"));if(e.includes("student_is_teacher"))return void x(r("contracts.status.studentIsTeacher"));x(e)}finally{k(!1)}}else F(s)},disabled:y||!M&&!S.username.trim(),children:r(y?"common.status.saving":M?"contracts.actions.update":"contracts.actions.create")})})]})]})}),tt.jsx(Ke,{open:P,onClose:()=>A(!1),onCancel:()=>o(d),botUrl:"https://t.me/teachair_bot",cancelButtonText:r("common.actions.done")}),tt.jsxs(Ct,{open:E,onClose:()=>$(!1),maxWidth:"xs",fullWidth:!0,children:[tt.jsx(St,{children:r("contracts.dialog.existingContract.title")}),tt.jsx(It,{children:tt.jsx(yt,{children:r("contracts.dialog.existingContract.message")})}),tt.jsxs(_t,{children:[tt.jsx(lt,{onClick:()=>$(!1),children:r("common.actions.cancel")}),tt.jsx(lt,{onClick:()=>{$(!1),T&&o(`/contracts/${T}/edit`)},color:"primary",variant:"contained",children:r("contracts.actions.editExisting")})]})]})]}):(o("/contracts"),null)},ns=Object.freeze(Object.defineProperty({__proto__:null,ContractFormPage:as,default:as},Symbol.toStringTag,{value:"Module"}));export{Xt as A,ns as C,Yt as P,Kt as T,es as a,ts as b,ss as c};
