import{$ as e,a8 as s,ab as n,r as t,j as r,u as a,B as l,x as o,b as i,U as c,ak as d,V as m,d as u,A as x,ah as h,w as p,z as f,E as y,f as j,n as b,H as v}from"./vendor-CAsuUi-l.js";import{b as g,u as _,U as I,a as P,aG as S,L as w,aH as C,aI as T,A as E,aJ as U,aK as A,c as z}from"./main-IJaOmtUW.js";import{v as D,z as O}from"./teacher-AFY1PGFB.js";const W=O.object({type:O.nativeEnum(S,{errorMap:()=>({message:"transactions.validation.typeRequired"})}),contract_id:O.string().uuid("transactions.validation.contractRequired"),amount:O.number().optional().nullable(),currency:O.string().optional().nullable(),lessons_number:O.number().int("transactions.validation.minimumLessons").min(1,"transactions.validation.minimumLessons").optional().nullable()}).refine((e=>void 0!==e.lessons_number&&null!==e.lessons_number||void 0!==e.amount&&null!==e.amount&&e.currency),{message:"transactions.validation.lessonsOrAmount",path:["form"]}),L=()=>{const{t:O}=g(),L=e();s();const[R]=n(),k=R.get("return_to")||"/transactions",{user:M}=_(),B=(null==M?void 0:M.role)===I.ADMIN,H=(null==M?void 0:M.role)===I.TEACHER||B,{showToast:V,showErrorToast:q}=P(),G=R.get("contract_id"),[J,K]=t.useState(!0),[N,X]=t.useState(!1),[Y,$]=t.useState([]),[F,Q]=t.useState([]),[Z,ee]=t.useState(null),[se,ne]=t.useState({}),[te,re]=t.useState({type:S.TOP_UP,lessons_number:1,amount:null,currency:null,contract_id:G||void 0});t.useEffect((()=>{(async()=>{K(!0),ee(null);try{const e=await z.contracts.getAll(0,100);$(e);const s=await z.contracts.getCurrencies();if(Q(s),G){const s=e.find((e=>e.id===G));s&&re((e=>({...e,contract_id:G,currency:s.currency})))}}catch(e){ee(O("common.error")),q(e.message)}finally{K(!1)}})()}),[q,G]);const ae=e=>{const{name:s,value:n}=e.target;let t=n;"lessons_number"!==s&&"amount"!==s||(t=""===n?null:Math.max(0,parseInt(n,10))),re((e=>({...e,[s]:t}))),se[s]&&ne((e=>{const n={...e};return delete n[s],n}))},le=e=>{const{name:s,value:n}=e.target;if("contract_id"===s){const e=Y.find((e=>e.id===n));re(e?t=>({...t,[s]:n,currency:e.currency}):e=>({...e,[s]:n}))}else re((e=>({...e,[s]:n})));se[s]&&ne((e=>{const n={...e};return delete n[s],n}))},oe=async e=>{e.preventDefault();const s=D(W,te);if(s.isValid){X(!0),ee(null);try{await z.transactions.create(te),V(O("transactions.actions.createdSuccess"),"success"),L(k)}catch(n){ee(O("common.error")),q(n.message)}finally{X(!1)}}else ne(s.errors)};if(J)return r.jsx(w,{message:O("common.loading")});if(!H)return r.jsx(a,{severity:"error",children:O("common.error")});const ie=e=>{var s,n;return((null==(s=e.student)?void 0:s.first_name)||"")+" "+((null==(n=e.student)?void 0:n.last_name)||"")};return r.jsx(l,{sx:{display:"flex",flexDirection:"column",overflowX:"hidden",overflowY:"auto"},children:r.jsxs(l,{sx:{flex:1,display:"flex",flexDirection:"column",mx:"auto",width:"100%",maxWidth:"800px",pb:1},children:[r.jsxs(o,{sx:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",p:3,pt:1},children:[r.jsx(l,{sx:{mt:2,mb:3},children:r.jsx(i,{variant:"h4",children:O("transactions.form.title")})}),Z&&r.jsx(a,{severity:"error",sx:{mb:3},children:Z}),se.form&&r.jsx(a,{severity:"error",sx:{mb:3},children:O(se.form)}),r.jsxs(l,{component:"form",onSubmit:oe,noValidate:!0,children:[r.jsxs(c,{fullWidth:!0,error:!!se.contract_id,sx:{mb:3},children:[r.jsx(d,{id:"contract-label",children:O("transactions.form.contract")}),r.jsx(m,{labelId:"contract-label",name:"contract_id",value:te.contract_id||"",label:O("transactions.form.contract"),onChange:le,children:0===Y.length?r.jsx(u,{disabled:!0,children:O("transactions.form.noActiveContracts")}):Y.map((e=>{var s,n,t;return r.jsx(u,{value:e.id,children:r.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[r.jsx(x,{src:(null==(s=e.student)?void 0:s.photo_url)||void 0,sx:{width:24,height:24},children:((null==(t=null==(n=e.student)?void 0:n.first_name)?void 0:t[0])+"").toUpperCase()}),r.jsx(i,{children:ie(e)})]})},e.id)}))}),se.contract_id&&r.jsx(h,{children:O(se.contract_id)})]}),te.contract_id&&r.jsx(o,{elevation:0,variant:"outlined",sx:{p:2,mb:3},children:(()=>{const e=Y.find((e=>e.id===te.contract_id));return e?r.jsxs(p,{spacing:2,children:[r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(C,{sx:{mr:1,color:"text.secondary"}}),r.jsxs(i,{children:[O("transactions.form.contractInfo.paidLessons"),": ",e.balance]})]}),r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(T,{sx:{mr:1,color:"text.secondary"}}),r.jsxs(i,{children:[O("transactions.form.contractInfo.pricePerLesson"),": ",e.price," ",e.currency]})]})]}):null})()}),r.jsxs(c,{fullWidth:!0,error:!!se.type,sx:{mb:3},children:[r.jsxs(f,{value:te.type,exclusive:!0,onChange:(e,s)=>{null!==s&&(re((e=>({...e,type:s}))),se.type&&ne((e=>{const s={...e};return delete s.type,s})))},"aria-label":O("transactions.form.type.label"),fullWidth:!0,color:"primary",children:[r.jsx(y,{value:S.TOP_UP,children:r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(E,{fontSize:"small",color:"success",sx:{mr:.5}}),r.jsx(i,{children:O("transactions.form.type.topUp")})]})}),r.jsx(y,{value:S.REDEEM,children:r.jsxs(l,{sx:{display:"flex",alignItems:"center"},children:[r.jsx(U,{fontSize:"small",color:"error",sx:{mr:.5}}),r.jsx(i,{children:O("transactions.form.type.redeem")})]})})]}),se.type&&r.jsx(h,{children:O(se.type)})]}),r.jsxs(p,{spacing:3,children:[r.jsxs(l,{children:[r.jsxs(i,{variant:"body1",gutterBottom:!0,sx:{display:"flex",alignItems:"center",mb:2},children:[te.type===S.TOP_UP?r.jsx(E,{fontSize:"small",color:"success",sx:{mr:.5}}):r.jsx(U,{fontSize:"small",color:"error",sx:{mr:.5}}),O("transactions.form.lessons.title",{action:te.type===S.TOP_UP?O("transactions.toAdd"):O("transactions.toRedeem")})]}),r.jsx(j,{fullWidth:!0,name:"lessons_number",label:O("transactions.form.lessons.label"),type:"number",value:null===te.lessons_number?"":te.lessons_number,onChange:ae,error:!!se.lessons_number,helperText:se.lessons_number?O(se.lessons_number):"",InputProps:{inputProps:{min:1}}})]}),te.type===S.TOP_UP&&r.jsxs(l,{id:"payment-section",children:[r.jsxs(i,{variant:"body1",gutterBottom:!0,sx:{display:"flex",alignItems:"center",mb:2},children:[r.jsx(A,{fontSize:"small",sx:{mr:1}}),O("transactions.form.payment.title")]}),r.jsxs(l,{sx:{display:"flex",gap:2},children:[r.jsx(j,{sx:{flex:1},name:"amount",label:O("transactions.form.payment.amount"),type:"number",value:null===te.amount?"":te.amount,onChange:ae,error:!!se.amount,helperText:se.amount?O(se.amount):"",InputProps:{inputProps:{min:0}}}),r.jsxs(c,{sx:{minWidth:120},error:!!se.currency,children:[r.jsx(d,{id:"currency-label",children:O("transactions.form.payment.currency")}),r.jsx(m,{labelId:"currency-label",name:"currency",value:te.currency||"",label:O("transactions.form.payment.currency"),onChange:le,children:F.map((e=>r.jsxs(u,{value:e.code,children:[e.emoji," ",e.code]},e.code)))}),se.currency&&r.jsx(h,{children:O(se.currency)})]})]})]})]})]})]}),r.jsxs(l,{sx:{mt:2,display:"flex",justifyContent:"space-between",flexShrink:0},children:[r.jsx(l,{sx:{display:"flex",alignItems:"center"},children:r.jsx(b,{variant:"outlined",color:"inherit",sx:{mr:2},onClick:()=>{L(k)},disabled:N,children:O("common.actions.cancel")})}),r.jsx(l,{children:r.jsx(b,{type:"submit",variant:"contained",color:"primary",onClick:oe,disabled:N,startIcon:N?r.jsx(v,{size:20}):null,children:O(N?"transactions.actions.creating":"transactions.actions.create")})})]})]})})};export{L as default};
